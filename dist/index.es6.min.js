var e,t,i={},s={};function r(e){var t=s[e];if(void 0!==t)return t.exports;var n=s[e]={exports:{}};return i[e](n,n.exports,r),n.exports}r.m=i,r.d=(e,t)=>{for(var i in t)r.o(t,i)&&!r.o(e,i)&&Object.defineProperty(e,i,{enumerable:!0,get:t[i]})},r.f={},r.e=e=>Promise.all(Object.keys(r.f).reduce(((t,i)=>(r.f[i](e,t),t)),[])),r.u=e=>e+".index.es6.min.js",r.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),e={},t="jsge:",r.l=(i,s,n,a)=>{if(e[i])e[i].push(s);else{var o,l;if(void 0!==n)for(var h=document.getElementsByTagName("script"),c=0;c<h.length;c++){var d=h[c];if(d.getAttribute("src")==i||d.getAttribute("data-webpack")==t+n){o=d;break}}o||(l=!0,(o=document.createElement("script")).type="module",o.charset="utf-8",o.timeout=120,r.nc&&o.setAttribute("nonce",r.nc),o.setAttribute("data-webpack",t+n),o.src=i),e[i]=[s];var u=(t,s)=>{o.onerror=o.onload=null,clearTimeout(g);var r=e[i];if(delete e[i],o.parentNode&&o.parentNode.removeChild(o),r&&r.forEach((e=>e(s))),t)return t(s)},g=setTimeout(u.bind(null,void 0,{type:"timeout",target:o}),12e4);o.onerror=u.bind(null,o.onerror),o.onload=u.bind(null,o.onload),l&&document.head.appendChild(o)}},r.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},(()=>{var e;if("string"==typeof import.meta.url&&(e=import.meta.url),!e)throw new Error("Automatic publicPath is not supported in this browser");e=e.replace(/#.*$/,"").replace(/\?.*$/,"").replace(/\/[^\/]+$/,"/"),r.p=e})(),(()=>{var e={179:0};r.f.j=(t,i)=>{var s=r.o(e,t)?e[t]:void 0;if(0!==s)if(s)i.push(s[2]);else{var n=new Promise(((i,r)=>s=e[t]=[i,r]));i.push(s[2]=n);var a=r.p+r.u(t),o=new Error;r.l(a,(i=>{if(r.o(e,t)&&(0!==(s=e[t])&&(e[t]=void 0),s)){var n=i&&("load"===i.type?"missing":i.type),a=i&&i.target&&i.target.src;o.message="Loading chunk "+t+" failed.\n("+n+": "+a+")",o.name="ChunkLoadError",o.type=n,o.request=a,s[1](o)}}),"chunk-"+t,t)}};var t=(t,i)=>{var s,n,[a,o,l]=i,h=0;if(a.some((t=>0!==e[t]))){for(s in o)r.o(o,s)&&(r.m[s]=o[s]);l&&l(r)}for(t&&t(i);h<a.length;h++)n=a[h],r.o(e,n)&&e[n]&&e[n][0](),e[n]=0},i=self.webpackChunkjsge=self.webpackChunkjsge||[];i.forEach(t.bind(null,0)),i.push=t.bind(null,i.push.bind(i))})();var n={};r.d(n,{oX:()=>l,QD:()=>W,T_:()=>Oe,uw:()=>H,xl:()=>a,xP:()=>Pe,bq:()=>V,P6:()=>o});var a={};r.r(a),r.d(a,{Rectangle:()=>M,Vector:()=>D,Vertex:()=>P});var o={};r.r(o),r.d(o,{angle_2points:()=>$,angle_3points:()=>ee,calculateEllipseVertices:()=>Te,countClosestTraversal:()=>J,countClosestTraversal2:()=>Q,countDistance:()=>ne,crossProduct:()=>se,dotProduct:()=>ie,dotProductWithAngle:()=>te,generateUniqId:()=>fe,isCircleLineIntersect:()=>ue,isEllipseCircleIntersect:()=>me,isEllipseLineIntersect:()=>ge,isEllipsePolygonIntersect:()=>Ee,isLineShorter:()=>ae,isMobile:()=>K,isPointCircleIntersect:()=>de,isPointLineIntersect:()=>oe,isPointOnTheLine:()=>re,isPointPolygonIntersect:()=>he,isPointRectIntersect:()=>ce,isPolygonLineIntersect:()=>le,isSafari:()=>q,pointToCircleDistance:()=>Z,verticesArrayToArrayNumbers:()=>_e});const l={MODE:{DEBUG:"DEBUG",PRODUCTION:"PRODUCTION"},SCREENS:{},AUDIO:{},CONNECTION_STATUS:{DISCONNECTED:"disconnected",CONNECTED:"connected",CONNECTION_LOST:"connection lost"},EVENTS:{SYSTEM:{START_PAGE:"START_PAGE",STOP_PAGE:"STOP_PAGE",RENDER:{START:"start",END:"end"}},GAME:{BOUNDARIES_COLLISION:"BOUNDARIES_COLLISION",OBJECTS_COLLISION:"OBJECTS_COLLISION"},WEBSOCKET:{SERVER_CLIENT:{CONNECTION_STATUS_CHANGED:"CONNECTION_STATUS_CHANGED",ROOMS_INFO:"roomsInfo",CREATED:"created",JOINED:"joined",FULL:"full",DISCONNECTED:"disconnected",SERVER_MESSAGE:"message",RESTARTED:"restarted"},CLIENT_SERVER:{ROOMS_INFO_REQUEST:"gatherRoomsInfo",CREATE_OR_JOIN:"create or join",RESTART_REQUEST:"restart",CLIENT_MESSAGE:"message"}}},WEBGL:{DRAW_PROGRAMS:{PRIMITIVES:"drawPrimitives",IMAGES:"drawImages"}},DRAW_TYPE:{RECTANGLE:"rect",CONUS:"conus",CIRCLE:"circle",POLYGON:"polygon",LINE:"line",TEXT:"text",IMAGE:"image"},LAYERS:{DEFAULT:"default-view-layer",BOUNDARIES:"boundaries-view-layer"},GAME_OPTIONS:{},LIBRARY:{WEBGL:"webgl"},OPTIMIZATION:{CYCLE_TIME_CALC:{AVERAGES:"AVERAGES",CURRENT:"CURRENT"},NATIVE_JS:{NOT_OPTIMIZED:"NOT_OPTIMIZED",OPTIMIZED:"OPTIMIZED"},WEB_ASSEMBLY:{ASSEMBLY_SCRIPT:"ASSEMBLY_SCRIPT",NATIVE_WAT:"WASM"}}},h="CREATE_INSTANCE_ERROR",c="VIEW_NOT_EXIST",d="UNEXPECTED_INPUT_PARAMS",u="WEBGL_ERROR",g="NOT_FOUND",m="WORLD_DIMENSIONS_NOT_SET",E="UNHANDLED_DRAW_ISSUE",f="UNEXPECTED_WORLD_SIZE",_="AUDIO_NOT_REGISTERED",T="AUDIO_NOT_LOADED",A="POLYGON_VERTICES_NOT_CORRECT";function p(e,t){throw new Error(e+": "+t)}function R(e,t){console.warn(e,t)}class S{#e;#t;#i;#s;#r=0;#n=0;#a=0;#o=0;#l=0;#h=[];#c=[];#d=[];#u=[];#g=[];#m;#E=!1;isOffsetTurnedOff(){return this.#m}set mapRotate(e){this.#l=e}#f(e){this.#h.push([e.x1,e.y1,e.x2,e.y2])}_addBoundariesArray(e){this.#h.push(...e)}_addEllipseBoundaries(e){this.#c.push(...e)}_addPointBoundaries(e){this.#d.push(...e)}_clearBoundaries(){this.#h=[],this.#c=[],this.#d=[]}_setWorldDimensions(e,t){this.#e=e,this.#t=t}_setCanvasDimensions(e,t){this.#i=e,this.#s=t}_setMapBoundaries(){const[e,t]=[this.#e,this.#t],[i,s]=[this.#r,this.#n],r=e-i,n=t-s;e&&t||R(m,"Can't set map boundaries."),this.#f({x1:0,y1:0,x2:r,y2:0}),this.#f({x1:r,y1:0,x2:r,y2:n}),this.#f({x1:r,y1:n,x2:0,y2:n}),this.#f({x1:0,y1:n,x2:0,y2:0})}_setWholeWorldMapBoundaries(){const[e,t]=[this.#e,this.#t];e&&t||R(m,"Can't set map boundaries."),this.#u.push([0,0,e,0]),this.#u.push([e,0,e,t]),this.#u.push([e,t,0,t]),this.#u.push([0,t,0,0])}_mergeBoundaries(e=!1){const t=e?this.getWholeWorldBoundaries():this.getBoundaries(),i=new Set(t);for(const e of i.values()){const t=e[0],s=e[1],r=e[2],n=e[3];for(const a of i.values()){const o=a[0],l=a[1],h=a[2],c=a[3];t===h&&s===c&&r===o&&n===l&&(i.delete(e),i.delete(a)),r!==o||n!==l||t!==h&&s!==c||(a[0]=t,a[1]=s,i.delete(e))}}e?this.#h=Array.from(i):this.#u=Array.from(i),i.clear()}_setWholeMapBoundaries(e){this.#u.push(...e)}_enableMapBoundaries(){this.#E=!0}getBoundaries(){return this.#h}getEllipseBoundaries(){return this.#c}getPointBoundaries(){return this.#d}getWholeWorldBoundaries(){return this.#u}get isWorldBoundariesEnabled(){return this.#E}get canvasDimensions(){return[this.#i,this.#s]}get worldDimensions(){return[this.#e,this.#t]}get worldOffset(){return[this.#r,this.#n]}get mapCenter(){return[this.#a,this.#o]}get mapRotate(){return this.#l}centerCameraPosition=(e,t)=>{let[i,s]=this.worldOffset;const[r,n]=this.canvasDimensions,[a,o]=this.worldDimensions,l=r/2,h=n/2,c=h-s;if(l-i<e)if(e<a-l){const t=e-l;t>=0&&(this.#r=Math.round(t))}else if(a>r){const e=a-r;this.#r=Math.round(e)}if(c<t)if(t<o-h){const e=t-h;e>=0&&(this.#n=Math.round(e))}else if(o>n){const e=o-n;this.#n=Math.round(e)}this.#a=e,this.#o=t};personRotatedCenterCamera=(e,t,i)=>{console.log("new centering algorithm")};get renderObjects(){return this.#g}getObjectsByInstance(e){return this.#g.filter((t=>t instanceof e))}_sortRenderObjectsBySortIndex(){this.#g=this.#g.sort(((e,t)=>e.sortIndex-t.sortIndex))}set _renderObject(e){this.#g.push(e)}set _renderObjects(e){this.#g=e}}const x={loadstart:"loadstart",progress:"progress",abort:"abort",error:"error",load:"load",timeout:"timeout"},y={RECURSION_ERROR:"Too much recursion. Stop iteration.",ATLAS_IMAGE_LOADING_FAILED:"Can't load atlas image ",TILESET_LOADING_FAILED:"Can't load related tileset ",TILEMAP_LOADING_FAILED:"Can't load tilemap ",AUDIO_LOADING_FAILED:"Can't load audio ",NOT_CORRECT_METHOD_TYPE:"uploadMethod should be instance of Promise and return upload result value",XML_FORMAT_INCORRECT:" XML format is not correct.",XML_FILE_EXTENSION_INCORRECT:"Only xml files are supported",TILESET_FILE_EXTENSION_INCORRECT:"Related Tileset file extension is not correct, only .tsj or .json files are supported",TILEMAP_FILE_EXTENSION_INCORRECT:"Tilemap file extension is not correct, only .tmj or .json files are supported",INPUT_PARAMS_ARE_INCORRECT:"fileKey and url should be provided"};class I{#_;#T;#A=new Map;#p=new Map;constructor(e,t){this.#_=e,this.#T=(e,i,...s)=>{const r=t(e,i,...s);if(r instanceof Promise)return r.then((t=>this.#R(t,e)));throw new TypeError(y.NOT_CORRECT_METHOD_TYPE)}}#R=(e,t)=>new Promise(((i,s)=>{e&&0!==e.length||O("uploadMethod for "+this.#_+" should return Promise with upload value"),this.#S(t,e),this.#x(t),i()}));#S(e,t){this.#p.set(e,t)}#x(e){this.#A.delete(e)}get filesWaitingForUpload(){return this.#A.size}get loadingQueue(){return this.#A}get uploadMethod(){return this.#T}_addFile=(e,t)=>{this.#A.has(e)&&O("File "+this.#_+" with key "+e+" is already added"),this.#A.set(e,t)};_isFileInQueue=e=>this.#A.has(e);_getFile=e=>this.#p.get(e)}class v{#y=5;#I=new EventTarget;#v=new Map;#w=0;constructor(){this.registerLoader("Audio",this._loadAudio),this.registerLoader("Image",this._loadImage),this.registerLoader("TileMap",this._loadTileMap),this.registerLoader("TileSet",this._loadTileSet),this.registerLoader("AtlasImageMap",this._loadAtlasImage),this.registerLoader("AtlasXML",this._loadAtlasXml)}get filesWaitingForUpload(){let e=0;return Array.from(this.#v.values()).map((t=>e+=t.filesWaitingForUpload)),e}registerLoader=(e,t=this._defaultUploadMethod)=>{this["add"+e]=(t,i,...s)=>{this.addFile(e,t,i,...s)},this["get"+e]=t=>this.getFile(e,t),this["is"+e+["InQueue"]]=t=>this.isFileInQueue(e,t);const i=this.#v.get(e)||new I(e,t);this.#v.set(e,i)};preload(){return this.#O(),new Promise((async(e,t)=>{this.#b().then((()=>{this.#C(),e()})).catch((e=>{t(e)}))}))}#b(e=0){return this.#P().then((t=>0===this.filesWaitingForUpload?Promise.resolve(t):++e>this.#y?Promise.reject(new Error(y.RECURSION_ERROR)):this.#b(e))).catch((e=>Promise.reject(e)))}#P(){return new Promise(((e,t)=>{let i=[];Array.from(this.#v.values()).forEach((e=>{Array.from(e.loadingQueue.entries()).forEach((t=>{const s=new Promise(((i,s)=>e.uploadMethod(t[0],...t[1]).then((e=>i(e)))));i.push(s)}))})),Promise.allSettled(i).then((i=>{for(const s of i){if("rejected"===s.status){const e=s.reason;this.#M(e)?t(e):(O(e),this.#D(e))}e(i)}}))}))}addEventListener(e,t,...i){x[e]?this.#I.addEventListener(e,t,...i):O("Event type should be one of the ProgressEvent.type")}removeEventListener(e,t,...i){this.#I.removeEventListener(e,t,...i)}_loadAtlasXml=(e,t)=>(this.#L(t),fetch(t).then((e=>e.text())).then((e=>(new window.DOMParser).parseFromString(e,"text/xml"))).then((i=>{const s=i.documentElement||i.activeElement,r=s.attributes.getNamedItem("imagePath"),n=s.children;if(r){const i=this.#N(t);return this.addAtlasImageMap(e,i+r.value,n,i),Promise.resolve(s)}{const t=new Error(e+y.XML_FORMAT_INCORRECT);return Promise.reject(t)}})));_loadAtlasImage=(e,t,i,s="anonymous")=>new Promise(((e,r)=>{const n=new Image,a=new Map,o=document.createElement("canvas"),l=o.getContext("2d");n.crossOrigin=s,n.onload=()=>{const t=[];let s=[];o.width=n.width,o.height=n.height,l.drawImage(n,0,0);for(let e of i){const i=e.attributes,r=i.getNamedItem("name").value,n=r.includes(".")?r.split(".")[0]:r,a=i.getNamedItem("x").value,o=i.getNamedItem("y").value,h=i.getNamedItem("width").value,c=i.getNamedItem("height").value;t.push(createImageBitmap(l.getImageData(a,o,h,c),{premultiplyAlpha:"premultiply"})),s.push(n)}this.#B(),Promise.all(t).then((t=>{t.forEach(((e,t)=>{const i=s[t];a.set(i,e),this.addImage(i,"empty url",e)})),o.remove(),e(a)}))},n.onerror=()=>{const e=new Error(y.ATLAS_IMAGE_LOADING_FAILED+t);this.#D(e),r(e)},n.src=t}));_loadTileSet=(e,t,i=1,s)=>(this.#W(t),fetch(s?s+t:t).then((e=>e.json())).then((e=>{const{name:t,image:r,spacing:n,margin:a,tilewidth:o,tileheight:l}=e;return t&&r&&!this.isFileInQueue("Image",t)&&this.addImage(t,s?s+r:r),e.gid=i,Promise.resolve(e)})).catch((()=>{const e=new Error(y.TILESET_LOADING_FAILED+t);return Promise.reject(e)})));_defaultUploadMethod=(e,t)=>fetch(t);_loadTileMap=(e,t,i=!0)=>(this.#G(t),fetch(t).then((e=>e.json())).then((e=>{const s=this.#N(t);if(!0===i&&e.tilesets&&e.tilesets.length>0){const t=[];return e.tilesets.forEach(((e,i)=>{const{firstgid:r,source:n}=e,a=this._loadTileSet("default-"+r,n,r,s).then((e=>(this.#B(),Promise.resolve(e))));t.push(a)})),Promise.all(t).then((t=>{for(let i=0;i<t.length;i++){const s=t[i];e.tilesets[i].data=s}return Promise.resolve(e)}))}return Promise.resolve(e)})).catch((e=>(e.message.includes("JSON.parse:")&&(e=new Error(y.TILEMAP_LOADING_FAILED+t)),this.#D(e),Promise.reject(e)))));_loadAudio=(e,t)=>new Promise(((e,i)=>{const s=new Audio(t);s.addEventListener("loadeddata",(()=>{this.#B(),e(s)})),s.addEventListener("error",(()=>{const e=new Error(y.AUDIO_LOADING_FAILED+t);this.#D(e),i(e)}))}));_loadImage=(e,t,i,s="anonymous")=>new Promise(((e,r)=>{if(i)e(i);else{const i=new Image;i.crossOrigin=s,i.onload=()=>{createImageBitmap(i,{premultiplyAlpha:"premultiply"}).then((t=>{this.#B(),e(t)}))},i.onerror=()=>{const e=new Error(y.IMAGE_LOADING_FAILED+t);this.#D(e),r(e)},i.src=t}}));#L(e){e.includes(".xml")||w(y.XML_FILE_EXTENSION_INCORRECT)}#W(e){e.includes(".tsj")||e.includes(".json")||w(y.TILESET_FILE_EXTENSION_INCORRECT)}#G(e){e.includes(".tmj")||e.includes(".json")||w(y.TILEMAP_FILE_EXTENSION_INCORRECT)}#M(e){return e.message.includes(y.NOT_CORRECT_METHOD_TYPE)}#N(e){let t=e.split("/"),i=t.length,s="/";return t[i-1].includes(".tmj")||t[i-1].includes(".xml")||t[i-1].includes(".json")?(t.pop(),s=t.join("/")+"/"):(t[i-2].includes(".tmj")||t[i-2].includes(".xml")||t[i-2].includes(".json"))&&(t.splice(i-2,2),s=t.join("/")+"/"),s}addFile(e,t,i,...s){const r=this.#v.get(e);r?(this.#F(t,i),r._addFile(t,[i,...s])):w("Loader for "+e+" is not registered!")}isFileInQueue(e,t){const i=this.#v.get(e);if(i)return i._isFileInQueue(t);w("Loader for "+e+" is not registered!")}getFile(e,t){const i=this.#v.get(e);if(i)return i._getFile(t);w("Loader for "+e+" is not registered!")}#F(e,t){const i=y.INPUT_PARAMS_ARE_INCORRECT;e&&0!==e.trim().length||w(i),t&&0!==t.trim().length||w(i)}#O(){let e=this.filesWaitingForUpload;this.#I.dispatchEvent(new ProgressEvent(x.loadstart,{total:e}))}#C(){this.#I.dispatchEvent(new ProgressEvent(x.load))}#B(){const e=this.filesWaitingForUpload;this.#w+=1,this.#I.dispatchEvent(new ProgressEvent(x.progress,{lengthComputable:!0,loaded:this.#w,total:e}))}#D(e){this.#I.dispatchEvent(new ProgressEvent(x.error,{error:e}))}}function w(e){throw new Error(e)}function O(e){console.warn(e)}class b{#k;#U;#j;#V;#Y;#X=0;#z=0;#H=fe();#K=!1;#q;#Z;#m=!1;#J=!1;constructor(e,t,i,s){this.#k=t,this.#U=i,this.#j=s,this.#V=e}get bgColor(){return this.#j}set bgColor(e){this.#j=e}get type(){return this.#V}get x(){return this.#k}get y(){return this.#U}set x(e){this.#k=e}set y(e){this.#U=e}get sortIndex(){return this.#X}set sortIndex(e){this.#X=e}get blendFunc(){return this.#Y}set blendFunc(e){this.#Y=e}get rotation(){return this.#z}set rotation(e){this.#z=e}get id(){return this.#H}get isRemoved(){return this.#K}destroy(){this.#K=!0}get isMaskAttached(){return!!this.#q}get _maskId(){return this.#q}setMask(e){e._isMask=!0,this.#q=e.id}removeMask(){this.#q=null}set _isMask(e){this.#Z=e}get _isMask(){return this.#Z}get isOffsetTurnedOff(){return this.#m}turnOffOffset(){this.#m=!0}_calculateRectVertices=(e,t)=>{const i=e/2,s=t/2;return[[-i,-s],[i,-s],[i,s],[-i,s]]};_interpolateConus(e,t=2*Math.PI,i=Math.PI/14){let s=[0,0];for(let r=0;r<=t;r+=i){let t=Math.cos(r)*e,i=Math.sin(r)*e;s.push(t,i)}return s}_calculateConusBoundaries(e,t=2*Math.PI,i=Math.PI/14){let s=[];for(let r=0;r<=t;r+=i){let t=Math.cos(r)*e,i=Math.sin(r)*e;s.push([t,i])}return s}_convertVerticesArray(e){return void 0!==e[0].x&&void 0!==e[0].y?_e(e):e}}class C extends b{#Q;#w;#$;constructor(e,t,i,s,r){super(l.DRAW_TYPE.RECTANGLE,e,t,r),this.#Q=i,this.#w=s,this.#$=this._calculateRectVertices(i,s)}get vertices(){return this.#$}get width(){return this.#Q}get height(){return this.#w}set width(e){this.#Q=e}set height(e){this.#w=e}}class P{#k;#U;constructor(e,t){this.#k=e,this.#U=t}get x(){return this.#k}get y(){return this.#U}}class M{#k;#U;#Q;#w;constructor(e,t,i,s){this.#k=e,this.#U=t,this.#Q=i,this.#w=s}get x(){return this.#k}get y(){return this.#U}get width(){return this.#Q}get height(){return this.#w}}class D{#k;#U;constructor(e,t,i,s){this.#k=i-e,this.#U=s-t}get x(){return this.#k}get y(){return this.#U}get length(){return Math.sqrt(Math.pow(this.#k,2)+Math.pow(this.#U,2))}get tetaAngle(){return Math.atan2(this.#U,this.#k)}}class L extends b{#ee;#te;#ie;#se;#re;#ne;#ae;#oe=document.createElement("canvas");#le;constructor(e,t,i,s,r){super(l.DRAW_TYPE.TEXT,e,t),this.#ne=i,this.#ee=s,this.#se=r,this.#ae,this.#he()}get boundariesBox(){const e=this.textMetrics?Math.floor(this.textMetrics.width):300,t=this.textMetrics?Math.floor(this.textMetrics.fontBoundingBoxAscent+this.textMetrics.fontBoundingBoxDescent):30;return new M(this.x,this.y-t,e,t)}get vertices(){const e=this.boundariesBox;return this._calculateRectVertices(e.width,e.height)}get text(){return this.#ne}set text(e){e!==this.#ne&&(this.#ne=e,this.#he())}get font(){return this.#ee}set font(e){e!==this.#ee&&(this.#ee=e,this.#he())}get textAlign(){return this.#te}set textAlign(e){e!==this.#te&&(this.#te=e,this.#he())}get textBaseline(){return this.#ie}set textBaseline(e){e!==this.#ie&&(this.#ie=e,this.#he())}get fillStyle(){return this.#se}set fillStyle(e){e!==this.#se&&(this.#se=e,this.#he())}get strokeStyle(){return this.#re}set strokeStyle(e){e!==this.#re&&(this.#re=e,this.#he())}get textMetrics(){return this.#ae}set _textMetrics(e){this.#ae=e}get _textureStorage(){return this.#le}set _textureStorage(e){this.#le=e}get _textureCanvas(){return this.#oe}#he(){const e=this.#oe.getContext("2d",{willReadFrequently:!0});if(e){e.font=this.font,this._textMetrics=e.measureText(this.text);const t=this.boundariesBox.width,i=this.boundariesBox.height;e.canvas.width=t,e.canvas.height=i,e.clearRect(0,0,t,i),e.font=this.font,e.textBaseline="bottom",this.fillStyle&&(e.fillStyle=this.fillStyle,e.fillText(this.text,0,i)),this.strokeStyle&&(e.strokeStyle=this.strokeStyle,e.strokeText(this.text,0,i)),this.#le&&(this.#le._isTextureRecalculated=!0)}else p("UNHANDLED_EXCEPTION","can't getContext('2d')")}}class N extends b{#ce;#de;#$;#ue;constructor(e,t,i,s,r,n=0){super(l.DRAW_TYPE.CONUS,e,t,s),this.#ce=i,this.#de=r,this.#ue=n,this.#$=this._interpolateConus(i,r)}get vertices(){return this.#$}set vertices(e){this.#$=e}get radius(){return this.#ce}get angle(){return this.#de}get fade_min(){return this.#ue}set fade_min(e){this.#ue=e}}class B{#ge;#me=100;#Ee;#fe;#_e;#Te;#Ae;constructor(e,t,i=!1,s,r=!1){this.#ge=e,this.#Ee=this.#pe(t),this.#fe=s||0,this.#_e=r,this.#Te=i}get name(){return this.#ge}get isActive(){return this.#_e}get currentSprite(){return this.#Ee[this.#fe][0]}get _isLastSprite(){return this.#Ee.length-1===this.#fe}iterateAnimationIndex(){const e=this.#fe;this.#Ee[e][1]<Date.now()-this.#Ae&&(this._isLastSprite?this.#Te?this.#fe=0:this.deactivateAnimation():this.#fe++,this.#Ae=Date.now())}activateAnimation=()=>{this.#_e=!0,this.#fe=0,this.#Ae=Date.now()};deactivateAnimation=()=>{this.#_e=!1};#pe(e){let t=[];return e.forEach((e=>{"number"==typeof e.id&&"number"==typeof e.duration?t.push([e.id,e.duration]):t.push([e,this.#me])})),t}}class W extends b{#Q;#w;#Re;#Se;#xe;#ye;#Ie;#ve=0;#$;#we;#le;constructor(e,t,i,s,r,n=0,a,o,h=0){super(l.DRAW_TYPE.IMAGE,e,t),this.#Re=r,this.#xe=new EventTarget,this.#ye=new Map,this.image=o,this.#Ie=n,this.#ve=h,this.#Q=i,this.#w=s,this.#$=a&&!a.r?this._convertVerticesArray(a):a&&a.r?this._calculateConusBoundaries(a.r):this._calculateRectVertices(i,s),this.#we=a&&void 0!==a.r?a:null}get width(){return this.#Q}get height(){return this.#w}set width(e){this.#Q=e}set height(e){this.#w=e}get key(){return this.#Re}get image(){return this.#Se}set image(e){this.#le&&(this.#le._isTextureRecalculated=!0),this.#Se=e}get imageIndex(){return this.#Ie}set imageIndex(e){this.#Ie=e}get spacing(){return this.#ve}get hasAnimations(){return this.#ye.size>0}get boundaries(){return this.#$}get vertices(){return this.#$}get circleBoundaries(){return this.#we}_processActiveAnimations(){for(let e of this.#ye.values())e.isActive&&(e.iterateAnimationIndex(),this.#Ie=e.currentSprite)}get _textureStorage(){return this.#le}set _textureStorage(e){this.#le=e}emit(e,...t){const i=new Event(e);i.data=[...t],this.#xe.dispatchEvent(i)}addEventListener(e,t,i){this.#xe.addEventListener(e,t,i)}removeEventListener(e,t,i){this.#xe.removeEventListener(e,t,i)}addAnimation(e,t,i){this.#Oe(t)||p(d," animationSpriteIndexes should be Array of indexes, or Array of objects {duration:number, id:number}");const s=new B(e,t,i);this.#ye.set(e,s),this.addEventListener(e,this.#be)}#Oe(e){let t=!0;return e.forEach((e=>{"number"!=typeof e&&("number"==typeof e.duration&&"number"==typeof e.id||(t=!1))})),t}#be=e=>{const t=this.#ye.get(e.type);t.activateAnimation(),this.#Ie=t.currentSprite};stopRepeatedAnimation(e){this.#ye.get(e).deactivateAnimation()}removeAllAnimations(){for(let[e,t]of this.#ye.entries())this.removeEventListener(e,t.activateAnimation),t.deactivateAnimation();this.#ye.clear(),this.#ye=void 0}destroy(){this.removeAllAnimations(),super.destroy()}}class G extends b{#$;constructor(e,t){super(l.DRAW_TYPE.LINE,e[0][0],e[0][1],t),this.#$=e}get vertices(){return this.#$}set vertices(e){this.#$=e}}class F extends b{#$;constructor(e,t){super(l.DRAW_TYPE.POLYGON,e[0].x,e[0].y,t),this.#$=this._convertVerticesArray(e)}get vertices(){return this.#$}set vertices(e){this.#$=e}}class k extends b{#ce;#$;constructor(e,t,i,s){super(l.DRAW_TYPE.CIRCLE,e,t,s),this.#ce=i,this.#$=this._interpolateConus(i)}get vertices(){return this.#$}set vertices(e){this.#$=e}get radius(){return this.#ce}}class U{#Ce;#Pe;#Me;#De;#Le="-#-";#Ne;#Be;#We;#Ge;#Fe;#q;#X=0;#ye=new Map;#m;constructor(e,t,i,s,r,n,a=!1,o){this.#Ce=e,this.#Pe=t,this.#Me=i,this.#De=s,this.#Be=[],this.#Ne=r,this.#We=n,this.#Ge=a,this.#Fe=a||!1,o&&this.setMask(o),this.#ke(s)}get layerKey(){return this.#Ce}get tileMapKey(){return this.#Pe}get tilemap(){return this.#Me}get tilesets(){return this.#De}get tilesetImages(){return this.#Ne}get layerData(){return this.#We}get setBoundaries(){return this.#Ge}get drawBoundaries(){return this.#Fe}set drawBoundaries(e){this.#Fe=e}get _maskId(){return this.#q}setMask(e){e._isMask=!0,this.#q=e.id}removeMask(){this.#q=null}get sortIndex(){return this.#X}set sortIndex(e){this.#X=e}get isOffsetTurnedOff(){return this.#m}turnOffOffset(){this.#m=!0}get hasAnimations(){return this.#ye.size>0}get _textureStorages(){return this.#Be}_setTextureStorage(e,t){this.#Be[e]=t}#ke(e){for(let t of e){const e=t.data.tiles,i=t.data.name;if(e)for(let s of e){const e=s.animation,r=s.objectgroup,n=s.id;if(e){const s=i+this.#Le+n,r=this.#Ue(e),a=new B(s,r,!0);this.#ye.set(s,a),t.data._hasAnimations||(t.data._hasAnimations=!0,t.data._animations=new Map,t.data._animations.set(n,r[0][0])),this.#be(a)}r&&(t.data._hasBoundaries||(t.data._hasBoundaries=!0,t.data._boundaries=new Map),t.data._boundaries.set(n,r))}}}#Ue(e){return e.map((e=>({duration:e.duration,id:e.tileid})))}_processActiveAnimations(){for(let e of this.#ye.values())e.isActive&&(e.iterateAnimationIndex(),this.#je(e))}#be=e=>{e.activateAnimation(),this.#je(e)};#je=e=>{const[t,i]=e.name.split(this.#Le),s=this.#De.findIndex((e=>e.data.name===t));this.#De[s].data._animations.set(parseInt(i),e.currentSprite)};stopRepeatedAnimation(e){this.#ye.get(e).deactivateAnimation()}removeAllAnimations(){for(let[e,t]of this.#ye.entries())this.removeEventListener(e,t.activateAnimation),t.deactivateAnimation();this.#ye.clear(),this.#ye=void 0}destroy(){this.removeAllAnimations(),super.destroy()}}class j{#Ve;#Ye;constructor(e){this.#Ve=e}get stageData(){return this.#Ye}#Xe(e){return this.#Ye._renderObject=e,this.#Ye._sortRenderObjectsBySortIndex(),e}rect(e,t,i,s,r){const n=new C(e,t,i,s,r);return this.#Xe(n),n}text(e,t,i,s,r){const n=new L(e,t,i,s,r);return this.#Xe(n),n}conus(e,t,i,s,r,n=0){const a=new N(e,t,i,s,r,n);return this.#Xe(a),a}circle(e,t,i,s){const r=new k(e,t,i,s);return this.#Xe(r),r}image(e,t,i,s,r,n=0,a,o=0){const l=this.#Ve.getImage(r),h=new W(e,t,i,s,r,n,a,l,o);return this.#Xe(h),h}line(e,t){const i=new G(e,t);return this.#Xe(i),i}polygon(e,t){const i=new F(e,t);return this.#Xe(i),i}tiledLayer(e,t,i,s){const r=this.#Ve.getTileMap(t),n=r.tilesets,a=n.map((e=>this.#Ve.getImage(e.data.name))),o=r.layers.find((t=>t.name===e)),l=new U(e,t,r,n,a,o,i,s);return this.#Xe(l),l}_registerNewObjectMethod=(e,t)=>{this[e]=(...e)=>this.#ze(t,...e)};#ze=(e,...t)=>{const i=e(...t);return this.#Xe(i),i};_attachPageData=e=>{this.#Ye=e};_detachPageData=()=>{this.#Ye=null}}class V{constructor(){}static mode=l.MODE.DEBUG;static gameOptions={library:l.LIBRARY.WEBGL,optimization:l.OPTIMIZATION.NATIVE_JS.OPTIMIZED,optimizationWASMUrl:"/src/wa/calculateBufferDataWat.wasm",optimizationAssemblyUrl:"/src/wa/calculateBufferDataAssembly.wasm",loadingScreen:{backgroundColor:"rgba(128, 128, 128, 0.6)",loadingBarBg:"rgba(128, 128, 128, 1)",loadingBarProgress:"rgba(128, 128, 128, 0.2)"},render:{minCycleTime:16.666,cyclesTimeCalc:{check:l.OPTIMIZATION.CYCLE_TIME_CALC.AVERAGES,averageFPStime:1e4},boundaries:{mapBoundariesEnabled:!0,realtimeCalculations:!0,wholeWorldPrecalculations:!1}},debug:{checkWebGlErrors:!1,debugMobileTouch:!1,boundaries:{drawLayerBoundaries:!1,drawObjectBoundaries:!1,boundariesColor:"rgba(224, 12, 21, 0.6)",boundariesWidth:2},delayBetweenObjectRender:!1}};static network={address:"https://gameserver.reslc.ru:9009",gatherRoomsInfoInterval:5e3};static canvasMaxSize={width:1800,height:1800};static worldSize={width:960,height:960};static defaultCanvasKey="default"}class Y{static debug(...e){V.mode===l.MODE.DEBUG&&e.forEach((e=>console.log(e)))}}class X extends Event{#He;constructor(e,t){super(e),this.#Ke(e)||p("UNEXPECTED_EVENT_NAME",", Please check if event is exist"),this.#He=t}#Ke(e){return Object.values(l.EVENTS.WEBSOCKET.SERVER_CLIENT).find((t=>t===e))}get data(){return this.#He}}class z extends EventTarget{#qe;#Ze;constructor(e){super(),e||p(h,"systemSettings should be passed to class instance"),this.#qe=e}init(){r.e(992).then(r.bind(r,992)).then((e=>{this.#Ze=e.io(this.#qe.network.address,{withCredentials:!0}),this.#Je()}))}get isServerConnected(){return!(!this.#Ze||!this.#Ze.connected)}get playerId(){return this.#Ze.id}sendGatherRoomsInfo(){this.#Ze.emit(l.EVENTS.WEBSOCKET.CLIENT_SERVER.ROOMS_INFO_REQUEST)}sendCreateOrJoinRoom(e,t){this.#Ze.emit(l.EVENTS.WEBSOCKET.CLIENT_SERVER.CREATE_OR_JOIN,e,t)}sendMessage(e){this.#Ze.emit(l.EVENTS.WEBSOCKET.CLIENT_SERVER.CLIENT_MESSAGE,e)}#Qe=()=>{Y.debug("connected, socket id: "+this.#Ze.id),this.dispatchEvent(new Event(l.EVENTS.WEBSOCKET.SERVER_CLIENT.CONNECTION_STATUS_CHANGED))};#$e=e=>{Y.debug("server disconnected, reason: "+e),this.dispatchEvent(new Event(l.EVENTS.WEBSOCKET.SERVER_CLIENT.CONNECTION_STATUS_CHANGED))};#et=e=>{console.warn("server data: ",e)};#tt=e=>{Y.debug("received new message from server: "+e),this.dispatchEvent(new X(l.EVENTS.WEBSOCKET.SERVER_CLIENT.SERVER_MESSAGE,e))};#it=e=>{Y.debug("received roomsInfo "+e),this.dispatchEvent(new X(l.EVENTS.WEBSOCKET.SERVER_CLIENT.ROOMS_INFO,e))};#st=(e,t)=>{Y.debug("CLIENT SOCKET: Created room  "+e),this.dispatchEvent(new X(l.EVENTS.WEBSOCKET.SERVER_CLIENT.CREATED,{room:e,map:t}))};#rt=e=>{Y.debug("CLIENT SOCKET: Room is full, can't join: "+e),this.dispatchEvent(new X(l.EVENTS.WEBSOCKET.SERVER_CLIENT.FULL,{room:e}))};#nt=(e,t)=>{Y.debug("CLIENT SOCKET: Joined to room: "+e,", map: ",t),this.dispatchEvent(new X(l.EVENTS.WEBSOCKET.SERVER_CLIENT.JOINED,{room:e,map:t}))};#at=e=>{this.dispatchEvent(new X(l.EVENTS.WEBSOCKET.SERVER_CLIENT.DISCONNECTED,{playerId:e}))};#Je(){this.#Ze.on("connect",this.#Qe),this.#Ze.on("disconnect",this.#$e),this.#Ze.on("data",this.#et),this.#Ze.on("roomsInfo",this.#it),this.#Ze.on("created",this.#st),this.#Ze.on("full",this.#rt),this.#Ze.on("joined",this.#nt),this.#Ze.on("log",(function(e){console.log.apply(console,e)})),this.#Ze.on("message",this.#tt),this.#Ze.on("removed",(function(e){console.log("removed message"),console.log(e)})),this.#Ze.on("disconnected",this.#at),addEventListener("beforeunload",this.#ot)}#ot=()=>{this.#Ze.disconnect()}}class H{#lt=.5;#ht=new Map;#ct;constructor(e){this.#ct=e}getAudio=e=>{const t=this.#ht.get(e);return null===t?(R(T,"Audio with key "+e+" exists, but not actually loaded"),t):t||(R(_,""),null)};getAudioCloned=e=>{const t=this.#ht.get(e);if(null===t)return R(T,"Audio with key "+e+" exists, but not actually loaded"),t;if(t){const e=t.cloneNode();return e.volume=this.#lt,e}return R(_),null};set volume(e){this.#lt=e,this.#dt(e)}get volume(){return this.#lt}#dt(e){for(const t of this.#ht.values())t&&(t.volume=e)}registerAudio(e){let t=this.#ct.getAudio(e);this.#ht.set(e,t)}}function K(){return/Android|webOS|iPhone|iPad|iPod|Opera Mini/i.test(navigator.userAgent)}function q(){return/^((?!chrome|android).)*safari/i.test(navigator.userAgent)}function Z(e,t,i){return new D(e,t,i.x,i.y).length-i.r}function J(e,t){const i=t.x1,s=t.y1,r=t.x2,n=t.y2,a=e.x1,o=e.y1,l=i,h=s,c=r-i,d=n-s,u=a,g=o,m=e.x2-a,E=e.y2-o,f=Math.sqrt(c*c+d*d),_=Math.sqrt(m*m+E*E);if(c/f==m/_&&d/f==E/_)return null;const T=(c*(g-h)+d*(l-u))/(m*d-E*c),A=(u+m*T-l)/c;return A<0||isNaN(A)||T<0||T>1?null:{x:l+c*A,y:h+d*A,p:A}}function Q(e,t){const i=t.x1,s=t.y1,r=t.x2,n=t.y2,a=e.x1,o=e.y1,l=e.x2,h=e.y2,c=(i-r)*(o-h)-(s-n)*(a-l);if(0===c)return;let d=((i*n-s*r)*(a-l)-(i-r)*(a*h-o*l))/c,u=((i*n-s*r)*(o-h)-(s-n)*(a*h-o*l))/c;const g={x:d,y:u};return re(g,e,1e-13)&&re(g,t,1e-13)?{x:d,y:u,p:Math.sqrt(Math.pow(d-i,2)+Math.pow(u-s,2))}:void 0}function $(e,t,i,s){return Math.atan2(s-t,i-e)}function ee(e,t,i){const s=e.x-t.x,r=i.x-t.x,n=e.y-t.y,a=i.y-t.y,o=Math.sqrt(s*s+n*n),l=Math.sqrt(r*r+a*a);return Math.acos((s*r+n*a)/(o*l))}function te(e,t,i){return e*t*Math.cos(i)}function ie(e,t){return e.x*t.x+e.y*t.y}function se(e,t){return e.x*t.y-t.x*e.y}function re(e,t,i=0){return(e.x>=t.x1-i&&e.x<=t.x2+i||e.x<=t.x1+i&&e.x>=t.x2-i)&&(e.y>=t.y1-i&&e.y<=t.y2+i||e.y<=t.y1+i&&e.y>=t.y2-i)}function ne(e,t){return new D(e.x,e.y,t.x,t.y).length}function ae(e,t){return new D(e.x1,e.y1,e.x2,e.y2).length<new D(t.x1,t.y1,t.x2,t.y2).length}function oe(e,t){const i=new D(t.x1,t.y1,t.x2,t.y2).length;return new D(t.x1,t.y1,e.x,e.y).length+new D(t.x2,t.y2,e.x,e.y).length<=i+.2}function le(e,t){const i=e.length;for(let s=0;s<i;s+=1){let i=e[s],r=e[s+1];if(!r){if(i[0]===e[0][0]&&i[1]===e[0][1])continue;r=e[0]}const n=Q({x1:i[0],y1:i[1],x2:r[0],y2:r[1]},t);if(n)return n}if(e[i-1][0]!==e[0][0]&&e[i-1][1]!==e[0][1]){const s=e[i-1],r=e[0],n=Q({x1:s[0],y1:s[1],x2:r[0],y2:r[1]},t);if(n)return n}return null}function he(e,t,i){const s=i.length;for(let r=0;r<s;r+=1){let s=i[r],n=i[r+1];if(n||(n=i[0]),oe({x:e,y:t},{x1:s[0],y1:s[1],x2:n[0],y2:n[1]}))return!0}return!1}function ce(e,t,i){return e>=i.x&&e<=i.width+i.x&&t>=i.y&&t<=i.y+i.height}function de(e,t,i){const s=i.r;return new D(e,t,i.x,i.y).length<s}function ue(e,t,i,s){const r=s.x1,n=s.y1,a=s.x2,o=s.y2,l={x:r-e,y:n-t},h={x:a-e,y:o-t},c={x:a-r,y:o-n},d={x:r-a,y:n-o},u=Math.sqrt(Math.pow(c.x,2)+Math.pow(c.y,2)),g=ie(l,d),m=ie(h,c);let E;return g>0&&m>0?(E=se(l,h)/u,E<0&&(E*=-1)):E=Math.min(l.length,h.length),E<=i}function ge(e,t){const i=e[0],s=e[1],r=e[2],n=e[3],a={x:i-t[0][0],y:s-t[0][1]},o={x:i-t[1][0],y:s-t[1][1]},l=Math.sqrt(Math.pow(a.x,2)+Math.pow(a.y,2)),h=Math.sqrt(Math.pow(o.x,2)+Math.pow(o.y,2)),c=Math.min(l,h);if(c>Math.max(r,n))return!1;const d=c===l?a:o,u=Math.atan2(d.y,d.x),g={x:0-Math.cos(u)*r,y:0-Math.sin(u)*n};return!(c>Math.sqrt(Math.pow(g.x,2)+Math.pow(g.y,2)))}function me(e,t){const i=e[0],s=e[1],r={x:i-t.x,y:s-t.y},n=Math.sqrt(Math.pow(r.x,2)+Math.pow(r.y,2));if(n>Math.max(e[2],e[3])+t.r)return!1;{const r=$(i,s,t.x,t.y),a=i-(i+e[2]*Math.cos(r)),o=s-(s+e[3]*Math.sin(r));return n<=Math.sqrt(Math.pow(a,2)+Math.pow(o,2))+t.r&&{x:a,y:o,p:1}}}function Ee(e,t){const i=t.length;for(let s=0;s<i;s+=1){let i=t[s],r=t[s+1];if(r||(r=t[0]),ge(e,[i,r]))return!0}return!1}function fe(){return Math.round(1e6*Math.random())}function _e(e){const t=e.length,i=[];for(let s=0;s<t;s++){const t=e[s];i.push([t.x,t.y])}return i}function Te(e=0,t=0,i,s,r=2*Math.PI,n=Math.PI/8){let a=[];for(let o=0;o<=r;o+=n){let r=Math.cos(o)*i+e,n=Math.sin(o)*s+t;a.push([r,n])}return a}class Ae{#ut;#gt;#mt=!0;constructor(e,t=0){this.#gt=e,this.#ut=t}get _isTextureRecalculated(){return this.#mt}set _isTextureRecalculated(e){this.#mt=e}get _texture(){return this.#gt}set _texture(e){this.#gt=e}get _textureIndex(){return this.#ut}}class pe{#Et;#ft;#_t;#Tt;#At;#pt;#Rt=new Map;#St=new Map;constructor(e,t){e&&e instanceof WebGLRenderingContext||p(d," context parameter should be specified and equal to WebGLRenderingContext"),this.#Et=e,this.#Tt=t,this.#_t=t.debug.checkWebGlErrors,this.#ft=e.getParameter(e.MAX_TEXTURE_IMAGE_UNITS),this.#At=e.createBuffer(),this.#pt=e.createBuffer()}getProgram(e){return this.#Rt.get(e)}getProgramVarLocations(e){return this.#St.get(e)}_fixCanvasSize(e,t){this.#Et.viewport(0,0,e,t)}_initWebGlAttributes=()=>{const e=this.#Et;return e.enable(e.BLEND),e.enable(e.STENCIL_TEST),e.stencilFunc(e.ALWAYS,1,255),e.stencilOp(e.KEEP,e.KEEP,e.REPLACE),Promise.resolve()};_initiateWasm=()=>{const e=this.#Tt.optimization===l.OPTIMIZATION.WEB_ASSEMBLY.NATIVE_WAT?this.#Tt.optimizationWASMUrl:this.#Tt.optimizationAssemblyUrl;return new Promise(((t,i)=>{this.layerData=new WebAssembly.Memory({initial:1e3}),this.layerDataFloat32=new Float32Array(this.layerData.buffer);const s={env:{memory:this.layerData,logi:console.log,logf:console.log}};fetch(e).then((e=>e.arrayBuffer())).then((e=>WebAssembly.instantiate(e,s))).then((e=>{this.calculateBufferData=e.instance.exports.calculateBufferData,t()}))}))};_clearView(){const e=this.#Et;e.clearColor(0,0,0,0),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT|e.STENCIL_BUFFER_BIT)}_render(e,t,i=0){const s=this.#Et,r=this.#_t?s.getError():0;if(0!==r)throw console.error(r),new Error("Error num: "+r);return s.drawArrays(t,i,e),s.stencilFunc(s.ALWAYS,1,255),new Promise(((e,t)=>{this.#Tt.debug.delayBetweenObjectRender?setTimeout((()=>{e()}),1e3):e()}))}_registerAndCompileWebGlProgram(e,t,i,s,r){const n=this.#xt(t,i),a=this.#yt(n,s,r);return this.#Rt.set(e,n),this.#St.set(e,a),Promise.resolve()}#xt(e,t){const i=this.#Et,s=i.createProgram();if(s){const r=this.#It(i,e,i.VERTEX_SHADER);r?i.attachShader(s,r):p(u,"#compileShader(vertexShaderSource) is null");const n=this.#It(i,t,i.FRAGMENT_SHADER);if(n?i.attachShader(s,n):p(u,"#compileShader(fragmentShaderSource) is null"),i.linkProgram(s),!i.getProgramParameter(s,i.LINK_STATUS)){const e=i.getProgramInfoLog(s);p(u,`Could not compile WebGL program. \n\n${e}`)}}else p(u,"gl.createProgram() is null");return s}#yt(e,t,i){const s=this.#Et;let r={};return t.forEach((t=>{r[t]=s.getUniformLocation(e,t)})),i.forEach((t=>{r[t]=s.getAttribLocation(e,t)})),r}#It(e,t,i){const s=e.createShader(i);if(s){if(e.shaderSource(s,t),e.compileShader(s),!e.getShaderParameter(s,e.COMPILE_STATUS)){const t=e.getShaderInfoLog(s);p(u,"Couldn't compile webGl program. \n\n"+t)}}else p(u,`gl.createShader(${i}) is null`);return s}_bindPrimitives=(e,t,i,s,r)=>{const[n,a]=!0===e.isOffsetTurnedOff?[0,0]:i.worldOffset,o=e.x-n,h=e.y-a,c=[1,1],d=e.rotation,u=e.blendFunc?e.blendFunc:[t.SRC_ALPHA,t.ONE_MINUS_SRC_ALPHA],{u_translation:g,u_rotation:m,u_scale:E,u_resolution:f,u_color:_,a_position:T,u_fade_min:p}=r;let S=0;switch(t.useProgram(s),t.uniform2f(f,t.canvas.width,t.canvas.height),t.uniform2f(g,o,h),t.uniform2f(E,c[0],c[1]),t.uniform1f(m,d),t.uniform1f(p,0),t.enableVertexAttribArray(T),t.bindBuffer(t.ARRAY_BUFFER,this.#At),e.type){case l.DRAW_TYPE.RECTANGLE:this.#vt(e.width,e.height),S+=6;break;case l.DRAW_TYPE.TEXT:break;case l.DRAW_TYPE.CIRCLE:{const i=e.vertices;t.bufferData(this.#Et.ARRAY_BUFFER,new Float32Array(i),this.#Et.STATIC_DRAW),S+=i.length/2;break}case l.DRAW_TYPE.POLYGON:{const t=this.#wt(e.vertices);this.#Ot(t);const i=t.length;if(i%3!=0)return R(A,`polygons ${e.id}, vertices are not correct, skip drawing`),Promise.reject();S+=i/2;break}}const x=t.FLOAT;t.vertexAttribPointer(T,2,x,!1,0,0);const y=this.#bt(e.bgColor);return t.uniform4f(_,y[0]/255,y[1]/255,y[2]/255,y[3]),u&&t.blendFunc(u[0],u[1]),e.isMaskAttached?t.stencilFunc(t.EQUAL,e._maskId,255):e._isMask&&t.stencilFunc(t.ALWAYS,e.id,255),Promise.resolve([S,t.TRIANGLES])};_bindConus=(e,t,i,s,r)=>{const[n,a]=!0===e.isOffsetTurnedOff?[0,0]:i.worldOffset,o=e.x-n,l=e.y-a,h=[1,1],c=e.rotation,{u_translation:d,u_rotation:u,u_scale:g,u_resolution:m,u_color:E,a_position:f,u_fade_max:_,u_fade_min:T}=r,A=e.vertices,p=e.bgColor,R=e.fade_min,S=e.radius,x=e.blendFunc?e.blendFunc:[t.SRC_ALPHA,t.ONE_MINUS_SRC_ALPHA];let y=0;t.useProgram(s),t.uniform2f(m,t.canvas.width,t.canvas.height),t.uniform2f(d,o,l),t.uniform2f(g,h[0],h[1]),t.uniform1f(u,c),t.uniform1f(T,R),t.uniform1f(_,S),t.bindBuffer(t.ARRAY_BUFFER,this.#At),t.bufferData(this.#Et.ARRAY_BUFFER,new Float32Array(A),this.#Et.STATIC_DRAW),t.enableVertexAttribArray(f);const I=t.FLOAT;t.vertexAttribPointer(f,2,I,!1,0,0),y+=A.length/2,x&&t.blendFunc(x[0],x[1]);const v=this.#bt(p);return t.uniform4f(E,v[0]/255,v[1]/255,v[2]/255,v[3]),e.isMaskAttached?t.stencilFunc(t.EQUAL,e._maskId,255):e._isMask&&t.stencilFunc(t.ALWAYS,e.id,255),Promise.resolve([y,t.TRIANGLE_FAN])};_bindText=(e,t,i,s,r)=>{const{u_translation:n,u_rotation:a,u_scale:o,u_resolution:l,a_position:h,a_texCoord:c,u_image:d}=r,{width:u,height:g}=e.boundariesBox,[m,E]=(e.text,!0===e.isOffsetTurnedOff?[0,0]:i.worldOffset),f=e.x-m,_=e.y-E-g,T=e.blendFunc?e.blendFunc:[t.ONE,t.ONE_MINUS_SRC_ALPHA],A=[1,1],p=f+u,R=_+g,S=[f,_,p,_,f,R,f,R,p,_,p,R];let x=0;t.useProgram(s),t.uniform2f(l,t.canvas.width,t.canvas.height),t.uniform2f(n,f,_),t.uniform2f(o,A[0],A[1]),t.uniform1f(a,0),t.bindBuffer(t.ARRAY_BUFFER,this.#At),t.bufferData(t.ARRAY_BUFFER,new Float32Array(S),t.STATIC_DRAW),t.enableVertexAttribArray(h);const y=t.FLOAT;t.vertexAttribPointer(h,2,y,!1,0,0),t.bindBuffer(t.ARRAY_BUFFER,this.#pt),t.bufferData(t.ARRAY_BUFFER,new Float32Array([0,0,1,0,0,1,0,1,1,0,1,1]),t.STATIC_DRAW),t.enableVertexAttribArray(c),t.vertexAttribPointer(c,2,t.FLOAT,!1,0,0),x+=6,t.blendFunc(T[0],T[1]);let I=e._textureStorage;return I||(I=new Ae(t.createTexture()),e._textureStorage=I),!0===I._isTextureRecalculated?(this.#Ct(t,I._texture,e._textureCanvas),I._isTextureRecalculated=!1):this.#Pt(t,I._texture),t.uniform1i(d,I._textureIndex),t.depthMask(!1),Promise.resolve([6,t.TRIANGLES])};_bindImage=(e,t,i,s,r)=>{const{u_translation:n,u_rotation:a,u_scale:o,u_resolution:l,a_position:h,a_texCoord:c,u_image:d}=r,[u,g]=!0===e.isOffsetTurnedOff?[0,0]:i.worldOffset,m=e.x-u,E=e.y-g,f=e.image,_=e.imageIndex,T=(e.key,e._maskId),A=e.spacing,p=e.blendFunc?e.blendFunc:[t.ONE,t.ONE_MINUS_SRC_ALPHA],R=[1,1];let S=0,x=0,y=0,I=0,v=0;if(0!==_){const t=(f.width+A)/(e.width+A);y=_%t,I=Math.floor(_/t),S=y*e.width+y*A,x=I*e.height+I*A}const w=m-e.width/2,O=E-e.height/2,b=w+e.width,C=O+e.height,P=1/f.width*S,M=1/f.height*x,D=P+1/f.width*e.width,L=M+1/f.height*e.height,N=[w,O,b,O,w,C,w,C,b,O,b,C],B=[P,M,D,M,P,L,P,L,D,M,D,L];t.useProgram(s),t.uniform2f(l,t.canvas.width,t.canvas.height),t.uniform2f(n,m,E),t.uniform2f(o,R[0],R[1]),t.uniform1f(a,e.rotation),t.bindBuffer(t.ARRAY_BUFFER,this.#At),t.bufferData(t.ARRAY_BUFFER,new Float32Array(N),t.STATIC_DRAW),v+=N.length/2,t.enableVertexAttribArray(h);const W=t.FLOAT;t.vertexAttribPointer(h,2,W,!1,0,0),t.bindBuffer(t.ARRAY_BUFFER,this.#pt),t.bufferData(t.ARRAY_BUFFER,new Float32Array(B),t.STATIC_DRAW),t.enableVertexAttribArray(c),t.vertexAttribPointer(c,2,t.FLOAT,!1,0,0);let G=e._textureStorage;return G||(G=new Ae(t.createTexture()),e._textureStorage=G),!0===G._isTextureRecalculated?(this.#Mt(t,G._texture,e.image),G._isTextureRecalculated=!1):this.#Pt(t,G._texture),t.uniform1i(d,G._textureIndex),t.blendFunc(p[0],p[1]),T&&t.stencilFunc(t.EQUAL,T,255),Promise.resolve([v,t.TRIANGLES])};_bindTileImages=async(e,t,i,s,r)=>{const{u_translation:n,u_rotation:a,u_scale:o,u_resolution:h,a_position:c,a_texCoord:d,u_image:u}=r;let g;switch(t.useProgram(s),this.#Tt.optimization){case l.OPTIMIZATION.NATIVE_JS.NOT_OPTIMIZED:g=await this.#Dt(e,i);break;case l.OPTIMIZATION.WEB_ASSEMBLY.ASSEMBLY_SCRIPT:case l.OPTIMIZATION.WEB_ASSEMBLY.NATIVE_WAT:g=await this.#Lt(e,i);break;case l.OPTIMIZATION.NATIVE_JS.OPTIMIZED:default:g=await this.#Nt(e,i)}const m=[0,0],E=[1,1],f=["ONE","ONE_MINUS_SRC_ALPHA"],_=e._maskId;let T=0,A=!1;for(let i=0;i<g.length;i++){const s=g[i],r=s[0],l=s[1],p=(s[2],s[3]);if(r.length>0&&l.length>0){A&&await this._render(T,t.TRIANGLES),t.uniform2f(h,t.canvas.width,t.canvas.height),t.uniform2f(n,m[0],m[1]),t.uniform2f(o,E[0],E[1]),t.uniform1f(a,0),t.bindBuffer(t.ARRAY_BUFFER,this.#At),t.bufferData(t.ARRAY_BUFFER,r,t.STATIC_DRAW),t.enableVertexAttribArray(c);const s=2,g=t.FLOAT,R=!1,S=0,x=0;t.vertexAttribPointer(c,s,g,R,S,x),t.bindBuffer(t.ARRAY_BUFFER,this.#pt),t.bufferData(t.ARRAY_BUFFER,l,t.STATIC_DRAW),t.enableVertexAttribArray(d),t.vertexAttribPointer(d,2,t.FLOAT,!1,0,x);let y=e._textureStorages[i];y||(y=new Ae(t.createTexture(),i),e._setTextureStorage(i,y)),!0===y._isTextureRecalculated?(this.#Mt(t,y._texture,p,y._textureIndex),y._isTextureRecalculated=!1):this.#Pt(t,y._texture,y._textureIndex),t.uniform1i(u,y._textureIndex),t.blendFunc(t[f[0]],t[f[1]]),T=r.length/2,_&&t.stencilFunc(t.EQUAL,_,255),A=!0}}return Promise.resolve([T,t.TRIANGLES])};_drawPolygon(e,t){const[i,s]=!0===e.isOffsetTurnedOff?[0,0]:t.worldOffset,r=e.x-i,n=e.y-s,a=e.rotation||0,o=e.vertices,h=this.#Tt.debug.boundaries.boundariesColor,c=this.getProgram(l.WEBGL.DRAW_PROGRAMS.PRIMITIVES),{u_translation:d,u_rotation:u,u_scale:g,u_resolution:m,u_color:E,a_position:f,u_fade_max:_,u_fade_min:T}=this.getProgramVarLocations(l.WEBGL.DRAW_PROGRAMS.PRIMITIVES),p=this.#Et;let S=0;p.useProgram(c),p.uniform2f(m,p.canvas.width,p.canvas.height),p.uniform2f(d,r,n),p.uniform2f(g,1,1),p.uniform1f(u,a),p.uniform1f(T,0),p.enableVertexAttribArray(f),p.bindBuffer(p.ARRAY_BUFFER,this.#At);const x=this.#wt(o),y=x.length;if(y%3!=0)return void R(A,"polygon boundaries vertices are not correct, skip drawing");this.#Ot(x),S+=y/2;const I=p.FLOAT;p.vertexAttribPointer(f,2,I,!1,0,0);const v=this.#bt(h);p.uniform4f(E,v[0]/255,v[1]/255,v[2]/255,v[3]),this._render(S,p.TRIANGLES)}_bindLine=(e,t,i,s,r)=>{const[n,a]=!0===e.isOffsetTurnedOff?[0,0]:i.worldOffset,o=e.x-n,l=e.y-a,h=e.rotation,{u_translation:c,u_rotation:d,u_scale:u,u_resolution:g,u_color:m,a_position:E,u_fade_max:f,u_fade_min:_}=r,T=e.vertices,A=e.bgColor,p=(e.fade_min,e.radius,this.#Tt.debug.boundaries.boundariesWidth);let R=0;t.useProgram(s),t.uniform2f(g,t.canvas.width,t.canvas.height),t.uniform2f(c,o,l),t.uniform2f(u,1,1),t.uniform1f(d,h),t.uniform1f(_,0),t.enableVertexAttribArray(E),t.bindBuffer(t.ARRAY_BUFFER,this.#At),this.#Et.bufferData(this.#Et.ARRAY_BUFFER,new Float32Array(T),this.#Et.STATIC_DRAW),R+=T.length/2;const S=t.FLOAT;t.vertexAttribPointer(E,2,S,!1,0,0);const x=this.#bt(A);return t.uniform4f(m,x[0]/255,x[1]/255,x[2]/255,x[3]),t.lineWidth(p),Promise.resolve([0,t.LINES])};_drawLines(e,t,i=1,s=0,r=[0,0]){const n=this.getProgram(l.WEBGL.DRAW_PROGRAMS.PRIMITIVES),{u_translation:a,u_rotation:o,u_scale:h,u_resolution:c,u_color:d,a_position:u,u_fade_max:g,u_fade_min:m}=this.getProgramVarLocations(l.WEBGL.DRAW_PROGRAMS.PRIMITIVES),E=this.#Et;let f=0;E.useProgram(n),E.uniform2f(c,E.canvas.width,E.canvas.height),E.uniform2f(a,r[0],r[1]),E.uniform2f(h,1,1),E.uniform1f(o,s),E.uniform1f(m,0),E.enableVertexAttribArray(u),E.bindBuffer(E.ARRAY_BUFFER,this.#At),this.#Et.bufferData(this.#Et.ARRAY_BUFFER,new Float32Array(e),this.#Et.STATIC_DRAW),f+=e.length/2;const _=E.FLOAT;E.vertexAttribPointer(u,2,_,!1,0,0);const T=this.#bt(t);E.uniform4f(d,T[0]/255,T[1]/255,T[2]/255,T[3]),E.lineWidth(i),this._render(f,E.LINES)}#Nt(e,t){return new Promise(((i,s)=>{const r=e.tilemap,n=e.tilesets,a=e.tilesetImages,o=e.layerData,{tileheight:l,tilewidth:h}=r,c=h,d=l,[u,m]=t.worldDimensions,[E,_]=t.canvasDimensions,[T,A]=!0===e.isOffsetTurnedOff?[0,0]:t.worldOffset,p=(this.#Tt.render.boundaries.realtimeCalculations,e.setBoundaries);let S=new Map,x=[],y=[],I=[],v=[];o||(R(g,"check tilemap and layers name"),s());for(let e=0;e<n.length;e++){const i=n[e].data,s=n[e].firstgid,r=n[e+1],g=r?r.firstgid:1e9,w=i.tilewidth,O=i.tileheight,b=a[e],C=i.imagewidth,P=i.imageheight,M=i.columns,D=o.width,L=o.height,N=c*D,B=d*L,W=A%d,G=T%c,F=0!==A?Math.floor(A/d):0,k=0!==T?Math.floor(T/c):0,U=B>_?Math.ceil(_/d)+1:L,j=N>E?Math.ceil(E/c)+1:D,V=D-j-k,Y=i.spacing,X=(i.margin,i._hasAnimations),z=[],H=[],K=i._hasBoundaries,q=i._boundaries;N===u&&B===m||(R(f," World size from tilemap is different than settings one, fixing..."),t._setWorldDimensions(N,B)),p&&this.#Tt.render.boundaries.mapBoundariesEnabled&&t._setMapBoundaries();let Z=F*D;for(let e=0;e<U;e++){Z+=k;let t=new Map;for(let r=0;r<j;r++){let n=o.data[Z];if(n>=s&&n<g){const a=r*h-G,o=e*l-W;if(n-=s,X){const e=i._animations.get(n);void 0!==e&&(n=e)}const c=n%M,d=Math.floor(n/M),u=a,g=o,m=a+w,E=o+O,f=1/C*(c*w+c*Y),_=1/P*(d*O+d*Y),T=f+1/C*w,A=_+1/P*O;if(z.push(u,g,m,g,u,E,u,E,m,g,m,E),H.push(f,_,T,_,f,A,f,A,T,_,T,A),p){let i=!1;if(K&&q.size>0){const e=q.get(n);e&&(i=!0,e.objects.forEach((e=>{const t=a+e.x,i=o+e.y;if(0!==e.rotation&&R("tilesetData.tiles.rotation property is not supported yet"),e.polygon)e.polygon.forEach(((s,r)=>{const n=e.polygon[r+1];if(n)x.push([s.x+t,s.y+i,n.x+t,n.y+i]);else{const r=e.polygon[0];x.push([s.x+t,s.y+i,r.x+t,r.y+i])}}));else if(e.point)I.push([t,i]);else if(e.ellipse){const s=e.width/2,r=e.height/2;y.push([t+s,i+r,s,r])}else{const s=e.width,r=e.height,n=s+t,a=r+i;x.push([t,i,n,i]),x.push([n,i,n,a]),x.push([n,a,t,a]),x.push([t,a,t,i])}})))}if(!1===i){let i=[a+w,o,a+w,o+O],s=[a+w,o+O,a,o+O],n=[a,o,a+w,o],l=[a,o+O,a,o],h=[null,null,null,null];const c=0!==e?S.get(e-1):void 0;if(c){const e=c.get(r);if(e){const t=e[2],s=x[t];if(s){const e=s[0],i=s[1],r=s[2],a=s[3],o=n[0],l=n[1],h=n[2],c=n[3];o===r&&l===a&&h===e&&c===i&&(x[t]=void 0,n=void 0)}const r=e[1],a=x[r];if(a){const e=a[0],t=a[1],s=a[2],n=i[0];e===i[2]&&s===n&&(x[r]=void 0,i[0]=e,i[1]=t)}const o=e[3],h=x[o];if(h){const e=h[0],t=h[2],i=h[3],s=l[0];e===l[2]&&t===s&&(x[o]=void 0,l[2]=t,l[3]=i)}}}const d=0!==r?t.get(r-1):void 0;if(d){const e=d[1],t=x[e],i=t[0],r=t[1],a=t[2],o=t[3],h=l[0],c=l[1],u=l[2],g=l[3];h===a&&c===o&&u===i&&g===r&&(x[e]=void 0,l=void 0);const m=d[0],E=x[m];if(E&&n){const e=E[0],t=E[1],i=E[3],s=n[1];t===n[3]&&i===s&&(x[m]=void 0,n[0]=e,n[1]=t)}const f=d[2],_=x[f];if(_){const e=_[1],t=_[2],i=_[3],r=s[1];e===s[3]&&i===r&&(x[f]=void 0,s[2]=t,s[3]=i)}}n&&(x.push(n),h[0]=x.length-1),x.push(i),h[1]=x.length-1,x.push(s),h[2]=x.length-1,l&&(x.push(l),h[3]=x.length-1),t.set(r,h)}}}Z++}t.size>0&&S.set(e,t),Z+=V}v.push([new Float32Array(z),new Float32Array(H),i.name,b])}if(p){const e=x.filter((e=>e));t._addBoundariesArray(e),y.length>0&&t._addEllipseBoundaries(y),I.length>0&&t._addPointBoundaries(I)}i(v)}))}#Dt(e,t){return new Promise(((i,s)=>{const r=e.tilemap,n=e.tilesets,a=e.tilesetImages,o=e.layerData,{tileheight:l,tilewidth:h}=r,c=h,d=l,[u,m]=(e.setBoundaries,t.worldDimensions),[E,_]=t.canvasDimensions,[T,A]=!0===e.isOffsetTurnedOff?[0,0]:t.worldOffset;let p=[];o||(R(g,"check tilemap and layers name"),s());for(let e=0;e<=n.length-1;e++){const i=n[e].data,s=n[e].firstgid,r=n[e+1],g=r?r.firstgid:1e9,S=i.tilewidth,x=i.tileheight,y=i.columns,I=o.width,v=o.height,w=c*I,O=d*v,b=(Math.ceil(E/c),Math.ceil(_/d),a[e]),C=b.width,P=b.height,M=i.spacing;i.margin;let D=0,L=[],N=[];w===u&&O===m||(R(f," World size from tilemap is different than settings one, fixing..."),t._setWorldDimensions(w,O));for(let e=0;e<v;e++)for(let t=0;t<I;t++){let i=o.data[D];if(i>=s&&i<g){i-=s;const r=i%y,n=Math.floor(i/y),a=t*h-T,o=e*l-A,c=a+S,d=o+x,u=1/C*(r*S+r*M),g=1/P*(n*x+n*M),m=u+1/C*S,E=g+1/P*x;L.push(a,o,c,o,a,d,a,d,c,o,c,d),N.push(u,g,m,g,u,E,u,E,m,g,m,E)}D++}const B=new Float32Array(L),W=new Float32Array(N);p.push([B,W,i.name,b])}i(p)}))}#Lt=(e,t)=>new Promise(((i,s)=>{const r=e.tilemap,n=r.tilesets,a=e.tilesetImages,o=e.layerData,{tileheight:l,tilewidth:h}=r,c=h,d=l,u=o.data.length,m=o.data.filter((e=>0!==e)).length,[E,_]=t.worldDimensions,[T,A]=!0===e.isOffsetTurnedOff?[0,0]:t.worldOffset,p=[];this.layerDataFloat32.set(o.data),o||(R(g,"check tilemap and layers name"),s());for(let e=0;e<n.length;e++){const i=n[e].data,s=n[e].firstgid,r=n[e+1],g=r?r.firstgid:1e9,S=i.tilewidth,x=i.tileheight,y=i.columns,I=o.width,v=o.height,w=c*I,O=d*v,b=a[e],C=b.width,P=b.height,M=4,D=12*m,L=12*m,N=i.spacing;i.margin,w===E&&O===_||(R(f," World size from tilemap is different than settings one, fixing..."),t._setWorldDimensions(w,O)),this.#Tt.render.boundaries.mapBoundariesEnabled&&t._setMapBoundaries();const B=this.calculateBufferData(M,u,D,v,I,h,l,S,x,y,C,P,T,A,s,g,N,!1),W=B>0?this.layerDataFloat32.slice(u,D+u):[],G=B>0?this.layerDataFloat32.slice(D+u,D+L+u):[];p.push([W,G,i.name,b])}i(p)}));#bt(e){return e.replace("rgba(","").replace(")","").split(",").map((e=>Number(e.trim())))}#wt(e){return this.#Bt(e)}#Bt(e,t=[]){const i=e.length;if(i<=3)return e.forEach((e=>{t.push(e[0]),t.push(e[1])})),t;const s=[...e].sort(((e,t)=>t[1]-e[1])),r=e.indexOf(s[0]),n=r!==i-1?r+1:0;let a=e,o=a.length,l=0,h=n;for(;a.length>2;){const e=a.length;h>=e&&(h-=e);const i=0===h?a[e-1]:a[h-1],s=a[h],r=e===h+1?a[0]:a[h+1];if(c=i,d=s,se({x:(u=r)[0]-c[0],y:u[1]-c[1]},{x:d[0]-c[0],y:d[1]-c[1]})<0)t.push(i[0]),t.push(i[1]),t.push(s[0]),t.push(s[1]),t.push(r[0]),t.push(r[1]),a=a.filter(((e,t)=>t!==h));else{if(l+=1,l>o)return R("TRIANGULATE_ISSUE","Can't extract all triangles vertices. Probably vertices input is not correct, or the order is wrong"),t;h++}}var c,d,u;return t}#Ot(e){this.#Et.bufferData(this.#Et.ARRAY_BUFFER,new Float32Array(e),this.#Et.STATIC_DRAW)}#vt(e,t){const i=0+e,s=0+t;this.#Et.bufferData(this.#Et.ARRAY_BUFFER,new Float32Array([0,0,i,0,0,s,0,s,i,0,i,s]),this.#Et.STATIC_DRAW)}#Mt(e,t,i,s=0,r=!1){this.#Pt(e,t,s),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,i),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,r?e.LINEAR_MIPMAP_LINEAR:e.LINEAR)}#Ct(e,t,i,s=0){this.#Pt(e,t,s),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,i),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST)}#Pt(e,t,i=0){e.activeTexture(e.TEXTURE0+i),e.bindTexture(e.TEXTURE_2D,t)}#Wt(e,t){e.deleteTexture(t)}isPowerOfTwo(e){return 0==(e&e-1)}nextHighestPowerOfTwo(e){--e;for(var t=1;t<32;t<<=1)e|=e>>t;return e+1}}const Re=["u_translation","u_rotation","u_scale","u_resolution","u_image"],Se=["a_position","a_texCoord"],xe=["u_translation","u_rotation","u_scale","u_resolution","u_fade_min","u_fade_max","u_color"],ye=["a_position"];class Ie{#Gt;#Ft;#kt;#_e;#Ut;#jt;#Vt;#ct;#Yt;#Xt;#zt=!1;#Ht;#xe=new EventTarget;#Kt;#qt=new Map;#Zt=[];constructor(e,t,i){this.#kt=!1,this.#Gt=document.createElement("canvas"),i.appendChild(this.#Gt),this.#Ft=this.#Gt.getContext("webgl",{stencil:!0}),this.#Vt=e,this.#ct=t,this.#Yt=[],this.#Ht=this.systemSettings.gameOptions.render.minCycleTime,this.#zt=this.systemSettings.gameOptions.render.boundaries.wholeWorldPrecalculations,this.#Ut=new pe(this.#Ft,this.#Vt.gameOptions),this.systemSettings.gameOptions.optimization!==l.OPTIMIZATION.WEB_ASSEMBLY.NATIVE_WAT&&this.systemSettings.gameOptions.optimization!==l.OPTIMIZATION.WEB_ASSEMBLY.ASSEMBLY_SCRIPT||this._registerRenderInit(this.#Ut._initiateWasm),this._registerRenderInit(this.fixCanvasSize),this._registerRenderInit((()=>this._registerAndCompileWebGlProgram(l.WEBGL.DRAW_PROGRAMS.IMAGES,"\n    attribute vec2 a_texCoord;\n\n    attribute vec2 a_position;\n\n    uniform vec2 u_translation;\n    uniform float u_rotation;\n    uniform vec2 u_scale;\n\n    uniform vec2 u_resolution;\n\n    varying vec2 v_texCoord;\n\n    void main(void) {\n        float c = cos(u_rotation);\n        float s = sin(u_rotation);\n\n        mat3 translationMatrix1 = mat3(\n            1, 0, 0,\n            0, 1, 0,\n            u_translation.x, u_translation.y, 1\n        );\n\n        mat3 translationMatrix2 = mat3(\n            1, 0, 0,\n            0, 1, 0,\n            -u_translation.x, -u_translation.y, 1\n        );\n        \n        mat3 rotationMatrix = mat3(\n            c, s, 0,\n            -s, c, 0,\n            0, 0, 1\n        );\n\n        mat3 scalingMatrix = mat3(\n            u_scale.x, 0, 0,\n            0, u_scale.y, 0,\n            0, 0, 1\n        );\n\n        mat3 matrix = translationMatrix1 * rotationMatrix * translationMatrix2 * scalingMatrix;\n    \n        vec2 position = (matrix * vec3(a_position, 1)).xy;\n\n        vec2 clipSpace = position / u_resolution * 2.0 - 1.0;\n\n        gl_Position = vec4(clipSpace * vec2(1, -1), 0, 1);\n        \n        v_texCoord = a_texCoord;\n    }","\n    precision mediump float;\n\n    uniform sampler2D u_image;\n\n    //texCoords passed in from the vertex shader\n    varying vec2 v_texCoord;\n    void main() {\n        vec4 color = texture2D(u_image, v_texCoord);\n        gl_FragColor = color;\n    }",Re,Se))),this._registerRenderInit((()=>this._registerAndCompileWebGlProgram(l.WEBGL.DRAW_PROGRAMS.PRIMITIVES,"\n    precision mediump float;\n\n    attribute vec2 a_position;\n\n    uniform vec2 u_translation;\n    uniform float u_rotation;\n    uniform vec2 u_scale;\n\n    uniform vec2 u_resolution;\n\n    void main(void) {\n        float c = cos(u_rotation);\n        float s = sin(u_rotation);\n\n        mat3 translationMatrix1 = mat3(\n            1, 0, 0,\n            0, 1, 0,\n            u_translation.x, u_translation.y, 1\n        );\n\n        //mat3 translationMatrix2 = mat3(\n        //    1, 0, 0,\n        //    0, 1, 0,\n        //    -u_translation.x, -u_translation.y, 1\n        //);\n        \n        mat3 rotationMatrix = mat3(\n            c, s, 0,\n            -s, c, 0,\n            0, 0, 1\n        );\n\n        mat3 scalingMatrix = mat3(\n            u_scale.x, 0, 0,\n            0, u_scale.y, 0,\n            0, 0, 1\n        );\n        \n        mat3 matrix = translationMatrix1 * rotationMatrix * scalingMatrix;\n\n        vec2 position = (matrix * vec3(a_position, 1)).xy;\n\n        vec2 clipSpace = position / u_resolution * 2.0 - 1.0;\n\n        gl_Position = vec4(clipSpace * vec2(1, -1), 0, 1);\n    }\n","\n    precision mediump float;\n\n    uniform vec4 u_color;\n    uniform float u_fade_min; \n    uniform float u_fade_max;\n    uniform vec2 a_position;\n    uniform vec2 u_resolution;\n    uniform vec2 u_translation;\n\n    void main(void) {\n        vec4 p = u_color;\n        if (u_fade_min > 0.0) {\n            vec2 fix_tr = vec2(u_translation.x, u_resolution.y - u_translation.y); \n            float distance = distance(fix_tr.xy, gl_FragCoord.xy);\n            if (u_fade_min <= distance && distance <= u_fade_max) {\n                float percent = ((distance - u_fade_max) / (u_fade_min - u_fade_max)) * 100.0;\n                p.a = u_color.a * (percent / 100.0);\n            }\n        }\n\n        gl_FragColor = p;\n    }\n",xe,ye))),this._registerRenderInit(this.#Ut._initWebGlAttributes),this._registerObjectRender(L.name,this.#Ut._bindText,l.WEBGL.DRAW_PROGRAMS.IMAGES),this._registerObjectRender(C.name,this.#Ut._bindPrimitives,l.WEBGL.DRAW_PROGRAMS.PRIMITIVES),this._registerObjectRender(F.name,this.#Ut._bindPrimitives,l.WEBGL.DRAW_PROGRAMS.PRIMITIVES),this._registerObjectRender(k.name,this.#Ut._bindConus,l.WEBGL.DRAW_PROGRAMS.PRIMITIVES),this._registerObjectRender(N.name,this.#Ut._bindConus,l.WEBGL.DRAW_PROGRAMS.PRIMITIVES),this._registerObjectRender(U.name,this.#Ut._bindTileImages,l.WEBGL.DRAW_PROGRAMS.IMAGES),this._registerObjectRender(G.name,this.#Ut._bindLine,l.WEBGL.DRAW_PROGRAMS.PRIMITIVES)}addEventListener=(e,t,i)=>{this.#xe.addEventListener(e,t,i)};removeEventListener=(e,t,i)=>{this.#xe.removeEventListener(e,t,i)};get stageData(){return this.#jt}get systemSettings(){return this.#Vt}get iLoader(){return this.#ct}get canvas(){return this.#Gt}get drawContext(){return this.#Ft}emit=(e,...t)=>{const i=new Event(e);i.data=[...t],this.#xe.dispatchEvent(i)};isAllFilesLoaded=()=>0===this.iLoader.filesWaitingForUpload;initiateContext=()=>Promise.all(this.#Zt.map((e=>e())));clearContext(){this.#Ut._clearView()}setCanvasSize(e,t){this.#Gt.width=e,this.#Gt.height=t,this.#Ut&&this.#Ut._fixCanvasSize(e,t)}fixCanvasSize=()=>{const e=this.systemSettings,t=e.canvasMaxSize.width&&e.canvasMaxSize.width<window.innerWidth?e.canvasMaxSize.width:window.innerWidth,i=e.canvasMaxSize.height&&e.canvasMaxSize.height<window.innerHeight?e.canvasMaxSize.height:window.innerHeight;return this.setCanvasSize(t,i),Promise.resolve()};_registerAndCompileWebGlProgram(e,t,i,s,r){return this.#Ut._registerAndCompileWebGlProgram(e,t,i,s,r),Promise.resolve()}_registerRenderInit(e){this.#Zt.push(e)}_registerObjectRender(e,t,i){this.#qt.set(e,{method:t,webglProgramName:i})}async render(){let e=[],t=[],i=!1;const s=this.stageData.renderObjects;if(0!==s.length){for(let t=0;t<s.length;t++){const i=s[t];if(i.isRemoved){s.splice(t,1),t--;continue}i.hasAnimations&&i._processActiveAnimations();const r=await this._bindRenderObject(i).catch((e=>Promise.reject(e)));e.push(r)}this.systemSettings.gameOptions.debug.boundaries.drawLayerBoundaries&&e.push(this.#Jt().catch((e=>Promise.reject(e))))}return(await Promise.allSettled(e)).forEach((e=>{"rejected"===e.status&&(Promise.reject(e.reason),i=!0,t.push(e.reason))})),this.#Qt(),this._isCleared=!1,!1===i?Promise.resolve():Promise.reject(t)}set _isCleared(e){this.#kt=e}get _isCleared(){return this.#kt}_createBoundariesPrecalculations(){}#Qt(){}#$t(e){return new Promise(((t,i)=>{if(e.setBoundaries){const s=this.iLoader.getTileMap(e.tileMapKey),r=s.tilesets,n=s.layers.find((t=>t.name===e.layerKey)),{tileheight:a,tilewidth:o}=s,l=o,h=a,[c,d]=this.stageData.worldDimensions;let u=[];n||(R(g,"check tilemap and layers name"),i());for(let t=0;t<r.length;t++){const t=n.width,i=n.height,s=l*t,r=h*i;s===c&&r===d||(R(f," World size from tilemap is different than settings one, fixing..."),this.stageData._setWorldDimensions(s,r)),e.setBoundaries&&this.systemSettings.gameOptions.render.boundaries.mapBoundariesEnabled&&this.stageData._setWholeWorldMapBoundaries();let a=0;for(let e=0;e<i;e++)for(let i=0;i<t;i++){let t=n.data[a],s=i*l,r=e*h;0!==t&&(t-=1,u.push([s,r,s+l,r]),u.push([s+l,r,s+l,r+h]),u.push([s+l,r+h,s,r+h]),u.push([s,r+h,s,r])),a++}}this.stageData._setWholeMapBoundaries(u),this.stageData._mergeBoundaries(!0),console.warn("precalculated boundaries set"),console.log(this.stageData.getWholeWorldBoundaries()),t()}else t()}))}_bindRenderObject(e){const t=e.constructor.name,i=this.#qt.get(t);if(i){const t=i.webglProgramName;if(t){const s=this.#Ut.getProgram(t),r=this.#Ut.getProgramVarLocations(t);return i.method(e,this.drawContext,this.stageData,s,r).then((e=>this.#Ut._render(e[0],e[1])))}return i.method(e,this.drawContext,this.stageData)}if(e.type===l.DRAW_TYPE.IMAGE){const t=this.#Ut.getProgram(l.WEBGL.DRAW_PROGRAMS.IMAGES),i=this.#Ut.getProgramVarLocations(l.WEBGL.DRAW_PROGRAMS.IMAGES);return e.image||(e.image=this.iLoader.getImage(e.key)),this.#Ut._bindImage(e,this.drawContext,this.stageData,t,i).then((e=>this.#Ut._render(e[0],e[1]))).then((()=>e.vertices&&this.systemSettings.gameOptions.debug.boundaries.drawObjectBoundaries?this.#Ut._drawPolygon(e,this.stageData):Promise.resolve()))}return console.warn("no registered draw object method for "+t+" skip draw"),Promise.resolve()}#Jt(){return new Promise((e=>{const t=this.stageData.getBoundaries(),i=this.stageData.getEllipseBoundaries(),s=this.stageData.getPointBoundaries(),r=(t.length,i.length),n=s.length;this.#Ut._drawLines(t.flat(),this.systemSettings.gameOptions.debug.boundaries.boundariesColor,this.systemSettings.gameOptions.debug.boundaries.boundariesWidth),r&&i.forEach((e=>{const t=Te(e[0],e[1],e[2],e[3]);this.#Ut._drawPolygon({x:0,y:0,vertices:t,isOffsetTurnedOff:!0},this.stageData)})),n&&s.forEach((e=>{const t=e[0],i=e[1],s=[t,i,t+1,i+1];this.#Ut._drawLines(s,this.systemSettings.gameOptions.debug.boundaries.boundariesColor,this.systemSettings.gameOptions.debug.boundaries.boundariesWidth)})),e()}))}#ei(){const e=this.systemSettings.gameOptions.render.cyclesTimeCalc.averageFPStime,t=this.#Yt.length;let i=0;for(let e=0;e<t;e++)i+=this.#Yt[e];console.log("FPS average for",e/1e3,"sec, is ",(1e3/(i/t)).toFixed(2)),this.#Yt=[]}_startRender=async e=>{const t=this.systemSettings.gameOptions;this.#_e=!0,this.#jt=e,this.fixCanvasSize(),t.library===l.LIBRARY.WEBGL&&(await this.#ti(),this.timeStart=Date.now(),setTimeout((()=>requestAnimationFrame(this.#ii)))),t.render.cyclesTimeCalc.check===l.OPTIMIZATION.CYCLE_TIME_CALC.AVERAGES&&(this.#Xt=setInterval((()=>this.#ei()),t.render.cyclesTimeCalc.averageFPStime))};_stopRender=()=>{this.#_e=!1,this.#jt=null,this.#Yt=[],clearInterval(this.#Xt),this.#Xt=null};#ti(){return new Promise(((e,t)=>{let i=[];const s=this.#zt;i.push(this.initiateContext()),s&&console.warn("isBoundariesPrecalculations() is turned off"),Promise.allSettled(i).then((i=>{i.forEach((e=>{if("rejected"===e.status){const i=e.reason;R(E,i),t(i)}})),e()}))}))}#ii=async()=>{const e=performance.now(),t=this.#Ht,i=this.systemSettings.gameOptions.render.cyclesTimeCalc.check===l.OPTIMIZATION.CYCLE_TIME_CALC.CURRENT;this.emit(l.EVENTS.SYSTEM.RENDER.START),this.stageData._clearBoundaries(),this.clearContext(),this.render().then((()=>{const s=performance.now()-e,r=t-s,n=r>0?r:0,a=s+n;i&&s>t&&console.log("current draw take: ",s," ms"),this.emit(l.EVENTS.SYSTEM.RENDER.END),a>0&&this.#Yt.push(a),this.#_e&&setTimeout((()=>requestAnimationFrame(this.#ii)),n)})).catch((e=>{e.forEach?e.forEach((e=>{R(E,e)})):R(E,e.message),this._stopRender()}))}}class ve{#si;constructor(e){this.#si=e}registerDrawObject(e,t){this.#si.drawObjectFactory._registerNewObjectMethod(e,t)}registerAndCompileWebGlProgram(e,t,i,s,r){return this.#si.iRender._registerAndCompileWebGlProgram(e,t,i,s,r)}registerRenderInit(e){this.#si.iRender._registerRenderInit(e)}registerObjectRender(e,t,i){this.#si.iRender._registerObjectRender(e,t,i)}}class we{#qe;#ri;#ni;#ai;#Ve=new v;#oi;#li=new j(this.#Ve);#hi=new Map;#ci;#xe=new EventTarget;constructor(e,t,i){e||p(h,"systemSettings should be passed to class instance"),this.#qe=e,this.#ai=new H(this.iLoader),this.#ni=new z(e),this.#oi=new Ie(this.systemSettings,this.iLoader,i),this.#ri=new ve(this,this.#oi),this.#ci=t,this.#oi.addEventListener(l.EVENTS.SYSTEM.RENDER.START,(()=>this.emit(l.EVENTS.SYSTEM.RENDER.START))),this.#oi.addEventListener(l.EVENTS.SYSTEM.RENDER.END,(()=>this.emit(l.EVENTS.SYSTEM.RENDER.END)))}emit=(e,...t)=>{const i=new Event(e);i.data=[...t],this.#xe.dispatchEvent(i)};addEventListener=(e,t,i)=>{this.#xe.addEventListener(e,t,i)};removeEventListener=(e,t,i)=>{this.#xe.removeEventListener(e,t,i)};get iNetwork(){return this.#ni}get systemSettings(){return this.#qe}get audio(){return this.#ai}get iLoader(){return this.#Ve}get iRender(){return this.#oi}get drawObjectFactory(){return this.#li}get iExtension(){return this.#ri}get modules(){return this.#hi}installModule=(e,t,...i)=>{const s=new t(this,...i);return this.#hi.has(e)?(R("MODULE_ALREADY_INSTALLED","module "+e+" is already installed"),this.#hi.get(e)):(this.#hi.set(e,s),s)};startGameStage=(e,t)=>{if(this.#ci.has(e)){const i=this.#ci.get(e),s=i.stageData;this.#li._attachPageData(s),!1===i.isInitiated&&i._init(),i._start(t),this.emit(l.EVENTS.SYSTEM.START_PAGE),this.#oi._startRender(s)}else p(c,"View "+e+" is not registered!")};stopGameStage=e=>{this.#ci.has(e)?(this.emit(l.EVENTS.SYSTEM.STOP_PAGE),this.drawObjectFactory._detachPageData(),this.#oi._stopRender(),this.#ci.get(e)._stop()):p(c,"View "+e+" is not registered!")}}class Oe{#di;#ui=!1;#_e;#gi;#mi;constructor(){this.#_e=!1,this.#mi=new S}_register(e,t){this.#di=e,this.#gi=t,this.#Ei(),this.#fi(),this.register()}_init(){this.init(),this.#ui=!0}register(){}init(){}start(e){}stop(){}resize(){}get iLoader(){return this.#gi.iLoader}get draw(){return this.#gi.drawObjectFactory}_attachCanvasToContainer(e){this.#_i(this.canvasHtmlElement,e)}addRenderObject=e=>{const t=this.stageData;-1!==t.renderObjects.indexOf(e)?R("NEW_BEHAVIOR_INTRODUCED","stage.draw methods add objects to pageData, no need to call addRenderObject"):(t._renderObject=e,t._sortRenderObjectsBySortIndex())};get isActive(){return this.#_e}get isInitiated(){return this.#ui}get name(){return this.#di}get stageData(){return this.#mi}get systemSettings(){return this.#gi.systemSettings}get audio(){return this.#gi.audio}get iSystem(){return this.#gi}get canvasHtmlElement(){return document.getElementsByTagName("canvas")[0]}addEventListener=(e,t,i)=>{this.iSystem.addEventListener(e,t,i)};removeEventListener=(e,t,i)=>{this.iSystem.removeEventListener(e,t,i)};_start(e){this.start(e),this.#_e=!0,window.addEventListener("resize",this._resize),this._resize()}_stop(){this.#_e=!1,window.removeEventListener("resize",this._resize),this.stop()}_resize=()=>{this.#fi(),this.resize()};#_i(e,t){t.appendChild(e)}#Ei(){const e=this.systemSettings.worldSize?this.systemSettings.worldSize.width:0,t=this.systemSettings.worldSize?this.systemSettings.worldSize.height:0;this.stageData._setWorldDimensions(e,t)}isBoundariesCollision=(e,t,i)=>{const s=i.type,r=i.vertices,n=i.circleBoundaries;switch(s){case l.DRAW_TYPE.TEXT:case l.DRAW_TYPE.RECTANGLE:case l.DRAW_TYPE.CONUS:case l.DRAW_TYPE.IMAGE:return n?this.#Ti(e,t,i.circleBoundaries.r):this.#Ai(e,t,r,i.rotation);case l.DRAW_TYPE.CIRCLE:R(l.WARNING_CODES.METHOD_NOT_IMPLEMENTED,"isObjectCollision.circle check is not implemented yet!");break;case l.DRAW_TYPE.LINE:R(l.WARNING_CODES.METHOD_NOT_IMPLEMENTED,"isObjectCollision.line check is not implemented yet, please use .rect instead line!");break;default:R(l.WARNING_CODES.UNKNOWN_DRAW_OBJECT,"unknown object type!")}return!1};isObjectsCollision=(e,t,i,s)=>{const r=i.type,n=i.vertices,a=i.circleBoundaries;switch(r){case l.DRAW_TYPE.TEXT:case l.DRAW_TYPE.RECTANGLE:case l.DRAW_TYPE.CONUS:case l.DRAW_TYPE.IMAGE:return a?this.#pi(e,t,a,s):this.#Ri(e,t,n,i.rotation,s);case l.DRAW_TYPE.CIRCLE:R(l.WARNING_CODES.METHOD_NOT_IMPLEMENTED,"isObjectCollision.circle check is not implemented yet!");break;case l.DRAW_TYPE.LINE:R(l.WARNING_CODES.METHOD_NOT_IMPLEMENTED,"isObjectCollision.line check is not implemented yet, please use .rect instead line!");break;default:R(l.WARNING_CODES.UNKNOWN_DRAW_OBJECT,"unknown object type!")}return!1};#Ri(e,t,i,s,r){const n=r.length;let a=[];for(let o=0;o<n;o++){const n=r[o];let h;switch(n.type){case l.DRAW_TYPE.TEXT:case l.DRAW_TYPE.RECTANGLE:case l.DRAW_TYPE.CONUS:case l.DRAW_TYPE.IMAGE:h=this.#Si(e,t,i,s,n);break;case l.DRAW_TYPE.CIRCLE:console.warn("isObjectCollision.circle check is not implemented yet!");break;case l.DRAW_TYPE.LINE:console.warn("isObjectCollision.line check is not implemented, please use rect instead");break;default:console.warn("unknown object type!")}h&&a.push(h)}return a.length>0?this.#xi(a):null}#pi(e,t,i,s){const r=i.r,n=s.length;let a=[];for(let i=0;i<n;i++){const n=s[i],o=n.type,h=n.circleBoundaries;let c;switch(o){case l.DRAW_TYPE.TEXT:case l.DRAW_TYPE.RECTANGLE:case l.DRAW_TYPE.CONUS:case l.DRAW_TYPE.IMAGE:c=h?this.#yi(e,t,r,n.x,n.y,h.r):this.#Ii(e,t,r,n);break;case l.DRAW_TYPE.CIRCLE:console.warn("isObjectCollision.circle check is not implemented yet!");break;case l.DRAW_TYPE.LINE:console.warn("isObjectCollision.line check is not implemented, please use rect instead");break;default:console.warn("unknown object type!")}c&&a.push(c)}return a.length>0?this.#xi(a):null}#xi(e){return e.sort(((e,t)=>e.p<t.p))[0]}#Ii(e,t,i,s){const[r,n]=this.stageData.worldOffset,a=e-r,o=t-n,l=s.x-r,h=s.y-n,c=s.vertices,d=s.rotation,u=c.length;for(let e=0;e<u;e+=1){const t=c[e];let s=c[e+1];s||(s=c[0]);const r=this.#vi(t,l,h,d),n=this.#vi(s,l,h,d),u=ue(a,o,i,{x1:r[0],y1:r[1],x2:n[0],y2:n[1]});if(u)return u}return!1}#yi(e,t,i,s,r,n){const a=new D(e,t,s,r).length;return console.log(a),console.log(i),console.log(n),!(a-(i+n)>0)}#Si(e,t,i,s,r){const[n,a]=this.stageData.worldOffset,o=e-n,l=t-a,h=r.x-n,c=r.y-a,d=r.vertices,u=r.rotation,g=i.map((e=>this.#vi(e,o,l,s))),m=d.length;for(let e=0;e<m;e+=1){const t=d[e];let i=d[e+1];i||(i=d[0]);const s=this.#vi(t,h,c,u),r=this.#vi(i,h,c,u),n=le(g,{x1:s[0],y1:s[1],x2:r[0],y2:r[1]});if(n)return n}return!1}#vi(e,t,i,s){const r=new D(0,0,e[0],e[1]),n=$(0,0,e[0],e[1]),a=r.length;return[t+a*Math.cos(s+n),i+a*Math.sin(s+n)]}#Ti(e,t,i){const s=this.stageData.getBoundaries(),r=this.stageData.getEllipseBoundaries(),n=this.stageData.getPointBoundaries(),[a,o]=this.stageData.worldOffset,l=e-a,h=t-o,c=s.length,d=r.length,u=n.length;for(let e=0;e<c;e+=1){const t=s[e],r=ue(l,h,i,{x1:t[0],y1:t[1],x2:t[2],y2:t[3]});if(r)return r}if(d>0)for(let e=0;e<d;e+=1){const t=me(r[e],{x:l,y:h,r:i});if(t)return t}if(u>0)for(let e=0;e<u;e+=1){const t=n[e],s=de(t[0],t[1],{x:l,y:h,r:i});if(s)return s}return!1}#Ai(e,t,i,s){const r=this.stageData.getBoundaries(),n=this.stageData.getEllipseBoundaries(),a=this.stageData.getPointBoundaries(),[o,l]=this.stageData.worldOffset,h=e-o,c=t-l,d=i.map((e=>this.#vi(e,h,c,s))),u=r.length,g=n.length,m=a.length;for(let e=0;e<u;e+=1){const t=r[e],i=le(d,{x1:t[0],y1:t[1],x2:t[2],y2:t[3]});if(i)return i}if(g>0)for(let e=0;e<g;e+=1){const t=Ee(n[e],d);if(t)return t}if(m>0)for(let e=0;e<m;e+=1){const t=a[e],i=he(t[0],t[1],d);if(i)return i}return!1}#fi(){const e=this.systemSettings.canvasMaxSize.width&&this.systemSettings.canvasMaxSize.width<window.innerWidth?this.systemSettings.canvasMaxSize.width:window.innerWidth,t=this.systemSettings.canvasMaxSize.height&&this.systemSettings.canvasMaxSize.height<window.innerHeight?this.systemSettings.canvasMaxSize.height:window.innerHeight;this.stageData._setCanvasDimensions(e,t)}}class be extends Oe{#wi=0;#Oi=0;#bi=0;register(){}init(){const[e,t]=this.stageData.canvasDimensions,i=e/3;this.background=this.draw.rect(0,0,e,t,this.systemSettings.gameOptions.loadingScreen.backgroundColor),this.loadingBarBg=this.draw.rect(e/2-i/2,t/2-10,i,20,this.systemSettings.gameOptions.loadingScreen.loadingBarBg),this.loadingBarProgress=this.draw.rect(e/2-i/2,t/2-10,i,20,this.systemSettings.gameOptions.loadingScreen.loadingBarProgress),this.text=this.draw.text(e/2-20,t/2-40,"JsGE","24px sans-serif","black"),this.#bi=i}_progress=e=>{const t=this.#bi/this.#wi;this.#Oi=e;const i=t*this.#Oi,s=e>this.#wi?this.#bi:i;this.loadingBarProgress.width=s};start(e){this.#wi=e.total}}const Ce="loadingPage";class Pe{#Ci;#Pi;constructor(e,t){e||p(h,"iSystemSettings should be passed to class instance"),this.#Ci=new Map,t||(t=document.createElement("div"),document.body.appendChild(t)),this.#Pi=new we(e,this.#Ci,t),this.registerStage(Ce,be),this.#Pi.iLoader.addEventListener("loadstart",this.#Mi),this.#Pi.iLoader.addEventListener("progress",this.#Di),this.#Pi.iLoader.addEventListener("load",this.#Li)}get iSystem(){return this.#Pi}registerStage(e,t){if(e&&"string"==typeof e&&e.trim().length>0){const i=new t;i._register(e,this.iSystem),this.#Ci.set(e,i)}else p(h,"valid class name should be provided")}preloadAllData(){return this.#Pi.iLoader.preload()}#Mi=e=>{this.#Pi.startGameStage(Ce,{total:e.total})};#Di=e=>{const t=e.loaded,i=e.total;this.#Ci.get(Ce)._progress(t,i)};#Li=()=>{this.#Pi.stopGameStage(Ce)}}var Me=n.oX,De=n.QD,Le=n.T_,Ne=n.uw,Be=n.xl,We=n.xP,Ge=n.bq,Fe=n.P6;export{Me as CONST,De as DrawImageObject,Le as GameStage,Ne as ISystemAudio,Be as Primitives,We as System,Ge as SystemSettings,Fe as utils};