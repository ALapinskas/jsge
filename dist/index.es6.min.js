var e,t,i={},s={};function r(e){var t=s[e];if(void 0!==t)return t.exports;var n=s[e]={exports:{}};return i[e](n,n.exports,r),n.exports}r.m=i,r.d=(e,t)=>{for(var i in t)r.o(t,i)&&!r.o(e,i)&&Object.defineProperty(e,i,{enumerable:!0,get:t[i]})},r.f={},r.e=e=>Promise.all(Object.keys(r.f).reduce(((t,i)=>(r.f[i](e,t),t)),[])),r.u=e=>e+".index.es6.min.js",r.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),e={},t="jsge:",r.l=(i,s,n,a)=>{if(e[i])e[i].push(s);else{var o,l;if(void 0!==n)for(var c=document.getElementsByTagName("script"),u=0;u<c.length;u++){var h=c[u];if(h.getAttribute("src")==i||h.getAttribute("data-webpack")==t+n){o=h;break}}o||(l=!0,(o=document.createElement("script")).type="module",o.charset="utf-8",o.timeout=120,r.nc&&o.setAttribute("nonce",r.nc),o.setAttribute("data-webpack",t+n),o.src=i),e[i]=[s];var d=(t,s)=>{o.onerror=o.onload=null,clearTimeout(g);var r=e[i];if(delete e[i],o.parentNode&&o.parentNode.removeChild(o),r&&r.forEach((e=>e(s))),t)return t(s)},g=setTimeout(d.bind(null,void 0,{type:"timeout",target:o}),12e4);o.onerror=d.bind(null,o.onerror),o.onload=d.bind(null,o.onload),l&&document.head.appendChild(o)}},r.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},(()=>{var e;if("string"==typeof import.meta.url&&(e=import.meta.url),!e)throw new Error("Automatic publicPath is not supported in this browser");e=e.replace(/#.*$/,"").replace(/\?.*$/,"").replace(/\/[^\/]+$/,"/"),r.p=e})(),(()=>{var e={179:0};r.f.j=(t,i)=>{var s=r.o(e,t)?e[t]:void 0;if(0!==s)if(s)i.push(s[2]);else{var n=new Promise(((i,r)=>s=e[t]=[i,r]));i.push(s[2]=n);var a=r.p+r.u(t),o=new Error;r.l(a,(i=>{if(r.o(e,t)&&(0!==(s=e[t])&&(e[t]=void 0),s)){var n=i&&("load"===i.type?"missing":i.type),a=i&&i.target&&i.target.src;o.message="Loading chunk "+t+" failed.\n("+n+": "+a+")",o.name="ChunkLoadError",o.type=n,o.request=a,s[1](o)}}),"chunk-"+t,t)}};var t=(t,i)=>{var s,n,[a,o,l]=i,c=0;if(a.some((t=>0!==e[t]))){for(s in o)r.o(o,s)&&(r.m[s]=o[s]);l&&l(r)}for(t&&t(i);c<a.length;c++)n=a[c],r.o(e,n)&&e[n]&&e[n][0](),e[n]=0},i=self.webpackChunkjsge=self.webpackChunkjsge||[];i.forEach(t.bind(null,0)),i.push=t.bind(null,i.push.bind(i))})();var n={};r.d(n,{oX:()=>l,QD:()=>C,T_:()=>tt,uw:()=>ce,xl:()=>a,xP:()=>rt,bq:()=>ne,P6:()=>o});var a={};r.r(a),r.d(a,{Rectangle:()=>W,Vector:()=>j,Vertex:()=>F});var o={};r.r(o),r.d(o,{angle_2points:()=>fe,angle_3points:()=>Ee,calculateEllipseVertices:()=>Fe,calculateLinesVertices:()=>Be,countClosestTraversal:()=>ge,countClosestTraversal2:()=>me,countDistance:()=>xe,crossProduct:()=>be,dotProduct:()=>pe,dotProductWithAngle:()=>_e,generateUniqId:()=>Le,isCircleLineIntersect:()=>Oe,isEllipseCircleIntersect:()=>Ce,isEllipseLineIntersect:()=>Pe,isEllipsePolygonIntersect:()=>Me,isLineShorter:()=>Re,isMobile:()=>ue,isPointCircleIntersect:()=>Ie,isPointInsidePolygon:()=>ye,isPointLineIntersect:()=>Ae,isPointOnTheLine:()=>Te,isPointPolygonIntersect:()=>Se,isPointRectIntersect:()=>we,isPolygonLineIntersect:()=>ve,isSafari:()=>he,mat3Multiply:()=>We,mat3MultiplyPosCoords:()=>Ge,mat3MultiplyVector:()=>je,pointToCircleDistance:()=>de,randomFromArray:()=>De,verticesArrayToArrayNumbers:()=>Ne});const l={MODE:{DEBUG:"DEBUG",PRODUCTION:"PRODUCTION"},AUDIO:{},CONNECTION_STATUS:{DISCONNECTED:"disconnected",CONNECTED:"connected",CONNECTION_LOST:"connection lost"},EVENTS:{SYSTEM:{START_PAGE:"START_PAGE",STOP_PAGE:"STOP_PAGE",RENDER:{START:"start",END:"end"}},WEBSOCKET:{SERVER_CLIENT:{CONNECTION_STATUS_CHANGED:"CONNECTION_STATUS_CHANGED",ROOMS_INFO:"roomsInfo",CREATED:"created",JOINED:"joined",FULL:"full",DISCONNECTED:"disconnected",SERVER_MESSAGE:"message",RESTARTED:"restarted"},CLIENT_SERVER:{ROOMS_INFO_REQUEST:"gatherRoomsInfo",CREATE_OR_JOIN:"create or join",RESTART_REQUEST:"restart",CLIENT_MESSAGE:"message"}}},WEBGL:{DRAW_PROGRAMS:{PRIMITIVES:"drawPrimitives",PRIMITIVES_M:"drawPrimitivesMerge",IMAGES_M:"drawImagesMerge"}},GAME_OPTIONS:{},LIBRARY:{WEBGL:"webgl"},OPTIMIZATION:{CYCLE_TIME_CALC:{AVERAGES:"AVERAGES",CURRENT:"CURRENT"},NATIVE_JS:{NOT_OPTIMIZED:"NOT_OPTIMIZED",OPTIMIZED:"OPTIMIZED"},WEB_ASSEMBLY:{ASSEMBLY_SCRIPT:"ASSEMBLY_SCRIPT",NATIVE_WAT:"WASM"}}},c="rect",u="conus",h="circle",d="polygon",g="line",m="text",f="image",E={STAGE_NOT_EXIST:"STAGE_NOT_EXIST",ELEMENT_NOT_EXIST:"ELEMENT_NOT_EXIST",FILE_NOT_EXIST:"FILE_NOT_EXIST",CANT_GET_THE_IMAGE:"CANT_GET_THE_IMAGE",UNEXPECTED_INPUT_PARAMS:"UNEXPECTED_INPUT_PARAMS",UNHANDLED_EXCEPTION:"UNHANDLED_EXCEPTION",CANVAS_KEY_NOT_SPECIFIED:"CANVAS_KEY_NOT_SPECIFIED",CANVAS_WITH_KEY_NOT_EXIST:"CANVAS_WITH_KEY_NOT_EXIST",WRONG_TYPE_ERROR:"WRONG_TYPE_ERROR",UNEXPECTED_WS_MESSAGE:"UNEXPECTED_WS_MESSAGE",UNEXPECTED_PLAYER_ID:"UNEXPECTED_PLAYER_ID",UNEXPECTED_BULLET_ID:"UNEXPECTED_BULLET_ID",UNEXPECTED_EVENT_NAME:"UNEXPECTED_EVENT_NAME",WEBGL_ERROR:"WEBGL_ERROR",DRAW_PREPARE_ERROR:"DRAW_PREPARE_ERROR",ANOTHER_STAGE_ACTIVE:"ANOTHER_STAGE_ACTIVE",UNEXPECTED_TILE_ID:"UNEXPECTED_TILE_ID",UNEXPECTED_TOUCH_AREA:"UNEXPECTED TOUCH AREA",UNEXPECTED_METHOD_TYPE:"UNEXPECTED METHOD TYPE"},_="NOT_FOUND",p="WORLD_DIMENSIONS_NOT_SET",b="UNHANDLED_DRAW_ISSUE",T="AUDIO_NOT_REGISTERED",x="AUDIO_NOT_LOADED",R="UNKNOWN_DRAW_OBJECT",A="METHOD_NOT_IMPLEMENTED",v="POLYGON_VERTICES_NOT_CORRECT";function S(e,t){throw new Error(e+": "+t)}function y(e,t){console.warn(e,t)}class w{#e;#t=100;#i;#s;#r;#n;#a;constructor(e,t,i=!1,s,r=!1){this.#e=e,this.#i=this.#o(t),this.#s=s||0,this.#r=r,this.#n=i}get name(){return this.#e}get isActive(){return this.#r}get currentSprite(){return this.#i[this.#s][0]}get _isLastSprite(){return this.#i.length-1===this.#s}iterateAnimationIndex(){const e=this.#s;this.#i[e][1]<Date.now()-this.#a&&(this._isLastSprite?this.#n?this.#s=0:this.deactivateAnimation():this.#s++,this.#a=Date.now())}activateAnimation=()=>{this.#r=!0,this.#s=0,this.#a=Date.now()};deactivateAnimation=()=>{this.#r=!1};#o(e){let t=[];return e.forEach((e=>{"number"==typeof e.id&&"number"==typeof e.duration?t.push([e.id,e.duration]):t.push([e,this.#t])})),t}}class I{#l;#c;#u;#h;#d;#g=0;#m=0;#f=[1,1];#E=Le();#_=!1;#p;#b;#T=!1;constructor(e,t,i,s){this.#l=t,this.#c=i,this.#u=s,this.#h=e}get bgColor(){return this.#u}set bgColor(e){this.#u=e}get type(){return this.#h}get x(){return this.#l}get y(){return this.#c}set x(e){this.#l=e}set y(e){this.#c=e}get sortIndex(){return this.#g}set sortIndex(e){this.#g=e}get blendFunc(){return this.#d}set blendFunc(e){this.#d=e}get rotation(){return this.#m}set rotation(e){this.#m=e}get scale(){return this.#f}set scale(e){"number"==typeof e?this.#f=[e,e]:Array.isArray(e)&&(this.#f=e)}get id(){return this.#E}get isRemoved(){return this.#_}destroy(){this.#_=!0}get isMaskAttached(){return!!this.#p}get _maskId(){return this.#p}setMask(e){e._isMask=!0,this.#p=e.id}removeMask(){this.#p=null}set _isMask(e){this.#b=e}get _isMask(){return this.#b}get isOffsetTurnedOff(){return this.#T}turnOffOffset(){this.#T=!0}_calculateRectVertices=(e,t)=>{const i=e/2,s=t/2;return[[-i,-s],[i,-s],[i,s],[-i,s]]};_interpolateConus(e,t=2*Math.PI,i=Math.PI/14){let s=[0,0];for(let r=0;r<=t;r+=i){let t=Math.cos(r)*e,i=Math.sin(r)*e;s.push(t,i)}return s}_calculateConusBoundaries(e,t=2*Math.PI,i=Math.PI/14){let s=[];for(let r=0;r<=t;r+=i){let t=Math.cos(r)*e,i=Math.sin(r)*e;s.push([t,i])}return s}_convertVerticesArray(e){return void 0!==e[0].x&&void 0!==e[0].y?Ne(e):e}}class O{#x;#R;#A;#v=0;#S=0;#y=0;constructor(e,t){this._initiateStorageData(e,t)}get cells(){return this.#S}get vectors(){return this.#x}get textures(){return this.#R}get _bTempIndexes(){return this.#A}get bufferSize(){return this.#v}_initiateStorageData(e,t){this.#S=e,this.#y=t||e,this.#y>e&&(this.#y=e),this.#v=12*this.#y,this.#x=new Array(this.#v),this.#R=new Array(this.#v),this.#A=new Int32Array(4*this.#S)}}class P{#w;#I;#O;#P;#C="-#-";#M;#L;#D;#N;#B;#p;#g=0;#F=new Map;#T;#_=!1;constructor(e,t,i,s,r,n,a=!1,o){this.#w=e,this.#I=t,this.#O=i,this.#P=s,this.#L=[],this.#M=r,this.#D=n,this.#N=a,this.#B=a||!1,o&&this.setMask(o),this.#W(s,n)}get layerKey(){return this.#w}get tileMapKey(){return this.#I}get tilemap(){return this.#O}get tilesets(){return this.#P}get tilesetImages(){return this.#M}get layerData(){return this.#D}get setBoundaries(){return this.#N}get drawBoundaries(){return this.#B}set drawBoundaries(e){this.#B=e}get isRemoved(){return this.#_}set isRemoved(e){this.#_=e}get _maskId(){return this.#p}setMask(e){e._isMask=!0,this.#p=e.id}removeMask(){this.#p=null}get sortIndex(){return this.#g}set sortIndex(e){this.#g=e}get isOffsetTurnedOff(){return this.#T}turnOffOffset(){this.#T=!0}get hasAnimations(){return this.#F.size>0}get _textureStorages(){return this.#L}_setTextureStorage(e,t){this.#L[e]=t}#W(e,t){let i=0,s=0,r=0;e.forEach(((e,n)=>{const a=e.tiles,o=e.name,l=e.firstgid,c=this.tilesets[n+1],u=c?c.firstgid:1e9;if(a)for(let n of a){const a=n.animation,c=n.objectgroup,u=n.id;if(a){const t=o+this.#C+u,i=this.#j(a),s=new w(t,i,!0);this.#F.set(t,s),e._hasAnimations||(e._hasAnimations=!0,e._animations=new Map,e._animations.set(u,i[0][0])),this.#G(s)}c&&this.#N&&(e._hasBoundaries||(e._hasBoundaries=!0,e._boundaries=new Map),e._boundaries.set(u,c),c.objects.forEach((e=>{if(e.ellipse){const e=t.data.filter((e=>e===u+l)).length;i+=4*e}else if(e.point){const e=t.data.filter((e=>e===u+l)).length;s+=2*e}else if(e.polygon){const i=t.data.filter((e=>e===u+l)).length;r+=2*e.polygon.length*i}else{const e=t.data.filter((e=>e===u+l)).length;r+=16*e}})))}const h=t.data.filter((e=>e>=l&&e<u)).length,d=t.data.length;this.#N&&(r+=16*h),e._temp=new O(d,h)})),t.ellipseBoundariesLen=i,t.pointBoundariesLen=s,t.polygonBoundariesLen=r}#j(e){return e.map((e=>({duration:e.duration,id:e.tileid})))}_processActiveAnimations(){for(let e of this.#F.values())e.isActive&&(e.iterateAnimationIndex(),this.#U(e))}#G=e=>{e.activateAnimation(),this.#U(e)};#U=e=>{const[t,i]=e.name.split(this.#C),s=this.#P.findIndex((e=>e.name===t));this.#P[s]._animations.set(parseInt(i),e.currentSprite)};stopRepeatedAnimation(e){this.#F.get(e).deactivateAnimation()}removeAllAnimations(){for(let[e,t]of this.#F.entries())this.removeEventListener(e,t.activateAnimation),t.deactivateAnimation();this.#F.clear(),this.#F=void 0}destroy(){this.removeAllAnimations(),super.destroy()}}class C extends I{#V;#k;#X;#Y;#z;#F;#H;#K;#Q=0;#Z=0;#q;#J;#$;constructor(e,t,i,s,r,n=0,a,o,l=0,c=0){super(f,e,t),this.#X=r,this.#z=new EventTarget,this.#F=new Map,this.image=o,this.#K=n,this.#Q=l,this.#Z=c,this.#V=i,this.#k=s,this.#q=a&&!a.r?this._convertVerticesArray(a):a&&a.r?this._calculateConusBoundaries(a.r):this._calculateRectVertices(i,s),this.#J=a&&void 0!==a.r?a:null}get width(){return this.#V}get height(){return this.#k}set width(e){this.#V=e}set height(e){this.#k=e}get key(){return this.#X}get image(){return this.#Y}set image(e){this.#$&&(this.#$._isTextureRecalculated=!0),this.#Y=e}get scale(){return super.scale}set scale(e){this.#J?this.#J.r=this.#J.r*e:this.#q=this._calculateRectVertices(this.width*e,this.height*e),super.scale=e}get imageIndex(){return this.#K}set imageIndex(e){this.#K=e}get spacing(){return this.#Q}get margin(){return this.#Z}get hasAnimations(){return this.#F.size>0}get activeAnimation(){return this.#H}get boundaries(){return this.#q}get vertices(){return this.#q}get circleBoundaries(){return this.#J}_processActiveAnimations(){const e=this.#H;if(e){const t=this.#F.get(e);!1===t.isActive?this.#H=null:(t.iterateAnimationIndex(),this.#K=t.currentSprite)}}get _textureStorage(){return this.#$}set _textureStorage(e){this.#$=e}emit(e,...t){const i=new Event(e);i.data=[...t],this.#z.dispatchEvent(i)}addEventListener(e,t,i){this.#z.addEventListener(e,t,i)}removeEventListener(e,t,i){this.#z.removeEventListener(e,t,i)}addAnimation(e,t,i){this.#ee(t)||S(E.UNEXPECTED_INPUT_PARAMS," animationSpriteIndexes should be Array of indexes, or Array of objects {duration:number, id:number}");const s=new w(e,t,i);this.#F.set(e,s),this.addEventListener(e,this.#G)}#ee(e){let t=!0;return e.forEach((e=>{"number"!=typeof e&&("number"==typeof e.duration&&"number"==typeof e.id||(t=!1))})),t}#G=e=>{const t=e.type,i=this.#F.get(t);this.#H&&this.#H!==t&&this.stopRepeatedAnimation(this.#H),i.activateAnimation(),this.#H=t,this.#K=i.currentSprite};stopRepeatedAnimation(e){this.#F.get(e).deactivateAnimation(),this.#H=null}removeAllAnimations(){for(let[e,t]of this.#F.entries())this.removeEventListener(e,t.activateAnimation),t.deactivateAnimation();this.#F.clear(),this.#F=void 0}destroy(){this.removeAllAnimations(),super.destroy()}}class M extends I{#te;#q;constructor(e,t,i,s){super(h,e,t,s),this.#te=i,this.#q=this._interpolateConus(i)}get scale(){return super.scale}set scale(e){this.#q=this._interpolateConus(this.#te*e),super.scale=e}get vertices(){return this.#q}set vertices(e){this.#q=e}get radius(){return this.#te}}class L extends I{#te;#ie;#q;#se;constructor(e,t,i,s,r,n=0){super(u,e,t,s),this.#te=i,this.#ie=r,this.#se=n,this.#q=this._interpolateConus(i,r)}get scale(){return super.scale}set scale(e){this.#q=this._interpolateConus(this.#te*e,this.#ie),super.scale=e}get vertices(){return this.#q}set vertices(e){this.#q=e}get radius(){return this.#te}get angle(){return this.#ie}get fade_min(){return this.#se}set fade_min(e){this.#se=e}}class D extends I{#q;constructor(e,t){super(g,e[0][0],e[0][1],t),this.#q=e}get scale(){return super.scale}set scale(e){super.scale=e}get vertices(){return this.#q}set vertices(e){this.#q=e}}class N extends I{#q;constructor(e,t){super(d,e[0].x,e[0].y,t),this.#q=this._convertVerticesArray(e)}get scale(){return super.scale}set scale(e){super.scale=e}get vertices(){return this.#q}set vertices(e){this.#q=e}}class B extends I{#V;#k;#q;constructor(e,t,i,s,r){super(c,e,t,r),this.#V=i,this.#k=s,this.#q=this._calculateRectVertices(i,s)}get scale(){return super.scale}set scale(e){super.scale=e}get vertices(){return this.#q}get width(){return this.#V}get height(){return this.#k}set width(e){this.#V=e}set height(e){this.#k=e}}class F{#l;#c;constructor(e,t){this.#l=e,this.#c=t}get x(){return this.#l}get y(){return this.#c}}class W{#l;#c;#V;#k;constructor(e,t,i,s){this.#l=e,this.#c=t,this.#V=i,this.#k=s}get x(){return this.#l}get y(){return this.#c}get width(){return this.#V}get height(){return this.#k}}class j{#l;#c;constructor(e,t,i,s){this.#l=i-e,this.#c=s-t}get x(){return this.#l}get y(){return this.#c}get length(){return Math.sqrt(Math.pow(this.#l,2)+Math.pow(this.#c,2))}get tetaAngle(){return Math.atan2(this.#c,this.#l)}}class G{#re;#l;#c;#V;#k;#ne=!1;constructor(e,t){this.#V=e,this.#k=t}get x(){return this.#l}get y(){return this.#c}get width(){return this.#V}get height(){return this.#k}get atlasIndex(){return this.#re}get isMeasurementsSet(){return this.#ne}_setMeasurements(e,t,i){this.#l=t,this.#c=i,this.#re=e,this.#ne=!0}}class U extends I{#ae;#oe;#le;#ce;#ue;#he;#de;#ge=document.createElement("canvas");#me=!1;#fe;constructor(e,t,i,s,r,n,a){super(m,e,t),this.#he=i,this.#ae=s,this.#ce=r,this.#de,this.#Ee(n,a)}get boundariesBox(){const e=this._atlasPos.width,t=this._atlasPos.height;return new W(this.x,this.y-t,e,t)}get vertices(){const e=this.boundariesBox;return this._calculateRectVertices(e.width,e.height)}get text(){return this.#he}set text(e){e!==this.#he&&(this.#he=e,this.#Ee())}get font(){return this.#ae}set font(e){e!==this.#ae&&(this.#ae=e,this.#Ee())}get textAlign(){return this.#oe}set textAlign(e){e!==this.#oe&&(this.#oe=e,this.#Ee())}get textBaseline(){return this.#le}set textBaseline(e){e!==this.#le&&(this.#le=e,this.#Ee())}get fillStyle(){return this.#ce}set fillStyle(e){e!==this.#ce&&(this.#ce=e,this.#Ee())}get strokeStyle(){return this.#ue}set strokeStyle(e){e!==this.#ue&&(this.#ue=e,this.#Ee())}get scale(){return super.scale}set scale(e){super.scale=e}get textMetrics(){return this.#de}set _textMetrics(e){this.#de=e}get _textureCanvas(){return this.#ge}get _atlasPos(){return this.#fe}get _isTextureUpdated(){return this.#me}_setTextureUpdated(){this.#me=!1}#Ee(e,t){const i=this.#ge.getContext("2d",{willReadFrequently:!0});i?(i.font=this.font,this._textMetrics=i.measureText(this.text),this._atlasPos?(e=this._atlasPos.width,t=this._atlasPos.height):(e||(e=Math.floor(this.textMetrics.width)),t||(t=Math.floor(this.textMetrics.fontBoundingBoxAscent+this.textMetrics.fontBoundingBoxDescent)),this.#fe=new G(e,t)),i.canvas.width=e,i.canvas.height=t,i.clearRect(0,0,e,t),i.font=this.font,i.textBaseline="bottom",this.fillStyle&&(i.fillStyle=this.fillStyle,i.fillText(this.text,0,t)),this.strokeStyle&&(i.strokeStyle=this.strokeStyle,i.strokeText(this.text,0,t)),this.#me=!0):S(E.UNHANDLED_EXCEPTION,"can't getContext('2d')")}}class V{#_e;#pe;#be;#Te;#xe=0;#Re=0;#Ae=0;#ve=0;#Se=0;#ye=0;#we=0;#Ie=0;#Oe=0;#Pe=0;#Ce=0;#Me;#Le;#De;#Ne;#Be=[];#Fe=[];#T;#We=!1;#je=[];#Ge=!1;constructor(e){}isOffsetTurnedOff(){return this.#T}set mapRotate(e){this.#Se=e}#Ue(e){this._addBoundaryLine(e.x1,e.y1,e.x2,e.y2)}_addImageDebugBoundaries(e){const t=e.length;for(let i=0;i<t;i++)this.#je.push(...e[i])}_enableDebugObjectBoundaries(){this.#Ge=!0}_addBoundariesArray(e){const t=e.length;for(let i=0;i<t;i++){const t=e[i];this._addBoundaryLine(t[0],t[1],t[2],t[3])}}_addBoundaryLine(e,t,i,s){this.#Me[this.#Oe]=e,this.#Oe++,this.#Me[this.#Oe]=t,this.#Oe++,this.#Me[this.#Oe]=i,this.#Oe++,this.#Me[this.#Oe]=s,this.#Oe++}_addEllipseBoundary(e,t,i,s){this.#Le[this.#Ce]=e,this.#Ce++,this.#Le[this.#Ce]=t,this.#Ce++,this.#Le[this.#Ce]=i,this.#Ce++,this.#Le[this.#Ce]=s,this.#Ce++}_addPointBoundary(e,t){this.#De[this.#Pe]=e,this.#Pe++,this.#De[this.#Pe]=t,this.#Pe++}_removeBoundaryLine(e){this.#Me[e]=0,this.#Me[e+1]=0,this.#Me[e+2]=0,this.#Me[e+3]=0}_clearBoundaries(){this.#Me.fill(0),this.#Le.fill(0),this.#De.fill(0),this.#Oe=0,this.#Ce=0,this.#Pe=0,this.#Ge&&(this.#je=[])}_initiateBoundariesData(){this.#Me=new Float32Array(this.#ye),this.#Le=new Float32Array(this.#we),this.#De=new Float32Array(this.#Ie)}_setMaxBoundariesSize(e,t=0,i=0){this.#ye=e,this.#we=t,this.#Ie=i}_setWorldDimensions(e,t){this.#_e=e,this.#pe=t}_setCanvasDimensions(e,t){this.#be=e,this.#Te=t}_setMapBoundaries(){const[e,t]=[this.#_e,this.#pe],[i,s]=[this.#xe,this.#Re],r=e-i,n=t-s;e&&t||y(p,"Can't set map boundaries."),this.#Ue({x1:0,y1:0,x2:r,y2:0}),this.#Ue({x1:r,y1:0,x2:r,y2:n}),this.#Ue({x1:r,y1:n,x2:0,y2:n}),this.#Ue({x1:0,y1:n,x2:0,y2:0})}_setWholeWorldMapBoundaries(){const[e,t]=[this.#_e,this.#pe];e&&t||y(p,"Can't set map boundaries."),this.#Ne.push([0,0,e,0]),this.#Ne.push([e,0,e,t]),this.#Ne.push([e,t,0,t]),this.#Ne.push([0,t,0,0])}_mergeBoundaries(e=!1){const t=e?this.getWholeWorldBoundaries():this.getBoundaries(),i=new Set(t);for(const e of i.values()){const t=e[0],s=e[1],r=e[2],n=e[3];for(const a of i.values()){const o=a[0],l=a[1],c=a[2],u=a[3];t===c&&s===u&&r===o&&n===l&&(i.delete(e),i.delete(a)),r!==o||n!==l||t!==c&&s!==u||(a[0]=t,a[1]=s,i.delete(e))}}e?this.#Me=Array.from(i):this.#Ne=Array.from(i),i.clear()}_setWholeMapBoundaries(e){this.#Ne.push(...e)}_enableMapBoundaries(){this.#We=!0}_sortRenderObjectsBySortIndex(){this.#Be.sort(((e,t)=>e.sortIndex-t.sortIndex))}_processPendingRenderObjects(){this.#Fe.length>0&&(this.#Be.push(...this.#Fe),this._sortRenderObjectsBySortIndex(),this.#Fe=[])}set _renderObject(e){this.#Fe.push(e)}set _renderObjects(e){e.forEach((e=>{this._renderObject=e}))}getBoundaries(){const e=this.#Me,t=this.#Oe;let i=[],s=[];for(let r=0;r<t;r++){const t=e[r];i.push(t),(r+1)%4==0&&(s.push(i),i=[])}return s}getRawBoundaries(){return this.#Me}getEllipseBoundaries(){return this.#Le}getPointBoundaries(){return this.#De}getWholeWorldBoundaries(){return this.#Ne}getDebugObjectBoundaries(){return this.#je}get isWorldBoundariesEnabled(){return this.#We}get canvasDimensions(){return[this.#be,this.#Te]}get worldDimensions(){return[this.#_e,this.#pe]}get worldOffset(){return[this.#xe,this.#Re]}get mapCenter(){return[this.#Ae,this.#ve]}get mapRotate(){return this.#Se}get boundariesLen(){return this.#Oe}get ellipseBLen(){return this.#Ce}get pointBLen(){return this.#Pe}centerCameraPosition=(e,t)=>{let[i,s]=this.worldOffset;const[r,n]=this.canvasDimensions,[a,o]=this.worldDimensions,l=r/2,c=n/2,u=c-s;if(l-i<e)if(e<a-l){const t=e-l;t>=0&&(this.#xe=Math.round(t))}else if(a>r){const e=a-r;this.#xe=Math.round(e)}if(u<t)if(t<o-c){const e=t-c;e>=0&&(this.#Re=Math.round(e))}else if(o>n){const e=o-n;this.#Re=Math.round(e)}this.#Ae=e,this.#ve=t};personRotatedCenterCamera=(e,t,i)=>{console.log("new centering algorithm")};get renderObjects(){return this.#Be}getObjectsByInstance(e){return this.#Be.filter((t=>t instanceof e))}cleanUp(){this.#Be=[],this.#Fe=[],this._clearBoundaries()}}const k={loadstart:"loadstart",progress:"progress",abort:"abort",error:"error",load:"load",timeout:"timeout"},X=" loader is not registered.",Y="Too much recursion. Stop iteration.",z="uploadMethod should be instance of Promise and return upload result value",H=" AtlasXML file extension is incorrect, only .xml file supported",K=" tilemap file extension is not correct, only .tmj, .json, .tmx, .xml files are supported",Q=" fileKey and url should be provided",Z="Error loading related tileset ",q="JSON",J="XML",$="UNKNOWN";class ee{#Ve;#ke;#Xe=new Map;#Ye=new Map;constructor(e,t){this.#Ve=e,this.#ke=(e,i,...s)=>{const r=t(e,i,...s);if(r instanceof Promise)return r.then((t=>this.#ze(t,e)));throw new TypeError(z)}}#ze=(e,t)=>new Promise(((i,s)=>{e||null===e||se("AssetsManager: uploadMethod for "+this.#Ve+" returns incorrect value"),this.#He(t,e),this.#Ke(t),i()}));#He(e,t){this.#Ye.set(e,t)}#Ke(e){this.#Xe.delete(e)}get filesWaitingForUpload(){return this.#Xe.size}get loadingQueue(){return this.#Xe}get uploadMethod(){return this.#ke}_addFile=(e,t)=>{this.#Xe.has(e)&&se("AssetsManager: File "+this.#Ve+" with key "+e+" is already added"),this.#Xe.set(e,t)};_isFileInQueue=e=>this.#Xe.has(e);_getFile=e=>this.#Ye.get(e)}class te{#Qe=5;#z=new EventTarget;#Ze=new Map;#qe=0;constructor(){this.registerLoader("Audio",this._loadAudio),this.registerLoader("Image",this._loadImage),this.registerLoader("TileMap",this._loadTileMap),this.registerLoader("TileSet",this._loadTileSet),this.registerLoader("AtlasImageMap",this._loadAtlasImage),this.registerLoader("AtlasXML",this._loadAtlasXml)}get filesWaitingForUpload(){let e=0;return Array.from(this.#Ze.values()).map((t=>e+=t.filesWaitingForUpload)),e}registerLoader=(e,t=this._defaultUploadMethod)=>{this["add"+e]=(t,i,...s)=>{this.addFile(e,t,i,...s)},this["get"+e]=t=>this.getFile(e,t),this["is"+e+["InQueue"]]=t=>this.isFileInQueue(e,t);const i=this.#Ze.get(e)||new ee(e,t);this.#Ze.set(e,i)};preload(){return this.#Je(),new Promise((async(e,t)=>{this.#$e().then((()=>{this.#et(),e()})).catch((e=>{t(e)}))}))}#$e(e=0){return this.#tt().then((()=>{if(0===this.filesWaitingForUpload)return Promise.resolve();if(++e>this.#Qe){const e=new Error(Y);return this.#it(e),Promise.reject(new Error(Y))}return this.#$e(e)}))}#tt(){return new Promise(((e,t)=>{let i=[];Array.from(this.#Ze.values()).forEach((e=>{Array.from(e.loadingQueue.entries()).forEach((t=>{const s=new Promise(((i,s)=>e.uploadMethod(t[0],...t[1]).then((()=>i()))));i.push(s)}))})),Promise.allSettled(i).then((i=>{for(const e of i)if("rejected"===e.status){const i=e.reason;this.#st(i)?t(i):(se("AssetsManager: "+i.message),this.#it(i))}e()}))}))}addEventListener(e,t,...i){k[e]?this.#z.addEventListener(e,t,...i):se("AssetsManager: Event type should be one of the ProgressEvent.type")}removeEventListener(e,t,...i){this.#z.removeEventListener(e,t,...i)}_loadAtlasXml=(e,t)=>(this.#rt(t),fetch(t).then((e=>e.text())).then((e=>(new window.DOMParser).parseFromString(e,"text/xml"))).then((i=>{const s=i.documentElement||i.activeElement,r=s.attributes.getNamedItem("imagePath"),n=s.children;if(r){const i=this.#nt(t);return this.addAtlasImageMap(e,i+r.value,n,i),s}{const t=new Error(e+" XML format is not correct.");return this.#it(t),t}})));_loadAtlasImage=(e,t,i,s="anonymous")=>new Promise(((e,r)=>{const n=new Image,a=new Map,o=document.createElement("canvas"),l=o.getContext("2d");n.crossOrigin=s,n.onload=()=>{const t=[];let s=[];o.width=n.width,o.height=n.height,l.drawImage(n,0,0);for(let e of i){const i=e.attributes,r=i.getNamedItem("name").value,n=r.includes(".")?r.split(".")[0]:r,a=i.getNamedItem("x").value,o=i.getNamedItem("y").value,c=i.getNamedItem("width").value,u=i.getNamedItem("height").value;t.push(createImageBitmap(l.getImageData(a,o,c,u),{premultiplyAlpha:"premultiply"})),s.push(n)}this.#at(),Promise.all(t).then((t=>{t.forEach(((e,t)=>{const i=s[t];a.set(i,e),this.addImage(i,"empty url",e)})),o.remove(),e(a)}))},n.onerror=()=>{const i=new Error("Error loading atlas image "+t);this.#it(i),e(null)},n.src=t}));_loadTileSet=(e,t,i=1,s)=>{const r=this.#ot(t),n=s?s+t:t;return r===q?fetch(n).then((e=>e.json())).then((e=>this._processTilesetData(e,s,i,t))).catch((()=>{const e=new Error(Z+t);return this.#it(e),Promise.resolve(null)})):r===J?fetch(n).then((e=>e.text())).then((e=>(new window.DOMParser).parseFromString(e,"text/xml"))).then((e=>this._processTilesetXmlData(e.documentElement))).then((e=>this._processTilesetData(e,s,i,t))).catch((()=>{const e=new Error(Z+t);return this.#it(e),Promise.resolve(null)})):Promise.reject(n+K)};_processTilesetXmlData=e=>{const t={columns:Number(e.attributes?.columns?.value),name:e.attributes?.name?.value,tilecount:Number(e.attributes?.tilecount?.value),tiledversion:e.attributes?.tiledversion?.value,tileheight:Number(e.attributes?.tileheight?.value),tilewidth:Number(e.attributes?.tilewidth?.value),version:e.attributes?.version?.value,margin:e.attributes?.margin?Number(e.attributes.margin.value):0,spacing:e.attributes?.spacing?Number(e.attributes.margin.value):0,type:e.tagName};return this._processTilesetXmlChildData(t,e.childNodes),t};_processTilesetXmlChildData(e,t){for(let i=0;i<t.length;i++){const s=t[i],r=s.nodeName;if("image"===r)e.image=s?.attributes?.source?.value,e.imagewidth=s?.attributes?.width?Number(s.attributes.width.value):0,e.imageheight=s?.attributes?.height?Number(s.attributes.height.value):0;else if("tileoffset"===r)e.tileoffset={x:Number(s.attributes.x.value),y:Number(s.attributes.y.value)};else if("tile"===r){e.tiles||(e.tiles=[]);const t={id:Number(s.attributes?.id?.value)},i=s.childNodes;for(let e=0;e<i.length;e++){const s=i[e],r=s.nodeName;if("objectgroup"===r){t.objectgroup={type:r},s.attributes?.id&&(t.objectgroup.id=Number(s.attributes?.id?.value)),s.attributes?.draworder&&(t.objectgroup.draworder=s.attributes.draworder.value),s.attributes?.opacity&&(t.objectgroup.opacity=s.attributes.opacity.value),s.attributes?.x&&s.attributes?.y&&(t.objectgroup.x=s.attributes.x.value,t.objectgroup.y=s.attributes.y.value),t.objectgroup.objects=[];const e=s.childNodes;for(let i=0;i<e.length;i++){const s=e[i];if("object"===s.nodeName){const e={id:Number(s.attributes?.id?.value),visible:!s.attributes.visible||"0"!==s.attributes.visible.value,x:Number(s.attributes?.x?.value),y:Number(s.attributes?.y?.value),rotation:s.attributes?.rotation?Number(s.attributes.rotation.value):0};s.attributes?.width&&(e.width=Number(s.attributes.width.value)),s.attributes?.height&&(e.height=Number(s.attributes.height.value));const i=s.childNodes;if(i&&i.length>0)for(let t=0;t<i.length;t++){const s=i[t];if("ellipse"===s.nodeName)e.ellipse=!0;else if("point"===s.nodeName)e.point=!0;else if("polygon"===s.nodeName){const t=s.attributes?.points?.value;if(t&&t.length>0){const i=t.split(" ").map((e=>{const[t,i]=e.split(",");return{x:Number(t),y:Number(i)}}));e.polygon=i}}}t.objectgroup.objects.push(e)}}}else if("animation"===r){t.animation=[];const e=s.childNodes;for(let i=0;i<e.length;i++){const s=e[i];if("frame"===s.nodeName){const e={tileid:Number(s.attributes?.tileid?.value),duration:Number(s.attributes?.duration?.value)};t.animation.push(e)}}}}e.tiles.push(t)}}}_processTilesetData=(e,t,i,s)=>{const{name:r,image:n}=e;return r&&n&&!this.isFileInQueue("Image",r)&&this.addImage(r,t?t+n:n),i&&(e.firstgid=i),s&&(e.source=s),Promise.resolve(e)};_defaultUploadMethod=(e,t)=>fetch(t);_loadTileMap=(e,t,i=!0)=>{let s;return s=this.#lt(t)===q?fetch(t).then((e=>e.json())).then((e=>this._processTileMapData(e,t,i))).catch((e=>(e.message.includes("JSON.parse:")&&(e=new Error("Error loading tilemap "+t)),this.#it(e),Promise.resolve(null)))):fetch(t).then((e=>e.text())).then((e=>this._processTileMapXML(e))).then((e=>this._processTileMapData(e,t,i))).catch((e=>(this.#it(e),Promise.resolve(null)))),s};_processTileMapXML=e=>{const t=(new DOMParser).parseFromString(e,"text/xml"),i=t.documentElement,s={type:i.tagName,width:Number(i.attributes?.width?.value),height:Number(i.attributes?.height?.value),infinite:!(!i.attributes.infinite||"1"!==i.attributes.infinite.value),nextlayerid:Number(i.attributes?.nextlayerid?.value),nextobjectid:Number(i.attributes?.nextobjectid?.value),orientation:i.attributes?.orientation?.value,renderorder:i.attributes?.renderorder?.value,tiledversion:i.attributes?.tiledversion?.value,tileheight:Number(i.attributes?.tileheight?.value),tilewidth:Number(i.attributes?.tilewidth?.value),version:i.attributes?.version?.value,tilesets:[],layers:[]},r=t.documentElement.childNodes;for(let e=0;e<r.length;e++){const t=r[e],i=t.nodeName;if("tileset"===i){const e={firstgid:Number(t.attributes?.firstgid?.value)};t.attributes?.source?e.source=t.attributes?.source?.value:(e.columns=Number(t.attributes?.columns?.value),t.attributes?.margin&&(e.margin=Number(t.attributes?.margin?.value)),t.attributes?.spacing&&(e.spacing=t.attributes?.spacing?.value),e.name=t.attributes?.name?.value,e.tilecount=Number(t.attributes?.tilecount?.value),e.tilewidth=Number(t.attributes?.tilewidth?.value),e.tileheight=Number(t.attributes?.tileheight?.value),this._processTilesetXmlChildData(e,t.childNodes)),s.tilesets.push(e)}else if("layer"===i){const e={height:Number(t.attributes?.height?.value),id:Number(t.attributes?.id?.value),name:t.attributes?.name?.value,width:Number(t.attributes?.width?.value),data:t.textContent?t.textContent.trim().split(",").map((e=>Number(e))):null};s.layers.push(e)}}return s};_processTileMapData=(e,t,i)=>{const s=this.#nt(t);if(!0===i&&e.tilesets&&e.tilesets.length>0){const t=[];return e.tilesets.forEach(((e,i)=>{const{firstgid:r,source:n}=e;if(n){const e=this._loadTileSet("default-"+r,n,r,s).then((e=>(this.#at(),Promise.resolve(e))));t.push(e)}else{const i=this._processTilesetData(e,s).then((e=>(this.#at(),Promise.resolve(e))));t.push(i)}})),Promise.all(t).then((t=>{for(let i=0;i<t.length;i++){const s=t[i];e.tilesets[i]=s,e.tilesets[i].data=Object.assign({},s)}return Promise.resolve(e)}))}return Promise.resolve(e)};_loadAudio=(e,t)=>new Promise((e=>{const i=new Audio(t);i.addEventListener("loadeddata",(()=>{this.#at(),e(i)})),i.addEventListener("error",(()=>{const i=new Error("Error loading audio "+t);this.#it(i),e(null)}))}));_loadImage=(e,t,i,s="anonymous")=>new Promise(((e,r)=>{if(i)e(i);else{const i=new Image;i.crossOrigin=s,i.onload=()=>{createImageBitmap(i,{premultiplyAlpha:"premultiply"}).then((t=>{this.#at(),e(t)}))},i.onerror=()=>{const i=new Error("Error loading image "+t);this.#it(i),e(null)},i.src=t}}));#rt(e){e.includes(".xml")||ie(e+H)}#ot(e){return e.includes(".tsj")||e.includes(".json")?q:e.includes(".tsx")||e.includes(".xml")?J:$}#lt(e){return e.includes(".tmj")||e.includes(".json")?q:e.includes(".tmx")||e.includes(".xml")?J:$}#st(e){return e.message.includes(z)||e.message.includes(H)||e.message.includes(" tileset file extension is not correct, only .tsj, .json, .tsx, .xml files are supported")||e.message.includes(K)||e.message.includes(Q)||e.message.includes(X)}#nt(e){let t=e.split("/"),i=t[t.length-1],s="/";return(i.includes(".tmj")||i.includes(".tmx")||i.includes(".xml")||i.includes(".json"))&&(t.pop(),s=t.join("/")+"/"),s}addFile(e,t,i,...s){const r=this.#Ze.get(e);r?(this.#ct(t,i,e),r._addFile(t,[i,...s])):ie(e+X)}isFileInQueue(e,t){const i=this.#Ze.get(e);if(i)return i._isFileInQueue(t);ie("Loader for "+e+" is not registered!")}getFile(e,t){const i=this.#Ze.get(e);if(i)return i._getFile(t);ie("Loader for "+e+" is not registered!")}#ct(e,t,i){const s=Q;e&&0!==e.trim().length||ie("add"+i+"()"+s),t&&0!==t.trim().length||ie("add"+i+"()"+s)}#Je(){let e=this.filesWaitingForUpload;this.#z.dispatchEvent(new ProgressEvent(k.loadstart,{total:e}))}#et(){this.#z.dispatchEvent(new ProgressEvent(k.load))}#at(){const e=this.filesWaitingForUpload;this.#qe+=1,this.#z.dispatchEvent(new ProgressEvent(k.progress,{lengthComputable:!0,loaded:this.#qe,total:e}))}#it(e){se("AssetsManger: "+e.message),this.#z.dispatchEvent(new ErrorEvent(k.error,{error:e}))}}function ie(e){throw new Error(e)}function se(e){console.warn(e)}class re{#ut;#ht;constructor(e){this.#ut=e}get stageData(){return this.#ht}#dt(e){this.#ht._renderObject=e}rect(e,t,i,s,r){const n=new B(e,t,i,s,r);return this.#dt(n),n}text(e,t,i,s,r,n,a){const o=new U(e,t,i,s,r,n,a);return this.#dt(o),o}conus(e,t,i,s,r,n=0){const a=new L(e,t,i,s,r,n);return this.#dt(a),a}circle(e,t,i,s){const r=new M(e,t,i,s);return this.#dt(r),r}image(e,t,i,s,r,n=0,a,o=0,l=0){const c=this.#ut.getImage(r);c||S(E.CANT_GET_THE_IMAGE,"iLoader can't get the image with key: "+r);const u=new C(e,t,i,s,r,n,a,c,o,l);return this.#dt(u),u}line(e,t){const i=new D(e,t);return this.#dt(i),i}polygon(e,t){const i=new N(e,t);return this.#dt(i),i}tiledLayer(e,t,i,s){const r=this.#ut.getTileMap(t),n=Object.assign({},r.layers.find((t=>t.name===e))),a=Array.from(new Set(n.data.filter((e=>0!==e)))).sort(((e,t)=>e-t)),o=r.tilesets.map((e=>Object.assign({},e))).filter((e=>{const t=e.firstgid,i=t+e.tilecount;return!!a.find((e=>e>=t&&e<i))})),l=o.map((e=>this.#ut.getImage(e.name))),c=new P(e,t,r,o,l,n,i,s);return l.length>1&&y("MULTIPLE_IMAGE_TILESET"," tileset "+e+" includes multiple images, it can case performance issues!"),this.#dt(c),c}_registerNewObjectMethod=(e,t)=>{this[e]=(...e)=>this.#gt(t,...e)};#gt=(e,...t)=>{const i=e(...t);return this.#dt(i),i};_attachPageData=e=>{this.#ht=e};_detachPageData=()=>{this.#ht=null}}const ne={mode:l.MODE.DEBUG,gameOptions:{library:l.LIBRARY.WEBGL,optimization:l.OPTIMIZATION.NATIVE_JS.OPTIMIZED,optimizationWASMUrl:"./src/wa/calculateBufferDataWat.wasm",optimizationAssemblyUrl:"/src/wa/calculateBufferDataAssembly.wasm",loadingScreen:{backgroundColor:"rgba(128, 128, 128, 0.6)",loadingBarBg:"rgba(128, 128, 128, 1)",loadingBarProgress:"rgba(128, 128, 128, 0.2)"},render:{cyclesTimeCalc:{check:l.OPTIMIZATION.CYCLE_TIME_CALC.AVERAGES,averageFPStime:1e4},boundaries:{mapBoundariesEnabled:!0,realtimeCalculations:!0,wholeWorldPrecalculations:!1},textAtlasMaxSize:500},debug:{preserveDrawingBuffer:!1,checkWebGlErrors:!1,debugMobileTouch:!1,boundaries:{drawLayerBoundaries:!1,drawObjectBoundaries:!1,boundariesColor:"rgba(224, 12, 21, 0.6)",boundariesWidth:2},delayBetweenObjectRender:!1}},network:{enabled:!1,address:"https://gameserver.reslc.ru:9009",gatherRoomsInfoInterval:5e3},canvasMaxSize:{width:1800,height:1800},worldSize:{width:960,height:960},defaultCanvasKey:"default",customSettings:{}};class ae{static debug(...e){ne.mode===l.MODE.DEBUG&&e.forEach((e=>console.log(e)))}}class oe extends Event{#mt;constructor(e,t){super(e),this.#ft(e)||S(E.UNEXPECTED_EVENT_NAME,", Please check if event is exist"),this.#mt=t}#ft(e){return Object.values(l.EVENTS.WEBSOCKET.SERVER_CLIENT).find((t=>t===e))}get data(){return this.#mt}}class le extends EventTarget{#Et;#_t;constructor(e){super(),e||S(E.CREATE_INSTANCE_ERROR,"systemSettings should be passed to class instance"),this.#Et=e}init(){r.e(319).then(r.bind(r,319)).then((e=>{this.#_t=e.io(this.#Et.network.address,{withCredentials:!0}),this.#pt()}))}get isServerConnected(){return!(!this.#_t||!this.#_t.connected)}get playerId(){return this.#_t.id}sendGatherRoomsInfo(){this.#_t.emit(l.EVENTS.WEBSOCKET.CLIENT_SERVER.ROOMS_INFO_REQUEST)}sendCreateOrJoinRoom(e,t){this.#_t.emit(l.EVENTS.WEBSOCKET.CLIENT_SERVER.CREATE_OR_JOIN,e,t)}sendMessage(e){this.#_t.emit(l.EVENTS.WEBSOCKET.CLIENT_SERVER.CLIENT_MESSAGE,e)}#bt=()=>{ae.debug("connected, socket id: "+this.#_t.id),this.dispatchEvent(new Event(l.EVENTS.WEBSOCKET.SERVER_CLIENT.CONNECTION_STATUS_CHANGED))};#Tt=e=>{ae.debug("server disconnected, reason: "+e),this.dispatchEvent(new Event(l.EVENTS.WEBSOCKET.SERVER_CLIENT.CONNECTION_STATUS_CHANGED))};#xt=e=>{console.warn("server data: ",e)};#Rt=e=>{ae.debug("received new message from server: "+e),this.dispatchEvent(new oe(l.EVENTS.WEBSOCKET.SERVER_CLIENT.SERVER_MESSAGE,e))};#At=e=>{ae.debug("received roomsInfo "+e),this.dispatchEvent(new oe(l.EVENTS.WEBSOCKET.SERVER_CLIENT.ROOMS_INFO,e))};#vt=(e,t)=>{ae.debug("CLIENT SOCKET: Created room  "+e),this.dispatchEvent(new oe(l.EVENTS.WEBSOCKET.SERVER_CLIENT.CREATED,{room:e,map:t}))};#St=e=>{ae.debug("CLIENT SOCKET: Room is full, can't join: "+e),this.dispatchEvent(new oe(l.EVENTS.WEBSOCKET.SERVER_CLIENT.FULL,{room:e}))};#yt=(e,t)=>{ae.debug("CLIENT SOCKET: Joined to room: "+e,", map: ",t),this.dispatchEvent(new oe(l.EVENTS.WEBSOCKET.SERVER_CLIENT.JOINED,{room:e,map:t}))};#wt=e=>{this.dispatchEvent(new oe(l.EVENTS.WEBSOCKET.SERVER_CLIENT.DISCONNECTED,{playerId:e}))};#pt(){this.#_t.on("connect",this.#bt),this.#_t.on("disconnect",this.#Tt),this.#_t.on("data",this.#xt),this.#_t.on("roomsInfo",this.#At),this.#_t.on("created",this.#vt),this.#_t.on("full",this.#St),this.#_t.on("joined",this.#yt),this.#_t.on("log",(function(e){console.log.apply(console,e)})),this.#_t.on("message",this.#Rt),this.#_t.on("removed",(function(e){console.log("removed message"),console.log(e)})),this.#_t.on("disconnected",this.#wt),addEventListener("beforeunload",this.#It)}#It=()=>{this.#_t.disconnect()}}class ce{#Ot=.5;#Pt=new Map;#Ct;constructor(e){this.#Ct=e}getAudio=e=>{const t=this.#Pt.get(e);return null===t?(y(x,"Audio with key "+e+" exists, but not actually loaded"),t):t||(y(T,""),null)};getAudioCloned=e=>{const t=this.#Pt.get(e);if(null===t)return y(x,"Audio with key "+e+" exists, but not actually loaded"),t;if(t){const e=t.cloneNode();return e.volume=this.#Ot,e}return y(T),null};set volume(e){this.#Ot=e,this.#Mt(e)}get volume(){return this.#Ot}#Mt(e){for(const t of this.#Pt.values())t&&(t.volume=e)}registerAudio(e){let t=this.#Ct.getAudio(e);this.#Pt.set(e,t)}}function ue(){return/Android|webOS|iPhone|iPad|iPod|Opera Mini/i.test(navigator.userAgent)}function he(){return/^((?!chrome|android).)*safari/i.test(navigator.userAgent)}function de(e,t,i){return new j(e,t,i.x,i.y).length-i.r}function ge(e,t){const i=t.x1,s=t.y1,r=t.x2,n=t.y2,a=e.x1,o=e.y1,l=i,c=s,u=r-i,h=n-s,d=a,g=o,m=e.x2-a,f=e.y2-o,E=Math.sqrt(u*u+h*h),_=Math.sqrt(m*m+f*f);if(u/E==m/_&&h/E==f/_)return null;const p=(u*(g-c)+h*(l-d))/(m*h-f*u),b=(d+m*p-l)/u;return b<0||isNaN(b)||p<0||p>1?null:{x:l+u*b,y:c+h*b,p:b}}function me(e,t){const i=t.x1,s=t.y1,r=t.x2,n=t.y2,a=e.x1,o=e.y1,l=e.x2,c=e.y2,u=(i-r)*(o-c)-(s-n)*(a-l);if(0===u)return;let h=((i*n-s*r)*(a-l)-(i-r)*(a*c-o*l))/u,d=((i*n-s*r)*(o-c)-(s-n)*(a*c-o*l))/u;const g={x:h,y:d};return Te(g,e,1e-13)&&Te(g,t,1e-13)?{x:h,y:d,p:Math.sqrt(Math.pow(h-i,2)+Math.pow(d-s,2))}:void 0}function fe(e,t,i,s){return Math.atan2(s-t,i-e)}function Ee(e,t,i){const s=e.x-t.x,r=i.x-t.x,n=e.y-t.y,a=i.y-t.y,o=Math.sqrt(s*s+n*n),l=Math.sqrt(r*r+a*a);return Math.acos((s*r+n*a)/(o*l))}function _e(e,t,i){return e*t*Math.cos(i)}function pe(e,t){return e.x*t.x+e.y*t.y}function be(e,t){return e.x*t.y-t.x*e.y}function Te(e,t,i=0){return(e.x>=t.x1-i&&e.x<=t.x2+i||e.x<=t.x1+i&&e.x>=t.x2-i)&&(e.y>=t.y1-i&&e.y<=t.y2+i||e.y<=t.y1+i&&e.y>=t.y2-i)}function xe(e,t){return new j(e.x,e.y,t.x,t.y).length}function Re(e,t){return new j(e.x1,e.y1,e.x2,e.y2).length<new j(t.x1,t.y1,t.x2,t.y2).length}function Ae(e,t){const i=new j(t.x1,t.y1,t.x2,t.y2).length;return new j(t.x1,t.y1,e.x,e.y).length+new j(t.x2,t.y2,e.x,e.y).length<=i+.2}function ve(e,t){const i=e.length;for(let s=0;s<i;s+=1){let i=e[s],r=e[s+1];if(!r){if(i[0]===e[0][0]&&i[1]===e[0][1])continue;r=e[0]}const n=me({x1:i[0],y1:i[1],x2:r[0],y2:r[1]},t);if(n)return n}if(e[i-1][0]!==e[0][0]&&e[i-1][1]!==e[0][1]){const s=e[i-1],r=e[0],n=me({x1:s[0],y1:s[1],x2:r[0],y2:r[1]},t);if(n)return n}return null}function Se(e,t,i){const s=i.length;for(let r=0;r<s;r+=1){let s=i[r],n=i[r+1];if(n||(n=i[0]),Ae({x:e,y:t},{x1:s[0],y1:s[1],x2:n[0],y2:n[1]}))return!0}return!1}function ye(e,t,i){const s=i.length;let r=0;for(let n=0;n<s;n++){let s=i[n],a=i[n+1]?i[n+1]:i[0],o=s[0],l=s[1],c=a[0],u=a[1];t<l!=t<u&&e<(c-o)*(t-l)/(u-l)+o&&r++}return r>0&&r%2!=0}function we(e,t,i){return e>=i.x&&e<=i.width+i.x&&t>=i.y&&t<=i.y+i.height}function Ie(e,t,i){const s=i.r;return new j(e,t,i.x,i.y).length<s}function Oe(e,t,i,s){const r=s.x1,n=s.y1,a=s.x2,o=s.y2,l={x:r-e,y:n-t},c={x:a-e,y:o-t},u={x:a-r,y:o-n},h={x:r-a,y:n-o},d=Math.sqrt(Math.pow(u.x,2)+Math.pow(u.y,2)),g=pe(l,h),m=pe(c,u);let f;return g>0&&m>0?(f=be(l,c)/d,f<0&&(f*=-1)):f=Math.min(l.length,c.length),f<=i}function Pe(e,t){const i=e[0],s=e[1],r=e[2],n=e[3],a={x:i-t[0][0],y:s-t[0][1]},o={x:i-t[1][0],y:s-t[1][1]},l=Math.sqrt(Math.pow(a.x,2)+Math.pow(a.y,2)),c=Math.sqrt(Math.pow(o.x,2)+Math.pow(o.y,2)),u=Math.min(l,c);if(u>Math.max(r,n))return!1;const h=u===l?a:o,d=Math.atan2(h.y,h.x),g={x:0-Math.cos(d)*r,y:0-Math.sin(d)*n};return!(u>Math.sqrt(Math.pow(g.x,2)+Math.pow(g.y,2)))}function Ce(e,t){const i=e[0],s=e[1],r={x:i-t.x,y:s-t.y},n=Math.sqrt(Math.pow(r.x,2)+Math.pow(r.y,2));if(n>Math.max(e[2],e[3])+t.r)return!1;{const r=fe(i,s,t.x,t.y),a=i-(i+e[2]*Math.cos(r)),o=s-(s+e[3]*Math.sin(r));return n<=Math.sqrt(Math.pow(a,2)+Math.pow(o,2))+t.r&&{x:a,y:o,p:1}}}function Me(e,t){const i=t.length;for(let s=0;s<i;s+=1){let i=t[s],r=t[s+1];if(r||(r=t[0]),Pe(e,[i,r]))return!0}return!1}function Le(){return Math.round(1e6*Math.random())}function De(e){return e[Math.floor(Math.random()*e.length)]}function Ne(e){const t=e.length,i=[];for(let s=0;s<t;s++){const t=e[s];i.push([t.x,t.y])}return i}function Be(e=0,t=0,i,s){const r=s.length;let n=Array(r),a=0;for(let o=0;o<r;o++){const r=s[o];let l=s[o+1];l||(l=s[0]);const c=r[0],u=r[1],h=l[0],d=l[1],g=[c*Math.cos(i)-u*Math.sin(i)+e,c*Math.sin(i)+u*Math.cos(i)+t,h*Math.cos(i)-d*Math.sin(i)+e,h*Math.sin(i)+d*Math.cos(i)+t];n[a]=g,a++}return n}function Fe(e=0,t=0,i,s,r=2*Math.PI,n=Math.PI/8){let a=[];for(let o=0;o<=r;o+=n){let r=Math.cos(o)*i+e,n=Math.sin(o)*s+t;a.push([r,n])}return a}function We(e,t){let i=[];for(let s=0;s<9;s+=3){let r=s;for(let n=0;n<3;n++){let a=0,o=n;for(let i=0;i<3;i++)a+=e[s+i]*t[o],o+=3;i[r]=a,r++}}return i}function je(e,t){let i=[],s=0;for(let r=0;r<6;r+=3){let n=0;const a=r+3;let o=0;for(let i=r;i<a;i++)n+=e[i]*(t[o]||1),o++;i[s]=n,s++}return i}function Ge(e,t){const i=t.length;let s=[],r=0;for(let n=0;n<i;n+=2)for(let i=0;i<6;i+=3){let a=0;const o=i+3;let l=n,c=1;for(let s=i;s<o;s++)a+=e[s]*(3===c?1:t[l]),l++,c++;s[r]=a,r++}return s}class Ue{#Lt;#Dt;#Nt=!0;constructor(e,t=0){this.#Dt=e,this.#Lt=t}get _isTextureRecalculated(){return this.#Nt}set _isTextureRecalculated(e){this.#Nt=e}get _texture(){return this.#Dt}set _texture(e){this.#Dt=e}get _textureIndex(){return this.#Lt}}class Ve{#Bt;#Y=document.createElement("canvas");#Ft=[0,0];#Wt=0;#jt=0;#Dt;#Lt;#Gt=!1;constructor(e,t,i){this.#Bt=e,this.#Y.width=0,this.#Y.height=0,this.#Dt=t,this.#Lt=i}_isAddPossible(e,t){return this.#Y.width+e<this.#Bt||this.#Y.height+t<this.#Bt}_addNewTextImage(e,t,i){let s,r,[n,a]=this.#Ft;const o=document.createElement("canvas");if(o.width=this.#Y.width,o.height=this.#Y.height,n+t<this.#Bt){s=n+t,s>o.width&&(o.width=s),r=a,this.#Wt<i&&(this.#Wt=i),o.height<a+this.#Wt&&(o.height=a+this.#Wt);const l=o.getContext("2d");0===n&&0===a||l.drawImage(this.#Y,0,0),l.drawImage(e,n,a)}else{if(!(a+i<this.#Bt))throw new Error("Overflow error, _isAddingPossible() should be called first");{n=0,this.#jt+=1,a+=this.#Wt,r=a,this.#Wt=i,o.width<this.#Y.width&&(o.width=this.#Y.width),r+i>o.height&&(o.height=r+i),s=t;const l=o.getContext("2d");l.drawImage(this.#Y,0,0),l.drawImage(e,n,a)}}return this.#Y=o,this._isRecalculated=!0,this.#Ft=[s,r],[n,a]}_updateTextImage(e,t){const i=t.x,s=t.y,r=t.width,n=t.height,a=this.#Y.getContext("2d");return a.clearRect(i,s,r,n),a.drawImage(e,i,s),this._isRecalculated=!0,[i,s]}get _atlasImage(){return this.#Y}get _texture(){return this.#Dt}set _texture(e){this.#Dt=e}get _textureIndex(){return this.#Lt}incrementIndex(){this.#Lt++}get _isRecalculated(){return this.#Gt}set _isRecalculated(e){this.#Gt=e}}class ke{#Ut;#Vt;#kt;#Xt;#Yt;#Ct;#zt;#Ht;#Kt=null;#Qt=null;#Zt=[];#qt=0;#Jt=new Map;#$t=new Map;#ei=new Map;#ti;constructor(e,t,i){e&&e instanceof WebGLRenderingContext||S(E.UNEXPECTED_INPUT_PARAMS," context parameter should be specified and equal to WebGLRenderingContext"),this.#Ut=e,this.#Yt=t,this.#Ct=i,this.#Xt=t.debug.checkWebGlErrors,this.#Vt=e.getParameter(e.MAX_TEXTURE_IMAGE_UNITS),this.#kt=e.getParameter(e.MAX_TEXTURE_SIZE),this.#zt=e.createBuffer(),this.#Ht=e.createBuffer(),this.#Zt[0]=new Ve(t.render.textAtlasMaxSize,this.#Ut.createTexture(),0),this._registerObjectRender(U.name,this._bindText,l.WEBGL.DRAW_PROGRAMS.IMAGES_M),this._registerObjectRender(B.name,this._bindPrimitives,l.WEBGL.DRAW_PROGRAMS.PRIMITIVES_M),this._registerObjectRender(N.name,this._bindPrimitives,l.WEBGL.DRAW_PROGRAMS.PRIMITIVES_M),this._registerObjectRender(M.name,this._bindConus,l.WEBGL.DRAW_PROGRAMS.PRIMITIVES),this._registerObjectRender(L.name,this._bindConus,l.WEBGL.DRAW_PROGRAMS.PRIMITIVES),this._registerObjectRender(D.name,this._bindLine,l.WEBGL.DRAW_PROGRAMS.PRIMITIVES),this._registerObjectRender(P.name,this._bindTileImages,l.WEBGL.DRAW_PROGRAMS.IMAGES_M),this._registerObjectRender(f,this._bindImage,l.WEBGL.DRAW_PROGRAMS.IMAGES_M)}getProgram(e){return this.#Jt.get(e)}getProgramVarLocations(e){return this.#$t.get(e)}_fixCanvasSize(e,t){this.#Ut.viewport(0,0,e,t)}_initiateJsRender=e=>new Promise(((t,i)=>{const s=e.getObjectsByInstance(P),[r,n]=e.worldDimensions;let a=0,o=0,l=0,c=0,u=0;s.forEach((e=>{const t=e.setBoundaries,i=e.layerData,s=e.tilemap,r=e.tilesets,{tileheight:n,tilewidth:h}=s,d=h,g=n;for(let e=0;e<r.length;e++){const e=d*i.width,s=g*i.height,r=i.polygonBoundariesLen,n=i.ellipseBoundariesLen,h=i.pointBoundariesLen;c<e&&(c=e),u<s&&(u=s),t&&(a+=r,o+=n,l+=h)}})),0===c||0===u||c===r&&u===n||(y("UNEXPECTED_WORLD_SIZE"," World size from tilemap is different than settings one, fixing..."),e._setWorldDimensions(c,u)),this.#Yt.render.boundaries.mapBoundariesEnabled&&(a+=16),e._setMaxBoundariesSize(a,o,l),e._initiateBoundariesData(),t(!0)}));_initWebGlAttributes=()=>{const e=this.#Ut;return e.enable(e.BLEND),e.enable(e.STENCIL_TEST),e.stencilFunc(e.ALWAYS,1,255),e.stencilOp(e.KEEP,e.KEEP,e.REPLACE),Promise.resolve()};_initiateWasm=e=>{const t=this.#Yt.optimization===l.OPTIMIZATION.WEB_ASSEMBLY.NATIVE_WAT?this.#Yt.optimizationWASMUrl:this.#Yt.optimizationAssemblyUrl;return new Promise(((e,i)=>{this.layerData=new WebAssembly.Memory({initial:1e3}),this.layerDataFloat32=new Float32Array(this.layerData.buffer);const s={env:{memory:this.layerData,logi:console.log,logf:console.log}};fetch(t).then((e=>e.arrayBuffer())).then((e=>WebAssembly.instantiate(e,s))).then((t=>{this.calculateBufferData=t.instance.exports.calculateBufferData,e()}))}))};_initDrawCallsDebug(e){this.#ti=e}_clearView(){const e=this.#Ut;this.#ti.cleanupDebugInfo(),e.clearColor(0,0,0,0),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT|e.STENCIL_BUFFER_BIT)}_render(e,t,i=0){return this.#Ut.drawArrays(t,i,e),Promise.resolve(e)}_preRender(){return new Promise(((e,t)=>{const i=this.#Ut;if(this.#Xt){const e=this.#Xt?i.getError():0;if(0!==e)throw console.error(e),new Error("Error num: "+e)}else e()}))}_postRender(e){let t=e;if(Array.isArray(t)){const[i,s]=e;this.#Ut.drawArrays(s,0,i),t=i}return new Promise(((e,i)=>{const s=this.#Ut;0!==t&&(this.#ti.incrementDrawCallsCounter(),this.#ti.verticesDraw=t),s.stencilFunc(s.ALWAYS,1,255),this.#Yt.debug.delayBetweenObjectRender?setTimeout((()=>{e()}),1e3):e()}))}_registerAndCompileWebGlProgram(e,t,i,s,r){const n=this.#ii(t,i),a=this.#si(n,s,r);return this.#Jt.set(e,n),this.#$t.set(e,a),Promise.resolve()}#ii(e,t){const i=this.#Ut,s=i.createProgram();if(s){const r=this.#ri(i,e,i.VERTEX_SHADER);r?i.attachShader(s,r):S(E.WEBGL_ERROR,"#compileShader(vertexShaderSource) is null");const n=this.#ri(i,t,i.FRAGMENT_SHADER);if(n?i.attachShader(s,n):S(E.WEBGL_ERROR,"#compileShader(fragmentShaderSource) is null"),i.linkProgram(s),!i.getProgramParameter(s,i.LINK_STATUS)){const e=i.getProgramInfoLog(s);S(E.WEBGL_ERROR,`Could not compile WebGL program. \n\n${e}`)}}else S(E.WEBGL_ERROR,"gl.createProgram() is null");return s}#si(e,t,i){const s=this.#Ut;let r={};return t.forEach((t=>{r[t]=s.getUniformLocation(e,t)})),i.forEach((t=>{r[t]=s.getAttribLocation(e,t)})),r}#ri(e,t,i){const s=e.createShader(i);if(s){if(e.shaderSource(s,t),e.compileShader(s),!e.getShaderParameter(s,e.COMPILE_STATUS)){const t=e.getShaderInfoLog(s);S(E.WEBGL_ERROR,"Couldn't compile webGl program. \n\n"+t)}}else S(E.WEBGL_ERROR,`gl.createShader(${i}) is null`);return s}_bindPrimitives=(e,t,i,s,r)=>{const[n,a]=!0===e.isOffsetTurnedOff?[0,0]:i.worldOffset,o=e.x-n,l=e.y-a,u=e.scale,g=e.blendFunc?e.blendFunc:[t.SRC_ALPHA,t.ONE_MINUS_SRC_ALPHA],{u_resolution:m,u_color:f,a_position:E,u_fade_min:_}=r;let p=[];switch(e.type){case c:const t=0,i=0+e.width,s=0,r=0+e.height;p=[t,s,i,s,t,r,t,r,i,s,i,r];break;case h:p=e.vertices;break;case d:const n=this.#ni(e.vertices);if(p=n,n.length%3!=0)return y(v,`polygons ${e.id}, vertices are not correct, skip drawing`),Promise.reject()}const b=this.calculateTranslatedCoords(o,l,e.rotation,u,p),T=this.getNextRenderObject(e,i);if(T&&this._canPrimitivesObjectsMerge(e,T))return null===this.#Kt?(this.#Kt=b,Promise.resolve(0)):(this.#Kt.push(...b),Promise.resolve(0));{t.useProgram(s),t.uniform2f(m,t.canvas.width,t.canvas.height),t.uniform1f(_,0),null===this.#Kt?this.#Kt=b:this.#Kt.push(...b),t.bindBuffer(t.ARRAY_BUFFER,this.#zt),t.bufferData(t.ARRAY_BUFFER,new Float32Array(this.#Kt),t.STATIC_DRAW);const i=2,r=t.FLOAT,n=!1,a=0,o=0;t.vertexAttribPointer(E,i,r,n,a,o);const l=this.#ai(e.bgColor);t.uniform4f(f,l[0]/255,l[1]/255,l[2]/255,l[3]),g&&t.blendFunc(g[0],g[1]),e.isMaskAttached?t.stencilFunc(t.EQUAL,e._maskId,255):e._isMask&&t.stencilFunc(t.ALWAYS,e.id,255);const c=this.#Kt.length/2;return this.#Kt=null,this._render(c,t.TRIANGLES)}};_bindConus=(e,t,i,s,r)=>{const[n,a]=!0===e.isOffsetTurnedOff?[0,0]:i.worldOffset,o=e.x-n,l=e.y-a,c=e.scale,u=e.rotation,{u_translation:h,u_rotation:d,u_scale:g,u_resolution:m,u_color:f,a_position:E,u_fade_max:_,u_fade_min:p}=r,b=e.vertices,T=e.bgColor,x=e.fade_min,R=e.radius,A=e.blendFunc?e.blendFunc:[t.SRC_ALPHA,t.ONE_MINUS_SRC_ALPHA];let v=0;t.useProgram(s),t.uniform2f(m,t.canvas.width,t.canvas.height),t.uniform2f(h,o,l),t.uniform2f(g,c[0],c[1]),t.uniform1f(d,u),t.uniform1f(p,x),t.uniform1f(_,R),t.bindBuffer(t.ARRAY_BUFFER,this.#zt),t.bufferData(t.ARRAY_BUFFER,new Float32Array(b),t.STATIC_DRAW),t.enableVertexAttribArray(E);const S=t.FLOAT;t.vertexAttribPointer(E,2,S,!1,0,0),v+=b.length/2,A&&t.blendFunc(A[0],A[1]);const y=this.#ai(T);return t.uniform4f(f,y[0]/255,y[1]/255,y[2]/255,y[3]),e.isMaskAttached?t.stencilFunc(t.EQUAL,e._maskId,255):e._isMask&&t.stencilFunc(t.ALWAYS,e.id,255),this._render(v,t.TRIANGLE_FAN)};_bindText=(e,t,i,s,r)=>{const{u_resolution:n,a_position:a,a_texCoord:o,u_image:l}=r,{width:c,height:u}=e.boundariesBox,[h,d]=!0===e.isOffsetTurnedOff?[0,0]:i.worldOffset,g=e.x-h,m=e.y-d-u,f=e.blendFunc?e.blendFunc:[t.ONE,t.ONE_MINUS_SRC_ALPHA],E=e.rotation||0,_=e.scale,p=0+c,b=0+u,T=[0,0,p,0,0,b,0,b,p,0,p,b],x=e._atlasPos;let R,A,v=[0,0,1,1],S=void 0!==x.atlasIndex?x.atlasIndex:this.#qt,y=this.#Zt[S],w=c,I=u;if(!0===x.isMeasurementsSet){const t=e._atlasPos;!0===e._isTextureUpdated&&(y._updateTextImage(e._textureCanvas,e._atlasPos),e._setTextureUpdated()),R=t.x,A=t.y,v=[R,A,w,I]}else y._isAddPossible(c,u)?[R,A]=y._addNewTextImage(e._textureCanvas,c,u):(y=new Ve(this.#kt,t.createTexture(),S),[R,A]=y._addNewTextImage(e._textureCanvas,c,u),this.#qt=S,this.#Zt[S]=y),x._setMeasurements(S,R,A),v=[R,A,w,I];const O=this.calculateTranslatedCoords(g,m,E,_,T),P=this.calculateTextureCoords(y._atlasImage,v[0],v[1],v[2],v[3]),C=this.getNextRenderObject(e,i);if(!1===y._isRecalculated&&C&&C instanceof U&&this._canTextObjectsMerge(e,C))return null===this.#Kt?(this.#Kt=O,this.#Qt=P,Promise.resolve(0)):(this.#Kt.push(...O),this.#Qt.push(...P),Promise.resolve(0));{t.useProgram(s),t.uniform2f(n,t.canvas.width,t.canvas.height),null===this.#Kt?(this.#Kt=O,this.#Qt=P):(this.#Kt.push(...O),this.#Qt.push(...P)),t.bindBuffer(t.ARRAY_BUFFER,this.#zt),t.bufferData(t.ARRAY_BUFFER,new Float32Array(this.#Kt),t.STATIC_DRAW),t.enableVertexAttribArray(a);const e=2,i=t.FLOAT,r=!1,c=0,u=0;t.vertexAttribPointer(a,e,i,r,c,u),t.bindBuffer(t.ARRAY_BUFFER,this.#Ht),t.bufferData(t.ARRAY_BUFFER,new Float32Array(this.#Qt),t.STATIC_DRAW),t.enableVertexAttribArray(o),t.vertexAttribPointer(o,2,t.FLOAT,!1,0,0);const h=this.#Kt.length/2;return t.blendFunc(f[0],f[1]),y._isRecalculated?(this.#oi(t,y._texture,y._atlasImage,y._textureIndex),y._isRecalculated=!1):this.#li(t,y._texture),t.uniform1i(l,y._textureIndex),t.depthMask(!1),this.#Kt=null,this.#Qt=null,this._render(h,t.TRIANGLES)}};_bindImage=(e,t,i,s,r)=>{const[n,a]=!0===e.isOffsetTurnedOff?[0,0]:i.worldOffset,o=e.x-n,l=e.y-a;e.vertices&&this.#Yt.debug.boundaries.drawObjectBoundaries&&(i._enableDebugObjectBoundaries(),i._addImageDebugBoundaries(Be(o,l,e.rotation,e.vertices)));const{u_resolution:c,a_position:u,a_texCoord:h,u_image:d}=r;if(!e.image){const t=this.#Ct.getImage(e.key);t?e.image=t:S(E.CANT_GET_THE_IMAGE,"iLoader can't get the image with key: "+e.key)}const g=e.image,m=e.imageIndex,f=e._maskId,_=e.spacing,p=e.margin,b=e.blendFunc?e.blendFunc:[t.ONE,t.ONE_MINUS_SRC_ALPHA],T=e.scale;let x=p,R=p,A=0,v=0;if(0!==m){const t=(g.width+_-2*p)/(e.width+_);A=m%t,v=Math.floor(m/t),x=A*e.width+A*_+p,R=v*e.height+v*_+p}const y=0-e.width/2,w=0-e.height/2,I=y+e.width,O=w+e.height,P=[y,w,I,w,y,O,y,O,I,w,I,O],C=this.calculateTranslatedCoords(o,l,e.rotation,T,P),M=this.calculateTextureCoords(g,x,R,e.width,e.height),L=this.getNextRenderObject(e,i);if(L&&this._canImageObjectsMerge(e,L))return null===this.#Kt?(this.#Kt=C,this.#Qt=M,Promise.resolve(0)):(this.#Kt.push(...C),this.#Qt.push(...M),Promise.resolve(0));{t.useProgram(s),t.uniform2f(c,t.canvas.width,t.canvas.height),null===this.#Kt?(this.#Kt=C,this.#Qt=M):(this.#Kt.push(...C),this.#Qt.push(...M)),t.bindBuffer(t.ARRAY_BUFFER,this.#zt),t.bufferData(t.ARRAY_BUFFER,new Float32Array(this.#Kt),t.STATIC_DRAW);const i=this.#Kt.length/2;t.enableVertexAttribArray(u);const r=2,n=t.FLOAT,a=!1,o=0,l=0;t.vertexAttribPointer(u,r,n,a,o,l),t.bindBuffer(t.ARRAY_BUFFER,this.#Ht),t.bufferData(t.ARRAY_BUFFER,new Float32Array(this.#Qt),t.STATIC_DRAW),t.enableVertexAttribArray(h),t.vertexAttribPointer(h,2,t.FLOAT,!1,0,0);let g=e._textureStorage;return g||(g=new Ue(t.createTexture()),e._textureStorage=g),!0===g._isTextureRecalculated?(this.#oi(t,g._texture,e.image),g._isTextureRecalculated=!1):this.#li(t,g._texture),t.uniform1i(d,g._textureIndex),t.blendFunc(b[0],b[1]),f&&t.stencilFunc(t.EQUAL,f,255),this.#Kt=null,this.#Qt=null,this._render(i,t.TRIANGLES)}};_canImageObjectsMerge=(e,t)=>{const i=this.#ei.get(e.constructor.name)||this.#ei.get(e.type),s=this.#ei.get(t.constructor.name)||this.#ei.get(t.type);return i.webglProgramName===s.webglProgramName&&e.type===t.type&&e.image===t.image&&!1===t.isRemoved};_canTextObjectsMerge=(e,t)=>!(!t._atlasPos||e._atlasPos.atlasIndex!==t._atlasPos.atlasIndex||!0!==t._atlasPos.isMeasurementsSet||!1!==t.isRemoved);_canPrimitivesObjectsMerge=(e,t)=>{const i=this.#ei.get(e.constructor.name)||this.#ei.get(e.type),s=this.#ei.get(t.constructor.name)||this.#ei.get(t.type);return i.webglProgramName===s.webglProgramName&&e.bgColor===t.bgColor&&!1===t.isRemoved};_canMergeNextTileObject=(e,t)=>t instanceof P&&1===e.tilesetImages.length&&1===t.tilesetImages.length&&e.tilesetImages[0]===t.tilesetImages[0]&&!1===t.isRemoved;_canTextBeMerged=(e,t)=>{const i=this.#ei.get(e.constructor.name)||this.#ei.get(e.type),s=this.#ei.get(t.constructor.name)||this.#ei.get(t.type);return i.webglProgramName===s.webglProgramName&&e.type===t.type&&!1===t.isRemoved};_bindTileImages=async(e,t,i,s,r)=>{const{u_translation:n,u_rotation:a,u_scale:o,u_resolution:c,a_position:u,a_texCoord:h,u_image:d}=r;t.useProgram(s);let g=null;switch(this.#Yt.optimization){case l.OPTIMIZATION.NATIVE_JS.NOT_OPTIMIZED:g=await this.#ci(e,i);break;case l.OPTIMIZATION.WEB_ASSEMBLY.ASSEMBLY_SCRIPT:case l.OPTIMIZATION.WEB_ASSEMBLY.NATIVE_WAT:g=await this.#ui(e,i);break;case l.OPTIMIZATION.NATIVE_JS.OPTIMIZED:default:g=await this.#hi(e,i)}e.scale,e.rotation;const m=["ONE","ONE_MINUS_SRC_ALPHA"],f=e._maskId,E=this.getNextRenderObject(e,i);if(this._canMergeNextTileObject(e,E))return null===this.#Kt?(this.#Kt=g[0][0],this.#Qt=g[0][1],Promise.resolve(0)):(this.#Kt.push(...g[0][0]),this.#Qt.push(...g[0][1]),Promise.resolve(0));{let i=0,s=!1,r=g.length;if(t.enableVertexAttribArray(u),t.enableVertexAttribArray(h),t.uniform2f(c,t.canvas.width,t.canvas.height),r>1)for(let n=0;n<r;n++){const r=g[n],a=r[0],o=r[1],l=(r[2],r[3]);if(a.length>0&&o.length>0){s&&await this._render(i,t.TRIANGLES),t.bindBuffer(t.ARRAY_BUFFER,this.#zt),t.bufferData(t.ARRAY_BUFFER,new Float32Array(a),t.STATIC_DRAW);const r=2,c=t.FLOAT,g=!1,E=0,_=0;t.vertexAttribPointer(u,r,c,g,E,_),t.bindBuffer(t.ARRAY_BUFFER,this.#Ht),t.bufferData(t.ARRAY_BUFFER,new Float32Array(o),t.STATIC_DRAW),t.vertexAttribPointer(h,2,t.FLOAT,!1,0,_);let p=e._textureStorages[n];p||(p=new Ue(t.createTexture(),n),e._setTextureStorage(n,p)),!0===p._isTextureRecalculated?(this.#oi(t,p._texture,l,p._textureIndex),p._isTextureRecalculated=!1):this.#li(t,p._texture,p._textureIndex),t.uniform1i(d,p._textureIndex),t.blendFunc(t[m[0]],t[m[1]]),i=a.length/2,f&&t.stencilFunc(t.EQUAL,f,255),s=!0}}else{const s=g[0],r=s[0],n=s[1],a=(s[2],s[3]);null===this.#Kt?(this.#Kt=r,this.#Qt=n):(this.#Kt.push(...r),this.#Qt.push(...n)),t.bindBuffer(t.ARRAY_BUFFER,this.#zt),t.bufferData(t.ARRAY_BUFFER,new Float32Array(this.#Kt),t.STATIC_DRAW);const o=2,l=t.FLOAT,c=!1,E=0,_=0;t.vertexAttribPointer(u,o,l,c,E,_),t.bindBuffer(t.ARRAY_BUFFER,this.#Ht),t.bufferData(t.ARRAY_BUFFER,new Float32Array(this.#Qt),t.STATIC_DRAW),t.vertexAttribPointer(h,2,t.FLOAT,!1,0,_);let p=e._textureStorages[0];p||(p=new Ue(t.createTexture(),0),e._setTextureStorage(0,p)),!0===p._isTextureRecalculated?(this.#oi(t,p._texture,a,p._textureIndex),p._isTextureRecalculated=!1):this.#li(t,p._texture,p._textureIndex),t.uniform1i(d,p._textureIndex),t.blendFunc(t[m[0]],t[m[1]]),i=this.#Kt.length/2,f&&t.stencilFunc(t.EQUAL,f,255),this.#Kt=null,this.#Qt=null}return g=null,this._render(i,t.TRIANGLES)}};_drawPolygon(e,t){const[i,s]=!0===e.isOffsetTurnedOff?[0,0]:t.worldOffset,r=e.x-i,n=e.y-s,a=e.rotation||0,o=e.scale||[1,1],c=e.vertices,u=this.#Yt.debug.boundaries.boundariesColor,h=this.getProgram(l.WEBGL.DRAW_PROGRAMS.PRIMITIVES),{u_translation:d,u_rotation:g,u_scale:m,u_resolution:f,u_color:E,a_position:_,u_fade_max:p,u_fade_min:b}=this.getProgramVarLocations(l.WEBGL.DRAW_PROGRAMS.PRIMITIVES),T=this.#Ut;let x=0;T.useProgram(h),T.uniform2f(f,T.canvas.width,T.canvas.height),T.uniform2f(d,r,n),T.uniform2f(m,o[0],o[1]),T.uniform1f(g,a),T.uniform1f(b,0),T.enableVertexAttribArray(_),T.bindBuffer(T.ARRAY_BUFFER,this.#zt);const R=this.#ni(c),A=R.length;if(A%3!=0)return void y(v,"polygon boundaries vertices are not correct, skip drawing");this.#di(R),x+=A/2;const S=T.FLOAT;T.vertexAttribPointer(_,2,S,!1,0,0);const w=this.#ai(u);T.uniform4f(E,w[0]/255,w[1]/255,w[2]/255,w[3]),this._render(x,T.TRIANGLES)}_bindLine=(e,t,i,s,r)=>{const[n,a]=!0===e.isOffsetTurnedOff?[0,0]:i.worldOffset,o=e.x-n,l=e.y-a,c=e.scale,u=e.rotation,{u_translation:h,u_rotation:d,u_scale:g,u_resolution:m,u_color:f,a_position:E,u_fade_max:_,u_fade_min:p}=r,b=e.vertices,T=e.bgColor,x=(e.fade_min,e.radius,this.#Yt.debug.boundaries.boundariesWidth);let R=0;t.useProgram(s),t.uniform2f(m,t.canvas.width,t.canvas.height),t.uniform2f(h,o,l),t.uniform2f(g,c[0],c[1]),t.uniform1f(d,u),t.uniform1f(p,0),t.enableVertexAttribArray(E),t.bindBuffer(t.ARRAY_BUFFER,this.#zt),t.bufferData(t.ARRAY_BUFFER,new Float32Array(b),t.STATIC_DRAW),R+=b.length/2;const A=t.FLOAT;t.vertexAttribPointer(E,2,A,!1,0,0);const v=this.#ai(T);return t.uniform4f(f,v[0]/255,v[1]/255,v[2]/255,v[3]),t.lineWidth(x),this._render(0,t.LINES)};_drawLines(e,t,i=1,s=0,r=[0,0]){const n=this.getProgram(l.WEBGL.DRAW_PROGRAMS.PRIMITIVES),{u_translation:a,u_rotation:o,u_scale:c,u_resolution:u,u_color:h,a_position:d,u_fade_max:g,u_fade_min:m}=this.getProgramVarLocations(l.WEBGL.DRAW_PROGRAMS.PRIMITIVES),f=this.#Ut;let E=0;f.useProgram(n),f.uniform2f(u,f.canvas.width,f.canvas.height),f.uniform2f(a,r[0],r[1]),f.uniform2f(c,1,1),f.uniform1f(o,s),f.uniform1f(m,0),f.enableVertexAttribArray(d),f.bindBuffer(f.ARRAY_BUFFER,this.#zt),f.bufferData(f.ARRAY_BUFFER,e instanceof Float32Array?e:new Float32Array(e),f.STATIC_DRAW),E+=e.length/2;const _=f.FLOAT;f.vertexAttribPointer(d,2,_,!1,0,0);const p=this.#ai(t);f.uniform4f(h,p[0]/255,p[1]/255,p[2]/255,p[3]),f.lineWidth(i),this._render(E,f.LINES)}_registerObjectRender(e,t,i){this.#ei.set(e,{method:t,webglProgramName:i})}_drawRenderObject(e,t){const i=e.constructor.name,s=this.#ei.get(i)||this.#ei.get(e.type);if(s){const i=s.webglProgramName,r=i?this.getProgram(i):null,n=i?this.getProgramVarLocations(i):null;return s.method(e,this.#Ut,t,r,n)}return console.warn("no registered draw object method for "+i+" skip draw"),Promise.resolve()}#hi(e,t){return new Promise(((i,s)=>{const r=e.tilemap,n=e.tilesets,a=e.tilesetImages,o=e.layerData,{tileheight:l,tilewidth:c}=r,u=c,h=l,[d,g]=t.canvasDimensions,[m,f]=!0===e.isOffsetTurnedOff?[0,0]:t.worldOffset,E=(this.#Yt.render.boundaries.realtimeCalculations,e.setBoundaries),p=[];o||(y(_,"check tilemap and layers name"),s()),this.#Yt.render.boundaries.mapBoundariesEnabled&&t._setMapBoundaries();for(let e=0;e<n.length;e++){const i=n[e],s=n[e].firstgid,r=n[e+1],_=r?r.firstgid:1e9,b=i.tilewidth,T=i.tileheight,x=i.tileoffset?i.tileoffset.x:0,R=i.tileoffset?i.tileoffset.y:0,A=a[e],v=i.imagewidth,S=i.imageheight,w=i.columns,I=o.width,O=o.height,P=u*I,C=h*O,M=f%h,L=m%u,D=0!==f?Math.floor(f/h):0,N=0!==m?Math.floor(m/u):0,B=C>g?Math.ceil(g/h)+1:O,F=P>d?Math.ceil(d/u)+1:I,W=B*F,j=I-F-N,G="number"==typeof i.spacing?i.spacing:0,U="number"==typeof i.margin?i.margin:0,V=i._hasAnimations,k=i._hasBoundaries,X=i._boundaries,Y=n[e]._temp;Y.cells!==W&&Y._initiateStorageData(W);let z=Y.vectors,H=Y.textures,K=0;z=[],H=[];let Q=Y._bTempIndexes;const Z=4*F;let q=D*I;for(let e=0;e<B;e++){q+=N;for(let r=0;r<F;r++){let n=o.data[q];if(n>=s&&n<_){const a=r*c-L+x,o=e*l-(T-l)-M+R;if(n-=s,V){const e=i._animations.get(n);void 0!==e&&(n=e)}const u=n%w,h=Math.floor(n/w),d=u*b+u*G+U,g=h*T+h*G+U,m=a,f=o,_=a+b,p=o+T,[A,I,O,P]=this.normalizeCoords(v,S,d,g,b,T);if(z[K]=m,H[K]=A,K++,z[K]=f,H[K]=I,K++,z[K]=_,H[K]=O,K++,z[K]=f,H[K]=I,K++,z[K]=m,H[K]=A,K++,z[K]=p,H[K]=P,K++,z[K]=m,H[K]=A,K++,z[K]=p,H[K]=P,K++,z[K]=_,H[K]=O,K++,z[K]=f,H[K]=I,K++,z[K]=_,H[K]=O,K++,z[K]=p,H[K]=P,K++,E){let i=!1;if(k&&X.size>0){const e=X.get(n);e&&(i=!0,e.objects.forEach((e=>{const i=a+e.x,s=o+e.y;if(0!==e.rotation&&y("tilesetData.tiles.rotation property is not supported yet"),e.polygon)e.polygon.forEach(((r,n)=>{const a=e.polygon[n+1];if(a)t._addBoundaryLine(r.x+i,r.y+s,a.x+i,a.y+s);else{const n=e.polygon[0];t._addBoundaryLine(r.x+i,r.y+s,n.x+i,n.y+s)}}));else if(e.point)t._addPointBoundary(i,s);else if(e.ellipse){const r=e.width/2,n=e.height/2;t._addEllipseBoundary(i+r,s+n,r,n)}else{const r=e.width,n=e.height,a=r+i,o=n+s;t._addBoundaryLine(i,s,a,s),t._addBoundaryLine(a,s,a,o),t._addBoundaryLine(a,o,i,o),t._addBoundaryLine(i,o,i,s)}})))}if(!1===i){const i=t.getRawBoundaries();let s=[a+b,o,a+b,o+T],n=[a+b,o+T,a,o+T],l=[a,o,a+b,o],c=[a,o+T,a,o];if(0!==e){const n=(e-1)*Z+4*r,a=Q[n+2];if(a){const e=i[a];if(e){const s=i[a+1],r=i[a+2],n=i[a+3],o=l[0],c=l[1],u=l[2],h=l[3];o===r&&c===n&&u===e&&h===s&&(t._removeBoundaryLine(a),l=void 0)}const r=Q[n+1],o=i[r];if(o){const e=i[r+1],n=i[r+2],a=i[r+0];o===i[r+2]&&n===a&&(t._removeBoundaryLine(r),s[0]=o,s[1]=e)}const u=Q[n+3],h=i[u];if(h){const e=i[u+2],s=i[u+3],r=c[0];h===c[2]&&e===r&&(t._removeBoundaryLine(u),c[2]=e,c[3]=s)}}}if(0!==r){const s=e*Z+4*(r-1),a=Q[s];if(a){const e=Q[s+1],r=i[e],o=i[e+1],u=i[e+2],h=i[e+3],d=c[0],g=c[1],m=c[2],f=c[3];d===u&&g===h&&m===r&&f===o&&(t._removeBoundaryLine(e),c=void 0);const E=i[a];if(E&&l){const e=i[a+1],s=i[a+3],r=l[1];e===l[3]&&s===r&&(t._removeBoundaryLine(a),l[0]=E,l[1]=e)}const _=Q[s+2];if(i[_]){const e=i[_+1],s=i[_+2],r=i[_+3],a=n[1];e===n[3]&&r===a&&(t._removeBoundaryLine(_),n[2]=s,n[3]=r)}}}const u=e*Z+4*r;l&&(t._addBoundaryLine(l[0],l[1],l[2],l[3]),Q[u+0]=t.boundariesLen-4),t._addBoundaryLine(s[0],s[1],s[2],s[3]),Q[u+1]=t.boundariesLen-4,t._addBoundaryLine(n[0],n[1],n[2],n[3]),Q[u+2]=t.boundariesLen-4,c&&(t._addBoundaryLine(c[0],c[1],c[2],c[3]),Q[u+3]=t.boundariesLen-4)}}}q++}q+=j}p.push([z,H,i.name,A]),Q.fill(0)}i(p)}))}#ci(e,t){return new Promise(((i,s)=>{const r=e.tilemap,n=e.tilesets,a=e.tilesetImages,o=e.layerData,{tileheight:l,tilewidth:c}=r,[u,h]=!0===e.isOffsetTurnedOff?[0,0]:t.worldOffset;let d=[];o||(y(_,"check tilemap and layers name"),s()),this.#Yt.render.boundaries.mapBoundariesEnabled&&t._setMapBoundaries();for(let e=0;e<=n.length-1;e++){const t=n[e],i=n[e].firstgid,s=n[e+1],r=s?s.firstgid:1e9,g=t.tilewidth,m=t.tileheight,f=t.columns,E=o.width,_=o.height,p=a[e],b=t.imagewidth,T=t.imageheight,x="number"==typeof t.spacing?t.spacing:0,R="number"==typeof t.margin?t.margin:0,A=n[e]._temp;let v=0,S=A.vectors,y=A.textures,w=0;S=[],y=[];for(let e=0;e<_;e++)for(let t=0;t<E;t++){let s=o.data[v];if(s>=i&&s<r){s-=i;const r=s%f,n=Math.floor(s/f),a=r*g+r*x+R,o=n*m+n*x+R,d=t*c-u,E=e*l-h,_=d+g,p=E+m,[A,v,I,O]=this.normalizeCoords(b,T,a,o,g,m);S[w]=d,y[w]=A,w++,S[w]=E,y[w]=v,w++,S[w]=_,y[w]=I,w++,S[w]=E,y[w]=v,w++,S[w]=d,y[w]=A,w++,S[w]=p,y[w]=O,w++,S[w]=d,y[w]=A,w++,S[w]=p,y[w]=O,w++,S[w]=_,y[w]=I,w++,S[w]=E,y[w]=v,w++,S[w]=_,y[w]=I,w++,S[w]=p,y[w]=O,w++}v++}d.push([S,y,t.name,p])}i(d)}))}#ui=(e,t)=>new Promise(((i,s)=>{const r=e.tilemap,n=e.tilesets,a=e.tilesetImages,o=e.layerData,{tileheight:l,tilewidth:c}=r,u=o.data.length,h=o.data.filter((e=>0!==e)).length,[d,g]=t.worldDimensions,[m,f]=!0===e.isOffsetTurnedOff?[0,0]:t.worldOffset,E=[];this.layerDataFloat32.set(o.data),o||(y(_,"check tilemap and layers name"),s()),this.#Yt.render.boundaries.mapBoundariesEnabled&&t._setMapBoundaries();for(let e=0;e<n.length;e++){const t=n[e],i=n[e].firstgid,s=n[e+1],r=s?s.firstgid:1e9,d=t.tilewidth,g=t.tileheight,_=t.columns,p=o.width,b=o.height,T=a[e],x=t.imagewidth,R=t.imageheight,A=4,v=12*h,S=12*h,y="number"==typeof t.spacing?t.spacing:0,w=("number"==typeof t.margin&&t.margin,this.calculateBufferData(A,u,v,b,p,c,l,d,g,_,x,R,m,f,i,r,y,!1)),I=w>0?this.layerDataFloat32.slice(u,v+u):[],O=w>0?this.layerDataFloat32.slice(v+u,v+S+u):[];E.push([Array.from(I),Array.from(O),t.name,T])}i(E)}));#ai(e){return e.replace("rgba(","").replace(")","").split(",").map((e=>Number(e.trim())))}#ni(e){const t=new Float32Array(e.length*e.length),[i,s]=this.#gi(e,t,0);return i.slice(0,s)}#gi(e,t,i){const s=e.length;if(s<=3)return e.forEach((e=>{t[i]=e[0],i++,t[i]=e[1],i++})),[t,i];const r=[...e].sort(((e,t)=>t[1]-e[1])),n=e.indexOf(r[0]),a=n!==s-1?n+1:0;let o=e,l=o.length,c=0,u=a;for(;o.length>2;){const e=o.length;u>=e&&(u-=e);const s=0===u?o[e-1]:o[u-1],r=o[u],n=e===u+1?o[0]:o[u+1];if(h=s,d=r,be({x:(g=n)[0]-h[0],y:g[1]-h[1]},{x:d[0]-h[0],y:d[1]-h[1]})<0)t[i]=s[0],i++,t[i]=s[1],i++,t[i]=r[0],i++,t[i]=r[1],i++,t[i]=n[0],i++,t[i]=n[1],i++,o=o.filter(((e,t)=>t!==u));else{if(c+=1,c>l)return y("TRIANGULATE_ISSUE","Can't extract all triangles vertices."),[t,i];u++}}var h,d,g;return[t,i]}#di(e){this.#Ut.bufferData(this.#Ut.ARRAY_BUFFER,new Float32Array(e),this.#Ut.STATIC_DRAW)}#oi(e,t,i,s=0,r=!1){this.#li(e,t,s),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,i),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,r?e.LINEAR_MIPMAP_LINEAR:e.LINEAR)}#mi(e,t,i,s=0){this.#li(e,t,s),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,i),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST)}#li(e,t,i=0){e.activeTexture(e.TEXTURE0+i),e.bindTexture(e.TEXTURE_2D,t)}#fi(e,t){e.deleteTexture(t)}isPowerOfTwo(e){return!(e&e-1)}nextHighestPowerOfTwo(e){--e;for(var t=1;t<32;t<<=1)e|=e>>t;return e+1}getNextRenderObject=(e,t)=>{const i=t.renderObjects.indexOf(e);return t.renderObjects[i+1]};normalizeCoords(e,t,i,s,r,n){const a=1/e,o=1/t,l=a*i,c=o*s;return[l,c,l+a*r,c+o*n]}calculateTranslatedCoords=(e,t,i,s,r)=>{const n=Math.cos(i),a=Math.sin(i),o=[1,0,e,0,1,t,0,0,1],l=[n,-a,0,a,n,0,0,0,1],c=[s[0],0,0,0,s[1],0,0,0,1];return Ge(We(We(o,l),c),r)};calculateTextureCoords=(e,t,i,s,r)=>{const[n,a,o,l]=this.normalizeCoords(e.width,e.height,t,i,s,r);return[n,a,o,a,n,l,n,l,o,a,o,l]};#Ei=e=>e-33984;get maxTexture(){return this.#kt}}const Xe=["u_resolution","u_image"],Ye=["a_position","a_texCoord"],ze=["u_translation","u_rotation","u_scale","u_resolution","u_fade_min","u_fade_max","u_color"],He=["a_position"],Ke=["u_resolution","u_fade_min","u_fade_max","u_color"],Qe=["a_position"];class Ze{#_i=0;#pi=0;#bi=0;#Ti;#xi=0;constructor(e){this.#Ti=new Float32Array(e)}get drawCalls(){return this.#pi}get verticesDraw(){return this.#_i}get tempRCircleT(){return this.#Ti}get tempRCircleTPointer(){return this.#xi}set tempRCircleT(e){this.#Ti[this.#xi]=e}set prevDrawTime(e){this.#bi=e}currentDrawTime(e){return e-this.#bi}incrementTempRCircleTPointer(){this.#xi++}incrementDrawCallsCounter(){this.#pi+=1}set verticesDraw(e){this.#_i+=e}cleanupDebugInfo(){this.#_i=0,this.#pi=0}cleanupDrawCallsCounter(){this.#pi=0}cleanupTempVars(){this.#Ti.fill(0),this.#xi=0}}class qe{#r;#Ri;#Ai;#vi;#Si;#yi;#Et;#z=new EventTarget;constructor(e,t,i){this.#Et=e,this.#Si=t,this.#Ai=new Ze(this.#Et.gameOptions.render.cyclesTimeCalc.averageFPStime),this.#yi=i,this.#yi._initDrawCallsDebug(this.renderLoopDebug),this.#Et.gameOptions.render.cyclesTimeCalc.check===l.OPTIMIZATION.CYCLE_TIME_CALC.AVERAGES&&(this.#vi=setInterval((()=>this.#wi()),this.#Et.gameOptions.render.cyclesTimeCalc.averageFPStime))}get stageData(){return this.#Si}get renderLoopDebug(){return this.#Ai}set _isCleared(e){this.#Ri=e}get _isCleared(){return this.#Ri}_start(){this.#r=!0,requestAnimationFrame(this.#Ii)}_stop(){this.#r=!1,this.#Si=null,this.renderLoopDebug.cleanupTempVars(),clearInterval(this.#vi)}#Ii=e=>{if(!this.#r)return;const t=this.renderLoopDebug.currentDrawTime(e);this.renderLoopDebug.prevDrawTime=e;const i=performance.now(),s=this.#Et.gameOptions.render.cyclesTimeCalc.check===l.OPTIMIZATION.CYCLE_TIME_CALC.CURRENT;this.emit(l.EVENTS.SYSTEM.RENDER.START),this.#Si._clearBoundaries(),this.#Oi(),this.render().then((()=>{const e=performance.now()-i;s?(console.log("current draw take: ",t," ms"),console.log("current render() time: ",e),console.log("draw calls: ",this.renderLoopDebug.drawCalls),console.log("vertices draw: ",this.renderLoopDebug.verticesDraw)):(this.renderLoopDebug.tempRCircleT=t,this.renderLoopDebug.incrementTempRCircleTPointer()),this.emit(l.EVENTS.SYSTEM.RENDER.END),this.#r&&setTimeout((()=>requestAnimationFrame(this.#Ii)))})).catch((e=>{e.forEach?e.forEach((e=>{y(b,e)})):y(b,e.message),this._stop()}))};async render(){const e=this.#Si.renderObjects;let t=[],i=!1,s=e.length,r=new Array(s);if(0!==s){for(let t=0;t<s;t++){const i=e[t];if(i.isRemoved){e.splice(t,1),t--,s--;continue}"hasAnimations"in i&&i.hasAnimations&&i._processActiveAnimations();const n=await this.#Pi(i).catch((e=>Promise.reject(e)));r[t]=n}this.#Et.gameOptions.debug.boundaries.drawLayerBoundaries&&r.push(this.#Ci().catch((e=>Promise.reject(e))))}return(await Promise.allSettled(r)).forEach((e=>{"rejected"===e.status&&(Promise.reject(e.reason),i=!0,t.push(e.reason))})),this._isCleared=!1,!1===i?(this.#Si._processPendingRenderObjects(),Promise.resolve()):Promise.reject(t)}addEventListener=(e,t,i)=>{this.#z.addEventListener(e,t,i)};removeEventListener=(e,t,i)=>{this.#z.removeEventListener(e,t,i)};emit=(e,...t)=>{const i=new Event(e);i.data=[...t],this.#z.dispatchEvent(i)};#Pi(e){return this.#yi._preRender().then((()=>this.#r?this.#yi._drawRenderObject(e,this.stageData):Promise.resolve())).then((e=>this.#yi._postRender(e)))}#Oi(){this.#yi._clearView()}#Ci(){return new Promise((e=>{const t=this.stageData.getRawBoundaries(),i=this.stageData.getEllipseBoundaries(),s=this.stageData.getPointBoundaries(),r=this.stageData.getDebugObjectBoundaries(),n=this.stageData.boundariesLen,a=this.stageData.ellipseBLen,o=this.stageData.pointBLen,l=this.#Et.gameOptions.debug.boundaries.drawObjectBoundaries?r.length:0;if(n&&this.#yi._drawLines(t,this.#Et.gameOptions.debug.boundaries.boundariesColor,this.#Et.gameOptions.debug.boundaries.boundariesWidth),this.renderLoopDebug.incrementDrawCallsCounter(),a)for(let e=0;e<a;e+=4){const t=Fe(i[e],i[e+1],i[e+2],i[e+3]);this.#yi._drawPolygon({x:0,y:0,vertices:t,isOffsetTurnedOff:!0},this.stageData),this.renderLoopDebug.incrementDrawCallsCounter()}if(o)for(let e=0;e<o;e+=2){const t=s[e],i=s[e+1],r=[t,i,t+1,i+1];this.#yi._drawLines(r,this.#Et.gameOptions.debug.boundaries.boundariesColor,this.#Et.gameOptions.debug.boundaries.boundariesWidth),this.renderLoopDebug.incrementDrawCallsCounter()}l>0&&this.#yi._drawLines(r,this.#Et.gameOptions.debug.boundaries.boundariesColor,this.#Et.gameOptions.debug.boundaries.boundariesWidth),e()}))}#Mi(e){return new Promise(((e,t)=>{}))}#wi(){const e=this.#Et.gameOptions.render.cyclesTimeCalc.averageFPStime,t=this.renderLoopDebug.tempRCircleTPointer;let i=0;for(let e=0;e<t;e++)i+=this.renderLoopDebug.tempRCircleT[e];console.log("FPS average for",e/1e3,"sec, is ",(1e3/(i/t)).toFixed(2)),console.log("Last loop info:"),console.log("Webgl draw calls: ",this.renderLoopDebug.drawCalls),console.log("Vertices draw: ",this.renderLoopDebug.verticesDraw),this.renderLoopDebug.cleanupTempVars()}}class Je{#Li;#Di;#yi;#Ni;#Bi;#Ct;#Fi;#Wi=!1;#ji=[];#z=new EventTarget;constructor(e,t,i){let s={stencil:!0};!0===e.gameOptions.debug.preserveDrawingBuffer&&(s.preserveDrawingBuffer=!0),this.#Li=document.createElement("canvas"),i.appendChild(this.#Li),this.#Di=this.#Li.getContext("webgl",s),this.#Bi=e,this.#Ct=t,this.#Wi=this.systemSettings.gameOptions.render.boundaries.wholeWorldPrecalculations,this.#yi=new ke(this.#Di,this.#Bi.gameOptions,this.iLoader),this._registerRenderInit(this.#yi._initiateJsRender),this.systemSettings.gameOptions.optimization!==l.OPTIMIZATION.WEB_ASSEMBLY.NATIVE_WAT&&this.systemSettings.gameOptions.optimization!==l.OPTIMIZATION.WEB_ASSEMBLY.ASSEMBLY_SCRIPT||this._registerRenderInit(this.#yi._initiateWasm),this._registerRenderInit(this.fixCanvasSize),this._registerRenderInit((()=>this._registerAndCompileWebGlProgram(l.WEBGL.DRAW_PROGRAMS.IMAGES_M,"\n    attribute vec2 a_texCoord;\n\n    attribute vec2 a_position;\n\n    uniform vec2 u_resolution;\n\n    varying vec2 v_texCoord;\n\n    void main(void) {\n        vec2 clipSpace = a_position / u_resolution * 2.0 - 1.0;\n        gl_Position = vec4(clipSpace * vec2(1, -1), 0, 1);\n        v_texCoord = a_texCoord;\n    }","\n    precision mediump float;\n\n    uniform sampler2D u_image;\n\n    //texCoords passed in from the vertex shader\n    varying vec2 v_texCoord;\n    void main() {\n        vec4 color = texture2D(u_image, v_texCoord);\n        gl_FragColor = color;\n    }",Xe,Ye))),this._registerRenderInit((()=>this._registerAndCompileWebGlProgram(l.WEBGL.DRAW_PROGRAMS.PRIMITIVES,"\n    precision mediump float;\n\n    attribute vec2 a_position;\n\n    uniform vec2 u_translation;\n    uniform float u_rotation;\n    uniform vec2 u_scale;\n\n    uniform vec2 u_resolution;\n\n    void main(void) {\n        float c = cos(u_rotation);\n        float s = sin(u_rotation);\n\n        mat3 translationMatrix1 = mat3(\n            1, 0, 0,\n            0, 1, 0,\n            u_translation.x, u_translation.y, 1\n        );\n        \n        mat3 rotationMatrix = mat3(\n            c, s, 0,\n            -s, c, 0,\n            0, 0, 1\n        );\n\n        mat3 scalingMatrix = mat3(\n            u_scale.x, 0, 0,\n            0, u_scale.y, 0,\n            0, 0, 1\n        );\n        \n        mat3 matrix = translationMatrix1 * rotationMatrix * scalingMatrix;\n\n        vec2 position = (matrix * vec3(a_position, 1)).xy;\n\n        vec2 clipSpace = position / u_resolution * 2.0 - 1.0;\n\n        gl_Position = vec4(clipSpace * vec2(1, -1), 0, 1);\n    }\n","\n    precision mediump float;\n\n    uniform vec4 u_color;\n    uniform float u_fade_min; \n    uniform float u_fade_max;\n    uniform vec2 u_resolution;\n    uniform vec2 u_translation;\n\n    void main(void) {\n        vec4 p = u_color;\n        if (u_fade_min > 0.0) {\n            vec2 fix_tr = vec2(u_translation.x, u_resolution.y - u_translation.y); \n            float distance = distance(fix_tr.xy, gl_FragCoord.xy);\n            if (u_fade_min <= distance && distance <= u_fade_max) {\n                float percent = ((distance - u_fade_max) / (u_fade_min - u_fade_max)) * 100.0;\n                p.a = u_color.a * (percent / 100.0);\n            }\n        }\n\n        gl_FragColor = p;\n    }\n",ze,He))),this._registerRenderInit((()=>this._registerAndCompileWebGlProgram(l.WEBGL.DRAW_PROGRAMS.PRIMITIVES_M,"\n    precision mediump float;\n\n    attribute vec2 a_position;\n\n    uniform vec2 u_resolution;\n\n    void main(void) {\n        vec2 clipSpace = a_position / u_resolution * 2.0 - 1.0;\n\n        gl_Position = vec4(clipSpace * vec2(1, -1), 0, 1);\n    }\n","\n    precision mediump float;\n\n    uniform vec4 u_color;\n    uniform float u_fade_min; \n    uniform float u_fade_max;\n    uniform vec2 u_resolution;\n    uniform vec2 u_translation;\n\n    void main(void) {\n        vec4 p = u_color;\n        if (u_fade_min > 0.0) {\n            vec2 fix_tr = vec2(u_translation.x, u_resolution.y - u_translation.y); \n            float distance = distance(fix_tr.xy, gl_FragCoord.xy);\n            if (u_fade_min <= distance && distance <= u_fade_max) {\n                float percent = ((distance - u_fade_max) / (u_fade_min - u_fade_max)) * 100.0;\n                p.a = u_color.a * (percent / 100.0);\n            }\n        }\n\n        gl_FragColor = p;\n    }\n",Ke,Qe))),this._registerRenderInit(this.#yi._initWebGlAttributes)}_webGlEngine(){return this.#yi}addEventListener=(e,t,i)=>{this.#z.addEventListener(e,t,i)};removeEventListener=(e,t,i)=>{this.#z.removeEventListener(e,t,i)};get stageData(){return this.#Ni}get systemSettings(){return this.#Bi}get iLoader(){return this.#Ct}get canvas(){return this.#Li}get drawContext(){return this.#Di}emit=(e,...t)=>{const i=new Event(e);i.data=[...t],this.#z.dispatchEvent(i)};isAllFilesLoaded=()=>0===this.iLoader.filesWaitingForUpload;_isRenderActive(){return!!this.#Fi&&this.#Fi._isActive}initiateContext=e=>Promise.all(this.#ji.map((t=>t(e))));_registerAndCompileWebGlProgram(e,t,i,s,r){return this.#yi._registerAndCompileWebGlProgram(e,t,i,s,r),Promise.resolve()}_registerRenderInit(e){this.#ji.push(e)}_registerObjectRender(e,t,i){this.#yi._registerObjectRender(e,t,i)}setCanvasSize(e,t){this.#Li.width=e,this.#Li.height=t,this.#yi&&this.#yi._fixCanvasSize(e,t)}fixCanvasSize=()=>{const e=this.systemSettings,t=e.canvasMaxSize.width&&e.canvasMaxSize.width<window.innerWidth?e.canvasMaxSize.width:window.innerWidth,i=e.canvasMaxSize.height&&e.canvasMaxSize.height<window.innerHeight?e.canvasMaxSize.height:window.innerHeight;return this.setCanvasSize(t,i),Promise.resolve()};_createBoundariesPrecalculations(){}_startRender=async e=>{this.fixCanvasSize(),this.#Ni=e,this.systemSettings.gameOptions.library===l.LIBRARY.WEBGL&&(await this.#Gi(),this.#Fi=new qe(this.systemSettings,e,this._webGlEngine()),this.#Fi.addEventListener(l.EVENTS.SYSTEM.RENDER.START,(()=>this.emit(l.EVENTS.SYSTEM.RENDER.START))),this.#Fi.addEventListener(l.EVENTS.SYSTEM.RENDER.END,(()=>this.emit(l.EVENTS.SYSTEM.RENDER.END))),this.#Fi._start())};_stopRender=()=>{this.#Fi.removeEventListener(l.EVENTS.SYSTEM.RENDER.START,this.emit(l.EVENTS.SYSTEM.RENDER.START)),this.#Fi.removeEventListener(l.EVENTS.SYSTEM.RENDER.END,this.emit(l.EVENTS.SYSTEM.RENDER.END)),this.#Fi._stop(),this.#Fi=void 0};#Gi(){return new Promise(((e,t)=>{let i=[];const s=this.#Wi;i.push(this.initiateContext(this.#Ni)),s&&console.warn("isBoundariesPrecalculations() is turned off"),Promise.allSettled(i).then((i=>{i.forEach((e=>{if("rejected"===e.status){const i=e.reason;y(b,i),t(i)}})),e()}))}))}}class $e{#Ui;constructor(e){this.#Ui=e}registerDrawObject(e,t){this.#Ui.drawObjectFactory._registerNewObjectMethod(e,t)}registerAndCompileWebGlProgram(e,t,i,s,r){return this.#Ui.iRender._registerAndCompileWebGlProgram(e,t,i,s,r)}registerRenderInit(e){this.#Ui.iRender._registerRenderInit(e)}registerObjectRender(e,t,i){this.#Ui.iRender._registerObjectRender(e,t,i)}}class et{#Et;#Vi;#ki;#Xi;#ut=new te;#Yi;#zi=new re(this.#ut);#Hi=new Map;#Ki;#z=new EventTarget;constructor(e,t,i){e||S(E.CREATE_INSTANCE_ERROR,"systemSettings should be passed to class instance"),this.#Et=e,this.#Xi=new ce(this.iLoader),this.#ki=e.network.enabled?new le(e):null,this.#Yi=new Je(this.systemSettings,this.iLoader,i),this.#Vi=new $e(this),this.#Ki=t,this.#Yi.addEventListener(l.EVENTS.SYSTEM.RENDER.START,(()=>this.emit(l.EVENTS.SYSTEM.RENDER.START))),this.#Yi.addEventListener(l.EVENTS.SYSTEM.RENDER.END,(()=>this.emit(l.EVENTS.SYSTEM.RENDER.END)))}emit=(e,...t)=>{const i=new Event(e);i.data=[...t],this.#z.dispatchEvent(i)};addEventListener=(e,t,i)=>{this.#z.addEventListener(e,t,i)};removeEventListener=(e,t,i)=>{this.#z.removeEventListener(e,t,i)};get iNetwork(){return this.#ki}get systemSettings(){return this.#Et}get audio(){return this.#Xi}get iLoader(){return this.#ut}get iRender(){return this.#Yi}get drawObjectFactory(){return this.#zi}get iExtension(){return this.#Vi}get modules(){return this.#Hi}installModule=(e,t,...i)=>{const s=new t(this,...i);return this.#Hi.has(e)?(y("MODULE_ALREADY_INSTALLED","module "+e+" is already installed"),this.#Hi.get(e)):(this.#Hi.set(e,s),s)};startGameStage=(e,t)=>{if(this.#Ki.has(e))if(!0===this.#Yi._isRenderActive())this.#Yi._stopRender(),S(E.ANOTHER_STAGE_ACTIVE," Can't start the stage "+e+" while, another stage is active");else{const i=this.#Ki.get(e),s=i.stageData;this.#zi._attachPageData(s),!1===i.isInitiated&&i._init(),i._start(t),s._processPendingRenderObjects(),this.emit(l.EVENTS.SYSTEM.START_PAGE),this.#Yi._startRender(s)}else S(E.VIEW_NOT_EXIST,"Stage "+e+" is not registered!")};stopGameStage=e=>{this.#Ki.has(e)?(this.emit(l.EVENTS.SYSTEM.STOP_PAGE),this.drawObjectFactory._detachPageData(),this.#Yi._stopRender(),this.#Ki.get(e)._stop()):S(E.STAGE_NOT_EXIST,"GameStage "+e+" is not registered!")}}class tt{#Qi;#Zi=!1;#r;#qi;#Si;constructor(){this.#r=!1}_register(e,t){this.#Qi=e,this.#qi=t,this.#Si=new V(this.#qi.systemSettings.gameOptions),this.#Ji(),this.#$i(),this.register()}_init(){this.init(),this.#Zi=!0}register(){}init(){}start(e){}stop(){}resize(){}get iLoader(){return this.#qi.iLoader}get draw(){return this.#qi.drawObjectFactory}_attachCanvasToContainer(e){this.#es(this.canvasHtmlElement,e)}addRenderObject=e=>{const t=this.stageData;-1!==t.renderObjects.indexOf(e)?y("NEW_BEHAVIOR_INTRODUCED","stage.draw methods add objects to pageData, no need to call addRenderObject"):t._renderObject=e};get isActive(){return this.#r}get isInitiated(){return this.#Zi}get name(){return this.#Qi}get stageData(){return this.#Si}get systemSettings(){return this.#qi.systemSettings}get audio(){return this.#qi.audio}get iSystem(){return this.#qi}get canvasHtmlElement(){return document.getElementsByTagName("canvas")[0]}addEventListener=(e,t,i)=>{this.iSystem.addEventListener(e,t,i)};removeEventListener=(e,t,i)=>{this.iSystem.removeEventListener(e,t,i)};_start(e){this.start(e),this.#r=!0,window.addEventListener("resize",this._resize),this._resize()}_stop(){this.#r=!1,window.removeEventListener("resize",this._resize),this.stop()}_resize=()=>{this.#$i(),this.resize()};#es(e,t){t.appendChild(e)}#Ji(){const e=this.systemSettings.worldSize?this.systemSettings.worldSize.width:0,t=this.systemSettings.worldSize?this.systemSettings.worldSize.height:0;this.stageData._setWorldDimensions(e,t)}isBoundariesCollision=(e,t,i)=>{const s=i.type,r=i.vertices,n=i.circleBoundaries;switch(s){case m:case c:case u:case f:return n?this.#ts(e,t,i.circleBoundaries.r):this.#is(e,t,r,i.rotation);case h:y(A,"isObjectCollision.circle check is not implemented yet!");break;case g:y(A,"isObjectCollision.line check is not implemented yet, please use .rect instead line!");break;default:y(R,"unknown object type!")}return!1};isObjectsCollision=(e,t,i,s)=>{const r=i.type,n=i.vertices,a=i.circleBoundaries;switch(r){case m:case c:case u:case f:return a?this.#ss(e,t,a,s):this.#rs(e,t,n,i.rotation,s);case h:y(A,"isObjectCollision.circle check is not implemented yet!");break;case g:y(A,"isObjectCollision.line check is not implemented yet, please use .rect instead line!");break;default:y(R,"unknown object type!")}return!1};#rs(e,t,i,s,r){const n=r.length;let a=[];for(let o=0;o<n;o++){const n=r[o];let l;switch(n.type){case m:case c:case u:case f:l=this.#ns(e,t,i,s,n);break;case h:console.warn("isObjectCollision.circle check is not implemented yet!");break;case g:console.warn("isObjectCollision.line check is not implemented, please use rect instead");break;default:console.warn("unknown object type!")}l&&a.push(n)}return a.length>0&&a}#ss(e,t,i,s){const r=i.r,n=s.length;let a=[];for(let i=0;i<n;i++){const n=s[i],o=n.type,l=n.circleBoundaries;let d;switch(o){case m:case c:case u:case f:d=l?this.#as(e,t,r,n.x,n.y,l.r):this.#os(e,t,r,n);break;case h:console.warn("isObjectCollision.circle check is not implemented yet!");break;case g:console.warn("isObjectCollision.line check is not implemented, please use rect instead");break;default:console.warn("unknown object type!")}d&&a.push(n)}return a.length>0&&a}#ls(e){return e.sort(((e,t)=>e.p<t.p))[0]}#os(e,t,i,s){const[r,n]=this.stageData.worldOffset,a=e-r,o=t-n,l=s.x-r,c=s.y-n,u=s.vertices,h=s.rotation,d=u.length;for(let e=0;e<d;e+=1){const t=u[e];let s=u[e+1];s||(s=u[0]);const r=this.#cs(t,l,c,h),n=this.#cs(s,l,c,h),d=Oe(a,o,i,{x1:r[0],y1:r[1],x2:n[0],y2:n[1]});if(d)return d}return!1}#as(e,t,i,s,r,n){return!(new j(e,t,s,r).length-(i+n)>0)}#ns(e,t,i,s,r){const[n,a]=this.stageData.worldOffset,o=e-n,l=t-a,c=r.x-n,u=r.y-a,h=r.vertices,d=r.rotation,g=i.map((e=>this.#cs(e,o,l,s))),m=h.length;for(let e=0;e<m;e+=1){const t=h[e];let i=h[e+1];i||(i=h[0]);const s=this.#cs(t,c,u,d),r=this.#cs(i,c,u,d),n=ve(g,{x1:s[0],y1:s[1],x2:r[0],y2:r[1]});if(n)return n}return!1}#cs(e,t,i,s){const r=new j(0,0,e[0],e[1]),n=fe(0,0,e[0],e[1]),a=r.length;return[t+a*Math.cos(s+n),i+a*Math.sin(s+n)]}#ts(e,t,i){const s=this.stageData.getRawBoundaries(),r=this.stageData.getEllipseBoundaries(),n=this.stageData.getPointBoundaries(),[a,o]=this.stageData.worldOffset,l=e-a,c=t-o,u=this.stageData.boundariesLen,h=this.stageData.ellipseBLen,d=this.stageData.pointBLen;for(let e=0;e<u;e+=4){const t=s[e],r=s[e+1],n=s[e+2],a=s[e+3];if(0!==t||0!==r||0!==n||0!==a){const e=Oe(l,c,i,{x1:t,y1:r,x2:n,y2:a});if(e)return e}}if(h>0)for(let e=0;e<h;e+=4){const t=Ce([r[e],r[e+1],r[e+2],r[e+3]],{x:l,y:c,r:i});if(t)return t}if(d>0)for(let e=0;e<d;e+=2){const t=Ie(n[e],n[e+1],{x:l,y:c,r:i});if(t)return t}return!1}#is(e,t,i,s){const r=this.stageData.getRawBoundaries(),n=this.stageData.getEllipseBoundaries(),a=this.stageData.getPointBoundaries(),[o,l]=this.stageData.worldOffset,c=e-o,u=t-l,h=i.map((e=>this.#cs(e,c,u,s))),d=this.stageData.boundariesLen,g=this.stageData.ellipseBLen,m=this.stageData.pointBLen;for(let e=0;e<d;e+=4){const t=r[e],i=r[e+1],s=r[e+2],n=r[e+3];if(0!==t||0!==i||0!==s||0!==n){const e=ve(h,{x1:t,y1:i,x2:s,y2:n});if(e)return e}}if(g>0)for(let e=0;e<g;e+=4){const t=Me([n[e],n[e+1],n[e+2],n[e+3]],h);if(t)return t}if(m>0)for(let e=0;e<m;e+=2){const t=Se(a[e],a[e+1],h);if(t)return t}return!1}#$i(){const e=this.systemSettings.canvasMaxSize.width&&this.systemSettings.canvasMaxSize.width<window.innerWidth?this.systemSettings.canvasMaxSize.width:window.innerWidth,t=this.systemSettings.canvasMaxSize.height&&this.systemSettings.canvasMaxSize.height<window.innerHeight?this.systemSettings.canvasMaxSize.height:window.innerHeight;this.stageData._setCanvasDimensions(e,t)}}class it extends tt{#us=0;#hs=0;#ds=0;register(){}init(){const[e,t]=this.stageData.canvasDimensions,i=e/3;this.background=this.draw.rect(0,0,e,t,this.systemSettings.gameOptions.loadingScreen.backgroundColor),this.loadingBarBg=this.draw.rect(e/2-i/2,t/2-10,i,20,this.systemSettings.gameOptions.loadingScreen.loadingBarBg),this.loadingBarProgress=this.draw.rect(e/2-i/2,t/2-10,i,20,this.systemSettings.gameOptions.loadingScreen.loadingBarProgress),this.text=this.draw.text(e/2-20,t/2-40,"JsGE","24px sans-serif","black"),this.#ds=i}_progress=e=>{const t=this.#ds/this.#us;this.#hs=e;const i=t*this.#hs,s=e>this.#us?this.#ds:i;this.loadingBarProgress.width=s};start(e){this.#us=e.total}}const st="loadingPage";class rt{#gs;#ms;constructor(e,t){e||(e={});const i=Object.assign(ne,e);this.#gs=new Map,t||(t=document.createElement("div"),document.body.appendChild(t)),this.#ms=new et(i,this.#gs,t),this.#fs()}get iSystem(){return this.#ms}registerStage(e,t){if(e&&"string"==typeof e&&e.trim().length>0){const i=new t;i._register(e,this.iSystem),this.#gs.set(e,i)}else S(E.CREATE_INSTANCE_ERROR,"valid class name should be provided")}preloadAllData(){return this.#ms.iLoader.preload()}#fs(){this.registerStage(st,it),this.#ms.iLoader.addEventListener("loadstart",this.#Es),this.#ms.iLoader.addEventListener("progress",this.#_s),this.#ms.iLoader.addEventListener("load",this.#ps)}#Es=e=>{this.#ms.startGameStage(st,{total:e.total})};#_s=e=>{const t=e.loaded,i=e.total;this.#gs.get(st)._progress(t,i)};#ps=()=>{this.#ms.stopGameStage(st)}}var nt=n.oX,at=n.QD,ot=n.T_,lt=n.uw,ct=n.xl,ut=n.xP,ht=n.bq,dt=n.P6;export{nt as CONST,at as DrawImageObject,ot as GameStage,lt as ISystemAudio,ct as Primitives,ut as System,ht as SystemSettings,dt as utils};