var e,t,i={},s={};function n(e){var t=s[e];if(void 0!==t)return t.exports;var r=s[e]={exports:{}};return i[e](r,r.exports,n),r.exports}n.m=i,n.d=(e,t)=>{for(var i in t)n.o(t,i)&&!n.o(e,i)&&Object.defineProperty(e,i,{enumerable:!0,get:t[i]})},n.f={},n.e=e=>Promise.all(Object.keys(n.f).reduce(((t,i)=>(n.f[i](e,t),t)),[])),n.u=e=>e+".index.es6.min.js",n.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),e={},t="jsge:",n.l=(i,s,r,a)=>{if(e[i])e[i].push(s);else{var o,l;if(void 0!==r)for(var h=document.getElementsByTagName("script"),d=0;d<h.length;d++){var c=h[d];if(c.getAttribute("src")==i||c.getAttribute("data-webpack")==t+r){o=c;break}}o||(l=!0,(o=document.createElement("script")).type="module",o.charset="utf-8",o.timeout=120,n.nc&&o.setAttribute("nonce",n.nc),o.setAttribute("data-webpack",t+r),o.src=i),e[i]=[s];var u=(t,s)=>{o.onerror=o.onload=null,clearTimeout(g);var n=e[i];if(delete e[i],o.parentNode&&o.parentNode.removeChild(o),n&&n.forEach((e=>e(s))),t)return t(s)},g=setTimeout(u.bind(null,void 0,{type:"timeout",target:o}),12e4);o.onerror=u.bind(null,o.onerror),o.onload=u.bind(null,o.onload),l&&document.head.appendChild(o)}},n.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},(()=>{var e;if("string"==typeof import.meta.url&&(e=import.meta.url),!e)throw new Error("Automatic publicPath is not supported in this browser");e=e.replace(/#.*$/,"").replace(/\?.*$/,"").replace(/\/[^\/]+$/,"/"),n.p=e})(),(()=>{var e={179:0};n.f.j=(t,i)=>{var s=n.o(e,t)?e[t]:void 0;if(0!==s)if(s)i.push(s[2]);else{var r=new Promise(((i,n)=>s=e[t]=[i,n]));i.push(s[2]=r);var a=n.p+n.u(t),o=new Error;n.l(a,(i=>{if(n.o(e,t)&&(0!==(s=e[t])&&(e[t]=void 0),s)){var r=i&&("load"===i.type?"missing":i.type),a=i&&i.target&&i.target.src;o.message="Loading chunk "+t+" failed.\n("+r+": "+a+")",o.name="ChunkLoadError",o.type=r,o.request=a,s[1](o)}}),"chunk-"+t,t)}};var t=(t,i)=>{var s,r,[a,o,l]=i,h=0;if(a.some((t=>0!==e[t]))){for(s in o)n.o(o,s)&&(n.m[s]=o[s]);l&&l(n)}for(t&&t(i);h<a.length;h++)r=a[h],n.o(e,r)&&e[r]&&e[r][0](),e[r]=0},i=self.webpackChunkjsge=self.webpackChunkjsge||[];i.forEach(t.bind(null,0)),i.push=t.bind(null,i.push.bind(i))})();var r={};n.d(r,{oX:()=>l,QD:()=>Y,T_:()=>Ge,uw:()=>te,xl:()=>a,xP:()=>je,bq:()=>J,P6:()=>o});var a={};n.r(a),n.d(a,{Rectangle:()=>F,Vector:()=>k,Vertex:()=>G});var o={};n.r(o),n.d(o,{angle_2points:()=>oe,angle_3points:()=>le,calculateEllipseVertices:()=>Ie,countClosestTraversal:()=>re,countClosestTraversal2:()=>ae,countDistance:()=>ge,crossProduct:()=>ce,dotProduct:()=>de,dotProductWithAngle:()=>he,generateUniqId:()=>be,isCircleLineIntersect:()=>Se,isEllipseCircleIntersect:()=>ye,isEllipseLineIntersect:()=>xe,isEllipsePolygonIntersect:()=>Re,isLineShorter:()=>me,isMobile:()=>ie,isPointCircleIntersect:()=>Te,isPointInsidePolygon:()=>Ae,isPointLineIntersect:()=>fe,isPointOnTheLine:()=>ue,isPointPolygonIntersect:()=>_e,isPointRectIntersect:()=>pe,isPolygonLineIntersect:()=>Ee,isSafari:()=>se,pointToCircleDistance:()=>ne,randomFromArray:()=>ve,verticesArrayToArrayNumbers:()=>we});const l={MODE:{DEBUG:"DEBUG",PRODUCTION:"PRODUCTION"},SCREENS:{},AUDIO:{},CONNECTION_STATUS:{DISCONNECTED:"disconnected",CONNECTED:"connected",CONNECTION_LOST:"connection lost"},EVENTS:{SYSTEM:{START_PAGE:"START_PAGE",STOP_PAGE:"STOP_PAGE",RENDER:{START:"start",END:"end"}},GAME:{BOUNDARIES_COLLISION:"BOUNDARIES_COLLISION",OBJECTS_COLLISION:"OBJECTS_COLLISION"},WEBSOCKET:{SERVER_CLIENT:{CONNECTION_STATUS_CHANGED:"CONNECTION_STATUS_CHANGED",ROOMS_INFO:"roomsInfo",CREATED:"created",JOINED:"joined",FULL:"full",DISCONNECTED:"disconnected",SERVER_MESSAGE:"message",RESTARTED:"restarted"},CLIENT_SERVER:{ROOMS_INFO_REQUEST:"gatherRoomsInfo",CREATE_OR_JOIN:"create or join",RESTART_REQUEST:"restart",CLIENT_MESSAGE:"message"}}},WEBGL:{DRAW_PROGRAMS:{PRIMITIVES:"drawPrimitives",IMAGES:"drawImages"}},DRAW_TYPE:{RECTANGLE:"rect",CONUS:"conus",CIRCLE:"circle",POLYGON:"polygon",LINE:"line",TEXT:"text",IMAGE:"image"},LAYERS:{DEFAULT:"default-view-layer",BOUNDARIES:"boundaries-view-layer"},GAME_OPTIONS:{},LIBRARY:{WEBGL:"webgl"},OPTIMIZATION:{CYCLE_TIME_CALC:{AVERAGES:"AVERAGES",CURRENT:"CURRENT"},NATIVE_JS:{NOT_OPTIMIZED:"NOT_OPTIMIZED",OPTIMIZED:"OPTIMIZED"},WEB_ASSEMBLY:{ASSEMBLY_SCRIPT:"ASSEMBLY_SCRIPT",NATIVE_WAT:"WASM"}}},h="CREATE_INSTANCE_ERROR",d="VIEW_NOT_EXIST",c="CANT_GET_THE_IMAGE",u="UNEXPECTED_INPUT_PARAMS",g="WEBGL_ERROR",m="NOT_FOUND",f="WORLD_DIMENSIONS_NOT_SET",E="UNHANDLED_DRAW_ISSUE",_="UNEXPECTED_WORLD_SIZE",A="AUDIO_NOT_REGISTERED",p="AUDIO_NOT_LOADED",T="POLYGON_VERTICES_NOT_CORRECT";function S(e,t){throw new Error(e+": "+t)}function x(e,t){console.warn(e,t)}class y{#e;#t;#i;#s;#n=0;#r=0;#a=0;#o=0;#l=0;#h=0;#d=!1;#c=0;#u=0;#g=0;#m;#f;#E;#_;#A=[];#p;#T=!1;constructor(e){}isOffsetTurnedOff(){return this.#p}set mapRotate(e){this.#l=e}get isMaxBoundariesSizeSet(){return this.#d}#S(e){this._addBoundaryLine(e.x1,e.y1,e.x2,e.y2)}_addBoundariesArray(e){const t=e.length;for(let i=0;i<t;i++){const t=e[i];this._addBoundaryLine(t[0],t[1],t[2],t[3])}}_addBoundaryLine(e,t,i,s){this.#m[this.#c]=e,this.#c++,this.#m[this.#c]=t,this.#c++,this.#m[this.#c]=i,this.#c++,this.#m[this.#c]=s,this.#c++}_addEllipseBoundary(e,t,i,s){this.#f[this.#g]=e,this.#g++,this.#f[this.#g]=t,this.#g++,this.#f[this.#g]=i,this.#g++,this.#f[this.#g]=s,this.#g++}_addPointBoundary(e,t){this.#E[this.#u]=e,this.#u++,this.#E[this.#u]=t,this.#u++}_removeBoundaryLine(e){this.#m[e]=0,this.#m[e+1]=0,this.#m[e+2]=0,this.#m[e+3]=0}_clearBoundaries(){this.#m.fill(0),this.#f.fill(0),this.#E.fill(0),this.#c=0,this.#g=0,this.#u=0}_initiateBoundariesData(){this.#m=new Float32Array(this.#h),this.#f=new Float32Array(this.#h),this.#E=new Float32Array(this.#h)}_setMaxBoundariesSize(e){this.#h=e,this.#d=!0}_setWorldDimensions(e,t){this.#e=e,this.#t=t}_setCanvasDimensions(e,t){this.#i=e,this.#s=t}_setMapBoundaries(){const[e,t]=[this.#e,this.#t],[i,s]=[this.#n,this.#r],n=e-i,r=t-s;e&&t||x(f,"Can't set map boundaries."),this.#S({x1:0,y1:0,x2:n,y2:0}),this.#S({x1:n,y1:0,x2:n,y2:r}),this.#S({x1:n,y1:r,x2:0,y2:r}),this.#S({x1:0,y1:r,x2:0,y2:0})}_setWholeWorldMapBoundaries(){const[e,t]=[this.#e,this.#t];e&&t||x(f,"Can't set map boundaries."),this.#_.push([0,0,e,0]),this.#_.push([e,0,e,t]),this.#_.push([e,t,0,t]),this.#_.push([0,t,0,0])}_mergeBoundaries(e=!1){const t=e?this.getWholeWorldBoundaries():this.getBoundaries(),i=new Set(t);for(const e of i.values()){const t=e[0],s=e[1],n=e[2],r=e[3];for(const a of i.values()){const o=a[0],l=a[1],h=a[2],d=a[3];t===h&&s===d&&n===o&&r===l&&(i.delete(e),i.delete(a)),n!==o||r!==l||t!==h&&s!==d||(a[0]=t,a[1]=s,i.delete(e))}}e?this.#m=Array.from(i):this.#_=Array.from(i),i.clear()}_setWholeMapBoundaries(e){this.#_.push(...e)}_enableMapBoundaries(){this.#T=!0}getBoundaries(){const e=this.#m,t=this.#c;let i=[],s=[];for(let n=0;n<t;n++){const t=e[n];i.push(t),(n+1)%4==0&&(s.push(i),i=[])}return s}getRawBoundaries(){return this.#m}getEllipseBoundaries(){return this.#f}getPointBoundaries(){return this.#E}getWholeWorldBoundaries(){return this.#_}get isWorldBoundariesEnabled(){return this.#T}get canvasDimensions(){return[this.#i,this.#s]}get worldDimensions(){return[this.#e,this.#t]}get worldOffset(){return[this.#n,this.#r]}get mapCenter(){return[this.#a,this.#o]}get mapRotate(){return this.#l}get boundariesLen(){return this.#c}get ellipseBLen(){return this.#g}get pointBLen(){return this.#u}centerCameraPosition=(e,t)=>{let[i,s]=this.worldOffset;const[n,r]=this.canvasDimensions,[a,o]=this.worldDimensions,l=n/2,h=r/2,d=h-s;if(l-i<e)if(e<a-l){const t=e-l;t>=0&&(this.#n=Math.round(t))}else if(a>n){const e=a-n;this.#n=Math.round(e)}if(d<t)if(t<o-h){const e=t-h;e>=0&&(this.#r=Math.round(e))}else if(o>r){const e=o-r;this.#r=Math.round(e)}this.#a=e,this.#o=t};personRotatedCenterCamera=(e,t,i)=>{console.log("new centering algorithm")};get renderObjects(){return this.#A}getObjectsByInstance(e){return this.#A.filter((t=>t instanceof e))}_sortRenderObjectsBySortIndex(){this.#A=this.#A.sort(((e,t)=>e.sortIndex-t.sortIndex))}set _renderObject(e){this.#A.push(e)}set _renderObjects(e){this.#A=e}}const R={loadstart:"loadstart",progress:"progress",abort:"abort",error:"error",load:"load",timeout:"timeout"},b=" loader is not registered.",v="Too much recursion. Stop iteration.",w="uploadMethod should be instance of Promise and return upload result value",I=" AtlasXML file extension is incorrect, only .xml file supported",P=" tileset file extension is not correct, only .tsj or .json files are supported",O=" tilemap file extension is not correct, only .tmj or .json files are supported",C=" fileKey and url should be provided";class M{#x;#y;#R=new Map;#b=new Map;constructor(e,t){this.#x=e,this.#y=(e,i,...s)=>{const n=t(e,i,...s);if(n instanceof Promise)return n.then((t=>this.#v(t,e)));throw new TypeError(w)}}#v=(e,t)=>new Promise(((i,s)=>{e||null===e||L("AssetsManager: uploadMethod for "+this.#x+" returns incorrect value"),this.#w(t,e),this.#I(t),i()}));#w(e,t){this.#b.set(e,t)}#I(e){this.#R.delete(e)}get filesWaitingForUpload(){return this.#R.size}get loadingQueue(){return this.#R}get uploadMethod(){return this.#y}_addFile=(e,t)=>{this.#R.has(e)&&L("AssetsManager: File "+this.#x+" with key "+e+" is already added"),this.#R.set(e,t)};_isFileInQueue=e=>this.#R.has(e);_getFile=e=>this.#b.get(e)}class D{#P=5;#O=new EventTarget;#C=new Map;#M=0;constructor(){this.registerLoader("Audio",this._loadAudio),this.registerLoader("Image",this._loadImage),this.registerLoader("TileMap",this._loadTileMap),this.registerLoader("TileSet",this._loadTileSet),this.registerLoader("AtlasImageMap",this._loadAtlasImage),this.registerLoader("AtlasXML",this._loadAtlasXml)}get filesWaitingForUpload(){let e=0;return Array.from(this.#C.values()).map((t=>e+=t.filesWaitingForUpload)),e}registerLoader=(e,t=this._defaultUploadMethod)=>{this["add"+e]=(t,i,...s)=>{this.addFile(e,t,i,...s)},this["get"+e]=t=>this.getFile(e,t),this["is"+e+["InQueue"]]=t=>this.isFileInQueue(e,t);const i=this.#C.get(e)||new M(e,t);this.#C.set(e,i)};preload(){return this.#D(),new Promise((async(e,t)=>{this.#B().then((()=>{this.#L(),e()})).catch((e=>{t(e)}))}))}#B(e=0){return this.#N().then((t=>{if(0===this.filesWaitingForUpload)return Promise.resolve(t);if(++e>this.#P){const e=new Error(v);return this.#W(e),Promise.reject(new Error(v))}return this.#B(e)}))}#N(){return new Promise(((e,t)=>{let i=[];Array.from(this.#C.values()).forEach((e=>{Array.from(e.loadingQueue.entries()).forEach((t=>{const s=new Promise(((i,s)=>e.uploadMethod(t[0],...t[1]).then((e=>i(e)))));i.push(s)}))})),Promise.allSettled(i).then((i=>{for(const s of i){if("rejected"===s.status){const e=s.reason;this.#G(e)?t(e):(L("AssetsManager: "+e.message),this.#W(e))}e(i)}}))}))}addEventListener(e,t,...i){R[e]?this.#O.addEventListener(e,t,...i):L("AssetsManager: Event type should be one of the ProgressEvent.type")}removeEventListener(e,t,...i){this.#O.removeEventListener(e,t,...i)}_loadAtlasXml=(e,t)=>(this.#F(t),fetch(t).then((e=>e.text())).then((e=>(new window.DOMParser).parseFromString(e,"text/xml"))).then((i=>{const s=i.documentElement||i.activeElement,n=s.attributes.getNamedItem("imagePath"),r=s.children;if(n){const i=this.#k(t);return this.addAtlasImageMap(e,i+n.value,r,i),Promise.resolve(s)}{const t=new Error(e+" XML format is not correct.");return this.#W(t),Promise.resolve(t)}})));_loadAtlasImage=(e,t,i,s="anonymous")=>new Promise(((e,n)=>{const r=new Image,a=new Map,o=document.createElement("canvas"),l=o.getContext("2d");r.crossOrigin=s,r.onload=()=>{const t=[];let s=[];o.width=r.width,o.height=r.height,l.drawImage(r,0,0);for(let e of i){const i=e.attributes,n=i.getNamedItem("name").value,r=n.includes(".")?n.split(".")[0]:n,a=i.getNamedItem("x").value,o=i.getNamedItem("y").value,h=i.getNamedItem("width").value,d=i.getNamedItem("height").value;t.push(createImageBitmap(l.getImageData(a,o,h,d),{premultiplyAlpha:"premultiply"})),s.push(r)}this.#j(),Promise.all(t).then((t=>{t.forEach(((e,t)=>{const i=s[t];a.set(i,e),this.addImage(i,"empty url",e)})),o.remove(),e(a)}))},r.onerror=()=>{const i=new Error("Error loading atlas image "+t);this.#W(i),e(null)},r.src=t}));_loadTileSet=(e,t,i=1,s)=>(this.#U(t),fetch(s?s+t:t).then((e=>e.json())).then((e=>{const{name:t,image:n,spacing:r,margin:a,tilewidth:o,tileheight:l}=e;return t&&n&&!this.isFileInQueue("Image",t)&&this.addImage(t,s?s+n:n),e.gid=i,Promise.resolve(e)})).catch((()=>{const e=new Error("Error loading related tileset "+t);return this.#W(e),Promise.resolve(null)})));_defaultUploadMethod=(e,t)=>fetch(t);_loadTileMap=(e,t,i=!0)=>(this.#V(t),fetch(t).then((e=>e.json())).then((e=>{const s=this.#k(t);if(!0===i&&e.tilesets&&e.tilesets.length>0){const t=[];return e.tilesets.forEach(((e,i)=>{const{firstgid:n,source:r}=e,a=this._loadTileSet("default-"+n,r,n,s).then((e=>(this.#j(),Promise.resolve(e))));t.push(a)})),Promise.all(t).then((t=>{for(let i=0;i<t.length;i++){const s=t[i];e.tilesets[i].data=s}return Promise.resolve(e)}))}return Promise.resolve(e)})).catch((e=>(e.message.includes("JSON.parse:")&&(e=new Error("Error loading tilemap "+t)),this.#W(e),Promise.resolve(null)))));_loadAudio=(e,t)=>new Promise((e=>{const i=new Audio(t);i.addEventListener("loadeddata",(()=>{this.#j(),e(i)})),i.addEventListener("error",(()=>{const i=new Error("Error loading audio "+t);this.#W(i),e(null)}))}));_loadImage=(e,t,i,s="anonymous")=>new Promise(((e,n)=>{if(i)e(i);else{const i=new Image;i.crossOrigin=s,i.onload=()=>{createImageBitmap(i,{premultiplyAlpha:"premultiply"}).then((t=>{this.#j(),e(t)}))},i.onerror=()=>{const i=new Error("Error loading image "+t);this.#W(i),e(null)},i.src=t}}));#F(e){e.includes(".xml")||B(e+I)}#U(e){e.includes(".tsj")||e.includes(".json")||B(e+P)}#V(e){e.includes(".tmj")||e.includes(".json")||B(e+O)}#G(e){return e.message.includes(w)||e.message.includes(I)||e.message.includes(P)||e.message.includes(O)||e.message.includes(C)||e.message.includes(b)}#k(e){let t=e.split("/"),i=t.length,s="/";return t[i-1].includes(".tmj")||t[i-1].includes(".xml")||t[i-1].includes(".json")?(t.pop(),s=t.join("/")+"/"):(t[i-2].includes(".tmj")||t[i-2].includes(".xml")||t[i-2].includes(".json"))&&(t.splice(i-2,2),s=t.join("/")+"/"),s}addFile(e,t,i,...s){const n=this.#C.get(e);n?(this.#Y(t,i,e),n._addFile(t,[i,...s])):B(e+b)}isFileInQueue(e,t){const i=this.#C.get(e);if(i)return i._isFileInQueue(t);B("Loader for "+e+" is not registered!")}getFile(e,t){const i=this.#C.get(e);if(i)return i._getFile(t);B("Loader for "+e+" is not registered!")}#Y(e,t,i){const s=C;e&&0!==e.trim().length||B("add"+i+"()"+s),t&&0!==t.trim().length||B("add"+i+"()"+s)}#D(){let e=this.filesWaitingForUpload;this.#O.dispatchEvent(new ProgressEvent(R.loadstart,{total:e}))}#L(){this.#O.dispatchEvent(new ProgressEvent(R.load))}#j(){const e=this.filesWaitingForUpload;this.#M+=1,this.#O.dispatchEvent(new ProgressEvent(R.progress,{lengthComputable:!0,loaded:this.#M,total:e}))}#W(e){L("AssetsManger: "+e.message),this.#O.dispatchEvent(new ErrorEvent(R.error,{error:e}))}}function B(e){throw new Error(e)}function L(e){console.warn(e)}class N{#z;#X;#H;#K;#q;#Z=0;#J=0;#Q=be();#$=!1;#ee;#te;#p=!1;#ie=!1;constructor(e,t,i,s){this.#z=t,this.#X=i,this.#H=s,this.#K=e}get bgColor(){return this.#H}set bgColor(e){this.#H=e}get type(){return this.#K}get x(){return this.#z}get y(){return this.#X}set x(e){this.#z=e}set y(e){this.#X=e}get sortIndex(){return this.#Z}set sortIndex(e){this.#Z=e}get blendFunc(){return this.#q}set blendFunc(e){this.#q=e}get rotation(){return this.#J}set rotation(e){this.#J=e}get id(){return this.#Q}get isRemoved(){return this.#$}destroy(){this.#$=!0}get isMaskAttached(){return!!this.#ee}get _maskId(){return this.#ee}setMask(e){e._isMask=!0,this.#ee=e.id}removeMask(){this.#ee=null}set _isMask(e){this.#te=e}get _isMask(){return this.#te}get isOffsetTurnedOff(){return this.#p}turnOffOffset(){this.#p=!0}_calculateRectVertices=(e,t)=>{const i=e/2,s=t/2;return[[-i,-s],[i,-s],[i,s],[-i,s]]};_interpolateConus(e,t=2*Math.PI,i=Math.PI/14){let s=[0,0];for(let n=0;n<=t;n+=i){let t=Math.cos(n)*e,i=Math.sin(n)*e;s.push(t,i)}return s}_calculateConusBoundaries(e,t=2*Math.PI,i=Math.PI/14){let s=[];for(let n=0;n<=t;n+=i){let t=Math.cos(n)*e,i=Math.sin(n)*e;s.push([t,i])}return s}_convertVerticesArray(e){return void 0!==e[0].x&&void 0!==e[0].y?we(e):e}}class W extends N{#se;#D;#ne;constructor(e,t,i,s,n){super(l.DRAW_TYPE.RECTANGLE,e,t,n),this.#se=i,this.#D=s,this.#ne=this._calculateRectVertices(i,s)}get vertices(){return this.#ne}get width(){return this.#se}get height(){return this.#D}set width(e){this.#se=e}set height(e){this.#D=e}}class G{#z;#X;constructor(e,t){this.#z=e,this.#X=t}get x(){return this.#z}get y(){return this.#X}}class F{#z;#X;#se;#D;constructor(e,t,i,s){this.#z=e,this.#X=t,this.#se=i,this.#D=s}get x(){return this.#z}get y(){return this.#X}get width(){return this.#se}get height(){return this.#D}}class k{#z;#X;constructor(e,t,i,s){this.#z=i-e,this.#X=s-t}get x(){return this.#z}get y(){return this.#X}get length(){return Math.sqrt(Math.pow(this.#z,2)+Math.pow(this.#X,2))}get tetaAngle(){return Math.atan2(this.#X,this.#z)}}class j extends N{#re;#ae;#oe;#le;#he;#de;#ce;#ue=document.createElement("canvas");#ge;constructor(e,t,i,s,n){super(l.DRAW_TYPE.TEXT,e,t),this.#de=i,this.#re=s,this.#le=n,this.#ce,this.#me()}get boundariesBox(){const e=this.textMetrics?Math.floor(this.textMetrics.width):300,t=this.textMetrics?Math.floor(this.textMetrics.fontBoundingBoxAscent+this.textMetrics.fontBoundingBoxDescent):30;return new F(this.x,this.y-t,e,t)}get vertices(){const e=this.boundariesBox;return this._calculateRectVertices(e.width,e.height)}get text(){return this.#de}set text(e){e!==this.#de&&(this.#de=e,this.#me())}get font(){return this.#re}set font(e){e!==this.#re&&(this.#re=e,this.#me())}get textAlign(){return this.#ae}set textAlign(e){e!==this.#ae&&(this.#ae=e,this.#me())}get textBaseline(){return this.#oe}set textBaseline(e){e!==this.#oe&&(this.#oe=e,this.#me())}get fillStyle(){return this.#le}set fillStyle(e){e!==this.#le&&(this.#le=e,this.#me())}get strokeStyle(){return this.#he}set strokeStyle(e){e!==this.#he&&(this.#he=e,this.#me())}get textMetrics(){return this.#ce}set _textMetrics(e){this.#ce=e}get _textureStorage(){return this.#ge}set _textureStorage(e){this.#ge=e}get _textureCanvas(){return this.#ue}#me(){const e=this.#ue.getContext("2d",{willReadFrequently:!0});if(e){e.font=this.font,this._textMetrics=e.measureText(this.text);const t=this.boundariesBox.width,i=this.boundariesBox.height;e.canvas.width=t,e.canvas.height=i,e.clearRect(0,0,t,i),e.font=this.font,e.textBaseline="bottom",this.fillStyle&&(e.fillStyle=this.fillStyle,e.fillText(this.text,0,i)),this.strokeStyle&&(e.strokeStyle=this.strokeStyle,e.strokeText(this.text,0,i)),this.#ge&&(this.#ge._isTextureRecalculated=!0)}else S("UNHANDLED_EXCEPTION","can't getContext('2d')")}}class U extends N{#fe;#Ee;#ne;#_e;constructor(e,t,i,s,n,r=0){super(l.DRAW_TYPE.CONUS,e,t,s),this.#fe=i,this.#Ee=n,this.#_e=r,this.#ne=this._interpolateConus(i,n)}get vertices(){return this.#ne}set vertices(e){this.#ne=e}get radius(){return this.#fe}get angle(){return this.#Ee}get fade_min(){return this.#_e}set fade_min(e){this.#_e=e}}class V{#Ae;#pe=100;#Te;#Se;#xe;#ye;#Re;constructor(e,t,i=!1,s,n=!1){this.#Ae=e,this.#Te=this.#be(t),this.#Se=s||0,this.#xe=n,this.#ye=i}get name(){return this.#Ae}get isActive(){return this.#xe}get currentSprite(){return this.#Te[this.#Se][0]}get _isLastSprite(){return this.#Te.length-1===this.#Se}iterateAnimationIndex(){const e=this.#Se;this.#Te[e][1]<Date.now()-this.#Re&&(this._isLastSprite?this.#ye?this.#Se=0:this.deactivateAnimation():this.#Se++,this.#Re=Date.now())}activateAnimation=()=>{this.#xe=!0,this.#Se=0,this.#Re=Date.now()};deactivateAnimation=()=>{this.#xe=!1};#be(e){let t=[];return e.forEach((e=>{"number"==typeof e.id&&"number"==typeof e.duration?t.push([e.id,e.duration]):t.push([e,this.#pe])})),t}}class Y extends N{#se;#D;#ve;#we;#Ie;#Pe;#Oe;#Ce;#Me=0;#ne;#De;#ge;constructor(e,t,i,s,n,r=0,a,o,h=0){super(l.DRAW_TYPE.IMAGE,e,t),this.#ve=n,this.#Ie=new EventTarget,this.#Pe=new Map,this.image=o,this.#Ce=r,this.#Me=h,this.#se=i,this.#D=s,this.#ne=a&&!a.r?this._convertVerticesArray(a):a&&a.r?this._calculateConusBoundaries(a.r):this._calculateRectVertices(i,s),this.#De=a&&void 0!==a.r?a:null}get width(){return this.#se}get height(){return this.#D}set width(e){this.#se=e}set height(e){this.#D=e}get key(){return this.#ve}get image(){return this.#we}set image(e){this.#ge&&(this.#ge._isTextureRecalculated=!0),this.#we=e}get imageIndex(){return this.#Ce}set imageIndex(e){this.#Ce=e}get spacing(){return this.#Me}get hasAnimations(){return this.#Pe.size>0}get activeAnimation(){return this.#Oe}get boundaries(){return this.#ne}get vertices(){return this.#ne}get circleBoundaries(){return this.#De}_processActiveAnimations(){const e=this.#Oe;if(e){const t=this.#Pe.get(e);t.iterateAnimationIndex(),this.#Ce=t.currentSprite}}get _textureStorage(){return this.#ge}set _textureStorage(e){this.#ge=e}emit(e,...t){const i=new Event(e);i.data=[...t],this.#Ie.dispatchEvent(i)}addEventListener(e,t,i){this.#Ie.addEventListener(e,t,i)}removeEventListener(e,t,i){this.#Ie.removeEventListener(e,t,i)}addAnimation(e,t,i){this.#Be(t)||S(u," animationSpriteIndexes should be Array of indexes, or Array of objects {duration:number, id:number}");const s=new V(e,t,i);this.#Pe.set(e,s),this.addEventListener(e,this.#Le)}#Be(e){let t=!0;return e.forEach((e=>{"number"!=typeof e&&("number"==typeof e.duration&&"number"==typeof e.id||(t=!1))})),t}#Le=e=>{const t=e.type,i=this.#Pe.get(t);this.#Oe&&this.#Oe!==t&&this.stopRepeatedAnimation(this.#Oe),i.activateAnimation(),this.#Oe=t,this.#Ce=i.currentSprite};stopRepeatedAnimation(e){this.#Pe.get(e).deactivateAnimation(),this.#Oe=null}removeAllAnimations(){for(let[e,t]of this.#Pe.entries())this.removeEventListener(e,t.activateAnimation),t.deactivateAnimation();this.#Pe.clear(),this.#Pe=void 0}destroy(){this.removeAllAnimations(),super.destroy()}}class z extends N{#ne;constructor(e,t){super(l.DRAW_TYPE.LINE,e[0][0],e[0][1],t),this.#ne=e}get vertices(){return this.#ne}set vertices(e){this.#ne=e}}class X extends N{#ne;constructor(e,t){super(l.DRAW_TYPE.POLYGON,e[0].x,e[0].y,t),this.#ne=this._convertVerticesArray(e)}get vertices(){return this.#ne}set vertices(e){this.#ne=e}}class H extends N{#fe;#ne;constructor(e,t,i,s){super(l.DRAW_TYPE.CIRCLE,e,t,s),this.#fe=i,this.#ne=this._interpolateConus(i)}get vertices(){return this.#ne}set vertices(e){this.#ne=e}get radius(){return this.#fe}}class K{#Ne;#We;#Ge;#Fe=0;constructor(e,t){this.#Fe=12*t,this.#Ne=new Float32Array(this.#Fe),this.#We=new Float32Array(this.#Fe),this.#Ge=new Int32Array(4*e)}get vectors(){return this.#Ne}get textures(){return this.#We}get _bTempIndexes(){return this.#Ge}get bufferSize(){return this.#Fe}}class q{#ke;#je;#Ue;#Ve;#Ye="-#-";#ze;#Xe;#He;#Ke;#qe;#ee;#Z=0;#Pe=new Map;#p;constructor(e,t,i,s,n,r,a=!1,o){this.#ke=e,this.#je=t,this.#Ue=i,this.#Ve=s,this.#Xe=[],this.#ze=n,this.#He=r,this.#Ke=a,this.#qe=a||!1,o&&this.setMask(o),this.#Ze(s),this.#Je(this.#He)}get layerKey(){return this.#ke}get tileMapKey(){return this.#je}get tilemap(){return this.#Ue}get tilesets(){return this.#Ve}get tilesetImages(){return this.#ze}get layerData(){return this.#He}get setBoundaries(){return this.#Ke}get drawBoundaries(){return this.#qe}set drawBoundaries(e){this.#qe=e}get _maskId(){return this.#ee}setMask(e){e._isMask=!0,this.#ee=e.id}removeMask(){this.#ee=null}get sortIndex(){return this.#Z}set sortIndex(e){this.#Z=e}get isOffsetTurnedOff(){return this.#p}turnOffOffset(){this.#p=!0}get hasAnimations(){return this.#Pe.size>0}get _textureStorages(){return this.#Xe}_setTextureStorage(e,t){this.#Xe[e]=t}#Ze(e){for(let t of e){const e=t.data.tiles,i=t.data.name;if(e)for(let s of e){const e=s.animation,n=s.objectgroup,r=s.id;if(e){const s=i+this.#Ye+r,n=this.#Qe(e),a=new V(s,n,!0);this.#Pe.set(s,a),t.data._hasAnimations||(t.data._hasAnimations=!0,t.data._animations=new Map,t.data._animations.set(r,n[0][0])),this.#Le(a)}n&&(t.data._hasBoundaries||(t.data._hasBoundaries=!0,t.data._boundaries=new Map),t.data._boundaries.set(r,n))}}}#Je(e){this.tilesets.forEach(((t,i)=>{const s=t.firstgid,n=this.tilesets[i+1],r=n?n.firstgid:1e9,a=t.data.name+"_"+e.name,o=e.data.filter((e=>e>=s&&e<r)).length,l=e.data.length;e[a]=new K(l,o)}))}#Qe(e){return e.map((e=>({duration:e.duration,id:e.tileid})))}_processActiveAnimations(){for(let e of this.#Pe.values())e.isActive&&(e.iterateAnimationIndex(),this.#$e(e))}#Le=e=>{e.activateAnimation(),this.#$e(e)};#$e=e=>{const[t,i]=e.name.split(this.#Ye),s=this.#Ve.findIndex((e=>e.data.name===t));this.#Ve[s].data._animations.set(parseInt(i),e.currentSprite)};stopRepeatedAnimation(e){this.#Pe.get(e).deactivateAnimation()}removeAllAnimations(){for(let[e,t]of this.#Pe.entries())this.removeEventListener(e,t.activateAnimation),t.deactivateAnimation();this.#Pe.clear(),this.#Pe=void 0}destroy(){this.removeAllAnimations(),super.destroy()}}class Z{#et;#tt;constructor(e){this.#et=e}get stageData(){return this.#tt}#it(e){return this.#tt._renderObject=e,this.#tt._sortRenderObjectsBySortIndex(),e}rect(e,t,i,s,n){const r=new W(e,t,i,s,n);return this.#it(r),r}text(e,t,i,s,n){const r=new j(e,t,i,s,n);return this.#it(r),r}conus(e,t,i,s,n,r=0){const a=new U(e,t,i,s,n,r);return this.#it(a),a}circle(e,t,i,s){const n=new H(e,t,i,s);return this.#it(n),n}image(e,t,i,s,n,r=0,a,o=0){const l=this.#et.getImage(n);l||S(c,"iLoader can't get the image with key: "+n);const h=new Y(e,t,i,s,n,r,a,l,o);return this.#it(h),h}line(e,t){const i=new z(e,t);return this.#it(i),i}polygon(e,t){const i=new X(e,t);return this.#it(i),i}tiledLayer(e,t,i,s){const n=this.#et.getTileMap(t),r=n.tilesets,a=r.map((e=>this.#et.getImage(e.data.name))),o=n.layers.find((t=>t.name===e)),l=new q(e,t,n,r,a,o,i,s);return this.#it(l),l}_registerNewObjectMethod=(e,t)=>{this[e]=(...e)=>this.#st(t,...e)};#st=(e,...t)=>{const i=e(...t);return this.#it(i),i};_attachPageData=e=>{this.#tt=e};_detachPageData=()=>{this.#tt=null}}class J{constructor(){}static mode=l.MODE.DEBUG;static gameOptions={library:l.LIBRARY.WEBGL,optimization:l.OPTIMIZATION.NATIVE_JS.OPTIMIZED,optimizationWASMUrl:"./src/wa/calculateBufferDataWat.wasm",optimizationAssemblyUrl:"/src/wa/calculateBufferDataAssembly.wasm",loadingScreen:{backgroundColor:"rgba(128, 128, 128, 0.6)",loadingBarBg:"rgba(128, 128, 128, 1)",loadingBarProgress:"rgba(128, 128, 128, 0.2)"},render:{minCycleTime:16.666,cyclesTimeCalc:{check:l.OPTIMIZATION.CYCLE_TIME_CALC.AVERAGES,averageFPStime:1e4},boundaries:{mapBoundariesEnabled:!0,realtimeCalculations:!0,wholeWorldPrecalculations:!1}},debug:{checkWebGlErrors:!1,debugMobileTouch:!1,boundaries:{drawLayerBoundaries:!1,drawObjectBoundaries:!1,boundariesColor:"rgba(224, 12, 21, 0.6)",boundariesWidth:2},delayBetweenObjectRender:!1}};static network={enabled:!1,address:"https://gameserver.reslc.ru:9009",gatherRoomsInfoInterval:5e3};static canvasMaxSize={width:1800,height:1800};static worldSize={width:960,height:960};static defaultCanvasKey="default";static customSettings={}}class Q{static debug(...e){J.mode===l.MODE.DEBUG&&e.forEach((e=>console.log(e)))}}class $ extends Event{#nt;constructor(e,t){super(e),this.#rt(e)||S("UNEXPECTED_EVENT_NAME",", Please check if event is exist"),this.#nt=t}#rt(e){return Object.values(l.EVENTS.WEBSOCKET.SERVER_CLIENT).find((t=>t===e))}get data(){return this.#nt}}class ee extends EventTarget{#at;#ot;constructor(e){super(),e||S(h,"systemSettings should be passed to class instance"),this.#at=e}init(){n.e(319).then(n.bind(n,319)).then((e=>{this.#ot=e.io(this.#at.network.address,{withCredentials:!0}),this.#lt()}))}get isServerConnected(){return!(!this.#ot||!this.#ot.connected)}get playerId(){return this.#ot.id}sendGatherRoomsInfo(){this.#ot.emit(l.EVENTS.WEBSOCKET.CLIENT_SERVER.ROOMS_INFO_REQUEST)}sendCreateOrJoinRoom(e,t){this.#ot.emit(l.EVENTS.WEBSOCKET.CLIENT_SERVER.CREATE_OR_JOIN,e,t)}sendMessage(e){this.#ot.emit(l.EVENTS.WEBSOCKET.CLIENT_SERVER.CLIENT_MESSAGE,e)}#ht=()=>{Q.debug("connected, socket id: "+this.#ot.id),this.dispatchEvent(new Event(l.EVENTS.WEBSOCKET.SERVER_CLIENT.CONNECTION_STATUS_CHANGED))};#dt=e=>{Q.debug("server disconnected, reason: "+e),this.dispatchEvent(new Event(l.EVENTS.WEBSOCKET.SERVER_CLIENT.CONNECTION_STATUS_CHANGED))};#ct=e=>{console.warn("server data: ",e)};#ut=e=>{Q.debug("received new message from server: "+e),this.dispatchEvent(new $(l.EVENTS.WEBSOCKET.SERVER_CLIENT.SERVER_MESSAGE,e))};#gt=e=>{Q.debug("received roomsInfo "+e),this.dispatchEvent(new $(l.EVENTS.WEBSOCKET.SERVER_CLIENT.ROOMS_INFO,e))};#mt=(e,t)=>{Q.debug("CLIENT SOCKET: Created room  "+e),this.dispatchEvent(new $(l.EVENTS.WEBSOCKET.SERVER_CLIENT.CREATED,{room:e,map:t}))};#ft=e=>{Q.debug("CLIENT SOCKET: Room is full, can't join: "+e),this.dispatchEvent(new $(l.EVENTS.WEBSOCKET.SERVER_CLIENT.FULL,{room:e}))};#Et=(e,t)=>{Q.debug("CLIENT SOCKET: Joined to room: "+e,", map: ",t),this.dispatchEvent(new $(l.EVENTS.WEBSOCKET.SERVER_CLIENT.JOINED,{room:e,map:t}))};#_t=e=>{this.dispatchEvent(new $(l.EVENTS.WEBSOCKET.SERVER_CLIENT.DISCONNECTED,{playerId:e}))};#lt(){this.#ot.on("connect",this.#ht),this.#ot.on("disconnect",this.#dt),this.#ot.on("data",this.#ct),this.#ot.on("roomsInfo",this.#gt),this.#ot.on("created",this.#mt),this.#ot.on("full",this.#ft),this.#ot.on("joined",this.#Et),this.#ot.on("log",(function(e){console.log.apply(console,e)})),this.#ot.on("message",this.#ut),this.#ot.on("removed",(function(e){console.log("removed message"),console.log(e)})),this.#ot.on("disconnected",this.#_t),addEventListener("beforeunload",this.#At)}#At=()=>{this.#ot.disconnect()}}class te{#pt=.5;#Tt=new Map;#St;constructor(e){this.#St=e}getAudio=e=>{const t=this.#Tt.get(e);return null===t?(x(p,"Audio with key "+e+" exists, but not actually loaded"),t):t||(x(A,""),null)};getAudioCloned=e=>{const t=this.#Tt.get(e);if(null===t)return x(p,"Audio with key "+e+" exists, but not actually loaded"),t;if(t){const e=t.cloneNode();return e.volume=this.#pt,e}return x(A),null};set volume(e){this.#pt=e,this.#xt(e)}get volume(){return this.#pt}#xt(e){for(const t of this.#Tt.values())t&&(t.volume=e)}registerAudio(e){let t=this.#St.getAudio(e);this.#Tt.set(e,t)}}function ie(){return/Android|webOS|iPhone|iPad|iPod|Opera Mini/i.test(navigator.userAgent)}function se(){return/^((?!chrome|android).)*safari/i.test(navigator.userAgent)}function ne(e,t,i){return new k(e,t,i.x,i.y).length-i.r}function re(e,t){const i=t.x1,s=t.y1,n=t.x2,r=t.y2,a=e.x1,o=e.y1,l=i,h=s,d=n-i,c=r-s,u=a,g=o,m=e.x2-a,f=e.y2-o,E=Math.sqrt(d*d+c*c),_=Math.sqrt(m*m+f*f);if(d/E==m/_&&c/E==f/_)return null;const A=(d*(g-h)+c*(l-u))/(m*c-f*d),p=(u+m*A-l)/d;return p<0||isNaN(p)||A<0||A>1?null:{x:l+d*p,y:h+c*p,p}}function ae(e,t){const i=t.x1,s=t.y1,n=t.x2,r=t.y2,a=e.x1,o=e.y1,l=e.x2,h=e.y2,d=(i-n)*(o-h)-(s-r)*(a-l);if(0===d)return;let c=((i*r-s*n)*(a-l)-(i-n)*(a*h-o*l))/d,u=((i*r-s*n)*(o-h)-(s-r)*(a*h-o*l))/d;const g={x:c,y:u};return ue(g,e,1e-13)&&ue(g,t,1e-13)?{x:c,y:u,p:Math.sqrt(Math.pow(c-i,2)+Math.pow(u-s,2))}:void 0}function oe(e,t,i,s){return Math.atan2(s-t,i-e)}function le(e,t,i){const s=e.x-t.x,n=i.x-t.x,r=e.y-t.y,a=i.y-t.y,o=Math.sqrt(s*s+r*r),l=Math.sqrt(n*n+a*a);return Math.acos((s*n+r*a)/(o*l))}function he(e,t,i){return e*t*Math.cos(i)}function de(e,t){return e.x*t.x+e.y*t.y}function ce(e,t){return e.x*t.y-t.x*e.y}function ue(e,t,i=0){return(e.x>=t.x1-i&&e.x<=t.x2+i||e.x<=t.x1+i&&e.x>=t.x2-i)&&(e.y>=t.y1-i&&e.y<=t.y2+i||e.y<=t.y1+i&&e.y>=t.y2-i)}function ge(e,t){return new k(e.x,e.y,t.x,t.y).length}function me(e,t){return new k(e.x1,e.y1,e.x2,e.y2).length<new k(t.x1,t.y1,t.x2,t.y2).length}function fe(e,t){const i=new k(t.x1,t.y1,t.x2,t.y2).length;return new k(t.x1,t.y1,e.x,e.y).length+new k(t.x2,t.y2,e.x,e.y).length<=i+.2}function Ee(e,t){const i=e.length;for(let s=0;s<i;s+=1){let i=e[s],n=e[s+1];if(!n){if(i[0]===e[0][0]&&i[1]===e[0][1])continue;n=e[0]}const r=ae({x1:i[0],y1:i[1],x2:n[0],y2:n[1]},t);if(r)return r}if(e[i-1][0]!==e[0][0]&&e[i-1][1]!==e[0][1]){const s=e[i-1],n=e[0],r=ae({x1:s[0],y1:s[1],x2:n[0],y2:n[1]},t);if(r)return r}return null}function _e(e,t,i){const s=i.length;for(let n=0;n<s;n+=1){let s=i[n],r=i[n+1];if(r||(r=i[0]),fe({x:e,y:t},{x1:s[0],y1:s[1],x2:r[0],y2:r[1]}))return!0}return!1}function Ae(e,t,i){const s=i.length;let n=0;for(let r=0;r<s;r++){let s=i[r],a=i[r+1]?i[r+1]:i[0],o=s[0],l=s[1],h=a[0],d=a[1];t<l!=t<d&&e<(h-o)*(t-l)/(d-l)+o&&n++}return n>0&&n%2!=0}function pe(e,t,i){return e>=i.x&&e<=i.width+i.x&&t>=i.y&&t<=i.y+i.height}function Te(e,t,i){const s=i.r;return new k(e,t,i.x,i.y).length<s}function Se(e,t,i,s){const n=s.x1,r=s.y1,a=s.x2,o=s.y2,l={x:n-e,y:r-t},h={x:a-e,y:o-t},d={x:a-n,y:o-r},c={x:n-a,y:r-o},u=Math.sqrt(Math.pow(d.x,2)+Math.pow(d.y,2)),g=de(l,c),m=de(h,d);let f;return g>0&&m>0?(f=ce(l,h)/u,f<0&&(f*=-1)):f=Math.min(l.length,h.length),f<=i}function xe(e,t){const i=e[0],s=e[1],n=e[2],r=e[3],a={x:i-t[0][0],y:s-t[0][1]},o={x:i-t[1][0],y:s-t[1][1]},l=Math.sqrt(Math.pow(a.x,2)+Math.pow(a.y,2)),h=Math.sqrt(Math.pow(o.x,2)+Math.pow(o.y,2)),d=Math.min(l,h);if(d>Math.max(n,r))return!1;const c=d===l?a:o,u=Math.atan2(c.y,c.x),g={x:0-Math.cos(u)*n,y:0-Math.sin(u)*r};return!(d>Math.sqrt(Math.pow(g.x,2)+Math.pow(g.y,2)))}function ye(e,t){const i=e[0],s=e[1],n={x:i-t.x,y:s-t.y},r=Math.sqrt(Math.pow(n.x,2)+Math.pow(n.y,2));if(r>Math.max(e[2],e[3])+t.r)return!1;{const n=oe(i,s,t.x,t.y),a=i-(i+e[2]*Math.cos(n)),o=s-(s+e[3]*Math.sin(n));return r<=Math.sqrt(Math.pow(a,2)+Math.pow(o,2))+t.r&&{x:a,y:o,p:1}}}function Re(e,t){const i=t.length;for(let s=0;s<i;s+=1){let i=t[s],n=t[s+1];if(n||(n=t[0]),xe(e,[i,n]))return!0}return!1}function be(){return Math.round(1e6*Math.random())}function ve(e){return e[Math.floor(Math.random()*e.length)]}function we(e){const t=e.length,i=[];for(let s=0;s<t;s++){const t=e[s];i.push([t.x,t.y])}return i}function Ie(e=0,t=0,i,s,n=2*Math.PI,r=Math.PI/8){let a=[];for(let o=0;o<=n;o+=r){let n=Math.cos(o)*i+e,r=Math.sin(o)*s+t;a.push([n,r])}return a}class Pe{#yt;#Rt;#bt=!0;constructor(e,t=0){this.#Rt=e,this.#yt=t}get _isTextureRecalculated(){return this.#bt}set _isTextureRecalculated(e){this.#bt=e}get _texture(){return this.#Rt}set _texture(e){this.#Rt=e}get _textureIndex(){return this.#yt}}class Oe{#vt;#wt;#It;#Pt;#Ot;#Ct;#Mt=new Map;#Dt=new Map;constructor(e,t){e&&e instanceof WebGLRenderingContext||S(u," context parameter should be specified and equal to WebGLRenderingContext"),this.#vt=e,this.#Pt=t,this.#It=t.debug.checkWebGlErrors,this.#wt=e.getParameter(e.MAX_TEXTURE_IMAGE_UNITS),this.#Ot=e.createBuffer(),this.#Ct=e.createBuffer()}getProgram(e){return this.#Mt.get(e)}getProgramVarLocations(e){return this.#Dt.get(e)}_fixCanvasSize(e,t){this.#vt.viewport(0,0,e,t)}_initWebGlAttributes=()=>{const e=this.#vt;return e.enable(e.BLEND),e.enable(e.STENCIL_TEST),e.stencilFunc(e.ALWAYS,1,255),e.stencilOp(e.KEEP,e.KEEP,e.REPLACE),Promise.resolve()};_initiateWasm=()=>{const e=this.#Pt.optimization===l.OPTIMIZATION.WEB_ASSEMBLY.NATIVE_WAT?this.#Pt.optimizationWASMUrl:this.#Pt.optimizationAssemblyUrl;return new Promise(((t,i)=>{this.layerData=new WebAssembly.Memory({initial:1e3}),this.layerDataFloat32=new Float32Array(this.layerData.buffer);const s={env:{memory:this.layerData,logi:console.log,logf:console.log}};fetch(e).then((e=>e.arrayBuffer())).then((e=>WebAssembly.instantiate(e,s))).then((e=>{this.calculateBufferData=e.instance.exports.calculateBufferData,t()}))}))};_clearView(){const e=this.#vt;e.clearColor(0,0,0,0),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT|e.STENCIL_BUFFER_BIT)}_render(e,t,i=0){const s=this.#vt,n=this.#It?s.getError():0;if(0!==n)throw console.error(n),new Error("Error num: "+n);return s.drawArrays(t,i,e),s.stencilFunc(s.ALWAYS,1,255),new Promise(((e,t)=>{this.#Pt.debug.delayBetweenObjectRender?setTimeout((()=>{e()}),1e3):e()}))}_registerAndCompileWebGlProgram(e,t,i,s,n){const r=this.#Bt(t,i),a=this.#Lt(r,s,n);return this.#Mt.set(e,r),this.#Dt.set(e,a),Promise.resolve()}#Bt(e,t){const i=this.#vt,s=i.createProgram();if(s){const n=this.#Nt(i,e,i.VERTEX_SHADER);n?i.attachShader(s,n):S(g,"#compileShader(vertexShaderSource) is null");const r=this.#Nt(i,t,i.FRAGMENT_SHADER);if(r?i.attachShader(s,r):S(g,"#compileShader(fragmentShaderSource) is null"),i.linkProgram(s),!i.getProgramParameter(s,i.LINK_STATUS)){const e=i.getProgramInfoLog(s);S(g,`Could not compile WebGL program. \n\n${e}`)}}else S(g,"gl.createProgram() is null");return s}#Lt(e,t,i){const s=this.#vt;let n={};return t.forEach((t=>{n[t]=s.getUniformLocation(e,t)})),i.forEach((t=>{n[t]=s.getAttribLocation(e,t)})),n}#Nt(e,t,i){const s=e.createShader(i);if(s){if(e.shaderSource(s,t),e.compileShader(s),!e.getShaderParameter(s,e.COMPILE_STATUS)){const t=e.getShaderInfoLog(s);S(g,"Couldn't compile webGl program. \n\n"+t)}}else S(g,`gl.createShader(${i}) is null`);return s}_bindPrimitives=(e,t,i,s,n)=>{const[r,a]=!0===e.isOffsetTurnedOff?[0,0]:i.worldOffset,o=e.x-r,h=e.y-a,d=[1,1],c=e.rotation,u=e.blendFunc?e.blendFunc:[t.SRC_ALPHA,t.ONE_MINUS_SRC_ALPHA],{u_translation:g,u_rotation:m,u_scale:f,u_resolution:E,u_color:_,a_position:A,u_fade_min:p}=n;let S=0;switch(t.useProgram(s),t.uniform2f(E,t.canvas.width,t.canvas.height),t.uniform2f(g,o,h),t.uniform2f(f,d[0],d[1]),t.uniform1f(m,c),t.uniform1f(p,0),t.enableVertexAttribArray(A),t.bindBuffer(t.ARRAY_BUFFER,this.#Ot),e.type){case l.DRAW_TYPE.RECTANGLE:this.#Wt(e.width,e.height),S+=6;break;case l.DRAW_TYPE.TEXT:break;case l.DRAW_TYPE.CIRCLE:{const i=e.vertices;t.bufferData(t.ARRAY_BUFFER,new Float32Array(i),t.STATIC_DRAW),S+=i.length/2;break}case l.DRAW_TYPE.POLYGON:{const t=this.#Gt(e.vertices);this.#Ft(t);const i=t.length;if(i%3!=0)return x(T,`polygons ${e.id}, vertices are not correct, skip drawing`),Promise.reject();S+=i/2;break}}const y=t.FLOAT;t.vertexAttribPointer(A,2,y,!1,0,0);const R=this.#kt(e.bgColor);return t.uniform4f(_,R[0]/255,R[1]/255,R[2]/255,R[3]),u&&t.blendFunc(u[0],u[1]),e.isMaskAttached?t.stencilFunc(t.EQUAL,e._maskId,255):e._isMask&&t.stencilFunc(t.ALWAYS,e.id,255),Promise.resolve([S,t.TRIANGLES])};_bindConus=(e,t,i,s,n)=>{const[r,a]=!0===e.isOffsetTurnedOff?[0,0]:i.worldOffset,o=e.x-r,l=e.y-a,h=[1,1],d=e.rotation,{u_translation:c,u_rotation:u,u_scale:g,u_resolution:m,u_color:f,a_position:E,u_fade_max:_,u_fade_min:A}=n,p=e.vertices,T=e.bgColor,S=e.fade_min,x=e.radius,y=e.blendFunc?e.blendFunc:[t.SRC_ALPHA,t.ONE_MINUS_SRC_ALPHA];let R=0;t.useProgram(s),t.uniform2f(m,t.canvas.width,t.canvas.height),t.uniform2f(c,o,l),t.uniform2f(g,h[0],h[1]),t.uniform1f(u,d),t.uniform1f(A,S),t.uniform1f(_,x),t.bindBuffer(t.ARRAY_BUFFER,this.#Ot),t.bufferData(t.ARRAY_BUFFER,new Float32Array(p),t.STATIC_DRAW),t.enableVertexAttribArray(E);const b=t.FLOAT;t.vertexAttribPointer(E,2,b,!1,0,0),R+=p.length/2,y&&t.blendFunc(y[0],y[1]);const v=this.#kt(T);return t.uniform4f(f,v[0]/255,v[1]/255,v[2]/255,v[3]),e.isMaskAttached?t.stencilFunc(t.EQUAL,e._maskId,255):e._isMask&&t.stencilFunc(t.ALWAYS,e.id,255),Promise.resolve([R,t.TRIANGLE_FAN])};_bindText=(e,t,i,s,n)=>{const{u_translation:r,u_rotation:a,u_scale:o,u_resolution:l,a_position:h,a_texCoord:d,u_image:c}=n,{width:u,height:g}=e.boundariesBox,[m,f]=(e.text,!0===e.isOffsetTurnedOff?[0,0]:i.worldOffset),E=e.x-m,_=e.y-f-g,A=e.blendFunc?e.blendFunc:[t.ONE,t.ONE_MINUS_SRC_ALPHA],p=[1,1],T=E+u,S=_+g,x=[E,_,T,_,E,S,E,S,T,_,T,S];let y=0;t.useProgram(s),t.uniform2f(l,t.canvas.width,t.canvas.height),t.uniform2f(r,E,_),t.uniform2f(o,p[0],p[1]),t.uniform1f(a,0),t.bindBuffer(t.ARRAY_BUFFER,this.#Ot),t.bufferData(t.ARRAY_BUFFER,new Float32Array(x),t.STATIC_DRAW),t.enableVertexAttribArray(h);const R=t.FLOAT;t.vertexAttribPointer(h,2,R,!1,0,0),t.bindBuffer(t.ARRAY_BUFFER,this.#Ct),t.bufferData(t.ARRAY_BUFFER,new Float32Array([0,0,1,0,0,1,0,1,1,0,1,1]),t.STATIC_DRAW),t.enableVertexAttribArray(d),t.vertexAttribPointer(d,2,t.FLOAT,!1,0,0),y+=6,t.blendFunc(A[0],A[1]);let b=e._textureStorage;return b||(b=new Pe(t.createTexture()),e._textureStorage=b),!0===b._isTextureRecalculated?(this.#jt(t,b._texture,e._textureCanvas),b._isTextureRecalculated=!1):this.#Ut(t,b._texture),t.uniform1i(c,b._textureIndex),t.depthMask(!1),Promise.resolve([6,t.TRIANGLES])};_bindImage=(e,t,i,s,n)=>{const{u_translation:r,u_rotation:a,u_scale:o,u_resolution:l,a_position:h,a_texCoord:d,u_image:c}=n,[u,g]=!0===e.isOffsetTurnedOff?[0,0]:i.worldOffset,m=e.x-u,f=e.y-g,E=e.image,_=e.imageIndex,A=(e.key,e._maskId),p=e.spacing,T=e.blendFunc?e.blendFunc:[t.ONE,t.ONE_MINUS_SRC_ALPHA],S=[1,1];let x=0,y=0,R=0,b=0,v=0;if(0!==_){const t=(E.width+p)/(e.width+p);R=_%t,b=Math.floor(_/t),x=R*e.width+R*p,y=b*e.height+b*p}const w=m-e.width/2,I=f-e.height/2,P=w+e.width,O=I+e.height,C=1/E.width*x,M=1/E.height*y,D=C+1/E.width*e.width,B=M+1/E.height*e.height,L=[w,I,P,I,w,O,w,O,P,I,P,O],N=[C,M,D,M,C,B,C,B,D,M,D,B];t.useProgram(s),t.uniform2f(l,t.canvas.width,t.canvas.height),t.uniform2f(r,m,f),t.uniform2f(o,S[0],S[1]),t.uniform1f(a,e.rotation),t.bindBuffer(t.ARRAY_BUFFER,this.#Ot),t.bufferData(t.ARRAY_BUFFER,new Float32Array(L),t.STATIC_DRAW),v+=L.length/2,t.enableVertexAttribArray(h);const W=t.FLOAT;t.vertexAttribPointer(h,2,W,!1,0,0),t.bindBuffer(t.ARRAY_BUFFER,this.#Ct),t.bufferData(t.ARRAY_BUFFER,new Float32Array(N),t.STATIC_DRAW),t.enableVertexAttribArray(d),t.vertexAttribPointer(d,2,t.FLOAT,!1,0,0);let G=e._textureStorage;return G||(G=new Pe(t.createTexture()),e._textureStorage=G),!0===G._isTextureRecalculated?(this.#Vt(t,G._texture,e.image),G._isTextureRecalculated=!1):this.#Ut(t,G._texture),t.uniform1i(c,G._textureIndex),t.blendFunc(T[0],T[1]),A&&t.stencilFunc(t.EQUAL,A,255),Promise.resolve([v,t.TRIANGLES])};_bindTileImages=async(e,t,i,s,n)=>{const{u_translation:r,u_rotation:a,u_scale:o,u_resolution:h,a_position:d,a_texCoord:c,u_image:u}=n;let g;switch(t.useProgram(s),this.#Pt.optimization){case l.OPTIMIZATION.NATIVE_JS.NOT_OPTIMIZED:g=await this.#Yt(e,i);break;case l.OPTIMIZATION.WEB_ASSEMBLY.ASSEMBLY_SCRIPT:case l.OPTIMIZATION.WEB_ASSEMBLY.NATIVE_WAT:g=await this.#zt(e,i);break;case l.OPTIMIZATION.NATIVE_JS.OPTIMIZED:default:g=await this.#Xt(e,i)}const m=[0,0],f=[1,1],E=["ONE","ONE_MINUS_SRC_ALPHA"],_=e._maskId;let A=0,p=!1;t.enableVertexAttribArray(d),t.enableVertexAttribArray(c);for(let i=0;i<g.length;i++){const s=g[i],n=s[0],l=s[1],T=(s[2],s[3]);if(n.length>0&&l.length>0){p&&await this._render(A,t.TRIANGLES),t.uniform2f(h,t.canvas.width,t.canvas.height),t.uniform2f(r,m[0],m[1]),t.uniform2f(o,f[0],f[1]),t.uniform1f(a,0),t.bindBuffer(t.ARRAY_BUFFER,this.#Ot),t.bufferData(t.ARRAY_BUFFER,n,t.STATIC_DRAW);const s=2,g=t.FLOAT,S=!1,x=0,y=0;t.vertexAttribPointer(d,s,g,S,x,y),t.bindBuffer(t.ARRAY_BUFFER,this.#Ct),t.bufferData(t.ARRAY_BUFFER,l,t.STATIC_DRAW),t.vertexAttribPointer(c,2,t.FLOAT,!1,0,y);let R=e._textureStorages[i];R||(R=new Pe(t.createTexture(),i),e._setTextureStorage(i,R)),!0===R._isTextureRecalculated?(this.#Vt(t,R._texture,T,R._textureIndex),R._isTextureRecalculated=!1):this.#Ut(t,R._texture,R._textureIndex),t.uniform1i(u,R._textureIndex),t.blendFunc(t[E[0]],t[E[1]]),A=n.length/2,_&&t.stencilFunc(t.EQUAL,_,255),p=!0}}return Promise.resolve([A,t.TRIANGLES])};_drawPolygon(e,t){const[i,s]=!0===e.isOffsetTurnedOff?[0,0]:t.worldOffset,n=e.x-i,r=e.y-s,a=e.rotation||0,o=e.vertices,h=this.#Pt.debug.boundaries.boundariesColor,d=this.getProgram(l.WEBGL.DRAW_PROGRAMS.PRIMITIVES),{u_translation:c,u_rotation:u,u_scale:g,u_resolution:m,u_color:f,a_position:E,u_fade_max:_,u_fade_min:A}=this.getProgramVarLocations(l.WEBGL.DRAW_PROGRAMS.PRIMITIVES),p=this.#vt;let S=0;p.useProgram(d),p.uniform2f(m,p.canvas.width,p.canvas.height),p.uniform2f(c,n,r),p.uniform2f(g,1,1),p.uniform1f(u,a),p.uniform1f(A,0),p.enableVertexAttribArray(E),p.bindBuffer(p.ARRAY_BUFFER,this.#Ot);const y=this.#Gt(o),R=y.length;if(R%3!=0)return void x(T,"polygon boundaries vertices are not correct, skip drawing");this.#Ft(y),S+=R/2;const b=p.FLOAT;p.vertexAttribPointer(E,2,b,!1,0,0);const v=this.#kt(h);p.uniform4f(f,v[0]/255,v[1]/255,v[2]/255,v[3]),this._render(S,p.TRIANGLES)}_bindLine=(e,t,i,s,n)=>{const[r,a]=!0===e.isOffsetTurnedOff?[0,0]:i.worldOffset,o=e.x-r,l=e.y-a,h=e.rotation,{u_translation:d,u_rotation:c,u_scale:u,u_resolution:g,u_color:m,a_position:f,u_fade_max:E,u_fade_min:_}=n,A=e.vertices,p=e.bgColor,T=(e.fade_min,e.radius,this.#Pt.debug.boundaries.boundariesWidth);let S=0;t.useProgram(s),t.uniform2f(g,t.canvas.width,t.canvas.height),t.uniform2f(d,o,l),t.uniform2f(u,1,1),t.uniform1f(c,h),t.uniform1f(_,0),t.enableVertexAttribArray(f),t.bindBuffer(t.ARRAY_BUFFER,this.#Ot),t.bufferData(t.ARRAY_BUFFER,new Float32Array(A),t.STATIC_DRAW),S+=A.length/2;const x=t.FLOAT;t.vertexAttribPointer(f,2,x,!1,0,0);const y=this.#kt(p);return t.uniform4f(m,y[0]/255,y[1]/255,y[2]/255,y[3]),t.lineWidth(T),Promise.resolve([0,t.LINES])};_drawLines(e,t,i=1,s=0,n=[0,0]){const r=this.getProgram(l.WEBGL.DRAW_PROGRAMS.PRIMITIVES),{u_translation:a,u_rotation:o,u_scale:h,u_resolution:d,u_color:c,a_position:u,u_fade_max:g,u_fade_min:m}=this.getProgramVarLocations(l.WEBGL.DRAW_PROGRAMS.PRIMITIVES),f=this.#vt;let E=0;f.useProgram(r),f.uniform2f(d,f.canvas.width,f.canvas.height),f.uniform2f(a,n[0],n[1]),f.uniform2f(h,1,1),f.uniform1f(o,s),f.uniform1f(m,0),f.enableVertexAttribArray(u),f.bindBuffer(f.ARRAY_BUFFER,this.#Ot),f.bufferData(f.ARRAY_BUFFER,e instanceof Float32Array?e:new Float32Array(e),f.STATIC_DRAW),E+=e.length/2;const _=f.FLOAT;f.vertexAttribPointer(u,2,_,!1,0,0);const A=this.#kt(t);f.uniform4f(c,A[0]/255,A[1]/255,A[2]/255,A[3]),f.lineWidth(i),this._render(E,f.LINES)}#Xt(e,t){return new Promise(((i,s)=>{const n=e.tilemap,r=e.tilesets,a=e.tilesetImages,o=e.layerData,{tileheight:l,tilewidth:h}=n,d=h,c=l,[u,g]=t.worldDimensions,[f,E]=t.canvasDimensions,[A,p]=!0===e.isOffsetTurnedOff?[0,0]:t.worldOffset,T=(this.#Pt.render.boundaries.realtimeCalculations,e.setBoundaries),S=[];o||(x(m,"check tilemap and layers name"),s());for(let e=0;e<r.length;e++){const i=r[e].data,s=r[e].firstgid,n=r[e+1],m=n?n.firstgid:1e9,y=i.tilewidth,R=i.tileheight,b=a[e],v=i.imagewidth,w=i.imageheight,I=i.columns,P=o.width,O=o.height,C=d*P,M=c*O,D=p%c,B=A%d,L=0!==p?Math.floor(p/c):0,N=0!==A?Math.floor(A/d):0,W=M>E?Math.ceil(E/c)+1:O,G=C>f?Math.ceil(f/d)+1:P,F=P-G-N,k=i.spacing,j=(i.margin,i._hasAnimations),U=i._hasBoundaries,V=i._boundaries,Y=i.name+"_"+o.name,z=o[Y].bufferSize;let X=o[Y].vectors,H=o[Y].textures,K=0,q=o[Y]._bTempIndexes;const Z=4*G;X.fill(0),H.fill(0),C===u&&M===g||(x(_," World size from tilemap is different than settings one, fixing..."),t._setWorldDimensions(C,M)),T&&(t.isMaxBoundariesSizeSet||(t._setMaxBoundariesSize(z),t._initiateBoundariesData()),this.#Pt.render.boundaries.mapBoundariesEnabled&&t._setMapBoundaries());let J=L*P;for(let e=0;e<W;e++){J+=N;for(let n=0;n<G;n++){let r=o.data[J];if(r>=s&&r<m){const a=n*h-B,o=e*l-D;if(r-=s,j){const e=i._animations.get(r);void 0!==e&&(r=e)}const d=r%I,c=Math.floor(r/I),u=a,g=o,m=a+y,f=o+R,E=1/v*(d*y+d*k),_=1/w*(c*R+c*k),A=E+1/v*y,p=_+1/w*R;if(X[K]=u,H[K]=E,K++,X[K]=g,H[K]=_,K++,X[K]=m,H[K]=A,K++,X[K]=g,H[K]=_,K++,X[K]=u,H[K]=E,K++,X[K]=f,H[K]=p,K++,X[K]=u,H[K]=E,K++,X[K]=f,H[K]=p,K++,X[K]=m,H[K]=A,K++,X[K]=g,H[K]=_,K++,X[K]=m,H[K]=A,K++,X[K]=f,H[K]=p,K++,T){let i=!1;if(U&&V.size>0){const e=V.get(r);e&&(i=!0,e.objects.forEach((e=>{const i=a+e.x,s=o+e.y;if(0!==e.rotation&&x("tilesetData.tiles.rotation property is not supported yet"),e.polygon)e.polygon.forEach(((n,r)=>{const a=e.polygon[r+1];if(a)t._addBoundaryLine(n.x+i,n.y+s,a.x+i,a.y+s);else{const r=e.polygon[0];t._addBoundaryLine(n.x+i,n.y+s,r.x+i,r.y+s)}}));else if(e.point)t._addPointBoundary(i,s);else if(e.ellipse){const n=e.width/2,r=e.height/2;t._addEllipseBoundary(i+n,s+r,n,r)}else{const n=e.width,r=e.height,a=n+i,o=r+s;t._addBoundaryLine(i,s,a,s),t._addBoundaryLine(a,s,a,o),t._addBoundaryLine(a,o,i,o),t._addBoundaryLine(i,o,i,s)}})))}if(!1===i){const i=t.getRawBoundaries();let s=[a+y,o,a+y,o+R],r=[a+y,o+R,a,o+R],l=[a,o,a+y,o],h=[a,o+R,a,o];if(0!==e){const r=(e-1)*Z+4*n,a=q[r+2];if(a){const e=i[a];if(e){const s=i[a+1],n=i[a+2],r=i[a+3],o=l[0],h=l[1],d=l[2],c=l[3];o===n&&h===r&&d===e&&c===s&&(t._removeBoundaryLine(a),l=void 0)}const n=q[r+1],o=i[n];if(o){const e=i[n+1],r=i[n+2],a=i[n+0];o===i[n+2]&&r===a&&(t._removeBoundaryLine(n),s[0]=o,s[1]=e)}const d=q[r+3],c=i[d];if(c){const e=i[d+2],s=i[d+3],n=h[0];c===h[2]&&e===n&&(t._removeBoundaryLine(d),h[2]=e,h[3]=s)}}}if(0!==n){const s=e*Z+4*(n-1),a=q[s];if(a){const e=q[s+1],n=i[e],o=i[e+1],d=i[e+2],c=i[e+3],u=h[0],g=h[1],m=h[2],f=h[3];u===d&&g===c&&m===n&&f===o&&(t._removeBoundaryLine(e),h=void 0);const E=i[a];if(E&&l){const e=i[a+1],s=i[a+3],n=l[1];e===l[3]&&s===n&&(t._removeBoundaryLine(a),l[0]=E,l[1]=e)}const _=q[s+2];if(i[_]){const e=i[_+1],s=i[_+2],n=i[_+3],a=r[1];e===r[3]&&n===a&&(t._removeBoundaryLine(_),r[2]=s,r[3]=n)}}}const d=e*Z+4*n;l&&(t._addBoundaryLine(l[0],l[1],l[2],l[3]),q[d+0]=t.boundariesLen-4),t._addBoundaryLine(s[0],s[1],s[2],s[3]),q[d+1]=t.boundariesLen-4,t._addBoundaryLine(r[0],r[1],r[2],r[3]),q[d+2]=t.boundariesLen-4,h&&(t._addBoundaryLine(h[0],h[1],h[2],h[3]),q[d+3]=t.boundariesLen-4)}}}J++}J+=F}S.push([X,H,i.name,b]),q.fill(0)}i(S)}))}#Yt(e,t){return new Promise(((i,s)=>{const n=e.tilemap,r=e.tilesets,a=e.tilesetImages,o=e.layerData,{tileheight:l,tilewidth:h}=n,d=h,c=l,[u,g]=(e.setBoundaries,t.worldDimensions),[f,E]=t.canvasDimensions,[A,p]=!0===e.isOffsetTurnedOff?[0,0]:t.worldOffset;let T=[];o||(x(m,"check tilemap and layers name"),s());for(let e=0;e<=r.length-1;e++){const i=r[e].data,s=r[e].firstgid,n=r[e+1],m=n?n.firstgid:1e9,S=i.tilewidth,y=i.tileheight,R=i.columns,b=o.width,v=o.height,w=d*b,I=c*v,P=(Math.ceil(f/d),Math.ceil(E/c),a[e]),O=P.width,C=P.height,M=i.spacing,D=(i.margin,i.name+"_"+o.name);let B=0,L=o[D].vectors,N=o[D].textures,W=0;L.fill(0),N.fill(0),w===u&&I===g||(x(_," World size from tilemap is different than settings one, fixing..."),t._setWorldDimensions(w,I));for(let e=0;e<v;e++)for(let t=0;t<b;t++){let i=o.data[B];if(i>=s&&i<m){i-=s;const n=i%R,r=Math.floor(i/R),a=t*h-A,o=e*l-p,d=a+S,c=o+y,u=1/O*(n*S+n*M),g=1/C*(r*y+r*M),m=u+1/O*S,f=g+1/C*y;L[W]=a,N[W]=u,W++,L[W]=o,N[W]=g,W++,L[W]=d,N[W]=m,W++,L[W]=o,N[W]=g,W++,L[W]=a,N[W]=u,W++,L[W]=c,N[W]=f,W++,L[W]=a,N[W]=u,W++,L[W]=c,N[W]=f,W++,L[W]=d,N[W]=m,W++,L[W]=o,N[W]=g,W++,L[W]=d,N[W]=m,W++,L[W]=c,N[W]=f,W++}B++}T.push([L,N,i.name,P])}i(T)}))}#zt=(e,t)=>new Promise(((i,s)=>{const n=e.tilemap,r=n.tilesets,a=e.tilesetImages,o=e.layerData,{tileheight:l,tilewidth:h}=n,d=h,c=l,u=o.data.length,g=o.data.filter((e=>0!==e)).length,[f,E]=t.worldDimensions,[A,p]=!0===e.isOffsetTurnedOff?[0,0]:t.worldOffset,T=[];this.layerDataFloat32.set(o.data),o||(x(m,"check tilemap and layers name"),s());for(let e=0;e<r.length;e++){const i=r[e].data,s=r[e].firstgid,n=r[e+1],m=n?n.firstgid:1e9,S=i.tilewidth,y=i.tileheight,R=i.columns,b=o.width,v=o.height,w=d*b,I=c*v,P=a[e],O=P.width,C=P.height,M=4,D=12*g,B=12*g,L=i.spacing;if(i.margin,w===f&&I===E||(x(_," World size from tilemap is different than settings one, fixing..."),t._setWorldDimensions(w,I)),!t.isMaxBoundariesSizeSet){const e=o[i.name+"_"+o.name].bufferSize;t._setMaxBoundariesSize(e),t._initiateBoundariesData()}this.#Pt.render.boundaries.mapBoundariesEnabled&&t._setMapBoundaries();const N=this.calculateBufferData(M,u,D,v,b,h,l,S,y,R,O,C,A,p,s,m,L,!1),W=N>0?this.layerDataFloat32.slice(u,D+u):[],G=N>0?this.layerDataFloat32.slice(D+u,D+B+u):[];T.push([W,G,i.name,P])}i(T)}));#kt(e){return e.replace("rgba(","").replace(")","").split(",").map((e=>Number(e.trim())))}#Gt(e){return this.#Ht(e)}#Ht(e,t=[]){const i=e.length;if(i<=3)return e.forEach((e=>{t.push(e[0]),t.push(e[1])})),t;const s=[...e].sort(((e,t)=>t[1]-e[1])),n=e.indexOf(s[0]),r=n!==i-1?n+1:0;let a=e,o=a.length,l=0,h=r;for(;a.length>2;){const e=a.length;h>=e&&(h-=e);const i=0===h?a[e-1]:a[h-1],s=a[h],n=e===h+1?a[0]:a[h+1];if(d=i,c=s,ce({x:(u=n)[0]-d[0],y:u[1]-d[1]},{x:c[0]-d[0],y:c[1]-d[1]})<0)t.push(i[0]),t.push(i[1]),t.push(s[0]),t.push(s[1]),t.push(n[0]),t.push(n[1]),a=a.filter(((e,t)=>t!==h));else{if(l+=1,l>o)return x("TRIANGULATE_ISSUE","Can't extract all triangles vertices."),t;h++}}var d,c,u;return t}#Ft(e){this.#vt.bufferData(this.#vt.ARRAY_BUFFER,new Float32Array(e),this.#vt.STATIC_DRAW)}#Wt(e,t){const i=0+e,s=0+t;this.#vt.bufferData(this.#vt.ARRAY_BUFFER,new Float32Array([0,0,i,0,0,s,0,s,i,0,i,s]),this.#vt.STATIC_DRAW)}#Vt(e,t,i,s=0,n=!1){this.#Ut(e,t,s),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,i),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,n?e.LINEAR_MIPMAP_LINEAR:e.LINEAR)}#jt(e,t,i,s=0){this.#Ut(e,t,s),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,i),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST)}#Ut(e,t,i=0){e.activeTexture(e.TEXTURE0+i),e.bindTexture(e.TEXTURE_2D,t)}#Kt(e,t){e.deleteTexture(t)}isPowerOfTwo(e){return!(e&e-1)}nextHighestPowerOfTwo(e){--e;for(var t=1;t<32;t<<=1)e|=e>>t;return e+1}}const Ce=["u_translation","u_rotation","u_scale","u_resolution","u_image"],Me=["a_position","a_texCoord"],De=["u_translation","u_rotation","u_scale","u_resolution","u_fade_min","u_fade_max","u_color"],Be=["a_position"];class Le{#qt;#Zt;#Jt;#xe;#Qt;#$t;#ei;#St;#ti;#ii;#si=!1;#ni;#Ie=new EventTarget;#ri;#ai=new Map;#oi=[];constructor(e,t,i){this.#Jt=!1,this.#qt=document.createElement("canvas"),i.appendChild(this.#qt),this.#Zt=this.#qt.getContext("webgl",{stencil:!0}),this.#ei=e,this.#St=t,this.#ti=[],this.#ni=this.systemSettings.gameOptions.render.minCycleTime,this.#si=this.systemSettings.gameOptions.render.boundaries.wholeWorldPrecalculations,this.#Qt=new Oe(this.#Zt,this.#ei.gameOptions),this.systemSettings.gameOptions.optimization!==l.OPTIMIZATION.WEB_ASSEMBLY.NATIVE_WAT&&this.systemSettings.gameOptions.optimization!==l.OPTIMIZATION.WEB_ASSEMBLY.ASSEMBLY_SCRIPT||this._registerRenderInit(this.#Qt._initiateWasm),this._registerRenderInit(this.fixCanvasSize),this._registerRenderInit((()=>this._registerAndCompileWebGlProgram(l.WEBGL.DRAW_PROGRAMS.IMAGES,"\n    attribute vec2 a_texCoord;\n\n    attribute vec2 a_position;\n\n    uniform vec2 u_translation;\n    uniform float u_rotation;\n    uniform vec2 u_scale;\n\n    uniform vec2 u_resolution;\n\n    varying vec2 v_texCoord;\n\n    void main(void) {\n        float c = cos(u_rotation);\n        float s = sin(u_rotation);\n\n        mat3 translationMatrix1 = mat3(\n            1, 0, 0,\n            0, 1, 0,\n            u_translation.x, u_translation.y, 1\n        );\n\n        mat3 translationMatrix2 = mat3(\n            1, 0, 0,\n            0, 1, 0,\n            -u_translation.x, -u_translation.y, 1\n        );\n        \n        mat3 rotationMatrix = mat3(\n            c, s, 0,\n            -s, c, 0,\n            0, 0, 1\n        );\n\n        mat3 scalingMatrix = mat3(\n            u_scale.x, 0, 0,\n            0, u_scale.y, 0,\n            0, 0, 1\n        );\n\n        mat3 matrix = translationMatrix1 * rotationMatrix * translationMatrix2 * scalingMatrix;\n    \n        vec2 position = (matrix * vec3(a_position, 1)).xy;\n\n        vec2 clipSpace = position / u_resolution * 2.0 - 1.0;\n\n        gl_Position = vec4(clipSpace * vec2(1, -1), 0, 1);\n        \n        v_texCoord = a_texCoord;\n    }","\n    precision mediump float;\n\n    uniform sampler2D u_image;\n\n    //texCoords passed in from the vertex shader\n    varying vec2 v_texCoord;\n    void main() {\n        vec4 color = texture2D(u_image, v_texCoord);\n        gl_FragColor = color;\n    }",Ce,Me))),this._registerRenderInit((()=>this._registerAndCompileWebGlProgram(l.WEBGL.DRAW_PROGRAMS.PRIMITIVES,"\n    precision mediump float;\n\n    attribute vec2 a_position;\n\n    uniform vec2 u_translation;\n    uniform float u_rotation;\n    uniform vec2 u_scale;\n\n    uniform vec2 u_resolution;\n\n    void main(void) {\n        float c = cos(u_rotation);\n        float s = sin(u_rotation);\n\n        mat3 translationMatrix1 = mat3(\n            1, 0, 0,\n            0, 1, 0,\n            u_translation.x, u_translation.y, 1\n        );\n\n        //mat3 translationMatrix2 = mat3(\n        //    1, 0, 0,\n        //    0, 1, 0,\n        //    -u_translation.x, -u_translation.y, 1\n        //);\n        \n        mat3 rotationMatrix = mat3(\n            c, s, 0,\n            -s, c, 0,\n            0, 0, 1\n        );\n\n        mat3 scalingMatrix = mat3(\n            u_scale.x, 0, 0,\n            0, u_scale.y, 0,\n            0, 0, 1\n        );\n        \n        mat3 matrix = translationMatrix1 * rotationMatrix * scalingMatrix;\n\n        vec2 position = (matrix * vec3(a_position, 1)).xy;\n\n        vec2 clipSpace = position / u_resolution * 2.0 - 1.0;\n\n        gl_Position = vec4(clipSpace * vec2(1, -1), 0, 1);\n    }\n","\n    precision mediump float;\n\n    uniform vec4 u_color;\n    uniform float u_fade_min; \n    uniform float u_fade_max;\n    uniform vec2 u_resolution;\n    uniform vec2 u_translation;\n\n    void main(void) {\n        vec4 p = u_color;\n        if (u_fade_min > 0.0) {\n            vec2 fix_tr = vec2(u_translation.x, u_resolution.y - u_translation.y); \n            float distance = distance(fix_tr.xy, gl_FragCoord.xy);\n            if (u_fade_min <= distance && distance <= u_fade_max) {\n                float percent = ((distance - u_fade_max) / (u_fade_min - u_fade_max)) * 100.0;\n                p.a = u_color.a * (percent / 100.0);\n            }\n        }\n\n        gl_FragColor = p;\n    }\n",De,Be))),this._registerRenderInit(this.#Qt._initWebGlAttributes),this._registerObjectRender(j.name,this.#Qt._bindText,l.WEBGL.DRAW_PROGRAMS.IMAGES),this._registerObjectRender(W.name,this.#Qt._bindPrimitives,l.WEBGL.DRAW_PROGRAMS.PRIMITIVES),this._registerObjectRender(X.name,this.#Qt._bindPrimitives,l.WEBGL.DRAW_PROGRAMS.PRIMITIVES),this._registerObjectRender(H.name,this.#Qt._bindConus,l.WEBGL.DRAW_PROGRAMS.PRIMITIVES),this._registerObjectRender(U.name,this.#Qt._bindConus,l.WEBGL.DRAW_PROGRAMS.PRIMITIVES),this._registerObjectRender(q.name,this.#Qt._bindTileImages,l.WEBGL.DRAW_PROGRAMS.IMAGES),this._registerObjectRender(z.name,this.#Qt._bindLine,l.WEBGL.DRAW_PROGRAMS.PRIMITIVES)}addEventListener=(e,t,i)=>{this.#Ie.addEventListener(e,t,i)};removeEventListener=(e,t,i)=>{this.#Ie.removeEventListener(e,t,i)};get stageData(){return this.#$t}get systemSettings(){return this.#ei}get iLoader(){return this.#St}get canvas(){return this.#qt}get drawContext(){return this.#Zt}emit=(e,...t)=>{const i=new Event(e);i.data=[...t],this.#Ie.dispatchEvent(i)};isAllFilesLoaded=()=>0===this.iLoader.filesWaitingForUpload;initiateContext=()=>Promise.all(this.#oi.map((e=>e())));clearContext(){this.#Qt._clearView()}setCanvasSize(e,t){this.#qt.width=e,this.#qt.height=t,this.#Qt&&this.#Qt._fixCanvasSize(e,t)}fixCanvasSize=()=>{const e=this.systemSettings,t=e.canvasMaxSize.width&&e.canvasMaxSize.width<window.innerWidth?e.canvasMaxSize.width:window.innerWidth,i=e.canvasMaxSize.height&&e.canvasMaxSize.height<window.innerHeight?e.canvasMaxSize.height:window.innerHeight;return this.setCanvasSize(t,i),Promise.resolve()};_registerAndCompileWebGlProgram(e,t,i,s,n){return this.#Qt._registerAndCompileWebGlProgram(e,t,i,s,n),Promise.resolve()}_registerRenderInit(e){this.#oi.push(e)}_registerObjectRender(e,t,i){this.#ai.set(e,{method:t,webglProgramName:i})}async render(){let e=[],t=[],i=!1;const s=this.stageData.renderObjects;if(0!==s.length){for(let t=0;t<s.length;t++){const i=s[t];if(i.isRemoved){s.splice(t,1),t--;continue}i.hasAnimations&&i._processActiveAnimations();const n=await this._bindRenderObject(i).catch((e=>Promise.reject(e)));e.push(n)}this.systemSettings.gameOptions.debug.boundaries.drawLayerBoundaries&&e.push(this.#li().catch((e=>Promise.reject(e))))}return(await Promise.allSettled(e)).forEach((e=>{"rejected"===e.status&&(Promise.reject(e.reason),i=!0,t.push(e.reason))})),this.#hi(),this._isCleared=!1,!1===i?Promise.resolve():Promise.reject(t)}set _isCleared(e){this.#Jt=e}get _isCleared(){return this.#Jt}_createBoundariesPrecalculations(){}#hi(){}#di(e){return new Promise(((t,i)=>{if(e.setBoundaries){const s=this.iLoader.getTileMap(e.tileMapKey),n=s.tilesets,r=s.layers.find((t=>t.name===e.layerKey)),{tileheight:a,tilewidth:o}=s,l=o,h=a,[d,c]=this.stageData.worldDimensions;let u=[];r||(x(m,"check tilemap and layers name"),i());for(let t=0;t<n.length;t++){const t=r.width,i=r.height,s=l*t,n=h*i;s===d&&n===c||(x(_," World size from tilemap is different than settings one, fixing..."),this.stageData._setWorldDimensions(s,n)),e.setBoundaries&&this.systemSettings.gameOptions.render.boundaries.mapBoundariesEnabled&&this.stageData._setWholeWorldMapBoundaries();let a=0;for(let e=0;e<i;e++)for(let i=0;i<t;i++){let t=r.data[a],s=i*l,n=e*h;0!==t&&(t-=1,u.push([s,n,s+l,n]),u.push([s+l,n,s+l,n+h]),u.push([s+l,n+h,s,n+h]),u.push([s,n+h,s,n])),a++}}this.stageData._setWholeMapBoundaries(u),this.stageData._mergeBoundaries(!0),t()}else t()}))}_bindRenderObject(e){const t=e.constructor.name,i=this.#ai.get(t);if(i){const t=i.webglProgramName;if(t){const s=this.#Qt.getProgram(t),n=this.#Qt.getProgramVarLocations(t);return i.method(e,this.drawContext,this.stageData,s,n).then((e=>this.#Qt._render(e[0],e[1])))}return i.method(e,this.drawContext,this.stageData)}if(e.type===l.DRAW_TYPE.IMAGE){const t=this.#Qt.getProgram(l.WEBGL.DRAW_PROGRAMS.IMAGES),i=this.#Qt.getProgramVarLocations(l.WEBGL.DRAW_PROGRAMS.IMAGES);if(!e.image){const t=this.iLoader.getImage(e.key);t?e.image=t:S(c,"iLoader can't get the image with key: "+e.key)}return this.#Qt._bindImage(e,this.drawContext,this.stageData,t,i).then((e=>this.#Qt._render(e[0],e[1]))).then((()=>e.vertices&&this.systemSettings.gameOptions.debug.boundaries.drawObjectBoundaries?this.#Qt._drawPolygon(e,this.stageData):Promise.resolve()))}return console.warn("no registered draw object method for "+t+" skip draw"),Promise.resolve()}#li(){return new Promise((e=>{const t=this.stageData.getRawBoundaries(),i=this.stageData.getEllipseBoundaries(),s=this.stageData.getPointBoundaries(),n=this.stageData.boundariesLen,r=this.stageData.ellipseBLen,a=this.stageData?.pointBLen;if(n&&this.#Qt._drawLines(t,this.systemSettings.gameOptions.debug.boundaries.boundariesColor,this.systemSettings.gameOptions.debug.boundaries.boundariesWidth),r)for(let e=0;e<r;e+=4){const t=Ie(i[e],i[e+1],i[e+2],i[e+3]);this.#Qt._drawPolygon({x:0,y:0,vertices:t,isOffsetTurnedOff:!0},this.stageData)}if(a)for(let e=0;e<a;e+=2){const t=s[e],i=s[e+1],n=[t,i,t+1,i+1];this.#Qt._drawLines(n,this.systemSettings.gameOptions.debug.boundaries.boundariesColor,this.systemSettings.gameOptions.debug.boundaries.boundariesWidth)}e()}))}#ci(){const e=this.systemSettings.gameOptions.render.cyclesTimeCalc.averageFPStime,t=this.#ti.length;let i=0;for(let e=0;e<t;e++)i+=this.#ti[e];console.log("FPS average for",e/1e3,"sec, is ",(1e3/(i/t)).toFixed(2)),this.#ti=[]}_startRender=async e=>{const t=this.systemSettings.gameOptions;this.#xe=!0,this.#$t=e,this.fixCanvasSize(),t.library===l.LIBRARY.WEBGL&&(await this.#ui(),this.timeStart=Date.now(),setTimeout((()=>requestAnimationFrame(this.#gi)))),t.render.cyclesTimeCalc.check===l.OPTIMIZATION.CYCLE_TIME_CALC.AVERAGES&&(this.#ii=setInterval((()=>this.#ci()),t.render.cyclesTimeCalc.averageFPStime))};_stopRender=()=>{this.#xe=!1,this.#$t=null,this.#ti=[],clearInterval(this.#ii),this.#ii=null};#ui(){return new Promise(((e,t)=>{let i=[];const s=this.#si;i.push(this.initiateContext()),s&&console.warn("isBoundariesPrecalculations() is turned off"),Promise.allSettled(i).then((i=>{i.forEach((e=>{if("rejected"===e.status){const i=e.reason;x(E,i),t(i)}})),e()}))}))}#gi=async()=>{const e=performance.now(),t=this.#ni,i=this.systemSettings.gameOptions.render.cyclesTimeCalc.check===l.OPTIMIZATION.CYCLE_TIME_CALC.CURRENT;this.emit(l.EVENTS.SYSTEM.RENDER.START),this.stageData.isMaxBoundariesSizeSet&&this.stageData._clearBoundaries(),this.clearContext(),this.render().then((()=>{const s=performance.now()-e,n=t-s,r=n>0?n:0,a=s+r;i&&s>t&&console.log("current draw take: ",s," ms"),this.emit(l.EVENTS.SYSTEM.RENDER.END),a>0&&this.#ti.push(a),this.#xe&&setTimeout((()=>requestAnimationFrame(this.#gi)),r)})).catch((e=>{e.forEach?e.forEach((e=>{x(E,e)})):x(E,e.message),this._stopRender()}))}}class Ne{#mi;constructor(e){this.#mi=e}registerDrawObject(e,t){this.#mi.drawObjectFactory._registerNewObjectMethod(e,t)}registerAndCompileWebGlProgram(e,t,i,s,n){return this.#mi.iRender._registerAndCompileWebGlProgram(e,t,i,s,n)}registerRenderInit(e){this.#mi.iRender._registerRenderInit(e)}registerObjectRender(e,t,i){this.#mi.iRender._registerObjectRender(e,t,i)}}class We{#at;#fi;#Ei;#_i;#et=new D;#Ai;#pi=new Z(this.#et);#Ti=new Map;#Si;#Ie=new EventTarget;constructor(e,t,i){e||S(h,"systemSettings should be passed to class instance"),this.#at=e,this.#_i=new te(this.iLoader),this.#Ei=e.network.enabled?new ee(e):null,this.#Ai=new Le(this.systemSettings,this.iLoader,i),this.#fi=new Ne(this,this.#Ai),this.#Si=t,this.#Ai.addEventListener(l.EVENTS.SYSTEM.RENDER.START,(()=>this.emit(l.EVENTS.SYSTEM.RENDER.START))),this.#Ai.addEventListener(l.EVENTS.SYSTEM.RENDER.END,(()=>this.emit(l.EVENTS.SYSTEM.RENDER.END)))}emit=(e,...t)=>{const i=new Event(e);i.data=[...t],this.#Ie.dispatchEvent(i)};addEventListener=(e,t,i)=>{this.#Ie.addEventListener(e,t,i)};removeEventListener=(e,t,i)=>{this.#Ie.removeEventListener(e,t,i)};get iNetwork(){return this.#Ei}get systemSettings(){return this.#at}get audio(){return this.#_i}get iLoader(){return this.#et}get iRender(){return this.#Ai}get drawObjectFactory(){return this.#pi}get iExtension(){return this.#fi}get modules(){return this.#Ti}installModule=(e,t,...i)=>{const s=new t(this,...i);return this.#Ti.has(e)?(x("MODULE_ALREADY_INSTALLED","module "+e+" is already installed"),this.#Ti.get(e)):(this.#Ti.set(e,s),s)};startGameStage=(e,t)=>{if(this.#Si.has(e)){const i=this.#Si.get(e),s=i.stageData;this.#pi._attachPageData(s),!1===i.isInitiated&&i._init(),i._start(t),this.emit(l.EVENTS.SYSTEM.START_PAGE),this.#Ai._startRender(s)}else S(d,"View "+e+" is not registered!")};stopGameStage=e=>{this.#Si.has(e)?(this.emit(l.EVENTS.SYSTEM.STOP_PAGE),this.drawObjectFactory._detachPageData(),this.#Ai._stopRender(),this.#Si.get(e)._stop()):S(d,"View "+e+" is not registered!")}}class Ge{#xi;#yi=!1;#xe;#Ri;#bi;constructor(){this.#xe=!1}_register(e,t){this.#xi=e,this.#Ri=t,this.#bi=new y(this.#Ri.systemSettings.gameOptions),this.#vi(),this.#wi(),this.register()}_init(){this.init(),this.#yi=!0}register(){}init(){}start(e){}stop(){}resize(){}get iLoader(){return this.#Ri.iLoader}get draw(){return this.#Ri.drawObjectFactory}_attachCanvasToContainer(e){this.#Ii(this.canvasHtmlElement,e)}addRenderObject=e=>{const t=this.stageData;-1!==t.renderObjects.indexOf(e)?x("NEW_BEHAVIOR_INTRODUCED","stage.draw methods add objects to pageData, no need to call addRenderObject"):(t._renderObject=e,t._sortRenderObjectsBySortIndex())};get isActive(){return this.#xe}get isInitiated(){return this.#yi}get name(){return this.#xi}get stageData(){return this.#bi}get systemSettings(){return this.#Ri.systemSettings}get audio(){return this.#Ri.audio}get iSystem(){return this.#Ri}get canvasHtmlElement(){return document.getElementsByTagName("canvas")[0]}addEventListener=(e,t,i)=>{this.iSystem.addEventListener(e,t,i)};removeEventListener=(e,t,i)=>{this.iSystem.removeEventListener(e,t,i)};_start(e){this.start(e),this.#xe=!0,window.addEventListener("resize",this._resize),this._resize()}_stop(){this.#xe=!1,window.removeEventListener("resize",this._resize),this.stop()}_resize=()=>{this.#wi(),this.resize()};#Ii(e,t){t.appendChild(e)}#vi(){const e=this.systemSettings.worldSize?this.systemSettings.worldSize.width:0,t=this.systemSettings.worldSize?this.systemSettings.worldSize.height:0;this.stageData._setWorldDimensions(e,t)}isBoundariesCollision=(e,t,i)=>{const s=i.type,n=i.vertices,r=i.circleBoundaries;switch(s){case l.DRAW_TYPE.TEXT:case l.DRAW_TYPE.RECTANGLE:case l.DRAW_TYPE.CONUS:case l.DRAW_TYPE.IMAGE:return r?this.#Pi(e,t,i.circleBoundaries.r):this.#Oi(e,t,n,i.rotation);case l.DRAW_TYPE.CIRCLE:x(l.WARNING_CODES.METHOD_NOT_IMPLEMENTED,"isObjectCollision.circle check is not implemented yet!");break;case l.DRAW_TYPE.LINE:x(l.WARNING_CODES.METHOD_NOT_IMPLEMENTED,"isObjectCollision.line check is not implemented yet, please use .rect instead line!");break;default:x(l.WARNING_CODES.UNKNOWN_DRAW_OBJECT,"unknown object type!")}return!1};isObjectsCollision=(e,t,i,s)=>{const n=i.type,r=i.vertices,a=i.circleBoundaries;switch(n){case l.DRAW_TYPE.TEXT:case l.DRAW_TYPE.RECTANGLE:case l.DRAW_TYPE.CONUS:case l.DRAW_TYPE.IMAGE:return a?this.#Ci(e,t,a,s):this.#Mi(e,t,r,i.rotation,s);case l.DRAW_TYPE.CIRCLE:x(l.WARNING_CODES.METHOD_NOT_IMPLEMENTED,"isObjectCollision.circle check is not implemented yet!");break;case l.DRAW_TYPE.LINE:x(l.WARNING_CODES.METHOD_NOT_IMPLEMENTED,"isObjectCollision.line check is not implemented yet, please use .rect instead line!");break;default:x(l.WARNING_CODES.UNKNOWN_DRAW_OBJECT,"unknown object type!")}return!1};#Mi(e,t,i,s,n){const r=n.length;let a=[];for(let o=0;o<r;o++){const r=n[o];let h;switch(r.type){case l.DRAW_TYPE.TEXT:case l.DRAW_TYPE.RECTANGLE:case l.DRAW_TYPE.CONUS:case l.DRAW_TYPE.IMAGE:h=this.#Di(e,t,i,s,r);break;case l.DRAW_TYPE.CIRCLE:console.warn("isObjectCollision.circle check is not implemented yet!");break;case l.DRAW_TYPE.LINE:console.warn("isObjectCollision.line check is not implemented, please use rect instead");break;default:console.warn("unknown object type!")}h&&a.push(h)}return a.length>0?this.#Bi(a):null}#Ci(e,t,i,s){const n=i.r,r=s.length;let a=[];for(let i=0;i<r;i++){const r=s[i],o=r.type,h=r.circleBoundaries;let d;switch(o){case l.DRAW_TYPE.TEXT:case l.DRAW_TYPE.RECTANGLE:case l.DRAW_TYPE.CONUS:case l.DRAW_TYPE.IMAGE:d=h?this.#Li(e,t,n,r.x,r.y,h.r):this.#Ni(e,t,n,r);break;case l.DRAW_TYPE.CIRCLE:console.warn("isObjectCollision.circle check is not implemented yet!");break;case l.DRAW_TYPE.LINE:console.warn("isObjectCollision.line check is not implemented, please use rect instead");break;default:console.warn("unknown object type!")}d&&a.push(d)}return a.length>0?this.#Bi(a):null}#Bi(e){return e.sort(((e,t)=>e.p<t.p))[0]}#Ni(e,t,i,s){const[n,r]=this.stageData.worldOffset,a=e-n,o=t-r,l=s.x-n,h=s.y-r,d=s.vertices,c=s.rotation,u=d.length;for(let e=0;e<u;e+=1){const t=d[e];let s=d[e+1];s||(s=d[0]);const n=this.#Wi(t,l,h,c),r=this.#Wi(s,l,h,c),u=Se(a,o,i,{x1:n[0],y1:n[1],x2:r[0],y2:r[1]});if(u)return u}return!1}#Li(e,t,i,s,n,r){const a=new k(e,t,s,n).length;return console.log(a),console.log(i),console.log(r),!(a-(i+r)>0)}#Di(e,t,i,s,n){const[r,a]=this.stageData.worldOffset,o=e-r,l=t-a,h=n.x-r,d=n.y-a,c=n.vertices,u=n.rotation,g=i.map((e=>this.#Wi(e,o,l,s))),m=c.length;for(let e=0;e<m;e+=1){const t=c[e];let i=c[e+1];i||(i=c[0]);const s=this.#Wi(t,h,d,u),n=this.#Wi(i,h,d,u),r=Ee(g,{x1:s[0],y1:s[1],x2:n[0],y2:n[1]});if(r)return r}return!1}#Wi(e,t,i,s){const n=new k(0,0,e[0],e[1]),r=oe(0,0,e[0],e[1]),a=n.length;return[t+a*Math.cos(s+r),i+a*Math.sin(s+r)]}#Pi(e,t,i){const s=this.stageData.getRawBoundaries(),n=this.stageData.getEllipseBoundaries(),r=this.stageData.getPointBoundaries(),[a,o]=this.stageData.worldOffset,l=e-a,h=t-o,d=this.stageData.boundariesLen,c=this.stageData.ellipseBLen,u=this.stageData.pointBLen;for(let e=0;e<d;e+=4){const t=s[e],n=s[e+1],r=s[e+2],a=s[e+3];if(0!==t||0!==n||0!==r||0!==a){const e=Se(l,h,i,{x1:t,y1:n,x2:r,y2:a});if(e)return e}}if(c>0)for(let e=0;e<c;e+=4){const t=ye([n[e],n[e+1],n[e+2],n[e+3]],{x:l,y:h,r:i});if(t)return t}if(u>0)for(let e=0;e<u;e+=2){const t=Te(r[e],r[e+1],{x:l,y:h,r:i});if(t)return t}return!1}#Oi(e,t,i,s){const n=this.stageData.getRawBoundaries(),r=this.stageData.getEllipseBoundaries(),a=this.stageData.getPointBoundaries(),[o,l]=this.stageData.worldOffset,h=e-o,d=t-l,c=i.map((e=>this.#Wi(e,h,d,s))),u=this.stageData.boundariesLen,g=r.length,m=a.length;for(let e=0;e<u;e+=4){const t=n[e],i=n[e+1],s=n[e+2],r=n[e+3];if(0!==t||0!==i||0!==s||0!==r){const e=Ee(c,{x1:t,y1:i,x2:s,y2:r});if(e)return e}}if(g>0)for(let e=0;e<g;e+=4){const t=Re([r[e],r[e+1],r[e+2],r[e+3]],c);if(t)return t}if(m>0)for(let e=0;e<m;e+=2){const t=_e(a[e],a[e+1],c);if(t)return t}return!1}#wi(){const e=this.systemSettings.canvasMaxSize.width&&this.systemSettings.canvasMaxSize.width<window.innerWidth?this.systemSettings.canvasMaxSize.width:window.innerWidth,t=this.systemSettings.canvasMaxSize.height&&this.systemSettings.canvasMaxSize.height<window.innerHeight?this.systemSettings.canvasMaxSize.height:window.innerHeight;this.stageData._setCanvasDimensions(e,t)}}class Fe extends Ge{#Gi=0;#Fi=0;#ki=0;register(){}init(){const[e,t]=this.stageData.canvasDimensions,i=e/3;this.background=this.draw.rect(0,0,e,t,this.systemSettings.gameOptions.loadingScreen.backgroundColor),this.loadingBarBg=this.draw.rect(e/2-i/2,t/2-10,i,20,this.systemSettings.gameOptions.loadingScreen.loadingBarBg),this.loadingBarProgress=this.draw.rect(e/2-i/2,t/2-10,i,20,this.systemSettings.gameOptions.loadingScreen.loadingBarProgress),this.text=this.draw.text(e/2-20,t/2-40,"JsGE","24px sans-serif","black"),this.#ki=i}_progress=e=>{const t=this.#ki/this.#Gi;this.#Fi=e;const i=t*this.#Fi,s=e>this.#Gi?this.#ki:i;this.loadingBarProgress.width=s};start(e){this.#Gi=e.total}}const ke="loadingPage";class je{#ji;#Ui;constructor(e,t){e||S(h,"iSystemSettings should be passed to class instance"),this.#ji=new Map,t||(t=document.createElement("div"),document.body.appendChild(t)),this.#Ui=new We(e,this.#ji,t),this.registerStage(ke,Fe),this.#Ui.iLoader.addEventListener("loadstart",this.#Vi),this.#Ui.iLoader.addEventListener("progress",this.#Yi),this.#Ui.iLoader.addEventListener("load",this.#zi)}get iSystem(){return this.#Ui}registerStage(e,t){if(e&&"string"==typeof e&&e.trim().length>0){const i=new t;i._register(e,this.iSystem),this.#ji.set(e,i)}else S(h,"valid class name should be provided")}preloadAllData(){return this.#Ui.iLoader.preload()}#Vi=e=>{this.#Ui.startGameStage(ke,{total:e.total})};#Yi=e=>{const t=e.loaded,i=e.total;this.#ji.get(ke)._progress(t,i)};#zi=()=>{this.#Ui.stopGameStage(ke)}}var Ue=r.oX,Ve=r.QD,Ye=r.T_,ze=r.uw,Xe=r.xl,He=r.xP,Ke=r.bq,qe=r.P6;export{Ue as CONST,Ve as DrawImageObject,Ye as GameStage,ze as ISystemAudio,Xe as Primitives,He as System,Ke as SystemSettings,qe as utils};