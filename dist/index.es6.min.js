var e,t,i={},s={};function r(e){var t=s[e];if(void 0!==t)return t.exports;var n=s[e]={exports:{}};return i[e](n,n.exports,r),n.exports}r.m=i,r.d=(e,t)=>{for(var i in t)r.o(t,i)&&!r.o(e,i)&&Object.defineProperty(e,i,{enumerable:!0,get:t[i]})},r.f={},r.e=e=>Promise.all(Object.keys(r.f).reduce(((t,i)=>(r.f[i](e,t),t)),[])),r.u=e=>e+".index.es6.min.js",r.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),e={},t="jsge:",r.l=(i,s,n,o)=>{if(e[i])e[i].push(s);else{var a,c;if(void 0!==n)for(var h=document.getElementsByTagName("script"),l=0;l<h.length;l++){var d=h[l];if(d.getAttribute("src")==i||d.getAttribute("data-webpack")==t+n){a=d;break}}a||(c=!0,(a=document.createElement("script")).type="module",a.charset="utf-8",a.timeout=120,r.nc&&a.setAttribute("nonce",r.nc),a.setAttribute("data-webpack",t+n),a.src=i),e[i]=[s];var u=(t,s)=>{a.onerror=a.onload=null,clearTimeout(g);var r=e[i];if(delete e[i],a.parentNode&&a.parentNode.removeChild(a),r&&r.forEach((e=>e(s))),t)return t(s)},g=setTimeout(u.bind(null,void 0,{type:"timeout",target:a}),12e4);a.onerror=u.bind(null,a.onerror),a.onload=u.bind(null,a.onload),c&&document.head.appendChild(a)}},r.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},(()=>{var e;if("string"==typeof import.meta.url&&(e=import.meta.url),!e)throw new Error("Automatic publicPath is not supported in this browser");e=e.replace(/#.*$/,"").replace(/\?.*$/,"").replace(/\/[^\/]+$/,"/"),r.p=e})(),(()=>{var e={179:0};r.f.j=(t,i)=>{var s=r.o(e,t)?e[t]:void 0;if(0!==s)if(s)i.push(s[2]);else{var n=new Promise(((i,r)=>s=e[t]=[i,r]));i.push(s[2]=n);var o=r.p+r.u(t),a=new Error;r.l(o,(i=>{if(r.o(e,t)&&(0!==(s=e[t])&&(e[t]=void 0),s)){var n=i&&("load"===i.type?"missing":i.type),o=i&&i.target&&i.target.src;a.message="Loading chunk "+t+" failed.\n("+n+": "+o+")",a.name="ChunkLoadError",a.type=n,a.request=o,s[1](a)}}),"chunk-"+t,t)}};var t=(t,i)=>{var s,n,[o,a,c]=i,h=0;if(o.some((t=>0!==e[t]))){for(s in a)r.o(a,s)&&(r.m[s]=a[s]);c&&c(r)}for(t&&t(i);h<o.length;h++)n=o[h],r.o(e,n)&&e[n]&&e[n][0](),e[n]=0},i=self.webpackChunkjsge=self.webpackChunkjsge||[];i.forEach(t.bind(null,0)),i.push=t.bind(null,i.push.bind(i))})();var n={};r.d(n,{oX:()=>c,QD:()=>ae,xl:()=>o,r4:()=>ve,xP:()=>Se,jQ:()=>pe,bq:()=>b,P6:()=>a});var o={};r.r(o),r.d(o,{Rectangle:()=>M,Vector:()=>B,Vertex:()=>N});var a={};r.r(a),r.d(a,{angle_2points:()=>j,angle_3points:()=>V,countClosestTraversal:()=>G,countClosestTraversal2:()=>k,countDistance:()=>H,crossProduct:()=>X,dotProduct:()=>z,dotProductWithAngle:()=>Y,generateUniqId:()=>te,isLineShorter:()=>q,isMobile:()=>W,isPointCircleIntersect:()=>ee,isPointLineIntersect:()=>Q,isPointOnTheLine:()=>K,isPointPolygonIntersect:()=>$,isPointRectIntersect:()=>Z,isPolygonLineIntersect:()=>J,isSafari:()=>U,pointToCircleDistance:()=>F,verticesArrayToArrayNumbers:()=>ie});const c={MODE:{DEBUG:"DEBUG",PRODUCTION:"PRODUCTION"},SCREENS:{},AUDIO:{},CONNECTION_STATUS:{DISCONNECTED:"disconnected",CONNECTED:"connected",CONNECTION_LOST:"connection lost"},EVENTS:{SYSTEM:{START_PAGE:"START_PAGE",STOP_PAGE:"STOP_PAGE",RENDER:{START:"start",END:"end"}},GAME:{BOUNDARIES_COLLISION:"BOUNDARIES_COLLISION",OBJECTS_COLLISION:"OBJECTS_COLLISION"},WEBSOCKET:{SERVER_CLIENT:{CONNECTION_STATUS_CHANGED:"CONNECTION_STATUS_CHANGED",ROOMS_INFO:"roomsInfo",CREATED:"created",JOINED:"joined",FULL:"full",DISCONNECTED:"disconnected",SERVER_MESSAGE:"message",RESTARTED:"restarted"},CLIENT_SERVER:{ROOMS_INFO_REQUEST:"gatherRoomsInfo",CREATE_OR_JOIN:"create or join",RESTART_REQUEST:"restart",CLIENT_MESSAGE:"message"}}},WEBGL:{DRAW_PROGRAMS:{PRIMITIVES:"drawPrimitives",IMAGES:"drawImages"}},DRAW_TYPE:{RECTANGLE:"rect",CONUS:"conus",CIRCLE:"circle",POLYGON:"polygon",LINE:"line",TEXT:"text",IMAGE:"image"},LAYERS:{DEFAULT:"default-view-layer",BOUNDARIES:"boundaries-view-layer"},GAME_OPTIONS:{},LIBRARY:{WEBGL:"webgl"},OPTIMIZATION:{WEB_ASSEMBLY:{ASSEMBLY_SCRIPT:"ASSEMBLY_SCRIPT"}}},h="CREATE_INSTANCE_ERROR",l="VIEW_NOT_EXIST",d="UNEXPECTED_INPUT_PARAMS",u="UNHANDLED_PREPARE_EXCEPTION",g="CANVAS_KEY_NOT_SPECIFIED",m="CANVAS_WITH_KEY_NOT_EXIST",E="WEBGL_ERROR",f="NOT_FOUND",_="WORLD_DIMENSIONS_NOT_SET",p="UNHANDLED_DRAW_ISSUE",T="UNEXPECTED_WORLD_SIZE",v="AUDIO_NOT_REGISTERED",A="AUDIO_NOT_LOADED",R="POLYGON_VERTICES_NOT_CORRECT";function S(e,t){throw new Error(e+": "+t)}function y(e,t){console.warn(e,t)}class P{#e;#t;#i;#s;#r=0;#n=0;#o=0;#a=0;#c=0;#h=[];#l=[];#d(e){this.#h.push([e.x1,e.y1,e.x2,e.y2])}_addBoundariesArray(e){this.#h.push(...e)}_clearBoundaries(){this.#h=[]}_setWorldDimensions(e,t){this.#e=e,this.#t=t}set mapRotate(e){this.#c=e}_setCanvasDimensions(e,t){this.#i=e,this.#s=t}_setMapBoundaries(){const[e,t]=[this.#e,this.#t];e&&t||y(_,"Can't set map boundaries."),this.#d({x1:0,y1:0,x2:e,y2:0}),this.#d({x1:e,y1:0,x2:e,y2:t}),this.#d({x1:e,y1:t,x2:0,y2:t}),this.#d({x1:0,y1:t,x2:0,y2:0})}_setWholeWorldMapBoundaries(){const[e,t]=[this.#e,this.#t];e&&t||y(_,"Can't set map boundaries."),this.#l.push([0,0,e,0]),this.#l.push([e,0,e,t]),this.#l.push([e,t,0,t]),this.#l.push([0,t,0,0])}_mergeBoundaries(e=!1){const t=e?this.getWholeWorldBoundaries():this.getBoundaries(),i=new Set(t);for(const e of i.values()){const t=e[0],s=e[1],r=e[2],n=e[3];for(const o of i.values()){const a=o[0],c=o[1],h=o[2],l=o[3];t===h&&s===l&&r===a&&n===c&&(i.delete(e),i.delete(o)),r!==a||n!==c||t!==h&&s!==l||(o[0]=t,o[1]=s,i.delete(e))}}e?this.#h=Array.from(i):this.#l=Array.from(i),i.clear()}_setWholeMapBoundaries(e){this.#l.push(...e)}getBoundaries(){return this.#h}getWholeWorldBoundaries(){return this.#l}get canvasDimensions(){return[this.#i,this.#s]}get worldDimensions(){return[this.#e,this.#t]}get worldOffset(){return[this.#r,this.#n]}get mapCenter(){return[this.#o,this.#a]}get mapRotate(){return this.#c}centerCameraPosition=(e,t)=>{let[i,s]=this.worldOffset;const[r,n]=this.canvasDimensions,[o,a]=this.worldDimensions,c=r/2,h=n/2,l=h-s;if(c-i<e)if(e<o-c){const t=e-c;t>=0&&(this.#r=Math.round(t))}else if(o>r){const e=o-r;this.#r=Math.round(e)}if(l<t)if(t<a-h){const e=t-h;e>=0&&(this.#n=Math.round(e))}else if(a>n){const e=a-n;this.#n=Math.round(e)}this.#o=e,this.#a=t};personRotatedCenterCamera=(e,t,i)=>{console.log("new centering algorithm")}}const b={mode:c.MODE.DEBUG,gameOptions:{library:c.LIBRARY.WEBGL,checkWebGlErrors:!1,debugMobileTouch:!1,optimization:null,loadingScreen:{backgroundColor:"rgba(128, 128, 128, 0.6)",loadingBarBg:"rgba(128, 128, 128, 1)",loadingBarProgress:"rgba(128, 128, 128, 0.2)"},boundaries:{drawLayerBoundaries:!1,drawObjectBoundaries:!1,boundariesColor:"rgba(224, 12, 21, 0.6)",boundariesWidth:2},modules:{},render:{averageFPStime:1e4,minCircleTime:16,boundaries:{mapBoundariesEnabled:!0,realtimeCalculations:!0,wholeWorldPrecalculations:!1}}},network:{address:"https://gameserver.reslc.ru:9009",gatherRoomsInfoInterval:5e3},canvasMaxSize:{width:900,height:960},worldSize:{width:960,height:960},defaultCanvasKey:"default"};class x{static debug(...e){b.mode===c.MODE.DEBUG&&e.forEach((e=>console.log(e)))}}const w={loadstart:"loadstart",progress:"progress",abort:"abort",error:"error",load:"load",timeout:"timeout"};class C{#u;#g;#m=new Map;#E=new Map;constructor(e,t){this.#u=e,this.#g=(e,i,...s)=>{const r=t(e,i,...s);if(r instanceof Promise)return r.then((t=>this.#f(t,e)));I("uploadMethod should be instance of Promise and return upload result value")}}#f=(e,t)=>new Promise(((i,s)=>{e&&0!==e.length||O("uploadMethod for "+this.#u+" should return Promise with upload value"),this.#_(t,e),this.#p(t),i()}));#_(e,t){this.#E.set(e,t)}#p(e){this.#m.delete(e)}get filesWaitingForUpload(){return this.#m.size}get loadingQueue(){return this.#m}get uploadMethod(){return this.#g}_addFile=(e,t)=>{this.#m.has(e)&&O("File "+this.#u+" with key "+e+" is already added"),this.#m.set(e,t)};_isFileInQueue=e=>this.#m.has(e);_getFile=e=>this.#E.get(e)}class L{#T=new EventTarget;#v=new Map;#A=0;constructor(){this.registerLoader("Audio",this._loadAudio),this.registerLoader("Image",this._loadImage),this.registerLoader("TileMap",this._loadTileMap)}get filesWaitingForUpload(){let e=0;return Array.from(this.#v.values()).map((t=>e+=t.filesWaitingForUpload)),e}registerLoader=(e,t=this._defaultUploadMethod)=>{const i=this.#v.get(e)||new C(e,t);this["add"+e]=(t,i)=>{this.addFile(e,t,i)},this["get"+e]=t=>this.getFile(e,t),this["is"+e+["InQueue"]]=t=>this.isFileInQueue(e,t),this.#v.set(e,i)};preload(){return this.#R(),new Promise(((e,t)=>{this.#S().then((()=>{this.filesWaitingForUpload?this.#S().then((()=>{this.#y(),e()})):(this.#y(),e())}))}))}#S(){const e=Array.from(this.#v.values()).map((e=>Promise.allSettled(Array.from(e.loadingQueue.entries()).map((t=>e.uploadMethod(t[0],t[1]))))));return Promise.all(e)}addEventListener(e,t,...i){w[e]?this.#T.addEventListener(e,t,...i):O("Event type should be one of the ProgressEvent.type")}removeEventListener(e,t,...i){this.#T.removeEventListener(e,t,...i)}#P=(e,t)=>{const{firstgid:i,source:s}=e;return this.#b(s),fetch(t+s).then((e=>e.json())).then((e=>{const{name:s,image:r}=e;return s&&r&&!this.isImageInQueue(s)&&this.addImage(s,t?t+r:r,e),e.gid=i,Promise.resolve(e)})).catch((()=>{const e=new Error("Can't load related tileset ",s);return Promise.reject(e)}))};_defaultUploadMethod=(e,t)=>fetch(t);_loadTileMap=(e,t)=>(this.#x(t),fetch(t).then((e=>e.json())).then((e=>{let i,s=t.split("/"),r=s.length;if(s[r-1].includes(".tmj")||s[r-1].includes(".json")?(s.pop(),i=s.join("/")+"/"):(s[r-2].includes(".tmj")||s[r-2].includes(".json"))&&(s.splice(r-2,2),i=s.join("/")+"/"),e.tilesets&&e.tilesets.length>0){const t=[];return e.tilesets.forEach(((e,s)=>{const r=this.#P(e,i).then((e=>(this.#w(),Promise.resolve(e))));t.push(r)})),Promise.all(t).then((t=>{for(let i=0;i<t.length;i++){const s=t[i];e.tilesets[i].data=s}return Promise.resolve(e)}))}})).catch((e=>(e.message.includes("JSON.parse:")&&(e=new Error("Can't load tilemap "+t)),this.#C(e),Promise.reject(e)))));_loadAudio=(e,t)=>new Promise(((e,i)=>{const s=new Audio(t);s.addEventListener("loadeddata",(()=>{this.#w(),e(s)})),s.addEventListener("error",(()=>{const e=new Error("Can't load audio "+t);this.#C(e),i(e)}))}));_loadImage=(e,t)=>new Promise(((e,i)=>{const s=new Image;s.onload=()=>{createImageBitmap(s).then((t=>{this.#w(),e(t)}))},s.onerror=()=>{const e=new Error("Can't load image "+t);this.#C(e),i(e)},s.src=t}));#b(e){e.includes(".tsj")||e.includes(".json")||I("Related Tileset file type is not correct, only .tsj or .json files are supported")}#x(e){e.includes(".tmj")||e.includes(".json")||I("Tilemap file type is not correct, only .tmj or .json files are supported")}addFile(e,t,i){const s=this.#v.get(e);s?(this.#L(t,i),s._addFile(t,i)):I("Loader for "+e+" is not registered!")}isFileInQueue(e,t){const i=this.#v.get(e);if(i)return i._isFileInQueue(t);I("Loader for "+e+" is not registered!")}getFile(e,t){const i=this.#v.get(e);if(i)return i._getFile(t);I("Loader for "+e+" is not registered!")}#L(e,t){const i="fileKey and url should be provided";e&&0!==e.trim().length||I(i),t&&0!==t.trim().length||I(i)}#R(){let e=this.filesWaitingForUpload;this.#T.dispatchEvent(new ProgressEvent(w.loadstart,{total:e}))}#y(){this.#T.dispatchEvent(new ProgressEvent(w.load))}#w(){const e=this.filesWaitingForUpload;this.#A+=1,this.#T.dispatchEvent(new ProgressEvent(w.progress,{lengthComputable:!0,loaded:this.#A,total:e}))}#C(e){this.#T.dispatchEvent(new ProgressEvent(w.error,{error:e}))}}function I(e){throw new Error(e)}function O(e){console.warn(e)}class D{#I;#O;#D;#N;constructor(e,t,i=!1){this.#I=e,this.#O=t,this.#D=i,this.#N=i||!1}get layerKey(){return this.#I}get tileMapKey(){return this.#O}get setBoundaries(){return this.#D}get drawBoundaries(){return this.#N}set drawBoundaries(e){this.#N=e}}class N{#M;#B;constructor(e,t){this.#M=e,this.#B=t}get x(){return this.#M}get y(){return this.#B}}class M{#M;#B;#W;#R;constructor(e,t,i,s){this.#M=e,this.#B=t,this.#W=i,this.#R=s}get x(){return this.#M}get y(){return this.#B}get width(){return this.#W}get height(){return this.#R}}class B{#M;#B;constructor(e,t,i,s){this.#M=i-e,this.#B=s-t}get x(){return this.#M}get y(){return this.#B}get length(){return Math.sqrt(Math.pow(this.#M,2)+Math.pow(this.#B,2))}get tetaAngle(){return Math.atan2(this.#B,this.#M)}}function W(){return/Android|webOS|iPhone|iPad|iPod|Opera Mini/i.test(navigator.userAgent)}function U(){return/^((?!chrome|android).)*safari/i.test(navigator.userAgent)}function F(e,t,i){return new B(e,t,i.x,i.y).length-i.r}function G(e,t){const i=t.x1,s=t.y1,r=t.x2,n=t.y2,o=e.x1,a=e.y1,c=i,h=s,l=r-i,d=n-s,u=o,g=a,m=e.x2-o,E=e.y2-a,f=Math.sqrt(l*l+d*d),_=Math.sqrt(m*m+E*E);if(l/f==m/_&&d/f==E/_)return null;const p=(l*(g-h)+d*(c-u))/(m*d-E*l),T=(u+m*p-c)/l;return T<0||isNaN(T)||p<0||p>1?null:{x:c+l*T,y:h+d*T,p:T}}function k(e,t){const i=t.x1,s=t.y1,r=t.x2,n=t.y2,o=e.x1,a=e.y1,c=e.x2,h=e.y2,l=(i-r)*(a-h)-(s-n)*(o-c);if(0===l)return;let d=((i*n-s*r)*(o-c)-(i-r)*(o*h-a*c))/l,u=((i*n-s*r)*(a-h)-(s-n)*(o*h-a*c))/l;const g={x:d,y:u};return K(g,e,1e-13)&&K(g,t,1e-13)?{x:d,y:u,p:Math.sqrt(Math.pow(d-i,2)+Math.pow(u-s,2))}:void 0}function j(e,t,i,s){return Math.atan2(s-t,i-e)}function V(e,t,i){const s=e.x-t.x,r=i.x-t.x,n=e.y-t.y,o=i.y-t.y,a=Math.sqrt(s*s+n*n),c=Math.sqrt(r*r+o*o);return Math.acos((s*r+n*o)/(a*c))}function Y(e,t,i){return e*t*Math.cos(i)}function z(e,t){return e.x*t.x+e.y*t.y}function X(e,t){return e.x*t.y-t.x*e.y}function K(e,t,i=0){return(e.x>=t.x1-i&&e.x<=t.x2+i||e.x<=t.x1+i&&e.x>=t.x2-i)&&(e.y>=t.y1-i&&e.y<=t.y2+i||e.y<=t.y1+i&&e.y>=t.y2-i)}function H(e,t){return new B(e.x,e.y,t.x,t.y).length}function q(e,t){return new B(e.x1,e.y1,e.x2,e.y2).length<new B(t.x1,t.y1,t.x2,t.y2).length}function Q(e,t){const i=new B(t.x1,t.y1,t.x2,t.y2).length;return new B(t.x1,t.y1,e.x,e.y).length+new B(t.x2,t.y2,e.x,e.y).length<=i+.2}function J(e,t){const i=e.length;for(let s=0;s<i;s+=1){let i=e[s],r=e[s+1];if(!r){if(i[0]===e[0][0]&&i[1]===e[0][1])continue;r=e[0]}const n=k({x1:i[0],y1:i[1],x2:r[0],y2:r[1]},t);if(n)return n}if(e[i-1][0]!==e[0][0]&&e[i-1][1]!==e[0][1]){const s=e[i-1],r=e[0],n=k({x1:s[0],y1:s[1],x2:r[0],y2:r[1]},t);if(n)return n}return null}function $(){return!1}function Z(e,t,i){return e>=i.x&&e<=i.width+i.x&&t>=i.y&&t<=i.y+i.height}function ee(e,t,i){const s=i.width;return new B(e,t,i.x,i.y).length<s}function te(){return Math.round(1e6*Math.random())}function ie(e){const t=e.length,i=[];for(let s=0;s<t;s++){const t=e[s];i.push([t.x,t.y])}return i}class se{#U;#F;#G;#k;#j;#V;#Y;#z;#X;#K;constructor(e,t,i,s,r,n=["SRC_ALPHA","ONE_MINUS_SRC_ALPHA"],o=0,a=[0,0],c=[1,1]){this.#U=e,this.#F=t,this.#G=i,this.#k=s,this.#j=r,this.#V=n,this.#Y=o,this.#z=a,this.#X=c,this.#K=t.length/2}get programName(){return this.#U}get vectors(){return this.#F}get textures(){return this.#G}get image(){return this.#k}get imageName(){return this.#j}get drawMask(){return this.#V}get rotation(){return this.#Y}get translation(){return this.#z}get scale(){return this.#X}get programVerticesNum(){return this.#K}isProgramDataCanBeMerged(e,t=["SRC_ALPHA","ONE_MINUS_SRC_ALPHA"],i=0,s=[0,0],r=[1,1]){return this.imageName===e&&this.drawMask[0]===t[0]&&this.drawMask[1]===t[1]&&this.rotation===i&&this.translation[0]===s[0]&&this.translation[1]===s[1]&&this.scale[0]===r[0]&&this.scale[1]===r[1]}mergeProgramData(e,t){this.#F.push(...e),this.#G.push(...t),this.#K=this.#F.length/2}}class re{#H;#q;#Q;#J;#$;#Z;#ee;#te;#ie;#se;#re;constructor(e,t){e&&e instanceof WebGLRenderingContext||S(d," context parameter should be specified and equal to WebGLRenderingContext"),this.#ee=e,this.#te=t,this.#Q=new Map,this.#J=[],this.#$=new Map,this.#ie=new Map,this.#Z=0,this.#se=this.#ee.createBuffer(),this.#re=this.#ee.createBuffer()}_fixCanvasSize(e,t){this.#ee.viewport(0,0,e,t)}_initiateImagesDrawProgram(){this.#H="\n        attribute vec2 a_texCoord;\n\n        attribute vec2 a_position;\n\n        uniform vec2 u_translation;\n        uniform float u_rotation;\n        uniform vec2 u_scale;\n\n        uniform vec2 u_resolution;\n\n        varying vec2 v_texCoord;\n\n        void main(void) {\n            float c = cos(-u_rotation);\n            float s = sin(-u_rotation);\n\n            mat3 translationMatrix1 = mat3(\n                1, 0, 0,\n                0, 1, 0,\n                u_translation.x, u_translation.y, 1\n            );\n\n            mat3 translationMatrix2 = mat3(\n                1, 0, 0,\n                0, 1, 0,\n                -u_translation.x, -u_translation.y, 1\n            );\n            \n            mat3 rotationMatrix = mat3(\n                c, -s, 0,\n                s, c, 0,\n                0, 0, 1\n            );\n\n            mat3 scalingMatrix = mat3(\n                u_scale.x, 0, 0,\n                0, u_scale.y, 0,\n                0, 0, 1\n            );\n\n            mat3 matrix = translationMatrix1 * rotationMatrix * translationMatrix2 * scalingMatrix;\n            //Scale\n            // vec2 scaledPosition = a_position * u_scale;\n            // Rotate the position\n            // vec2 rotatedPosition = vec2(\n            //    scaledPosition.x * u_rotation.y + scaledPosition.y * u_rotation.x,\n            //    scaledPosition.y * u_rotation.y - scaledPosition.x * u_rotation.x\n            //);\n            \n            //vec2 position = rotatedPosition + u_translation;\n            vec2 position = (matrix * vec3(a_position, 1)).xy;\n\n            //convert position from pixels to 0.0 to 1.0\n            vec2 zeroToOne = position / u_resolution;\n\n            //convert from 0->1 to 0->2\n            vec2 zeroToTwo = zeroToOne * 2.0;\n\n            //convert from 0->2 to -1->+1\n            vec2 clipSpace = zeroToTwo - 1.0;\n\n            gl_Position = vec4(clipSpace * vec2(1, -1), 0, 1);\n            \n            v_texCoord = a_texCoord;\n        }\n        ",this.#q="\n        precision mediump float;\n\n        uniform sampler2D u_image;\n\n        //texCoords passed in from the vertex shader\n        varying vec2 v_texCoord;\n\n        void main() {\n            vec4 color = texture2D(u_image, v_texCoord);\n            gl_FragColor = color;\n        }\n        ";const e=this.#ne(),t=c.WEBGL.DRAW_PROGRAMS.IMAGES;this.#oe(t,e);const i=this.#ee,s=i.getUniformLocation(e,"u_translation"),r=i.getUniformLocation(e,"u_rotation"),n=i.getUniformLocation(e,"u_scale"),o=i.getUniformLocation(e,"u_resolution"),a=i.getAttribLocation(e,"a_position"),h=i.getAttribLocation(e,"a_texCoord"),l=i.getUniformLocation(e,"u_image");return i.enable(i.BLEND),this.#$.set(t,{translationLocation:s,rotationRotation:r,scaleLocation:n,resolutionUniformLocation:o,positionAttributeLocation:a,texCoordLocation:h,u_imageLocation:l}),Promise.resolve()}_initPrimitivesDrawProgram(){this.#H="\n        precision mediump float;\n\n        attribute vec2 a_position;\n\n        uniform vec2 u_translation;\n        uniform float u_rotation;\n        uniform vec2 u_scale;\n\n        uniform vec2 u_resolution;\n\n        void main(void) {\n            float c = cos(-u_rotation);\n            float s = sin(-u_rotation);\n\n            mat3 translationMatrix1 = mat3(\n                1, 0, 0,\n                0, 1, 0,\n                u_translation.x, u_translation.y, 1\n            );\n\n            //mat3 translationMatrix2 = mat3(\n            //    1, 0, 0,\n            //    0, 1, 0,\n            //    -u_translation.x, -u_translation.y, 1\n            //);\n            \n            mat3 rotationMatrix = mat3(\n                c, -s, 0,\n                s, c, 0,\n                0, 0, 1\n            );\n\n            mat3 scalingMatrix = mat3(\n                u_scale.x, 0, 0,\n                0, u_scale.y, 0,\n                0, 0, 1\n            );\n\n            //mat3 matrix = translationMatrix1 * rotationMatrix * translationMatrix2 * scalingMatrix;\n\n            mat3 matrix = translationMatrix1 * rotationMatrix * scalingMatrix;\n\n            //Scale\n            // vec2 scaledPosition = a_position * u_scale;\n            // Rotate the position\n            // vec2 rotatedPosition = vec2(\n            //    scaledPosition.x * u_rotation.y + scaledPosition.y * u_rotation.x,\n            //    scaledPosition.y * u_rotation.y - scaledPosition.x * u_rotation.x\n            //);\n            \n            //vec2 position = rotatedPosition + u_translation;\n            vec2 position = (matrix * vec3(a_position, 1)).xy;\n\n            //convert position from pixels to 0.0 to 1.0\n            vec2 zeroToOne = position / u_resolution;\n\n            //convert from 0->1 to 0->2\n            vec2 zeroToTwo = zeroToOne * 2.0;\n\n            //convert from 0->2 to -1->+1\n            vec2 clipSpace = zeroToTwo - 1.0;\n\n            gl_Position = vec4(clipSpace * vec2(1, -1), 0, 1);\n        }\n        ",this.#q="\n        precision mediump float;\n\n        uniform vec4 u_color;\n        uniform float u_fade_min; \n        uniform float u_fade_max;\n        uniform vec2 a_position;\n        uniform vec2 u_resolution;\n        uniform vec2 u_translation;\n        \n        void main(void) {\n            vec4 p = u_color;\n            if (u_fade_min > 0.0) {\n                vec2 fix_tr = vec2(u_translation.x, u_resolution.y - u_translation.y); \n                float distance = distance(fix_tr.xy, gl_FragCoord.xy);\n                if (u_fade_min <= distance && distance <= u_fade_max) {\n                    float percent = ((distance - u_fade_max) / (u_fade_min - u_fade_max)) * 100.0;\n                    p.a = u_color.a * (percent / 100.0);\n                }\n            }\n\n            gl_FragColor = p;\n        }\n        ";const e=this.#ne(),t=c.WEBGL.DRAW_PROGRAMS.PRIMITIVES;this.#oe(t,e);const i=this.#ee,s=i.getUniformLocation(e,"u_translation"),r=i.getUniformLocation(e,"u_rotation"),n=i.getUniformLocation(e,"u_scale"),o=i.getUniformLocation(e,"u_resolution"),a=i.getUniformLocation(e,"u_color"),h=i.getAttribLocation(e,"a_position"),l=i.getUniformLocation(e,"u_fade_min"),d=i.getUniformLocation(e,"u_fade_max");return this.#$.set(t,{translationLocation:s,rotationRotation:r,scaleLocation:n,resolutionUniformLocation:o,colorUniformLocation:a,positionAttributeLocation:h,fadeMinLocation:l,fadeMaxLocation:d}),Promise.resolve()}_bindTileImages(e,t,i,s,r=["SRC_ALPHA","ONE_MINUS_SRC_ALPHA"],n=0,o=[0,0],a=[1,1]){return new Promise((h=>{const l=c.WEBGL.DRAW_PROGRAMS.IMAGES,d=this.#J.filter((e=>e.programName===l));let u=!1;for(let i=0;i<d.length;i++){const n=d[i];n.isProgramDataCanBeMerged(s,r)&&(n.mergeProgramData(e,t),u=!0)}u||this.#J.push(new se(l,e,t,i,s,r,n,o,a)),h()}))}_executeTileImagesDraw(){return new Promise((e=>{const t=c.WEBGL.DRAW_PROGRAMS.IMAGES,i=this.#ae(t),{translationLocation:s,rotationRotation:r,scaleLocation:n,resolutionUniformLocation:o,positionAttributeLocation:a,texCoordLocation:h,u_imageLocation:l}=this.#$.get(t),d=this.#ee,u=this.#J.filter((e=>e.programName===t));d.useProgram(i);for(let e=0;e<u.length;e++){const t=u[e];d.uniform2f(o,d.canvas.width,d.canvas.height),d.uniform2f(s,t.translation[0],t.translation[1]),d.uniform2f(n,t.scale[0],t.scale[1]),d.uniform1f(r,t.rotation),d.bindBuffer(d.ARRAY_BUFFER,this.#se),d.bufferData(d.ARRAY_BUFFER,new Float32Array(t.vectors),d.STATIC_DRAW),d.enableVertexAttribArray(a);const i=2,c=d.FLOAT,g=!1,m=0,E=0;d.vertexAttribPointer(a,i,c,g,m,E),d.bindBuffer(d.ARRAY_BUFFER,this.#re),d.bufferData(d.ARRAY_BUFFER,new Float32Array(t.textures),d.STATIC_DRAW),d.enableVertexAttribArray(h),d.vertexAttribPointer(h,2,d.FLOAT,!1,0,E);let f=this.#ie.get(t.imageName);f?d.activeTexture(d["TEXTURE"+f]):(f=this.#ie.size+1,d.activeTexture(d["TEXTURE"+f]),d.bindTexture(d.TEXTURE_2D,d.createTexture()),d.texImage2D(d.TEXTURE_2D,0,d.RGBA,d.RGBA,d.UNSIGNED_BYTE,t.image),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_WRAP_S,d.CLAMP_TO_EDGE),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_WRAP_T,d.CLAMP_TO_EDGE),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_MIN_FILTER,d.NEAREST),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_MAG_FILTER,d.NEAREST),this.#ie.set(t.imageName,f)),d.uniform1i(l,f),d.blendFunc(d[t.drawMask[0]],d[t.drawMask[1]]),this.#Z=t.programVerticesNum,this.#ce()}e()}))}_bindAndDrawTileImages(e,t,i,s,r=0,n=[0,0],o=[1,1]){const a=c.WEBGL.DRAW_PROGRAMS.IMAGES,h=this.#ae(a),{translationLocation:l,rotationRotation:d,scaleLocation:u,resolutionUniformLocation:g,positionAttributeLocation:m,texCoordLocation:E,u_imageLocation:f}=this.#$.get(a),_=this.#ee;_.useProgram(h),_.uniform2f(g,_.canvas.width,_.canvas.height),_.uniform2f(l,n[0],n[1]),_.uniform2f(u,o[0],o[1]),_.uniform1f(d,r),_.bindBuffer(_.ARRAY_BUFFER,this.#se),_.bufferData(_.ARRAY_BUFFER,new Float32Array(e),_.STATIC_DRAW),this.#Z+=e.length/2,_.enableVertexAttribArray(m);const p=_.FLOAT;_.vertexAttribPointer(m,2,p,!1,0,0),_.bindBuffer(_.ARRAY_BUFFER,this.#re),_.bufferData(_.ARRAY_BUFFER,new Float32Array(t),_.STATIC_DRAW),_.enableVertexAttribArray(E),_.vertexAttribPointer(E,2,_.FLOAT,!1,0,0);let T=this.#ie.get(s);T?_.activeTexture(_["TEXTURE"+T]):(T=this.#ie.size+1,_.activeTexture(_["TEXTURE"+T]),_.bindTexture(_.TEXTURE_2D,_.createTexture()),_.texImage2D(_.TEXTURE_2D,0,_.RGBA,_.RGBA,_.UNSIGNED_BYTE,i),_.texParameteri(_.TEXTURE_2D,_.TEXTURE_WRAP_S,_.CLAMP_TO_EDGE),_.texParameteri(_.TEXTURE_2D,_.TEXTURE_WRAP_T,_.CLAMP_TO_EDGE),_.texParameteri(_.TEXTURE_2D,_.TEXTURE_MIN_FILTER,_.NEAREST),_.texParameteri(_.TEXTURE_2D,_.TEXTURE_MAG_FILTER,_.NEAREST),this.#ie.set(s,T)),_.uniform1i(f,T),_.blendFunc(_.SRC_ALPHA,_.ONE_MINUS_SRC_ALPHA),this.#ce()}_bindText(e,t,i){const s=c.WEBGL.DRAW_PROGRAMS.IMAGES,r=this.#ae(s),{translationLocation:n,rotationRotation:o,scaleLocation:a,resolutionUniformLocation:h,positionAttributeLocation:l,texCoordLocation:d,u_imageLocation:u}=this.#$.get(s),g=this.#ee,{boxWidth:m,boxHeight:E,ctx:f}=this.#he(i),_=f.canvas,p=i.text,T=[0,0],v=[1,1],A=(t-=E,e+m),R=t+E,S=[e,t,A,t,e,R,e,R,A,t,A,R];g.useProgram(r),g.uniform2f(h,g.canvas.width,g.canvas.height),g.uniform2f(n,T[0],T[1]),g.uniform2f(a,v[0],v[1]),g.uniform1f(o,0),g.bindBuffer(g.ARRAY_BUFFER,this.#se),g.bufferData(g.ARRAY_BUFFER,new Float32Array(S),g.STATIC_DRAW),g.enableVertexAttribArray(l);const y=g.FLOAT;g.vertexAttribPointer(l,2,y,!1,0,0),g.bindBuffer(g.ARRAY_BUFFER,this.#re),g.bufferData(g.ARRAY_BUFFER,new Float32Array([0,0,1,0,0,1,0,1,1,0,1,1]),g.STATIC_DRAW),g.enableVertexAttribArray(d),g.vertexAttribPointer(d,2,g.FLOAT,!1,0,0),this.#Z+=6,g.blendFunc(g.ONE,g.ONE_MINUS_SRC_ALPHA);let P=this.#ie.get(p);P?g.activeTexture(g["TEXTURE"+P]):(P=this.#ie.size+1,g.activeTexture(g["TEXTURE"+P]),g.bindTexture(g.TEXTURE_2D,g.createTexture()),g.texImage2D(g.TEXTURE_2D,0,g.RGBA,g.RGBA,g.UNSIGNED_BYTE,_),g.texParameteri(g.TEXTURE_2D,g.TEXTURE_WRAP_S,g.CLAMP_TO_EDGE),g.texParameteri(g.TEXTURE_2D,g.TEXTURE_WRAP_T,g.CLAMP_TO_EDGE),g.texParameteri(g.TEXTURE_2D,g.TEXTURE_MIN_FILTER,g.LINEAR)),g.uniform1i(u,P),this.#ce()}_bindPrimitives(e,t=0,i=[0,0],s=[1,1]){const r=c.WEBGL.DRAW_PROGRAMS.PRIMITIVES,n=this.#ae(r),{translationLocation:o,rotationRotation:a,scaleLocation:h,resolutionUniformLocation:l,colorUniformLocation:d,positionAttributeLocation:u,fadeMinLocation:g}=this.#$.get(r),m=this.#ee;switch(m.useProgram(n),m.uniform2f(l,m.canvas.width,m.canvas.height),m.uniform2f(o,i[0],i[1]),m.uniform2f(h,s[0],s[1]),m.uniform1f(a,t),m.uniform1f(g,0),m.enableVertexAttribArray(u),m.bindBuffer(m.ARRAY_BUFFER,this.#se),e.type){case c.DRAW_TYPE.RECTANGLE:this.#le(e.width,e.height),this.#Z+=6;break;case c.DRAW_TYPE.TEXT:break;case c.DRAW_TYPE.CIRCLE:{const t=e.vertices;m.bufferData(this.#ee.ARRAY_BUFFER,new Float32Array(t),this.#ee.STATIC_DRAW),this.#Z+=t.length/2;break}case c.DRAW_TYPE.POLYGON:{const t=this.#de(e.vertices);this.#ue(t);const i=t.length;if(i%3!=0)return void y(R,`polygons ${e.id}, vertices are not correct, skip drawing`);this.#Z+=i/2;break}}const E=m.FLOAT;m.vertexAttribPointer(u,2,E,!1,0,0);const f=this.#ge(e.bgColor);m.uniform4f(d,f[0]/255,f[1]/255,f[2]/255,f[3]),e.blendFunc&&m.blendFunc(e.blendFunc[0],e.blendFunc[1]),e.cut&&m.blendEquation(m.FUNC_SUBTRACT),this.#ce(0,null,!0)}_drawLines(e,t,i=1,s=0,r=[0,0]){const n=c.WEBGL.DRAW_PROGRAMS.PRIMITIVES,o=this.#ae(n),{resolutionUniformLocation:a,colorUniformLocation:h,positionAttributeLocation:l,translationLocation:d,rotationRotation:u,scaleLocation:g,fadeMinLocation:m}=this.#$.get(n),E=this.#ee;E.useProgram(o),E.uniform2f(a,E.canvas.width,E.canvas.height),E.uniform2f(d,r[0],r[1]),E.uniform2f(g,1,1),E.uniform1f(u,s),E.uniform1f(m,0),E.enableVertexAttribArray(l),E.bindBuffer(E.ARRAY_BUFFER,this.#se),this.#ee.bufferData(this.#ee.ARRAY_BUFFER,new Float32Array(e),this.#ee.STATIC_DRAW),this.#Z+=e.length/2;const f=E.FLOAT;E.vertexAttribPointer(l,2,f,!1,0,0);const _=this.#ge(t);E.uniform4f(h,_[0]/255,_[1]/255,_[2]/255,_[3]),E.lineWidth(i),this.#ce(0,E.LINES)}_drawPolygon(e,t,i=1,s=0,r=[0,0]){const n=c.WEBGL.DRAW_PROGRAMS.PRIMITIVES,o=this.#ae(n),{resolutionUniformLocation:a,colorUniformLocation:h,positionAttributeLocation:l,translationLocation:d,rotationRotation:u,scaleLocation:g,fadeMinLocation:m}=this.#$.get(n),E=this.#ee;E.useProgram(o),E.uniform2f(a,E.canvas.width,E.canvas.height),E.uniform2f(d,r[0],r[1]),E.uniform2f(g,1,1),E.uniform1f(u,s),E.uniform1f(m,0),E.enableVertexAttribArray(l),E.bindBuffer(E.ARRAY_BUFFER,this.#se);const f=this.#de(e),_=f.length;if(_%3!=0)return void y(R,"polygon boundaries vertices are not correct, skip drawing");this.#ue(f),this.#Z+=_/2;const p=E.FLOAT;E.vertexAttribPointer(l,2,p,!1,0,0);const T=this.#ge(t);E.uniform4f(h,T[0]/255,T[1]/255,T[2]/255,T[3]),this.#ce(0,null)}_bindConus(e,t=0,i=[0,0],s=[1,1]){const r=c.WEBGL.DRAW_PROGRAMS.PRIMITIVES,n=this.#ae(r),{translationLocation:o,rotationRotation:a,scaleLocation:h,resolutionUniformLocation:l,colorUniformLocation:d,positionAttributeLocation:u,fadeMinLocation:g,fadeMaxLocation:m}=this.#$.get(r),E=this.#ee,f=e.vertices,_=e.bgColor,p=e.fade_min,T=e.radius;E.useProgram(n),E.uniform2f(l,E.canvas.width,E.canvas.height),E.uniform2f(o,i[0],i[1]),E.uniform2f(h,s[0],s[1]),E.uniform1f(a,t),E.uniform1f(g,p),E.uniform1f(m,T),E.bindBuffer(E.ARRAY_BUFFER,this.#se),E.bufferData(this.#ee.ARRAY_BUFFER,new Float32Array(f),this.#ee.STATIC_DRAW),E.enableVertexAttribArray(u);const v=E.FLOAT;E.vertexAttribPointer(u,2,v,!1,0,0),this.#Z+=f.length/2,e.blendFunc&&E.blendFunc(e.blendFunc[0],e.blendFunc[1]),e.cut&&E.blendEquation(E.FUNC_SUBTRACT);const A=this.#ge(_);E.uniform4f(d,A[0]/255,A[1]/255,A[2]/255,A[3]),this.#ce(0,E.TRIANGLE_FAN,!0)}_clearView(){const e=this.#ee;this.#J=[],e.clearColor(0,0,0,0),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT)}#oe(e,t){this.#Q.set(e,t)}#ae(e){return this.#Q.get(e)}#ue(e){this.#ee.bufferData(this.#ee.ARRAY_BUFFER,new Float32Array(e),this.#ee.STATIC_DRAW)}#le(e,t){const i=0+e,s=0+t;this.#ee.bufferData(this.#ee.ARRAY_BUFFER,new Float32Array([0,0,i,0,0,s,0,s,i,0,i,s]),this.#ee.STATIC_DRAW)}#ce(e=0,t,i){const s=t||this.#ee.TRIANGLES,r=this.#ee,n=this.#te?r.getError():0;if(0!==n)throw console.error(n),new Error("Error num: "+n);r.drawArrays(s,e,this.#Z),this.#Z=0,i&&r.blendEquation(r.FUNC_ADD)}#ne(){const e=this.#ee,t=e.createProgram();if(t){const i=this.#me(this.#H,e.VERTEX_SHADER);i?e.attachShader(t,i):S(E,"#compileShader(vertexShaderSource) is null");const s=this.#me(this.#q,e.FRAGMENT_SHADER);if(s?e.attachShader(t,s):S(E,"#compileShader(fragmentShaderSource) is null"),e.linkProgram(t),!e.getProgramParameter(t,e.LINK_STATUS)){const i=e.getProgramInfoLog(t);S(E,`Could not compile WebGL program. \n\n${i}`)}}else S(E,"gl.createProgram() is null");return t}#he(e){const t=document.createElement("canvas").getContext("2d");if(t){t.font=e.font,e._textMetrics=t.measureText(e.text);const i=e.boundariesBox.width,s=e.boundariesBox.height;return t.canvas.width=i,t.canvas.height=s,t.font=e.font,t.textBaseline="bottom",e.fillStyle&&(t.fillStyle=e.fillStyle,t.fillText(e.text,0,s)),e.strokeStyle&&(t.strokeStyle=e.strokeStyle,t.strokeText(e.text,0,s)),{boxWidth:i,boxHeight:s,ctx:t}}S(E,"can't getContext('2d')")}#me(e,t){const i=this.#ee.createShader(t);if(i){if(this.#ee.shaderSource(i,e),this.#ee.compileShader(i),!this.#ee.getShaderParameter(i,this.#ee.COMPILE_STATUS)){const e=this.#ee.getShaderInfoLog(i);S(E,"Couldn't compile webGl program. \n\n"+e)}}else S(E,`gl.createShader(${t}) is null`);return i}#ge(e){return e.replace("rgba(","").replace(")","").split(",").map((e=>Number(e.trim())))}#de(e){return this.#Ee(e)}#Ee(e,t=[]){const i=e.length;if(i<=3)return e.forEach((e=>{t.push(e[0]),t.push(e[1])})),t;const s=[...e].sort(((e,t)=>t[1]-e[1])),r=e.indexOf(s[0]),n=r!==i-1?r+1:0;let o=e,a=o.length,c=0,h=n;for(;o.length>2;){const e=o.length;h>=e&&(h-=e);const i=0===h?o[e-1]:o[h-1],s=o[h],r=e===h+1?o[0]:o[h+1];l=i,d=s,X({x:(u=r)[0]-l[0],y:u[1]-l[1]},{x:d[0]-l[0],y:d[1]-l[1]})<0?(t.push(i[0]),t.push(i[1]),t.push(s[0]),t.push(s[1]),t.push(r[0]),t.push(r[1]),o=o.filter(((e,t)=>t!==h))):(c+=1,c>a&&S("DRAW_PREPARE_ERROR","Can't extract triangles. Probably vertices input is not correct, or the order is wrong")),h++}var l,d,u;return t}}class ne{#fe;#_e;#pe;#Te;#ve;constructor(e,t,i=!1,s,r=!1){this.#fe=e,this.#_e=t,this.#pe=s||0,this.#Te=r,this.#ve=i}get isActive(){return this.#Te}get currentSprite(){return this.#_e[this.#pe]}get isLastSprite(){return this.#_e.length-1===this.#pe}iterateSprite(){this.isLastSprite?this.#ve?this.#pe=0:this.#Te=!1:this.#pe=this.#pe+1}activateAnimation=()=>{this.#Te=!0,this.#pe=0};deactivateAnimation=()=>{this.#Te=!1}}class oe{#M;#B;#Ae;#Re;#Se;#ye;#Pe=0;#Y=0;#be=te();#xe=!1;constructor(e,t,i,s,r){this.#M=t,this.#B=i,this.#Ae=s,this.#Re=e,this.#Se=r}get bgColor(){return this.#Ae}set bgColor(e){this.#Ae=e}get type(){return this.#Re}get x(){return this.#M}get y(){return this.#B}set x(e){this.#M=e}set y(e){this.#B=e}get cut(){return this.#Se}get zIndex(){return this.#Pe}set zIndex(e){this.#Pe=e}get blendFunc(){return this.#ye}set blendFunc(e){this.#ye=e}get rotation(){return this.#Y}set rotation(e){this.#Y=e}get id(){return this.#be}get isRemoved(){return this.#xe}destroy(){this.#xe=!0}_calculateRectVertices=(e,t)=>{const i=e/2,s=t/2;return[[-i,-s],[i,-s],[i,s],[-i,s]]};_calculateConusVertices(e,t=2*Math.PI,i=Math.PI/14){let s=[0,0];for(let r=0;r<=t;r+=i){let t=Math.cos(r)*e,i=Math.sin(r)*e;s.push(t,i)}return s}_convertVerticesArray(e){return void 0!==e[0].x&&void 0!==e[0].y?ie(e):e}}class ae extends oe{#W;#R;#we;#Ce;#Le;#Ie;#Oe;constructor(e,t,i,s,r,n=0,o){super(c.DRAW_TYPE.IMAGE,e,t),this.#we=r,this.#Ce=new EventTarget,this.#Le=new Map,this.#Ie=n,this.#W=i,this.#R=s,this.#Oe=o?this._convertVerticesArray(o):this._calculateRectVertices(i,s)}get width(){return this.#W}get height(){return this.#R}set width(e){this.#W=e}set height(e){this.#R=e}get key(){return this.#we}get imageIndex(){return this.#Ie}set imageIndex(e){this.#Ie=e}get isAnimations(){return this.#Le.size>0}get boundaries(){return this.#Oe}get vertices(){return this.#Oe}_processActiveAnimations(){for(let e of this.#Le.values())e.isActive&&(e.iterateSprite(),this.#Ie=e.currentSprite)}emit(e,...t){const i=new Event(e);i.data=[...t],this.#Ce.dispatchEvent(i)}addEventListener(e,t,i){this.#Ce.addEventListener(e,t,i)}removeEventListener(e,t,i){this.#Ce.removeEventListener(e,t,i)}addAnimation(e,t,i){const s=new ne(e,t,i);this.#Le.set(e,s),this.addEventListener(e,this.#De)}#De=e=>{const t=this.#Le.get(e.type);t.activateAnimation(),this.#Ie=t.currentSprite};stopRepeatedAnimation(e){this.#Le.get(e).deactivateAnimation()}removeAllAnimations(){for(let[e,t]of this.#Le.entries())this.removeEventListener(e,t.activateAnimation),t.deactivateAnimation();this.#Le.clear(),this.#Le=void 0}destroy(){this.removeAllAnimations(),super.destroy()}}class ce extends oe{#Ne;#Oe;constructor(e,t,i,s,r){super(c.DRAW_TYPE.CIRCLE,e,t,s,r),this.#Ne=i,this.#Oe=this._calculateConusVertices(i)}get vertices(){return this.#Oe}set vertices(e){this.#Oe=e}get radius(){return this.#Ne}}class he extends oe{#Ne;#Me;#Oe;#Be;constructor(e,t,i,s,r,n,o=0){super(c.DRAW_TYPE.CONUS,e,t,s,n),this.#Ne=i,this.#Me=r,this.#Be=o,this.#Oe=this._calculateConusVertices(i,r)}get vertices(){return this.#Oe}set vertices(e){this.#Oe=e}get radius(){return this.#Ne}get angle(){return this.#Me}get fade_min(){return this.#Be}set fade_min(e){this.#Be=e}}class le extends oe{#Oe;constructor(e,t){super(c.DRAW_TYPE.LINE,e[0][0],e[0][1],t),this.#Oe=e}get vertices(){return this.#Oe}set vertices(e){this.#Oe=e}}class de extends oe{#Oe;constructor(e,t,i){super(c.DRAW_TYPE.POLYGON,e[0].x,e[0].y,t,i),this.#Oe=this._convertVerticesArray(e)}get vertices(){return this.#Oe}set vertices(e){this.#Oe=e}}class ue extends oe{#W;#R;#Oe;constructor(e,t,i,s,r,n){super(c.DRAW_TYPE.RECTANGLE,e,t,r,n),this.#W=i,this.#R=s,this.#Oe=this._calculateRectVertices(i,s)}get vertices(){return this.#Oe}get width(){return this.#W}get height(){return this.#R}set width(e){this.#W=e}set height(e){this.#R=e}}class ge extends oe{#We;#Ue;#Fe;#Ge;#ke;#je;#Ve;constructor(e,t,i,s,r){super(c.DRAW_TYPE.TEXT,e,t),this.#je=i,this.#We=s,this.#Ge=r,this.#Ve}get boundariesBox(){const e=this.textMetrics?this.textMetrics.width:300,t=this.textMetrics?this.textMetrics.actualBoundingBoxAscent+5:30;return new M(this.x,this.y-t,e,t)}get vertices(){const e=this.boundariesBox;return this._calculateRectVertices(e.width,e.height)}get text(){return this.#je}set text(e){this.#je=e}get font(){return this.#We}set font(e){this.#We=e}get textAlign(){return this.#Ue}set textAlign(e){this.#Ue=e}get textBaseline(){return this.#Fe}set textBaseline(e){this.#Fe=e}get fillStyle(){return this.#Ge}set fillStyle(e){this.#Ge=e}get strokeStyle(){return this.#ke}set strokeStyle(e){this.#ke=e}get textMetrics(){return this.#Ve}set _textMetrics(e){this.#Ve=e}}class me{#Ye;#ze;#Xe;#Ke;#He;#qe;#Qe;#Je;#$e;#Ze;#et;#tt;#it;constructor(e,t,i,s,r){this.#Ye=document.createElement("canvas"),this.#Ye.id=e,this.#Ye.style.position="absolute",this.#ze=!1,this.#Xe=r,this.#Je=i,this.#Qe=t,this.#$e=s,this.#Ze=[],this.#et=[],this.#tt=[],this.#it=[],this.bindRenderLayerMethod=this.systemSettings.gameOptions.optimization===c.OPTIMIZATION.WEB_ASSEMBLY.ASSEMBLY_SCRIPT?this._bindRenderLayerWM:this._bindRenderLayer}get screenPageData(){return this.#Je}get systemSettings(){return this.#Qe}get loader(){return this.#$e}get renderObjects(){return this.#Ze}get canvas(){return this.#Ye}getObjectsByInstance(e){return this.#Ze.filter((t=>t instanceof e))}get _renderLayers(){return this.#et}set _renderObject(e){this.#Ze.push(e)}set _renderObjects(e){this.#Ze=e}set _renderLayers(e){this.#et.push(e)}set _isCleared(e){this.#ze=e}get _isCleared(){return this.#ze}_createBoundariesPrecalculations(){const e=[];for(const t of this.#et)e.push(this.#st(t).catch((e=>{S(u,e)})));return e}_enableMapBoundaries(){this.#Ke=!0}_initiateWebGlContext(){const e=this.#Ye.getContext("webgl");if(e)return this.#He=e,this.#qe=new re(this.#He,this.#Qe.gameOptions.checkWebGlErrors),Promise.all([this.#qe._initiateImagesDrawProgram(),this.#qe._initPrimitivesDrawProgram()]);S(E,"webgl is not supported in this browser")}_clearWebGlContext(){this.#qe._clearView(),this.#ze=!0}_executeTileImagesDraw(){return this.#qe._executeTileImagesDraw()}_setCanvasSize(e,t){this.canvas.width=e,this.canvas.height=t,this.#qe&&this.#qe._fixCanvasSize(e,t)}_sortRenderObjectsByZIndex(){this.#Ze=this.#Ze.sort(((e,t)=>t.zIndex-e.zIndex))}_prepareBindRenderLayerPromises(){for(const e of this.#et)this.#tt.push(this.bindRenderLayerMethod(e).catch((e=>{S(u,e)})))}_executeBindRenderLayerPromises(){return Promise.allSettled(this.#tt).then((e=>(this.#rt(),Promise.resolve(e))))}_bindRenderLayerWM(e){return new Promise(((t,i)=>{const s=this.loader.getTileMap(e.tileMapKey),r=s.tilesets,n=r.map((e=>this.#nt(e.data.name))),o=s.layers.find((t=>t.name===e.layerKey)),{tileheight:a,tilewidth:c}=s;o||(y(f,"check tilemap and layers name"),i());for(let e=0;e<=r.length-1;e++){const i=r[e].data,s=(i.tilewidth,i.tileheight,i.imagewidth,o.width,o.height,n[e]);s.width,s.height,this.#ot(verticesBufferData,texturesBufferData,s,i.name),t()}}))}_bindRenderLayer(e){return new Promise(((t,i)=>{const s=this.loader.getTileMap(e.tileMapKey),r=s.tilesets,n=r.map((e=>this.#nt(e.data.name))),o=s.layers.find((t=>t.name===e.layerKey)),{tileheight:a,tilewidth:c}=s,h=c,l=a,[d,u]=this.screenPageData.worldDimensions,[g,m]=this.screenPageData.canvasDimensions,[E,_]=!0===this.#Xe?[0,0]:this.screenPageData.worldOffset,p=this.systemSettings.gameOptions.render.boundaries.realtimeCalculations,v=e.setBoundaries&&p;let A=new Map,R=[];o||(y(f,"check tilemap and layers name"),i());for(let e=0;e<r.length;e++){const t=r[e].data,i=r[e].firstgid,s=r[e+1],f=s?s.firstgid:null,p=t.tilewidth,S=t.tileheight,P=n[e],b=t.imagewidth,x=t.imageheight,w=Math.floor(b/p),C=o.width,L=o.height,I=h*C,O=l*L,D=_%l,N=E%h,M=0!==_?Math.floor(_/l):0,B=0!==E?Math.floor(E/h):0,W=O>m?Math.ceil(m/l)+1:L,U=I>g?Math.ceil(g/h)+1:C,F=C-U-B,G=[],k=[];v&&(I===d&&O===u||(y(T," World size from tilemap is different than settings one, fixing..."),this.screenPageData._setWorldDimensions(I,O)),this.#Ke&&this.screenPageData._setMapBoundaries());let j=M*C;for(let e=0;e<W;e++){j+=B;let t=new Map;for(let s=0;s<U;s++){let r=o.data[j];if(r>=i&&(null===f||r<f)){const n=s*c-N,o=e*a-D;r-=i;const h=n,l=o,d=n+p,u=o+S,g=1/b*(r%w*p),m=1/x*(Math.floor(r/w)*S),E=g+1/b*p,f=m+1/x*S;if(G.push(h,l,d,l,h,u,h,u,d,l,d,u),k.push(g,m,E,m,g,f,g,f,E,m,E,f),v){let i=[n+p,o,n+p,o+S],r=[n+p,o+S,n,o+S],a=[n,o,n+p,o],c=[n,o+S,n,o],h=[null,null,null,null];const l=0!==e?A.get(e-1):void 0;if(l){const e=l.get(s);if(e){const t=e[2],s=R[t];if(s){const e=s[0],i=s[1],r=s[2],n=s[3],o=a[0],c=a[1],h=a[2],l=a[3];o===r&&c===n&&h===e&&l===i&&(R[t]=void 0,a=void 0)}const r=e[1],n=R[r];if(n){const e=n[0],t=n[1],s=n[2],o=i[0];e===i[2]&&s===o&&(R[r]=void 0,i[0]=e,i[1]=t)}const o=e[3],h=R[o];if(h){const e=h[0],t=h[2],i=h[3],s=c[0];e===c[2]&&t===s&&(R[o]=void 0,c[2]=t,c[3]=i)}}}const d=0!==s?t.get(s-1):void 0;if(d){const e=d[1],t=R[e],i=t[0],s=t[1],n=t[2],o=t[3],h=c[0],l=c[1],u=c[2],g=c[3];h===n&&l===o&&u===i&&g===s&&(R[e]=void 0,c=void 0);const m=d[0],E=R[m];if(E&&a){const e=E[0],t=E[1],i=E[3],s=a[1];t===a[3]&&i===s&&(R[m]=void 0,a[0]=e,a[1]=t)}const f=d[2],_=R[f];if(_){const e=_[1],t=_[2],i=_[3],s=r[1];e===r[3]&&i===s&&(R[f]=void 0,r[2]=t,r[3]=i)}}a&&(R.push(a),h[0]=R.length-1),R.push(i),h[1]=R.length-1,R.push(r),h[2]=R.length-1,c&&(R.push(c),h[3]=R.length-1),t.set(s,h)}}j++}t.size>0&&A.set(e,t),j+=F}G.length>0&&k.length>0&&this.#ot(G,k,P,t.name)}if(v){const e=R.filter((e=>e));this.screenPageData._addBoundariesArray(e)}t()}))}_prepareBindRenderObjectPromises(){for(let e=0;e<this.#Ze.length;e++){const t=this.#Ze[e];t.isRemoved&&(this.#Ze.splice(e,1),e--);const i=this.#at(t).catch((e=>(y(p,e),Promise.reject(e))));this.#it.push(i)}}_prepareBindBoundariesPromise(){this.#it.push(this.#ct().catch((e=>{S(u,e)})))}_executeBindRenderObjectPromises(){return Promise.allSettled(this.#it).then((e=>(this.#ht(),Promise.resolve(e))))}_postRenderActions(){const e=this.getObjectsByInstance(ae);for(let t=0;t<e.length;t++){const i=e[t];i.isAnimations&&i._processActiveAnimations()}}#nt(e){return this.loader.getImage(e)}#ot(e,t,i,s,r,n,o){this.#qe._bindTileImages(e,t,i,s,r,n,o)}#rt(){this.#tt=[]}#st(e){return new Promise(((t,i)=>{if(e.setBoundaries){const s=this.loader.getTileMap(e.tileMapKey),r=s.tilesets,n=s.layers.find((t=>t.name===e.layerKey)),{tileheight:o,tilewidth:a}=s,c=a,h=o,[l,d]=this.screenPageData.worldDimensions;let u=[];n||(y(f,"check tilemap and layers name"),i());for(let e=0;e<r.length;e++){const e=n.width,t=n.height,i=c*e,s=h*t;i===l&&s===d||(y(T," World size from tilemap is different than settings one, fixing..."),this.screenPageData._setWorldDimensions(i,s)),this.#Ke&&this.screenPageData._setWholeWorldMapBoundaries();let r=0;for(let i=0;i<t;i++)for(let t=0;t<e;t++){let e=n.data[r],s=t*c,o=i*h;0!==e&&(e-=1,u.push([s,o,s+c,o]),u.push([s+c,o,s+c,o+h]),u.push([s+c,o+h,s,o+h]),u.push([s,o+h,s,o])),r++}}this.screenPageData._setWholeMapBoundaries(u),this.screenPageData._mergeBoundaries(!0),console.warn("precalculated boundaries set"),console.log(this.screenPageData.getWholeWorldBoundaries()),t()}else t()}))}#at(e){return new Promise((t=>{const[i,s]=!0===this.#Xe?[0,0]:this.screenPageData.worldOffset,r=e.x-i,n=e.y-s;if(e.type===c.DRAW_TYPE.IMAGE){const t=this.#nt(e.key),i=e.imageIndex;let s=0,o=0;if(0!==i){const r=t.width/e.width;s=i%r*e.width,o=Math.floor(i/r)*e.height}const a=r-e.width/2,c=n-e.height/2,h=a+e.width,l=c+e.height,d=1/t.width*s,u=1/t.height*o,g=d+1/t.width*e.width,m=u+1/t.height*e.height,E=[a,c,h,c,a,l,a,l,h,c,h,l],f=[d,u,g,u,d,m,d,m,g,u,g,m];if(this.#qe._bindAndDrawTileImages(E,f,t,e.key,e.rotation,[r,n]),e.vertices&&this.systemSettings.gameOptions.boundaries.drawObjectBoundaries){const t=r,i=n,s=e.rotation?e.rotation:0;this.#qe._drawPolygon(e.vertices,this.systemSettings.gameOptions.boundaries.boundariesColor,this.systemSettings.gameOptions.boundaries.boundariesWidth,s,[t,i])}}else e.type===c.DRAW_TYPE.TEXT?this.#qe._bindText(r,n,e):e.type===c.DRAW_TYPE.CIRCLE||e.type===c.DRAW_TYPE.CONUS?this.#qe._bindConus(e,e.rotation,[r,n]):e.type===c.DRAW_TYPE.LINE?this.#qe._drawLines(e.vertices,e.bgColor,this.systemSettings.gameOptions.boundariesWidth,e.rotation,[r,n]):this.#qe._bindPrimitives(e,e.rotation,[r,n]);return t()}))}#ht(){this.#it=[]}#ct(){return new Promise((e=>{const t=this.screenPageData.getBoundaries(),i=t.length,s=[];for(let e=0;e<i;e++){const i=t[e];s.push(i[0],i[1]),s.push(i[2],i[3])}this.#qe._drawLines(s,this.systemSettings.gameOptions.boundaries.boundariesColor,this.systemSettings.gameOptions.boundaries.boundariesWidth),e()}))}}class Ee{rect(e,t,i,s,r,n){return new ue(e,t,i,s,r,n)}text(e,t,i,s,r){return new ge(e,t,i,s,r)}conus(e,t,i,s,r,n=!1,o=0){return new he(e,t,i,s,r,n,o)}circle(e,t,i,s,r){return new ce(e,t,i,s,r)}image(e,t,i,s,r,n=0,o){return new ae(e,t,i,s,r,n,o)}line(e,t){return new le(e,t)}polygon(e,t,i){return new de(e,t,i)}}class fe extends Event{#lt;constructor(e,t){super(e),this.#dt(e)||S("UNEXPECTED_EVENT_NAME",", Please check if event is exist"),this.#lt=t}#dt(e){return Object.values(c.EVENTS.WEBSOCKET.SERVER_CLIENT).find((t=>t===e))}get data(){return this.#lt}}class _e extends EventTarget{#Qe;#ut;constructor(e){super(),e||S(h,"systemSettings should be passed to class instance"),this.#Qe=e}init(){r.e(992).then(r.bind(r,992)).then((e=>{this.#ut=e.io(this.#Qe.network.address,{withCredentials:!0}),this.#gt()}))}get isServerConnected(){return!(!this.#ut||!this.#ut.connected)}get playerId(){return this.#ut.id}sendGatherRoomsInfo(){this.#ut.emit(c.EVENTS.WEBSOCKET.CLIENT_SERVER.ROOMS_INFO_REQUEST)}sendCreateOrJoinRoom(e,t){this.#ut.emit(c.EVENTS.WEBSOCKET.CLIENT_SERVER.CREATE_OR_JOIN,e,t)}sendMessage(e){this.#ut.emit(c.EVENTS.WEBSOCKET.CLIENT_SERVER.CLIENT_MESSAGE,e)}#mt=()=>{x.debug("connected, socket id: "+this.#ut.id),this.dispatchEvent(new Event(c.EVENTS.WEBSOCKET.SERVER_CLIENT.CONNECTION_STATUS_CHANGED))};#Et=e=>{x.debug("server disconnected, reason: "+e),this.dispatchEvent(new Event(c.EVENTS.WEBSOCKET.SERVER_CLIENT.CONNECTION_STATUS_CHANGED))};#ft=e=>{console.warn("server data: ",e)};#_t=e=>{x.debug("received new message from server: "+e),this.dispatchEvent(new fe(c.EVENTS.WEBSOCKET.SERVER_CLIENT.SERVER_MESSAGE,e))};#pt=e=>{x.debug("received roomsInfo "+e),this.dispatchEvent(new fe(c.EVENTS.WEBSOCKET.SERVER_CLIENT.ROOMS_INFO,e))};#Tt=(e,t)=>{x.debug("CLIENT SOCKET: Created room  "+e),this.dispatchEvent(new fe(c.EVENTS.WEBSOCKET.SERVER_CLIENT.CREATED,{room:e,map:t}))};#vt=e=>{x.debug("CLIENT SOCKET: Room is full, can't join: "+e),this.dispatchEvent(new fe(c.EVENTS.WEBSOCKET.SERVER_CLIENT.FULL,{room:e}))};#At=(e,t)=>{x.debug("CLIENT SOCKET: Joined to room: "+e,", map: ",t),this.dispatchEvent(new fe(c.EVENTS.WEBSOCKET.SERVER_CLIENT.JOINED,{room:e,map:t}))};#Rt=e=>{this.dispatchEvent(new fe(c.EVENTS.WEBSOCKET.SERVER_CLIENT.DISCONNECTED,{playerId:e}))};#gt(){this.#ut.on("connect",this.#mt),this.#ut.on("disconnect",this.#Et),this.#ut.on("data",this.#ft),this.#ut.on("roomsInfo",this.#pt),this.#ut.on("created",this.#Tt),this.#ut.on("full",this.#vt),this.#ut.on("joined",this.#At),this.#ut.on("log",(function(e){console.log.apply(console,e)})),this.#ut.on("message",this.#_t),this.#ut.on("removed",(function(e){console.log("removed message"),console.log(e)})),this.#ut.on("disconnected",this.#Rt),addEventListener("beforeunload",this.#St)}#St=()=>{this.#ut.disconnect()}}class pe{#yt=.5;#Pt=new Map;#$e;constructor(e){this.#$e=e}getAudio=e=>{const t=this.#Pt.get(e);return null===t?(y(A,"Audio with key "+e+" exists, but not actually loaded"),t):t||(y(v,""),null)};getAudioCloned=e=>{const t=this.#Pt.get(e);if(null===t)return y(A,"Audio with key "+e+" exists, but not actually loaded"),t;if(t){const e=t.cloneNode();return e.volume=this.#yt,e}return y(v),null};set volume(e){this.#yt=e,this.#bt(e)}get volume(){return this.#yt}#bt(e){for(const t of this.#Pt.values())t&&(t.volume=e)}registerAudio(e){let t=this.#$e.getAudio(e);this.#Pt.set(e,t)}}class Te{#Qe;#xt;#wt;#Ct;#Lt;#$e;constructor(e,t,i){e||S(h,"systemSettings should be passed to class instance"),this.#Qe=e,this.#xt=t,this.#wt=i,this.#$e=new L,this.#Lt=new pe(this.loader),this.#Ct=new _e(e)}get network(){return this.#Ct}get systemSettings(){return this.#Qe}get audio(){return this.#Lt}get loader(){return this.#$e}startScreenPage=(e,t)=>{if(this.#wt.has(e)){const i=this.#wt.get(e);!1===i.isInitiated&&i._init(),i._attachViewsToContainer(this.#xt),i._start(t)}else S(l,"View "+e+" is not registered!")};stopScreenPage=e=>{this.#wt.has(e)?this.#wt.get(e)._stop():S(l,"View "+e+" is not registered!")}}class ve{#It;#Ot=!1;#Te;#Dt;#Nt;#Je;#Mt=new Ee;#Bt;#Wt;#Ce=new EventTarget;#Ut=!1;#Ft;constructor(){this.#Te=!1,this.#Nt=new Map,this.#Je=new P,this.#Bt=[]}emit=(e,...t)=>{const i=new Event(e);i.data=[...t],this.#Ce.dispatchEvent(i)};addEventListener=(e,t,i)=>{this.#Ce.addEventListener(e,t,i)};removeEventListener=(e,t,i)=>{this.#Ce.removeEventListener(e,t,i)};_register(e,t){this.#It=e,this.#Dt=t,this.#Ut=this.systemSettings.gameOptions.render.boundaries.wholeWorldPrecalculations,this.#Ft=this.systemSettings.gameOptions.render.minCircleTime,this.#Gt(),this.#kt(),this.register()}_init(){this.init(),this.#Ot=!0}register(){}init(){}start(e){}stop(){}resize(){}get loader(){return this.#Dt.loader}get draw(){return this.#Mt}createCanvasView=(e,t=!1)=>{if(e&&e.trim().length>0){const i=new me(e,this.#Dt.systemSettings,this.#Je,this.loader,t);this.#Nt.set(e,i)}else S(d)};_attachViewsToContainer(e){for(const t of this.#Nt.values())this.#jt(t.canvas,e)}addRenderObject=(e,t)=>{if(e)if(this.#Nt.has(e)){const i=this.#Nt.get(e);i._renderObject=t,i._sortRenderObjectsByZIndex()}else S(m,", should create canvas view, with "+e+" key first");else S(g,", should pass canvasKey as 3rd parameter")};addRenderLayer=(e,t,i,s)=>{if(e)if(this.#Nt.has(e)){const r=this.#Nt.get(e);r._renderLayers=new D(t,i,s),s&&this.systemSettings.gameOptions.render.boundaries.mapBoundariesEnabled&&r._enableMapBoundaries()}else S(m,", should create canvas view, with "+e+" key first");else S(g,", should pass canvasKey as 3rd parameter")};get isActive(){return this.#Te}get isInitiated(){return this.#Ot}get name(){return this.#It}isAllFilesLoaded=()=>0===this.loader.filesWaitingForUpload;get screenPageData(){return this.#Je}get systemSettings(){return this.#Dt.systemSettings}get audio(){return this.#Dt.audio}get system(){return this.#Dt}getView=e=>{if(this.#Nt.get(e))return this.#Nt.get(e);S(m,", cannot find canvas with key "+e)};_start(e){this.#Te=!0,window.addEventListener("resize",this._resize),this._resize(),this.#Nt.size>0&&requestAnimationFrame(this.#Vt),this.emit(c.EVENTS.SYSTEM.START_PAGE),this.start(e)}_stop(){this.#Te=!1,window.removeEventListener("resize",this._resize),this.emit(c.EVENTS.SYSTEM.STOP_PAGE),this.#Yt(),clearInterval(this.#Wt),this.stop()}_resize=()=>{this.#kt(),this.resize()};#jt(e,t){t.appendChild(e)}#Yt(){for(const e of this.#Nt.values())document.getElementById(e.canvas.id).remove()}#Gt(){const e=this.systemSettings.worldSize?this.systemSettings.worldSize.width:0,t=this.systemSettings.worldSize?this.systemSettings.worldSize.height:0;this.screenPageData._setWorldDimensions(e,t)}#zt(e,t,i,s,r){const n=r.length;let o=[];for(let a=0;a<n;a++){const n=r[a];let h;switch(n.type){case c.DRAW_TYPE.TEXT:case c.DRAW_TYPE.RECTANGLE:case c.DRAW_TYPE.CONUS:case c.DRAW_TYPE.IMAGE:h=this.#Xt(e,t,i,s,n);break;case c.DRAW_TYPE.CIRCLE:console.warn("isObjectCollision.circle check is not implemented yet!");break;case c.DRAW_TYPE.LINE:console.warn("isObjectCollision.line check is not implemented, please use rect instead");break;default:console.warn("unknown object type!")}h&&o.push(h)}return o.length>0?this.#Kt(o):null}#Ht(e,t,i,s){const r=this.screenPageData.getBoundaries(),[n,o]=this.screenPageData.worldOffset,a=e-n,c=t-o,h=i.map((e=>this.#qt(e,a,c,s))),l=r.length;for(let e=0;e<l;e+=1){const t=r[e],i=J(h,{x1:t[0],y1:t[1],x2:t[2],y2:t[3]});if(i)return i}return!1}#Kt(e){return e.sort(((e,t)=>e.p<t.p))[0]}#Xt(e,t,i,s,r){const[n,o]=this.screenPageData.worldOffset,a=e-n,c=t-o,h=r.x-n,l=r.y-o,d=r.vertices,u=r.rotation,g=i.map((e=>this.#qt(e,a,c,s))),m=d.length;for(let e=0;e<m;e+=1){const t=d[e];let i=d[e+1];i||(i=d[0]);const s=this.#qt(t,h,l,u),r=this.#qt(i,h,l,u),n=J(g,{x1:s[0],y1:s[1],x2:r[0],y2:r[1]});if(n)return n}return!1}#qt(e,t,i,s){const r=new B(0,0,e[0],e[1]),n=j(0,0,e[0],e[1]),o=r.length;return[t+o*Math.cos(s+n),i+o*Math.sin(s+n)]}isBoundariesCollision=(e,t,i)=>{const s=i.type,r=i.vertices;switch(s){case c.DRAW_TYPE.TEXT:case c.DRAW_TYPE.RECTANGLE:case c.DRAW_TYPE.CONUS:case c.DRAW_TYPE.IMAGE:return this.#Ht(e,t,r,i.rotation);case c.DRAW_TYPE.CIRCLE:y(c.WARNING_CODES.METHOD_NOT_IMPLEMENTED,"isObjectCollision.circle check is not implemented yet!");break;case c.DRAW_TYPE.LINE:y(c.WARNING_CODES.METHOD_NOT_IMPLEMENTED,"isObjectCollision.line check is not implemented yet, please use .rect instead line!");break;default:y(c.WARNING_CODES.UNKNOWN_DRAW_OBJECT,"unknown object type!")}return!1};isObjectsCollision=(e,t,i,s)=>{const r=i.type,n=i.vertices;switch(r){case c.DRAW_TYPE.TEXT:case c.DRAW_TYPE.RECTANGLE:case c.DRAW_TYPE.CONUS:case c.DRAW_TYPE.IMAGE:return this.#zt(e,t,n,i.rotation,s);case c.DRAW_TYPE.CIRCLE:y(c.WARNING_CODES.METHOD_NOT_IMPLEMENTED,"isObjectCollision.circle check is not implemented yet!");break;case c.DRAW_TYPE.LINE:y(c.WARNING_CODES.METHOD_NOT_IMPLEMENTED,"isObjectCollision.line check is not implemented yet, please use .rect instead line!");break;default:y(c.WARNING_CODES.UNKNOWN_DRAW_OBJECT,"unknown object type!")}return!1};#Qt(e){const t=this.screenPageData.getBoundaries(),i=t.length,s=e.length;for(let r=0;r<s;r++){const n=e[r];for(let e=0;e<s;e++);for(let e=0;e<i;e+=1){const i=t[e],s={x1:i[0],y1:i[1],x2:i[2],y2:i[3]},r=s.boundaries;r?J(r,s)&&this.emit(c.EVENTS.GAME.BOUNDARIES_COLLISION,n):Q({x:n.x,y:n.y},s)&&(this.emit(c.EVENTS.GAME.BOUNDARIES_COLLISION,n),console.log("boundaries collision detected"))}}}#kt(){const e=this.systemSettings.canvasMaxSize.width&&this.systemSettings.canvasMaxSize.width<window.innerWidth?this.systemSettings.canvasMaxSize.width:window.innerWidth,t=this.systemSettings.canvasMaxSize.height&&this.systemSettings.canvasMaxSize.height<window.innerHeight?this.systemSettings.canvasMaxSize.height:window.innerHeight;this.screenPageData._setCanvasDimensions(e,t);for(const i of this.#Nt.values())i._setCanvasSize(e,t)}#Jt(){const e=this.systemSettings.gameOptions.render.averageFPStime,t=this.#Bt.length;let i=0;for(let e=0;e<t;e++)i+=this.#Bt[e];console.log("FPS average for ",e/1e3,"sec, is ",i/t),this.#Bt=[]}#Vt=async()=>{x.debug("_render "+this.name+" class"),this.#Te&&(this.systemSettings.gameOptions.library===c.LIBRARY.WEBGL&&(this.isAllFilesLoaded()?await this.#$t():(y("ASSETS_NOT_READY","Is page initialization phase missed?"),this.#Te=!1),setTimeout((()=>requestAnimationFrame(this.#Zt)))),this.#Wt=setInterval((()=>this.#Jt()),this.systemSettings.gameOptions.render.averageFPStime))};#$t(){return new Promise(((e,t)=>{let i=[];const s=this.#Ut;for(const e of this.#Nt.values())i.push(e._initiateWebGlContext()),s&&i.push(e._createBoundariesPrecalculations());Promise.allSettled(i).then((i=>{i.forEach((e=>{if("rejected"===e.status){const i=e.reason;y(p,i),t(i)}})),e()}))}))}#Zt=()=>{const e=performance.now(),t=this.#Ft;let i=[];this.emit(c.EVENTS.SYSTEM.RENDER.START),this.screenPageData._clearBoundaries();for(const[e,t]of this.#Nt.entries())i.push(this.#ei(e,t));Promise.allSettled(i).then((i=>{i.forEach((e=>{"rejected"===e.status&&y(p,e.reason)}));const s=performance.now()-e,r=t-s,n=r>0?r:0,o=1e3/(s+n);this.emit(c.EVENTS.SYSTEM.RENDER.END),this.#Bt.push(o),this.#Te&&setTimeout((()=>requestAnimationFrame(this.#Zt)),n)}))};#ei(e,t){return new Promise(((i,s)=>{t._isCleared||t._clearWebGlContext(),0!==t._renderLayers.length&&t._prepareBindRenderLayerPromises(),t._executeBindRenderLayerPromises().then((e=>(e.forEach((e=>{if("rejected"===e.status)return y(p,e.reason),this.#Te=!1,s(p+", reason: "+e.reason)})),t._executeTileImagesDraw()))).then((()=>(0!==t.renderObjects.length&&t._prepareBindRenderObjectPromises(),e===c.LAYERS.BOUNDARIES&&t._prepareBindBoundariesPromise(),t._executeBindRenderObjectPromises()))).then((e=>{e.forEach((e=>{"rejected"===e.status&&(y(p,e.reason),this.#Te=!1)})),t._postRenderActions(),t._isCleared=!1,i()}))}))}}class Ae extends ve{#ti=0;#ii=0;#si=0;register(){}init(){const[e,t]=this.screenPageData.canvasDimensions,i=e/3;this.createCanvasView(c.LAYERS.DEFAULT),this.text=this.draw.text(e/2-20,t/2-40,"JsGE","24px sans-serif","black"),this.background=this.draw.rect(0,0,e,t,this.systemSettings.gameOptions.loadingScreen.backgroundColor),this.loadingBarBg=this.draw.rect(e/2-i/2,t/2-10,i,20,this.systemSettings.gameOptions.loadingScreen.loadingBarBg),this.loadingBarProgress=this.draw.rect(e/2-i/2,t/2-10,i,20,this.systemSettings.gameOptions.loadingScreen.loadingBarProgress),this.#si=i,this.addRenderObject(c.LAYERS.DEFAULT,this.background),this.addRenderObject(c.LAYERS.DEFAULT,this.text),this.addRenderObject(c.LAYERS.DEFAULT,this.loadingBarBg),this.addRenderObject(c.LAYERS.DEFAULT,this.loadingBarProgress)}_progress=(e,t)=>{const[i,s]=this.screenPageData.canvasDimensions,r=this.#si/this.#ti;this.#ii=e,this.loadingBarProgress.width=r*this.#ii};start(e){this.#ti=e.total}get loader(){return{filesWaitingForUpload:0}}}const Re="loadingPage";class Se{#wt;#Dt;constructor(e,t){e||S(h,"systemSettings should be passed to class instance"),this.#wt=new Map,t||(t=document.createElement("div"),document.body.appendChild(t)),this.#Dt=new Te(e,t,this.#wt),this.registerPage(Re,Ae),this.#Dt.loader.addEventListener("loadstart",this.#ri),this.#Dt.loader.addEventListener("progress",this.#ni),this.#Dt.loader.addEventListener("load",this.#oi)}get system(){return this.#Dt}registerPage(e,t){if(e&&"string"==typeof e&&e.trim().length>0){const i=new t;i._register(e,this.system),this.#wt.set(e,i)}else S(h,"valid class name should be provided")}preloadAllData(){return this.#Dt.loader.preload()}#ri=e=>{this.#Dt.startScreenPage(Re,{total:e.total})};#ni=e=>{const t=e.loaded,i=e.total;this.#wt.get(Re)._progress(t,i)};#oi=()=>{this.#Dt.stopScreenPage(Re)}}var ye=n.oX,Pe=n.QD,be=n.xl,xe=n.r4,we=n.xP,Ce=n.jQ,Le=n.bq,Ie=n.P6;export{ye as CONST,Pe as DrawImageObject,be as Primitives,xe as ScreenPage,we as System,Ce as SystemAudioInterface,Le as SystemSettings,Ie as utils};