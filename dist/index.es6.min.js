var e,t,i={},s={};function r(e){var t=s[e];if(void 0!==t)return t.exports;var n=s[e]={exports:{}};return i[e](n,n.exports,r),n.exports}r.m=i,r.d=(e,t)=>{for(var i in t)r.o(t,i)&&!r.o(e,i)&&Object.defineProperty(e,i,{enumerable:!0,get:t[i]})},r.f={},r.e=e=>Promise.all(Object.keys(r.f).reduce(((t,i)=>(r.f[i](e,t),t)),[])),r.u=e=>e+".index.es6.min.js",r.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),e={},t="jsge:",r.l=(i,s,n,a)=>{if(e[i])e[i].push(s);else{var o,l;if(void 0!==n)for(var d=document.getElementsByTagName("script"),h=0;h<d.length;h++){var c=d[h];if(c.getAttribute("src")==i||c.getAttribute("data-webpack")==t+n){o=c;break}}o||(l=!0,(o=document.createElement("script")).type="module",o.charset="utf-8",o.timeout=120,r.nc&&o.setAttribute("nonce",r.nc),o.setAttribute("data-webpack",t+n),o.src=i),e[i]=[s];var u=(t,s)=>{o.onerror=o.onload=null,clearTimeout(g);var r=e[i];if(delete e[i],o.parentNode&&o.parentNode.removeChild(o),r&&r.forEach((e=>e(s))),t)return t(s)},g=setTimeout(u.bind(null,void 0,{type:"timeout",target:o}),12e4);o.onerror=u.bind(null,o.onerror),o.onload=u.bind(null,o.onload),l&&document.head.appendChild(o)}},r.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},(()=>{var e;if("string"==typeof import.meta.url&&(e=import.meta.url),!e)throw new Error("Automatic publicPath is not supported in this browser");e=e.replace(/#.*$/,"").replace(/\?.*$/,"").replace(/\/[^\/]+$/,"/"),r.p=e})(),(()=>{var e={179:0};r.f.j=(t,i)=>{var s=r.o(e,t)?e[t]:void 0;if(0!==s)if(s)i.push(s[2]);else{var n=new Promise(((i,r)=>s=e[t]=[i,r]));i.push(s[2]=n);var a=r.p+r.u(t),o=new Error;r.l(a,(i=>{if(r.o(e,t)&&(0!==(s=e[t])&&(e[t]=void 0),s)){var n=i&&("load"===i.type?"missing":i.type),a=i&&i.target&&i.target.src;o.message="Loading chunk "+t+" failed.\n("+n+": "+a+")",o.name="ChunkLoadError",o.type=n,o.request=a,s[1](o)}}),"chunk-"+t,t)}};var t=(t,i)=>{var s,n,[a,o,l]=i,d=0;if(a.some((t=>0!==e[t]))){for(s in o)r.o(o,s)&&(r.m[s]=o[s]);l&&l(r)}for(t&&t(i);d<a.length;d++)n=a[d],r.o(e,n)&&e[n]&&e[n][0](),e[n]=0},i=self.webpackChunkjsge=self.webpackChunkjsge||[];i.forEach(t.bind(null,0)),i.push=t.bind(null,i.push.bind(i))})();var n={};r.d(n,{oX:()=>l,QD:()=>S,T_:()=>Ge,uw:()=>J,xl:()=>a,xP:()=>je,bq:()=>z,P6:()=>o});var a={};r.r(a),r.d(a,{Rectangle:()=>O,Vector:()=>C,Vertex:()=>w});var o={};r.r(o),r.d(o,{angle_2points:()=>ie,angle_3points:()=>se,calculateEllipseVertices:()=>xe,calculateLinesVertices:()=>be,countClosestTraversal:()=>ee,countClosestTraversal2:()=>te,countDistance:()=>le,crossProduct:()=>ae,dotProduct:()=>ne,dotProductWithAngle:()=>re,generateUniqId:()=>Ae,isCircleLineIntersect:()=>_e,isEllipseCircleIntersect:()=>Te,isEllipseLineIntersect:()=>fe,isEllipsePolygonIntersect:()=>pe,isLineShorter:()=>de,isMobile:()=>Z,isPointCircleIntersect:()=>Ee,isPointInsidePolygon:()=>ge,isPointLineIntersect:()=>he,isPointOnTheLine:()=>oe,isPointPolygonIntersect:()=>ue,isPointRectIntersect:()=>me,isPolygonLineIntersect:()=>ce,isSafari:()=>Q,pointToCircleDistance:()=>$,randomFromArray:()=>Re,verticesArrayToArrayNumbers:()=>Se});const l={MODE:{DEBUG:"DEBUG",PRODUCTION:"PRODUCTION"},SCREENS:{},AUDIO:{},CONNECTION_STATUS:{DISCONNECTED:"disconnected",CONNECTED:"connected",CONNECTION_LOST:"connection lost"},EVENTS:{SYSTEM:{START_PAGE:"START_PAGE",STOP_PAGE:"STOP_PAGE",RENDER:{START:"start",END:"end"}},GAME:{BOUNDARIES_COLLISION:"BOUNDARIES_COLLISION",OBJECTS_COLLISION:"OBJECTS_COLLISION"},WEBSOCKET:{SERVER_CLIENT:{CONNECTION_STATUS_CHANGED:"CONNECTION_STATUS_CHANGED",ROOMS_INFO:"roomsInfo",CREATED:"created",JOINED:"joined",FULL:"full",DISCONNECTED:"disconnected",SERVER_MESSAGE:"message",RESTARTED:"restarted"},CLIENT_SERVER:{ROOMS_INFO_REQUEST:"gatherRoomsInfo",CREATE_OR_JOIN:"create or join",RESTART_REQUEST:"restart",CLIENT_MESSAGE:"message"}}},WEBGL:{DRAW_PROGRAMS:{PRIMITIVES:"drawPrimitives",IMAGES:"drawImages",IMAGES_WITH_MERGE:"drawImagesWithMerge"}},DRAW_TYPE:{RECTANGLE:"rect",CONUS:"conus",CIRCLE:"circle",POLYGON:"polygon",LINE:"line",TEXT:"text",IMAGE:"image"},LAYERS:{DEFAULT:"default-view-layer",BOUNDARIES:"boundaries-view-layer"},GAME_OPTIONS:{},LIBRARY:{WEBGL:"webgl"},OPTIMIZATION:{CYCLE_TIME_CALC:{AVERAGES:"AVERAGES",CURRENT:"CURRENT"},NATIVE_JS:{NOT_OPTIMIZED:"NOT_OPTIMIZED",OPTIMIZED:"OPTIMIZED"},WEB_ASSEMBLY:{ASSEMBLY_SCRIPT:"ASSEMBLY_SCRIPT",NATIVE_WAT:"WASM"}}},d={CREATE_INSTANCE_ERROR:"CREATE_INSTANCE_ERROR",STAGE_NOT_EXIST:"STAGE_NOT_EXIST",ELEMENT_NOT_EXIST:"ELEMENT_NOT_EXIST",FILE_NOT_EXIST:"FILE_NOT_EXIST",CANT_GET_THE_IMAGE:"CANT_GET_THE_IMAGE",UNEXPECTED_INPUT_PARAMS:"UNEXPECTED_INPUT_PARAMS",UNHANDLED_EXCEPTION:"UNHANDLED_EXCEPTION",CANVAS_KEY_NOT_SPECIFIED:"CANVAS_KEY_NOT_SPECIFIED",CANVAS_WITH_KEY_NOT_EXIST:"CANVAS_WITH_KEY_NOT_EXIST",WRONG_TYPE_ERROR:"WRONG_TYPE_ERROR",UNEXPECTED_WS_MESSAGE:"UNEXPECTED_WS_MESSAGE",UNEXPECTED_PLAYER_ID:"UNEXPECTED_PLAYER_ID",UNEXPECTED_BULLET_ID:"UNEXPECTED_BULLET_ID",UNEXPECTED_EVENT_NAME:"UNEXPECTED_EVENT_NAME",WEBGL_ERROR:"WEBGL_ERROR",DRAW_PREPARE_ERROR:"DRAW_PREPARE_ERROR",ANOTHER_STAGE_ACTIVE:"ANOTHER_STAGE_ACTIVE",UNEXPECTED_TILE_ID:"UNEXPECTED_TILE_ID",UNEXPECTED_TOUCH_AREA:"UNEXPECTED TOUCH AREA",UNEXPECTED_METHOD_TYPE:"UNEXPECTED METHOD TYPE"},h="NOT_FOUND",c="WORLD_DIMENSIONS_NOT_SET",u="UNHANDLED_DRAW_ISSUE",g="AUDIO_NOT_REGISTERED",m="AUDIO_NOT_LOADED",E="POLYGON_VERTICES_NOT_CORRECT";function _(e,t){throw new Error(e+": "+t)}function f(e,t){console.warn(e,t)}class T{#e;#t=100;#i;#s;#r;#n;#a;constructor(e,t,i=!1,s,r=!1){this.#e=e,this.#i=this.#o(t),this.#s=s||0,this.#r=r,this.#n=i}get name(){return this.#e}get isActive(){return this.#r}get currentSprite(){return this.#i[this.#s][0]}get _isLastSprite(){return this.#i.length-1===this.#s}iterateAnimationIndex(){const e=this.#s;this.#i[e][1]<Date.now()-this.#a&&(this._isLastSprite?this.#n?this.#s=0:this.deactivateAnimation():this.#s++,this.#a=Date.now())}activateAnimation=()=>{this.#r=!0,this.#s=0,this.#a=Date.now()};deactivateAnimation=()=>{this.#r=!1};#o(e){let t=[];return e.forEach((e=>{"number"==typeof e.id&&"number"==typeof e.duration?t.push([e.id,e.duration]):t.push([e,this.#t])})),t}}class p{#l;#d;#h;#c;#u;#g=0;#m=0;#E=Ae();#_=!1;#f;#T;#p=!1;#A=!1;constructor(e,t,i,s){this.#l=t,this.#d=i,this.#h=s,this.#c=e}get bgColor(){return this.#h}set bgColor(e){this.#h=e}get type(){return this.#c}get x(){return this.#l}get y(){return this.#d}set x(e){this.#l=e}set y(e){this.#d=e}get sortIndex(){return this.#g}set sortIndex(e){this.#g=e}get blendFunc(){return this.#u}set blendFunc(e){this.#u=e}get rotation(){return this.#m}set rotation(e){this.#m=e}get id(){return this.#E}get isRemoved(){return this.#_}destroy(){this.#_=!0}get isMaskAttached(){return!!this.#f}get _maskId(){return this.#f}setMask(e){e._isMask=!0,this.#f=e.id}removeMask(){this.#f=null}set _isMask(e){this.#T=e}get _isMask(){return this.#T}get isOffsetTurnedOff(){return this.#p}turnOffOffset(){this.#p=!0}_calculateRectVertices=(e,t)=>{const i=e/2,s=t/2;return[[-i,-s],[i,-s],[i,s],[-i,s]]};_interpolateConus(e,t=2*Math.PI,i=Math.PI/14){let s=[0,0];for(let r=0;r<=t;r+=i){let t=Math.cos(r)*e,i=Math.sin(r)*e;s.push(t,i)}return s}_calculateConusBoundaries(e,t=2*Math.PI,i=Math.PI/14){let s=[];for(let r=0;r<=t;r+=i){let t=Math.cos(r)*e,i=Math.sin(r)*e;s.push([t,i])}return s}_convertVerticesArray(e){return void 0!==e[0].x&&void 0!==e[0].y?Se(e):e}}class A{#R;#S;#b;#x=0;#y=0;#v=0;constructor(e,t){this._initiateStorageData(e,t)}get cells(){return this.#y}get vectors(){return this.#R}get textures(){return this.#S}get _bTempIndexes(){return this.#b}get bufferSize(){return this.#x}_initiateStorageData(e,t){this.#y=e,this.#v=t||e,this.#v>e&&(this.#v=e),this.#x=12*this.#v,this.#R=new Float32Array(this.#x),this.#S=new Float32Array(this.#x),this.#b=new Int32Array(4*this.#y)}}class R{#I;#w;#O;#C;#P="-#-";#D;#L;#M;#N;#B;#f;#g=0;#W=new Map;#p;constructor(e,t,i,s,r,n,a=!1,o){this.#I=e,this.#w=t,this.#O=i,this.#C=s,this.#L=[],this.#D=r,this.#M=n,this.#N=a,this.#B=a||!1,o&&this.setMask(o),this.#G(s,n)}get layerKey(){return this.#I}get tileMapKey(){return this.#w}get tilemap(){return this.#O}get tilesets(){return this.#C}get tilesetImages(){return this.#D}get layerData(){return this.#M}get setBoundaries(){return this.#N}get drawBoundaries(){return this.#B}set drawBoundaries(e){this.#B=e}get _maskId(){return this.#f}setMask(e){e._isMask=!0,this.#f=e.id}removeMask(){this.#f=null}get sortIndex(){return this.#g}set sortIndex(e){this.#g=e}get isOffsetTurnedOff(){return this.#p}turnOffOffset(){this.#p=!0}get hasAnimations(){return this.#W.size>0}get _textureStorages(){return this.#L}_setTextureStorage(e,t){this.#L[e]=t}#G(e,t){let i=0,s=0,r=0;e.forEach(((e,n)=>{const a=e.data.tiles,o=e.data.name,l=e.firstgid,d=this.tilesets[n+1],h=d?d.firstgid:1e9;if(a)for(let n of a){const a=n.animation,d=n.objectgroup,h=n.id;if(a){const t=o+this.#P+h,i=this.#F(a),s=new T(t,i,!0);this.#W.set(t,s),e.data._hasAnimations||(e.data._hasAnimations=!0,e.data._animations=new Map,e.data._animations.set(h,i[0][0])),this.#U(s)}d&&this.#N&&(e.data._hasBoundaries||(e.data._hasBoundaries=!0,e.data._boundaries=new Map),e.data._boundaries.set(h,d),d.objects.forEach((e=>{if(e.ellipse){const e=t.data.filter((e=>e===h+l)).length;i+=4*e}else if(e.point){const e=t.data.filter((e=>e===h+l)).length;s+=2*e}else if(e.polygon){const i=t.data.filter((e=>e===h+l)).length;r+=2*e.polygon.length*i}else{const e=t.data.filter((e=>e===h+l)).length;r+=16*e}})))}const c=t.data.filter((e=>e>=l&&e<h)).length,u=t.data.length;this.#N&&(r+=16*c),e._temp=new A(u,c)})),t.ellipseBoundariesLen=i,t.pointBoundariesLen=s,t.polygonBoundariesLen=r}#F(e){return e.map((e=>({duration:e.duration,id:e.tileid})))}_processActiveAnimations(){for(let e of this.#W.values())e.isActive&&(e.iterateAnimationIndex(),this.#j(e))}#U=e=>{e.activateAnimation(),this.#j(e)};#j=e=>{const[t,i]=e.name.split(this.#P),s=this.#C.findIndex((e=>e.data.name===t));this.#C[s].data._animations.set(parseInt(i),e.currentSprite)};stopRepeatedAnimation(e){this.#W.get(e).deactivateAnimation()}removeAllAnimations(){for(let[e,t]of this.#W.entries())this.removeEventListener(e,t.activateAnimation),t.deactivateAnimation();this.#W.clear(),this.#W=void 0}destroy(){this.removeAllAnimations(),super.destroy()}}class S extends p{#k;#V;#Y;#X;#z;#W;#H;#K;#q=0;#J=0;#Z;#Q;#$;constructor(e,t,i,s,r,n=0,a,o,d=0,h=0){super(l.DRAW_TYPE.IMAGE,e,t),this.#Y=r,this.#z=new EventTarget,this.#W=new Map,this.image=o,this.#K=n,this.#q=d,this.#J=h,this.#k=i,this.#V=s,this.#Z=a&&!a.r?this._convertVerticesArray(a):a&&a.r?this._calculateConusBoundaries(a.r):this._calculateRectVertices(i,s),this.#Q=a&&void 0!==a.r?a:null}get width(){return this.#k}get height(){return this.#V}set width(e){this.#k=e}set height(e){this.#V=e}get key(){return this.#Y}get image(){return this.#X}set image(e){this.#$&&(this.#$._isTextureRecalculated=!0),this.#X=e}get imageIndex(){return this.#K}set imageIndex(e){this.#K=e}get spacing(){return this.#q}get margin(){return this.#J}get hasAnimations(){return this.#W.size>0}get activeAnimation(){return this.#H}get boundaries(){return this.#Z}get vertices(){return this.#Z}get circleBoundaries(){return this.#Q}_processActiveAnimations(){const e=this.#H;if(e){const t=this.#W.get(e);t.iterateAnimationIndex(),this.#K=t.currentSprite}}get _textureStorage(){return this.#$}set _textureStorage(e){this.#$=e}emit(e,...t){const i=new Event(e);i.data=[...t],this.#z.dispatchEvent(i)}addEventListener(e,t,i){this.#z.addEventListener(e,t,i)}removeEventListener(e,t,i){this.#z.removeEventListener(e,t,i)}addAnimation(e,t,i){this.#ee(t)||_(d.UNEXPECTED_INPUT_PARAMS," animationSpriteIndexes should be Array of indexes, or Array of objects {duration:number, id:number}");const s=new T(e,t,i);this.#W.set(e,s),this.addEventListener(e,this.#U)}#ee(e){let t=!0;return e.forEach((e=>{"number"!=typeof e&&("number"==typeof e.duration&&"number"==typeof e.id||(t=!1))})),t}#U=e=>{const t=e.type,i=this.#W.get(t);this.#H&&this.#H!==t&&this.stopRepeatedAnimation(this.#H),i.activateAnimation(),this.#H=t,this.#K=i.currentSprite};stopRepeatedAnimation(e){this.#W.get(e).deactivateAnimation(),this.#H=null}removeAllAnimations(){for(let[e,t]of this.#W.entries())this.removeEventListener(e,t.activateAnimation),t.deactivateAnimation();this.#W.clear(),this.#W=void 0}destroy(){this.removeAllAnimations(),super.destroy()}}class b extends p{#te;#Z;constructor(e,t,i,s){super(l.DRAW_TYPE.CIRCLE,e,t,s),this.#te=i,this.#Z=this._interpolateConus(i)}get vertices(){return this.#Z}set vertices(e){this.#Z=e}get radius(){return this.#te}}class x extends p{#te;#ie;#Z;#se;constructor(e,t,i,s,r,n=0){super(l.DRAW_TYPE.CONUS,e,t,s),this.#te=i,this.#ie=r,this.#se=n,this.#Z=this._interpolateConus(i,r)}get vertices(){return this.#Z}set vertices(e){this.#Z=e}get radius(){return this.#te}get angle(){return this.#ie}get fade_min(){return this.#se}set fade_min(e){this.#se=e}}class y extends p{#Z;constructor(e,t){super(l.DRAW_TYPE.LINE,e[0][0],e[0][1],t),this.#Z=e}get vertices(){return this.#Z}set vertices(e){this.#Z=e}}class v extends p{#Z;constructor(e,t){super(l.DRAW_TYPE.POLYGON,e[0].x,e[0].y,t),this.#Z=this._convertVerticesArray(e)}get vertices(){return this.#Z}set vertices(e){this.#Z=e}}class I extends p{#k;#V;#Z;constructor(e,t,i,s,r){super(l.DRAW_TYPE.RECTANGLE,e,t,r),this.#k=i,this.#V=s,this.#Z=this._calculateRectVertices(i,s)}get vertices(){return this.#Z}get width(){return this.#k}get height(){return this.#V}set width(e){this.#k=e}set height(e){this.#V=e}}class w{#l;#d;constructor(e,t){this.#l=e,this.#d=t}get x(){return this.#l}get y(){return this.#d}}class O{#l;#d;#k;#V;constructor(e,t,i,s){this.#l=e,this.#d=t,this.#k=i,this.#V=s}get x(){return this.#l}get y(){return this.#d}get width(){return this.#k}get height(){return this.#V}}class C{#l;#d;constructor(e,t,i,s){this.#l=i-e,this.#d=s-t}get x(){return this.#l}get y(){return this.#d}get length(){return Math.sqrt(Math.pow(this.#l,2)+Math.pow(this.#d,2))}get tetaAngle(){return Math.atan2(this.#d,this.#l)}}class P extends p{#re;#ne;#ae;#oe;#le;#de;#he;#ce=document.createElement("canvas");#$;constructor(e,t,i,s,r){super(l.DRAW_TYPE.TEXT,e,t),this.#de=i,this.#re=s,this.#oe=r,this.#he,this.#ue()}get boundariesBox(){const e=this.textMetrics?Math.floor(this.textMetrics.width):300,t=this.textMetrics?Math.floor(this.textMetrics.fontBoundingBoxAscent+this.textMetrics.fontBoundingBoxDescent):30;return new O(this.x,this.y-t,e,t)}get vertices(){const e=this.boundariesBox;return this._calculateRectVertices(e.width,e.height)}get text(){return this.#de}set text(e){e!==this.#de&&(this.#de=e,this.#ue())}get font(){return this.#re}set font(e){e!==this.#re&&(this.#re=e,this.#ue())}get textAlign(){return this.#ne}set textAlign(e){e!==this.#ne&&(this.#ne=e,this.#ue())}get textBaseline(){return this.#ae}set textBaseline(e){e!==this.#ae&&(this.#ae=e,this.#ue())}get fillStyle(){return this.#oe}set fillStyle(e){e!==this.#oe&&(this.#oe=e,this.#ue())}get strokeStyle(){return this.#le}set strokeStyle(e){e!==this.#le&&(this.#le=e,this.#ue())}get textMetrics(){return this.#he}set _textMetrics(e){this.#he=e}get _textureStorage(){return this.#$}set _textureStorage(e){this.#$=e}get _textureCanvas(){return this.#ce}#ue(){const e=this.#ce.getContext("2d",{willReadFrequently:!0});if(e){e.font=this.font,this._textMetrics=e.measureText(this.text);const t=this.boundariesBox.width,i=this.boundariesBox.height;e.canvas.width=t,e.canvas.height=i,e.clearRect(0,0,t,i),e.font=this.font,e.textBaseline="bottom",this.fillStyle&&(e.fillStyle=this.fillStyle,e.fillText(this.text,0,i)),this.strokeStyle&&(e.strokeStyle=this.strokeStyle,e.strokeText(this.text,0,i)),this.#$&&(this.#$._isTextureRecalculated=!0)}else _(d.UNHANDLED_EXCEPTION,"can't getContext('2d')")}}class D{#ge;#me;#Ee;#_e;#fe=0;#Te=0;#pe=0;#Ae=0;#Re=0;#Se=0;#be=0;#xe=0;#ye=0;#ve=0;#Ie=0;#we;#Oe;#Ce;#Pe;#De=[];#p;#Le=!1;#Me=[];#Ne=!1;constructor(e){}isOffsetTurnedOff(){return this.#p}set mapRotate(e){this.#Re=e}#Be(e){this._addBoundaryLine(e.x1,e.y1,e.x2,e.y2)}_addImageDebugBoundaries(e){const t=e.length;for(let i=0;i<t;i++)this.#Me.push(...e[i])}_enableDebugObjectBoundaries(){this.#Ne=!0}_addBoundariesArray(e){const t=e.length;for(let i=0;i<t;i++){const t=e[i];this._addBoundaryLine(t[0],t[1],t[2],t[3])}}_addBoundaryLine(e,t,i,s){this.#we[this.#ye]=e,this.#ye++,this.#we[this.#ye]=t,this.#ye++,this.#we[this.#ye]=i,this.#ye++,this.#we[this.#ye]=s,this.#ye++}_addEllipseBoundary(e,t,i,s){this.#Oe[this.#Ie]=e,this.#Ie++,this.#Oe[this.#Ie]=t,this.#Ie++,this.#Oe[this.#Ie]=i,this.#Ie++,this.#Oe[this.#Ie]=s,this.#Ie++}_addPointBoundary(e,t){this.#Ce[this.#ve]=e,this.#ve++,this.#Ce[this.#ve]=t,this.#ve++}_removeBoundaryLine(e){this.#we[e]=0,this.#we[e+1]=0,this.#we[e+2]=0,this.#we[e+3]=0}_clearBoundaries(){this.#we.fill(0),this.#Oe.fill(0),this.#Ce.fill(0),this.#ye=0,this.#Ie=0,this.#ve=0,this.#Ne&&(this.#Me=[])}_initiateBoundariesData(){this.#we=new Float32Array(this.#Se),this.#Oe=new Float32Array(this.#be),this.#Ce=new Float32Array(this.#xe)}_setMaxBoundariesSize(e,t=0,i=0){this.#Se=e,this.#be=t,this.#xe=i}_setWorldDimensions(e,t){this.#ge=e,this.#me=t}_setCanvasDimensions(e,t){this.#Ee=e,this.#_e=t}_setMapBoundaries(){const[e,t]=[this.#ge,this.#me],[i,s]=[this.#fe,this.#Te],r=e-i,n=t-s;e&&t||f(c,"Can't set map boundaries."),this.#Be({x1:0,y1:0,x2:r,y2:0}),this.#Be({x1:r,y1:0,x2:r,y2:n}),this.#Be({x1:r,y1:n,x2:0,y2:n}),this.#Be({x1:0,y1:n,x2:0,y2:0})}_setWholeWorldMapBoundaries(){const[e,t]=[this.#ge,this.#me];e&&t||f(c,"Can't set map boundaries."),this.#Pe.push([0,0,e,0]),this.#Pe.push([e,0,e,t]),this.#Pe.push([e,t,0,t]),this.#Pe.push([0,t,0,0])}_mergeBoundaries(e=!1){const t=e?this.getWholeWorldBoundaries():this.getBoundaries(),i=new Set(t);for(const e of i.values()){const t=e[0],s=e[1],r=e[2],n=e[3];for(const a of i.values()){const o=a[0],l=a[1],d=a[2],h=a[3];t===d&&s===h&&r===o&&n===l&&(i.delete(e),i.delete(a)),r!==o||n!==l||t!==d&&s!==h||(a[0]=t,a[1]=s,i.delete(e))}}e?this.#we=Array.from(i):this.#Pe=Array.from(i),i.clear()}_setWholeMapBoundaries(e){this.#Pe.push(...e)}_enableMapBoundaries(){this.#Le=!0}getBoundaries(){const e=this.#we,t=this.#ye;let i=[],s=[];for(let r=0;r<t;r++){const t=e[r];i.push(t),(r+1)%4==0&&(s.push(i),i=[])}return s}getRawBoundaries(){return this.#we}getEllipseBoundaries(){return this.#Oe}getPointBoundaries(){return this.#Ce}getWholeWorldBoundaries(){return this.#Pe}getDebugObjectBoundaries(){return this.#Me}get isWorldBoundariesEnabled(){return this.#Le}get canvasDimensions(){return[this.#Ee,this.#_e]}get worldDimensions(){return[this.#ge,this.#me]}get worldOffset(){return[this.#fe,this.#Te]}get mapCenter(){return[this.#pe,this.#Ae]}get mapRotate(){return this.#Re}get boundariesLen(){return this.#ye}get ellipseBLen(){return this.#Ie}get pointBLen(){return this.#ve}centerCameraPosition=(e,t)=>{let[i,s]=this.worldOffset;const[r,n]=this.canvasDimensions,[a,o]=this.worldDimensions,l=r/2,d=n/2,h=d-s;if(l-i<e)if(e<a-l){const t=e-l;t>=0&&(this.#fe=Math.round(t))}else if(a>r){const e=a-r;this.#fe=Math.round(e)}if(h<t)if(t<o-d){const e=t-d;e>=0&&(this.#Te=Math.round(e))}else if(o>n){const e=o-n;this.#Te=Math.round(e)}this.#pe=e,this.#Ae=t};personRotatedCenterCamera=(e,t,i)=>{console.log("new centering algorithm")};get renderObjects(){return this.#De}getObjectsByInstance(e){return this.#De.filter((t=>t instanceof e))}_sortRenderObjectsBySortIndex(){this.#De=this.#De.sort(((e,t)=>e.sortIndex-t.sortIndex))}set _renderObject(e){this.#De.push(e)}set _renderObjects(e){this.#De=e}}const L={loadstart:"loadstart",progress:"progress",abort:"abort",error:"error",load:"load",timeout:"timeout"},M=" loader is not registered.",N="Too much recursion. Stop iteration.",B="uploadMethod should be instance of Promise and return upload result value",W=" AtlasXML file extension is incorrect, only .xml file supported",G=" tileset file extension is not correct, only .tsj or .json files are supported",F=" tilemap file extension is not correct, only .tmj or .json files are supported",U=" fileKey and url should be provided";class j{#We;#Ge;#Fe=new Map;#Ue=new Map;constructor(e,t){this.#We=e,this.#Ge=(e,i,...s)=>{const r=t(e,i,...s);if(r instanceof Promise)return r.then((t=>this.#je(t,e)));throw new TypeError(B)}}#je=(e,t)=>new Promise(((i,s)=>{e||null===e||Y("AssetsManager: uploadMethod for "+this.#We+" returns incorrect value"),this.#ke(t,e),this.#Ve(t),i()}));#ke(e,t){this.#Ue.set(e,t)}#Ve(e){this.#Fe.delete(e)}get filesWaitingForUpload(){return this.#Fe.size}get loadingQueue(){return this.#Fe}get uploadMethod(){return this.#Ge}_addFile=(e,t)=>{this.#Fe.has(e)&&Y("AssetsManager: File "+this.#We+" with key "+e+" is already added"),this.#Fe.set(e,t)};_isFileInQueue=e=>this.#Fe.has(e);_getFile=e=>this.#Ue.get(e)}class k{#Ye=5;#Xe=new EventTarget;#ze=new Map;#He=0;constructor(){this.registerLoader("Audio",this._loadAudio),this.registerLoader("Image",this._loadImage),this.registerLoader("TileMap",this._loadTileMap),this.registerLoader("TileSet",this._loadTileSet),this.registerLoader("AtlasImageMap",this._loadAtlasImage),this.registerLoader("AtlasXML",this._loadAtlasXml)}get filesWaitingForUpload(){let e=0;return Array.from(this.#ze.values()).map((t=>e+=t.filesWaitingForUpload)),e}registerLoader=(e,t=this._defaultUploadMethod)=>{this["add"+e]=(t,i,...s)=>{this.addFile(e,t,i,...s)},this["get"+e]=t=>this.getFile(e,t),this["is"+e+["InQueue"]]=t=>this.isFileInQueue(e,t);const i=this.#ze.get(e)||new j(e,t);this.#ze.set(e,i)};preload(){return this.#V(),new Promise((async(e,t)=>{this.#Ke().then((()=>{this.#qe(),e()})).catch((e=>{t(e)}))}))}#Ke(e=0){return this.#Je().then((t=>{if(0===this.filesWaitingForUpload)return Promise.resolve(t);if(++e>this.#Ye){const e=new Error(N);return this.#Ze(e),Promise.reject(new Error(N))}return this.#Ke(e)}))}#Je(){return new Promise(((e,t)=>{let i=[];Array.from(this.#ze.values()).forEach((e=>{Array.from(e.loadingQueue.entries()).forEach((t=>{const s=new Promise(((i,s)=>e.uploadMethod(t[0],...t[1]).then((e=>i(e)))));i.push(s)}))})),Promise.allSettled(i).then((i=>{for(const s of i){if("rejected"===s.status){const e=s.reason;this.#Qe(e)?t(e):(Y("AssetsManager: "+e.message),this.#Ze(e))}e(i)}}))}))}addEventListener(e,t,...i){L[e]?this.#Xe.addEventListener(e,t,...i):Y("AssetsManager: Event type should be one of the ProgressEvent.type")}removeEventListener(e,t,...i){this.#Xe.removeEventListener(e,t,...i)}_loadAtlasXml=(e,t)=>(this.#$e(t),fetch(t).then((e=>e.text())).then((e=>(new window.DOMParser).parseFromString(e,"text/xml"))).then((i=>{const s=i.documentElement||i.activeElement,r=s.attributes.getNamedItem("imagePath"),n=s.children;if(r){const i=this.#et(t);return this.addAtlasImageMap(e,i+r.value,n,i),Promise.resolve(s)}{const t=new Error(e+" XML format is not correct.");return this.#Ze(t),Promise.resolve(t)}})));_loadAtlasImage=(e,t,i,s="anonymous")=>new Promise(((e,r)=>{const n=new Image,a=new Map,o=document.createElement("canvas"),l=o.getContext("2d");n.crossOrigin=s,n.onload=()=>{const t=[];let s=[];o.width=n.width,o.height=n.height,l.drawImage(n,0,0);for(let e of i){const i=e.attributes,r=i.getNamedItem("name").value,n=r.includes(".")?r.split(".")[0]:r,a=i.getNamedItem("x").value,o=i.getNamedItem("y").value,d=i.getNamedItem("width").value,h=i.getNamedItem("height").value;t.push(createImageBitmap(l.getImageData(a,o,d,h),{premultiplyAlpha:"premultiply"})),s.push(n)}this.#tt(),Promise.all(t).then((t=>{t.forEach(((e,t)=>{const i=s[t];a.set(i,e),this.addImage(i,"empty url",e)})),o.remove(),e(a)}))},n.onerror=()=>{const i=new Error("Error loading atlas image "+t);this.#Ze(i),e(null)},n.src=t}));_loadTileSet=(e,t,i=1,s)=>(this.#it(t),fetch(s?s+t:t).then((e=>e.json())).then((e=>{const{name:t,image:r,spacing:n,margin:a,tilewidth:o,tileheight:l}=e;return t&&r&&!this.isFileInQueue("Image",t)&&this.addImage(t,s?s+r:r),e.gid=i,Promise.resolve(e)})).catch((()=>{const e=new Error("Error loading related tileset "+t);return this.#Ze(e),Promise.resolve(null)})));_defaultUploadMethod=(e,t)=>fetch(t);_loadTileMap=(e,t,i=!0)=>(this.#st(t),fetch(t).then((e=>e.json())).then((e=>{const s=this.#et(t);if(!0===i&&e.tilesets&&e.tilesets.length>0){const t=[];return e.tilesets.forEach(((e,i)=>{const{firstgid:r,source:n}=e,a=this._loadTileSet("default-"+r,n,r,s).then((e=>(this.#tt(),Promise.resolve(e))));t.push(a)})),Promise.all(t).then((t=>{for(let i=0;i<t.length;i++){const s=t[i];e.tilesets[i].data=s}return Promise.resolve(e)}))}return Promise.resolve(e)})).catch((e=>(e.message.includes("JSON.parse:")&&(e=new Error("Error loading tilemap "+t)),this.#Ze(e),Promise.resolve(null)))));_loadAudio=(e,t)=>new Promise((e=>{const i=new Audio(t);i.addEventListener("loadeddata",(()=>{this.#tt(),e(i)})),i.addEventListener("error",(()=>{const i=new Error("Error loading audio "+t);this.#Ze(i),e(null)}))}));_loadImage=(e,t,i,s="anonymous")=>new Promise(((e,r)=>{if(i)e(i);else{const i=new Image;i.crossOrigin=s,i.onload=()=>{createImageBitmap(i,{premultiplyAlpha:"premultiply"}).then((t=>{this.#tt(),e(t)}))},i.onerror=()=>{const i=new Error("Error loading image "+t);this.#Ze(i),e(null)},i.src=t}}));#$e(e){e.includes(".xml")||V(e+W)}#it(e){e.includes(".tsj")||e.includes(".json")||V(e+G)}#st(e){e.includes(".tmj")||e.includes(".json")||V(e+F)}#Qe(e){return e.message.includes(B)||e.message.includes(W)||e.message.includes(G)||e.message.includes(F)||e.message.includes(U)||e.message.includes(M)}#et(e){let t=e.split("/"),i=t.length,s="/";return t[i-1].includes(".tmj")||t[i-1].includes(".xml")||t[i-1].includes(".json")?(t.pop(),s=t.join("/")+"/"):(t[i-2].includes(".tmj")||t[i-2].includes(".xml")||t[i-2].includes(".json"))&&(t.splice(i-2,2),s=t.join("/")+"/"),s}addFile(e,t,i,...s){const r=this.#ze.get(e);r?(this.#rt(t,i,e),r._addFile(t,[i,...s])):V(e+M)}isFileInQueue(e,t){const i=this.#ze.get(e);if(i)return i._isFileInQueue(t);V("Loader for "+e+" is not registered!")}getFile(e,t){const i=this.#ze.get(e);if(i)return i._getFile(t);V("Loader for "+e+" is not registered!")}#rt(e,t,i){const s=U;e&&0!==e.trim().length||V("add"+i+"()"+s),t&&0!==t.trim().length||V("add"+i+"()"+s)}#V(){let e=this.filesWaitingForUpload;this.#Xe.dispatchEvent(new ProgressEvent(L.loadstart,{total:e}))}#qe(){this.#Xe.dispatchEvent(new ProgressEvent(L.load))}#tt(){const e=this.filesWaitingForUpload;this.#He+=1,this.#Xe.dispatchEvent(new ProgressEvent(L.progress,{lengthComputable:!0,loaded:this.#He,total:e}))}#Ze(e){Y("AssetsManger: "+e.message),this.#Xe.dispatchEvent(new ErrorEvent(L.error,{error:e}))}}function V(e){throw new Error(e)}function Y(e){console.warn(e)}class X{#nt;#at;constructor(e){this.#nt=e}get stageData(){return this.#at}#ot(e){return this.#at._renderObject=e,this.#at._sortRenderObjectsBySortIndex(),e}rect(e,t,i,s,r){const n=new I(e,t,i,s,r);return this.#ot(n),n}text(e,t,i,s,r){const n=new P(e,t,i,s,r);return this.#ot(n),n}conus(e,t,i,s,r,n=0){const a=new x(e,t,i,s,r,n);return this.#ot(a),a}circle(e,t,i,s){const r=new b(e,t,i,s);return this.#ot(r),r}image(e,t,i,s,r,n=0,a,o=0,l=0){const h=this.#nt.getImage(r);h||_(d.CANT_GET_THE_IMAGE,"iLoader can't get the image with key: "+r);const c=new S(e,t,i,s,r,n,a,h,o,l);return this.#ot(c),c}line(e,t){const i=new y(e,t);return this.#ot(i),i}polygon(e,t){const i=new v(e,t);return this.#ot(i),i}tiledLayer(e,t,i,s){const r=this.#nt.getTileMap(t),n=Object.assign({},r.layers.find((t=>t.name===e))),a=Array.from(new Set(n.data.filter((e=>0!==e)))).sort(((e,t)=>e-t)),o=r.tilesets.map((e=>Object.assign({},e))).filter((e=>{const t=e.firstgid,i=t+e.data.tilecount;return!!a.find((e=>e>=t&&e<=i))})),l=o.map((e=>this.#nt.getImage(e.data.name))),d=new R(e,t,r,o,l,n,i,s);return this.#ot(d),d}_registerNewObjectMethod=(e,t)=>{this[e]=(...e)=>this.#lt(t,...e)};#lt=(e,...t)=>{const i=e(...t);return this.#ot(i),i};_attachPageData=e=>{this.#at=e};_detachPageData=()=>{this.#at=null}}class z{constructor(){}static mode=l.MODE.DEBUG;static gameOptions={library:l.LIBRARY.WEBGL,optimization:l.OPTIMIZATION.NATIVE_JS.OPTIMIZED,optimizationWASMUrl:"./src/wa/calculateBufferDataWat.wasm",optimizationAssemblyUrl:"/src/wa/calculateBufferDataAssembly.wasm",loadingScreen:{backgroundColor:"rgba(128, 128, 128, 0.6)",loadingBarBg:"rgba(128, 128, 128, 1)",loadingBarProgress:"rgba(128, 128, 128, 0.2)"},render:{minCycleTime:16.666,cyclesTimeCalc:{check:l.OPTIMIZATION.CYCLE_TIME_CALC.AVERAGES,averageFPStime:1e4},boundaries:{mapBoundariesEnabled:!0,realtimeCalculations:!0,wholeWorldPrecalculations:!1}},debug:{checkWebGlErrors:!1,debugMobileTouch:!1,boundaries:{drawLayerBoundaries:!1,drawObjectBoundaries:!1,boundariesColor:"rgba(224, 12, 21, 0.6)",boundariesWidth:2},delayBetweenObjectRender:!1}};static network={enabled:!1,address:"https://gameserver.reslc.ru:9009",gatherRoomsInfoInterval:5e3};static canvasMaxSize={width:1800,height:1800};static worldSize={width:960,height:960};static defaultCanvasKey="default";static customSettings={}}class H{static debug(...e){z.mode===l.MODE.DEBUG&&e.forEach((e=>console.log(e)))}}class K extends Event{#dt;constructor(e,t){super(e),this.#ht(e)||_(d.UNEXPECTED_EVENT_NAME,", Please check if event is exist"),this.#dt=t}#ht(e){return Object.values(l.EVENTS.WEBSOCKET.SERVER_CLIENT).find((t=>t===e))}get data(){return this.#dt}}class q extends EventTarget{#ct;#ut;constructor(e){super(),e||_(d.CREATE_INSTANCE_ERROR,"systemSettings should be passed to class instance"),this.#ct=e}init(){r.e(319).then(r.bind(r,319)).then((e=>{this.#ut=e.io(this.#ct.network.address,{withCredentials:!0}),this.#gt()}))}get isServerConnected(){return!(!this.#ut||!this.#ut.connected)}get playerId(){return this.#ut.id}sendGatherRoomsInfo(){this.#ut.emit(l.EVENTS.WEBSOCKET.CLIENT_SERVER.ROOMS_INFO_REQUEST)}sendCreateOrJoinRoom(e,t){this.#ut.emit(l.EVENTS.WEBSOCKET.CLIENT_SERVER.CREATE_OR_JOIN,e,t)}sendMessage(e){this.#ut.emit(l.EVENTS.WEBSOCKET.CLIENT_SERVER.CLIENT_MESSAGE,e)}#mt=()=>{H.debug("connected, socket id: "+this.#ut.id),this.dispatchEvent(new Event(l.EVENTS.WEBSOCKET.SERVER_CLIENT.CONNECTION_STATUS_CHANGED))};#Et=e=>{H.debug("server disconnected, reason: "+e),this.dispatchEvent(new Event(l.EVENTS.WEBSOCKET.SERVER_CLIENT.CONNECTION_STATUS_CHANGED))};#_t=e=>{console.warn("server data: ",e)};#ft=e=>{H.debug("received new message from server: "+e),this.dispatchEvent(new K(l.EVENTS.WEBSOCKET.SERVER_CLIENT.SERVER_MESSAGE,e))};#Tt=e=>{H.debug("received roomsInfo "+e),this.dispatchEvent(new K(l.EVENTS.WEBSOCKET.SERVER_CLIENT.ROOMS_INFO,e))};#pt=(e,t)=>{H.debug("CLIENT SOCKET: Created room  "+e),this.dispatchEvent(new K(l.EVENTS.WEBSOCKET.SERVER_CLIENT.CREATED,{room:e,map:t}))};#At=e=>{H.debug("CLIENT SOCKET: Room is full, can't join: "+e),this.dispatchEvent(new K(l.EVENTS.WEBSOCKET.SERVER_CLIENT.FULL,{room:e}))};#Rt=(e,t)=>{H.debug("CLIENT SOCKET: Joined to room: "+e,", map: ",t),this.dispatchEvent(new K(l.EVENTS.WEBSOCKET.SERVER_CLIENT.JOINED,{room:e,map:t}))};#St=e=>{this.dispatchEvent(new K(l.EVENTS.WEBSOCKET.SERVER_CLIENT.DISCONNECTED,{playerId:e}))};#gt(){this.#ut.on("connect",this.#mt),this.#ut.on("disconnect",this.#Et),this.#ut.on("data",this.#_t),this.#ut.on("roomsInfo",this.#Tt),this.#ut.on("created",this.#pt),this.#ut.on("full",this.#At),this.#ut.on("joined",this.#Rt),this.#ut.on("log",(function(e){console.log.apply(console,e)})),this.#ut.on("message",this.#ft),this.#ut.on("removed",(function(e){console.log("removed message"),console.log(e)})),this.#ut.on("disconnected",this.#St),addEventListener("beforeunload",this.#bt)}#bt=()=>{this.#ut.disconnect()}}class J{#xt=.5;#yt=new Map;#vt;constructor(e){this.#vt=e}getAudio=e=>{const t=this.#yt.get(e);return null===t?(f(m,"Audio with key "+e+" exists, but not actually loaded"),t):t||(f(g,""),null)};getAudioCloned=e=>{const t=this.#yt.get(e);if(null===t)return f(m,"Audio with key "+e+" exists, but not actually loaded"),t;if(t){const e=t.cloneNode();return e.volume=this.#xt,e}return f(g),null};set volume(e){this.#xt=e,this.#It(e)}get volume(){return this.#xt}#It(e){for(const t of this.#yt.values())t&&(t.volume=e)}registerAudio(e){let t=this.#vt.getAudio(e);this.#yt.set(e,t)}}function Z(){return/Android|webOS|iPhone|iPad|iPod|Opera Mini/i.test(navigator.userAgent)}function Q(){return/^((?!chrome|android).)*safari/i.test(navigator.userAgent)}function $(e,t,i){return new C(e,t,i.x,i.y).length-i.r}function ee(e,t){const i=t.x1,s=t.y1,r=t.x2,n=t.y2,a=e.x1,o=e.y1,l=i,d=s,h=r-i,c=n-s,u=a,g=o,m=e.x2-a,E=e.y2-o,_=Math.sqrt(h*h+c*c),f=Math.sqrt(m*m+E*E);if(h/_==m/f&&c/_==E/f)return null;const T=(h*(g-d)+c*(l-u))/(m*c-E*h),p=(u+m*T-l)/h;return p<0||isNaN(p)||T<0||T>1?null:{x:l+h*p,y:d+c*p,p}}function te(e,t){const i=t.x1,s=t.y1,r=t.x2,n=t.y2,a=e.x1,o=e.y1,l=e.x2,d=e.y2,h=(i-r)*(o-d)-(s-n)*(a-l);if(0===h)return;let c=((i*n-s*r)*(a-l)-(i-r)*(a*d-o*l))/h,u=((i*n-s*r)*(o-d)-(s-n)*(a*d-o*l))/h;const g={x:c,y:u};return oe(g,e,1e-13)&&oe(g,t,1e-13)?{x:c,y:u,p:Math.sqrt(Math.pow(c-i,2)+Math.pow(u-s,2))}:void 0}function ie(e,t,i,s){return Math.atan2(s-t,i-e)}function se(e,t,i){const s=e.x-t.x,r=i.x-t.x,n=e.y-t.y,a=i.y-t.y,o=Math.sqrt(s*s+n*n),l=Math.sqrt(r*r+a*a);return Math.acos((s*r+n*a)/(o*l))}function re(e,t,i){return e*t*Math.cos(i)}function ne(e,t){return e.x*t.x+e.y*t.y}function ae(e,t){return e.x*t.y-t.x*e.y}function oe(e,t,i=0){return(e.x>=t.x1-i&&e.x<=t.x2+i||e.x<=t.x1+i&&e.x>=t.x2-i)&&(e.y>=t.y1-i&&e.y<=t.y2+i||e.y<=t.y1+i&&e.y>=t.y2-i)}function le(e,t){return new C(e.x,e.y,t.x,t.y).length}function de(e,t){return new C(e.x1,e.y1,e.x2,e.y2).length<new C(t.x1,t.y1,t.x2,t.y2).length}function he(e,t){const i=new C(t.x1,t.y1,t.x2,t.y2).length;return new C(t.x1,t.y1,e.x,e.y).length+new C(t.x2,t.y2,e.x,e.y).length<=i+.2}function ce(e,t){const i=e.length;for(let s=0;s<i;s+=1){let i=e[s],r=e[s+1];if(!r){if(i[0]===e[0][0]&&i[1]===e[0][1])continue;r=e[0]}const n=te({x1:i[0],y1:i[1],x2:r[0],y2:r[1]},t);if(n)return n}if(e[i-1][0]!==e[0][0]&&e[i-1][1]!==e[0][1]){const s=e[i-1],r=e[0],n=te({x1:s[0],y1:s[1],x2:r[0],y2:r[1]},t);if(n)return n}return null}function ue(e,t,i){const s=i.length;for(let r=0;r<s;r+=1){let s=i[r],n=i[r+1];if(n||(n=i[0]),he({x:e,y:t},{x1:s[0],y1:s[1],x2:n[0],y2:n[1]}))return!0}return!1}function ge(e,t,i){const s=i.length;let r=0;for(let n=0;n<s;n++){let s=i[n],a=i[n+1]?i[n+1]:i[0],o=s[0],l=s[1],d=a[0],h=a[1];t<l!=t<h&&e<(d-o)*(t-l)/(h-l)+o&&r++}return r>0&&r%2!=0}function me(e,t,i){return e>=i.x&&e<=i.width+i.x&&t>=i.y&&t<=i.y+i.height}function Ee(e,t,i){const s=i.r;return new C(e,t,i.x,i.y).length<s}function _e(e,t,i,s){const r=s.x1,n=s.y1,a=s.x2,o=s.y2,l={x:r-e,y:n-t},d={x:a-e,y:o-t},h={x:a-r,y:o-n},c={x:r-a,y:n-o},u=Math.sqrt(Math.pow(h.x,2)+Math.pow(h.y,2)),g=ne(l,c),m=ne(d,h);let E;return g>0&&m>0?(E=ae(l,d)/u,E<0&&(E*=-1)):E=Math.min(l.length,d.length),E<=i}function fe(e,t){const i=e[0],s=e[1],r=e[2],n=e[3],a={x:i-t[0][0],y:s-t[0][1]},o={x:i-t[1][0],y:s-t[1][1]},l=Math.sqrt(Math.pow(a.x,2)+Math.pow(a.y,2)),d=Math.sqrt(Math.pow(o.x,2)+Math.pow(o.y,2)),h=Math.min(l,d);if(h>Math.max(r,n))return!1;const c=h===l?a:o,u=Math.atan2(c.y,c.x),g={x:0-Math.cos(u)*r,y:0-Math.sin(u)*n};return!(h>Math.sqrt(Math.pow(g.x,2)+Math.pow(g.y,2)))}function Te(e,t){const i=e[0],s=e[1],r={x:i-t.x,y:s-t.y},n=Math.sqrt(Math.pow(r.x,2)+Math.pow(r.y,2));if(n>Math.max(e[2],e[3])+t.r)return!1;{const r=ie(i,s,t.x,t.y),a=i-(i+e[2]*Math.cos(r)),o=s-(s+e[3]*Math.sin(r));return n<=Math.sqrt(Math.pow(a,2)+Math.pow(o,2))+t.r&&{x:a,y:o,p:1}}}function pe(e,t){const i=t.length;for(let s=0;s<i;s+=1){let i=t[s],r=t[s+1];if(r||(r=t[0]),fe(e,[i,r]))return!0}return!1}function Ae(){return Math.round(1e6*Math.random())}function Re(e){return e[Math.floor(Math.random()*e.length)]}function Se(e){const t=e.length,i=[];for(let s=0;s<t;s++){const t=e[s];i.push([t.x,t.y])}return i}function be(e=0,t=0,i,s){const r=s.length;let n=Array(r),a=0;for(let o=0;o<r;o++){const r=s[o];let l=s[o+1];l||(l=s[0]);const d=r[0],h=r[1],c=l[0],u=l[1],g=[d*Math.cos(i)-h*Math.sin(i)+e,d*Math.sin(i)+h*Math.cos(i)+t,c*Math.cos(i)-u*Math.sin(i)+e,c*Math.sin(i)+u*Math.cos(i)+t];n[a]=g,a++}return n}function xe(e=0,t=0,i,s,r=2*Math.PI,n=Math.PI/8){let a=[];for(let o=0;o<=r;o+=n){let r=Math.cos(o)*i+e,n=Math.sin(o)*s+t;a.push([r,n])}return a}class ye{#wt;#Ot;#Ct=!0;constructor(e,t=0){this.#Ot=e,this.#wt=t}get _isTextureRecalculated(){return this.#Ct}set _isTextureRecalculated(e){this.#Ct=e}get _texture(){return this.#Ot}set _texture(e){this.#Ot=e}get _textureIndex(){return this.#wt}}class ve{#Pt;#Dt;#Lt;#Mt;#vt;#Nt;#Bt;#Wt=new Map;#Gt=new Map;#Ft=new Map;#Ut;constructor(e,t,i){e&&e instanceof WebGLRenderingContext||_(d.UNEXPECTED_INPUT_PARAMS," context parameter should be specified and equal to WebGLRenderingContext"),this.#Pt=e,this.#Mt=t,this.#vt=i,this.#Lt=t.debug.checkWebGlErrors,this.#Dt=e.getParameter(e.MAX_TEXTURE_IMAGE_UNITS),this.#Nt=e.createBuffer(),this.#Bt=e.createBuffer(),this._registerObjectRender(P.name,this._bindText,l.WEBGL.DRAW_PROGRAMS.IMAGES),this._registerObjectRender(I.name,this._bindPrimitives,l.WEBGL.DRAW_PROGRAMS.PRIMITIVES),this._registerObjectRender(v.name,this._bindPrimitives,l.WEBGL.DRAW_PROGRAMS.PRIMITIVES),this._registerObjectRender(b.name,this._bindConus,l.WEBGL.DRAW_PROGRAMS.PRIMITIVES),this._registerObjectRender(x.name,this._bindConus,l.WEBGL.DRAW_PROGRAMS.PRIMITIVES),this._registerObjectRender(R.name,this._bindTileImages,l.WEBGL.DRAW_PROGRAMS.IMAGES),this._registerObjectRender(y.name,this._bindLine,l.WEBGL.DRAW_PROGRAMS.PRIMITIVES),this._registerObjectRender(l.DRAW_TYPE.IMAGE,this._bindImage,l.WEBGL.DRAW_PROGRAMS.IMAGES)}getProgram(e){return this.#Wt.get(e)}getProgramVarLocations(e){return this.#Gt.get(e)}_fixCanvasSize(e,t){this.#Pt.viewport(0,0,e,t)}_initiateJsRender=e=>new Promise(((t,i)=>{const s=e.getObjectsByInstance(R),[r,n]=e.worldDimensions;let a=0,o=0,l=0,d=0,h=0;s.forEach((e=>{const t=e.setBoundaries,i=e.layerData,s=e.tilemap,r=e.tilesets,{tileheight:n,tilewidth:c}=s,u=c,g=n;for(let e=0;e<r.length;e++){const e=u*i.width,s=g*i.height,r=i.polygonBoundariesLen,n=i.ellipseBoundariesLen,c=i.pointBoundariesLen;d<e&&(d=e),h<s&&(h=s),t&&(a+=r,o+=n,l+=c)}})),0===d||0===h||d===r&&h===n||(f("UNEXPECTED_WORLD_SIZE"," World size from tilemap is different than settings one, fixing..."),e._setWorldDimensions(d,h)),this.#Mt.render.boundaries.mapBoundariesEnabled&&(a+=16),e._setMaxBoundariesSize(a,o,l),e._initiateBoundariesData(),t(!0)}));_initWebGlAttributes=()=>{const e=this.#Pt;return e.enable(e.BLEND),e.enable(e.STENCIL_TEST),e.stencilFunc(e.ALWAYS,1,255),e.stencilOp(e.KEEP,e.KEEP,e.REPLACE),Promise.resolve()};_initiateWasm=e=>{const t=this.#Mt.optimization===l.OPTIMIZATION.WEB_ASSEMBLY.NATIVE_WAT?this.#Mt.optimizationWASMUrl:this.#Mt.optimizationAssemblyUrl;return new Promise(((e,i)=>{this.layerData=new WebAssembly.Memory({initial:1e3}),this.layerDataFloat32=new Float32Array(this.layerData.buffer);const s={env:{memory:this.layerData,logi:console.log,logf:console.log}};fetch(t).then((e=>e.arrayBuffer())).then((e=>WebAssembly.instantiate(e,s))).then((t=>{this.calculateBufferData=t.instance.exports.calculateBufferData,e()}))}))};_initDrawCallsDebug(e){this.#Ut=e}_clearView(){const e=this.#Pt;this.#Ut.cleanupDebugInfo(),e.clearColor(0,0,0,0),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT|e.STENCIL_BUFFER_BIT)}_render(e,t,i=0){return this.#Pt.drawArrays(t,i,e),Promise.resolve(e)}_preRender(){return new Promise(((e,t)=>{const i=this.#Pt,s=this.#Lt?i.getError():0;if(0!==s)throw console.error(s),new Error("Error num: "+s);e()}))}_postRender(e){let t=e;if(Array.isArray(t)){const[i,s]=e;this.#Pt.drawArrays(s,0,i),t=i}return new Promise(((e,i)=>{const s=this.#Pt;this.#Ut.incrementDrawCallsCounter(),this.#Ut.verticesDraw=t,s.stencilFunc(s.ALWAYS,1,255),this.#Mt.debug.delayBetweenObjectRender?setTimeout((()=>{e()}),1e3):e()}))}_registerAndCompileWebGlProgram(e,t,i,s,r){const n=this.#jt(t,i),a=this.#kt(n,s,r);return this.#Wt.set(e,n),this.#Gt.set(e,a),Promise.resolve()}#jt(e,t){const i=this.#Pt,s=i.createProgram();if(s){const r=this.#Vt(i,e,i.VERTEX_SHADER);r?i.attachShader(s,r):_(d.WEBGL_ERROR,"#compileShader(vertexShaderSource) is null");const n=this.#Vt(i,t,i.FRAGMENT_SHADER);if(n?i.attachShader(s,n):_(d.WEBGL_ERROR,"#compileShader(fragmentShaderSource) is null"),i.linkProgram(s),!i.getProgramParameter(s,i.LINK_STATUS)){const e=i.getProgramInfoLog(s);_(d.WEBGL_ERROR,`Could not compile WebGL program. \n\n${e}`)}}else _(d.WEBGL_ERROR,"gl.createProgram() is null");return s}#kt(e,t,i){const s=this.#Pt;let r={};return t.forEach((t=>{r[t]=s.getUniformLocation(e,t)})),i.forEach((t=>{r[t]=s.getAttribLocation(e,t)})),r}#Vt(e,t,i){const s=e.createShader(i);if(s){if(e.shaderSource(s,t),e.compileShader(s),!e.getShaderParameter(s,e.COMPILE_STATUS)){const t=e.getShaderInfoLog(s);_(d.WEBGL_ERROR,"Couldn't compile webGl program. \n\n"+t)}}else _(d.WEBGL_ERROR,`gl.createShader(${i}) is null`);return s}_bindPrimitives=(e,t,i,s,r)=>{const[n,a]=!0===e.isOffsetTurnedOff?[0,0]:i.worldOffset,o=e.x-n,d=e.y-a,h=[1,1],c=e.rotation,u=e.blendFunc?e.blendFunc:[t.SRC_ALPHA,t.ONE_MINUS_SRC_ALPHA],{u_translation:g,u_rotation:m,u_scale:_,u_resolution:T,u_color:p,a_position:A,u_fade_min:R}=r;let S=0;switch(t.useProgram(s),t.uniform2f(T,t.canvas.width,t.canvas.height),t.uniform2f(g,o,d),t.uniform2f(_,h[0],h[1]),t.uniform1f(m,c),t.uniform1f(R,0),t.enableVertexAttribArray(A),t.bindBuffer(t.ARRAY_BUFFER,this.#Nt),e.type){case l.DRAW_TYPE.RECTANGLE:this.#Yt(e.width,e.height),S+=6;break;case l.DRAW_TYPE.TEXT:break;case l.DRAW_TYPE.CIRCLE:{const i=e.vertices;t.bufferData(t.ARRAY_BUFFER,new Float32Array(i),t.STATIC_DRAW),S+=i.length/2;break}case l.DRAW_TYPE.POLYGON:{const t=this.#Xt(e.vertices);this.#zt(t);const i=t.length;if(i%3!=0)return f(E,`polygons ${e.id}, vertices are not correct, skip drawing`),Promise.reject();S+=i/2;break}}const b=t.FLOAT;t.vertexAttribPointer(A,2,b,!1,0,0);const x=this.#Ht(e.bgColor);return t.uniform4f(p,x[0]/255,x[1]/255,x[2]/255,x[3]),u&&t.blendFunc(u[0],u[1]),e.isMaskAttached?t.stencilFunc(t.EQUAL,e._maskId,255):e._isMask&&t.stencilFunc(t.ALWAYS,e.id,255),this._render(S,t.TRIANGLES)};_bindConus=(e,t,i,s,r)=>{const[n,a]=!0===e.isOffsetTurnedOff?[0,0]:i.worldOffset,o=e.x-n,l=e.y-a,d=[1,1],h=e.rotation,{u_translation:c,u_rotation:u,u_scale:g,u_resolution:m,u_color:E,a_position:_,u_fade_max:f,u_fade_min:T}=r,p=e.vertices,A=e.bgColor,R=e.fade_min,S=e.radius,b=e.blendFunc?e.blendFunc:[t.SRC_ALPHA,t.ONE_MINUS_SRC_ALPHA];let x=0;t.useProgram(s),t.uniform2f(m,t.canvas.width,t.canvas.height),t.uniform2f(c,o,l),t.uniform2f(g,d[0],d[1]),t.uniform1f(u,h),t.uniform1f(T,R),t.uniform1f(f,S),t.bindBuffer(t.ARRAY_BUFFER,this.#Nt),t.bufferData(t.ARRAY_BUFFER,new Float32Array(p),t.STATIC_DRAW),t.enableVertexAttribArray(_);const y=t.FLOAT;t.vertexAttribPointer(_,2,y,!1,0,0),x+=p.length/2,b&&t.blendFunc(b[0],b[1]);const v=this.#Ht(A);return t.uniform4f(E,v[0]/255,v[1]/255,v[2]/255,v[3]),e.isMaskAttached?t.stencilFunc(t.EQUAL,e._maskId,255):e._isMask&&t.stencilFunc(t.ALWAYS,e.id,255),this._render(x,t.TRIANGLE_FAN)};_bindText=(e,t,i,s,r)=>{const{u_translation:n,u_rotation:a,u_scale:o,u_resolution:l,a_position:d,a_texCoord:h,u_image:c}=r,{width:u,height:g}=e.boundariesBox,[m,E]=(e.text,!0===e.isOffsetTurnedOff?[0,0]:i.worldOffset),_=e.x-m,f=e.y-E-g,T=e.blendFunc?e.blendFunc:[t.ONE,t.ONE_MINUS_SRC_ALPHA],p=[1,1],A=_+u,R=f+g,S=[_,f,A,f,_,R,_,R,A,f,A,R];let b=0;t.useProgram(s),t.uniform2f(l,t.canvas.width,t.canvas.height),t.uniform2f(n,_,f),t.uniform2f(o,p[0],p[1]),t.uniform1f(a,0),t.bindBuffer(t.ARRAY_BUFFER,this.#Nt),t.bufferData(t.ARRAY_BUFFER,new Float32Array(S),t.STATIC_DRAW),t.enableVertexAttribArray(d);const x=t.FLOAT;t.vertexAttribPointer(d,2,x,!1,0,0),t.bindBuffer(t.ARRAY_BUFFER,this.#Bt),t.bufferData(t.ARRAY_BUFFER,new Float32Array([0,0,1,0,0,1,0,1,1,0,1,1]),t.STATIC_DRAW),t.enableVertexAttribArray(h),t.vertexAttribPointer(h,2,t.FLOAT,!1,0,0),b+=6,t.blendFunc(T[0],T[1]);let y=e._textureStorage;return y||(y=new ye(t.createTexture()),e._textureStorage=y),!0===y._isTextureRecalculated?(this.#Kt(t,y._texture,e._textureCanvas),y._isTextureRecalculated=!1):this.#qt(t,y._texture),t.uniform1i(c,y._textureIndex),t.depthMask(!1),this._render(6,t.TRIANGLES)};_bindImage=(e,t,i,s,r)=>{const[n,a]=!0===e.isOffsetTurnedOff?[0,0]:i.worldOffset,o=e.x-n,l=e.y-a;e.vertices&&this.#Mt.debug.boundaries.drawObjectBoundaries&&(i._enableDebugObjectBoundaries(),i._addImageDebugBoundaries(be(o,l,e.rotation,e.vertices)));const{u_translation:h,u_rotation:c,u_scale:u,u_resolution:g,a_position:m,a_texCoord:E,u_image:f}=r;if(!e.image){const t=this.#vt.getImage(e.key);t?e.image=t:_(d.CANT_GET_THE_IMAGE,"iLoader can't get the image with key: "+e.key)}const T=e.image,p=e.imageIndex,A=e._maskId,R=e.spacing,S=e.margin,b=e.blendFunc?e.blendFunc:[t.ONE,t.ONE_MINUS_SRC_ALPHA],x=[1,1];let y=S,v=S,I=0,w=0,O=0;if(0!==p){const t=(T.width+R-2*S)/(e.width+R);I=p%t,w=Math.floor(p/t),y=I*e.width+I*R+S,v=w*e.height+w*R+S}const C=o-e.width/2,P=l-e.height/2,D=C+e.width,L=P+e.height,M=1/T.width*y,N=1/T.height*v,B=M+1/T.width*e.width,W=N+1/T.height*e.height,G=[C,P,D,P,C,L,C,L,D,P,D,L],F=[M,N,B,N,M,W,M,W,B,N,B,W];t.useProgram(s),t.uniform2f(g,t.canvas.width,t.canvas.height),t.uniform2f(h,o,l),t.uniform2f(u,x[0],x[1]),t.uniform1f(c,e.rotation),t.bindBuffer(t.ARRAY_BUFFER,this.#Nt),t.bufferData(t.ARRAY_BUFFER,new Float32Array(G),t.STATIC_DRAW),O+=G.length/2,t.enableVertexAttribArray(m);const U=t.FLOAT;t.vertexAttribPointer(m,2,U,!1,0,0),t.bindBuffer(t.ARRAY_BUFFER,this.#Bt),t.bufferData(t.ARRAY_BUFFER,new Float32Array(F),t.STATIC_DRAW),t.enableVertexAttribArray(E),t.vertexAttribPointer(E,2,t.FLOAT,!1,0,0);let j=e._textureStorage;return j||(j=new ye(t.createTexture()),e._textureStorage=j),!0===j._isTextureRecalculated?(this.#Jt(t,j._texture,e.image),j._isTextureRecalculated=!1):this.#qt(t,j._texture),t.uniform1i(f,j._textureIndex),t.blendFunc(b[0],b[1]),A&&t.stencilFunc(t.EQUAL,A,255),this._render(O,t.TRIANGLES)};_bindTileImages=async(e,t,i,s,r)=>{const{u_translation:n,u_rotation:a,u_scale:o,u_resolution:d,a_position:h,a_texCoord:c,u_image:u}=r;let g;switch(t.useProgram(s),this.#Mt.optimization){case l.OPTIMIZATION.NATIVE_JS.NOT_OPTIMIZED:g=await this.#Zt(e,i);break;case l.OPTIMIZATION.WEB_ASSEMBLY.ASSEMBLY_SCRIPT:case l.OPTIMIZATION.WEB_ASSEMBLY.NATIVE_WAT:g=await this.#Qt(e,i);break;case l.OPTIMIZATION.NATIVE_JS.OPTIMIZED:default:g=await this.#$t(e,i)}const m=[0,0],E=[1,1],_=["ONE","ONE_MINUS_SRC_ALPHA"],f=e._maskId;let T=0,p=!1;t.enableVertexAttribArray(h),t.enableVertexAttribArray(c),t.uniform2f(d,t.canvas.width,t.canvas.height),t.uniform2f(n,m[0],m[1]),t.uniform2f(o,E[0],E[1]),t.uniform1f(a,0);for(let i=0;i<g.length;i++){const s=g[i],r=s[0],n=s[1],a=(s[2],s[3]);if(r.length>0&&n.length>0){p&&await this._render(T,t.TRIANGLES),t.bindBuffer(t.ARRAY_BUFFER,this.#Nt),t.bufferData(t.ARRAY_BUFFER,r,t.STATIC_DRAW);const s=2,o=t.FLOAT,l=!1,d=0,g=0;t.vertexAttribPointer(h,s,o,l,d,g),t.bindBuffer(t.ARRAY_BUFFER,this.#Bt),t.bufferData(t.ARRAY_BUFFER,n,t.STATIC_DRAW),t.vertexAttribPointer(c,2,t.FLOAT,!1,0,g);let m=e._textureStorages[i];m||(m=new ye(t.createTexture(),i),e._setTextureStorage(i,m)),!0===m._isTextureRecalculated?(this.#Jt(t,m._texture,a,m._textureIndex),m._isTextureRecalculated=!1):this.#qt(t,m._texture,m._textureIndex),t.uniform1i(u,m._textureIndex),t.blendFunc(t[_[0]],t[_[1]]),T=r.length/2,f&&t.stencilFunc(t.EQUAL,f,255),p=!0}}return this._render(T,t.TRIANGLES)};_drawPolygon(e,t){const[i,s]=!0===e.isOffsetTurnedOff?[0,0]:t.worldOffset,r=e.x-i,n=e.y-s,a=e.rotation||0,o=e.vertices,d=this.#Mt.debug.boundaries.boundariesColor,h=this.getProgram(l.WEBGL.DRAW_PROGRAMS.PRIMITIVES),{u_translation:c,u_rotation:u,u_scale:g,u_resolution:m,u_color:_,a_position:T,u_fade_max:p,u_fade_min:A}=this.getProgramVarLocations(l.WEBGL.DRAW_PROGRAMS.PRIMITIVES),R=this.#Pt;let S=0;R.useProgram(h),R.uniform2f(m,R.canvas.width,R.canvas.height),R.uniform2f(c,r,n),R.uniform2f(g,1,1),R.uniform1f(u,a),R.uniform1f(A,0),R.enableVertexAttribArray(T),R.bindBuffer(R.ARRAY_BUFFER,this.#Nt);const b=this.#Xt(o),x=b.length;if(x%3!=0)return void f(E,"polygon boundaries vertices are not correct, skip drawing");this.#zt(b),S+=x/2;const y=R.FLOAT;R.vertexAttribPointer(T,2,y,!1,0,0);const v=this.#Ht(d);R.uniform4f(_,v[0]/255,v[1]/255,v[2]/255,v[3]),this._render(S,R.TRIANGLES)}_bindLine=(e,t,i,s,r)=>{const[n,a]=!0===e.isOffsetTurnedOff?[0,0]:i.worldOffset,o=e.x-n,l=e.y-a,d=e.rotation,{u_translation:h,u_rotation:c,u_scale:u,u_resolution:g,u_color:m,a_position:E,u_fade_max:_,u_fade_min:f}=r,T=e.vertices,p=e.bgColor,A=(e.fade_min,e.radius,this.#Mt.debug.boundaries.boundariesWidth);let R=0;t.useProgram(s),t.uniform2f(g,t.canvas.width,t.canvas.height),t.uniform2f(h,o,l),t.uniform2f(u,1,1),t.uniform1f(c,d),t.uniform1f(f,0),t.enableVertexAttribArray(E),t.bindBuffer(t.ARRAY_BUFFER,this.#Nt),t.bufferData(t.ARRAY_BUFFER,new Float32Array(T),t.STATIC_DRAW),R+=T.length/2;const S=t.FLOAT;t.vertexAttribPointer(E,2,S,!1,0,0);const b=this.#Ht(p);return t.uniform4f(m,b[0]/255,b[1]/255,b[2]/255,b[3]),t.lineWidth(A),this._render(0,t.LINES)};_drawLines(e,t,i=1,s=0,r=[0,0]){const n=this.getProgram(l.WEBGL.DRAW_PROGRAMS.PRIMITIVES),{u_translation:a,u_rotation:o,u_scale:d,u_resolution:h,u_color:c,a_position:u,u_fade_max:g,u_fade_min:m}=this.getProgramVarLocations(l.WEBGL.DRAW_PROGRAMS.PRIMITIVES),E=this.#Pt;let _=0;E.useProgram(n),E.uniform2f(h,E.canvas.width,E.canvas.height),E.uniform2f(a,r[0],r[1]),E.uniform2f(d,1,1),E.uniform1f(o,s),E.uniform1f(m,0),E.enableVertexAttribArray(u),E.bindBuffer(E.ARRAY_BUFFER,this.#Nt),E.bufferData(E.ARRAY_BUFFER,e instanceof Float32Array?e:new Float32Array(e),E.STATIC_DRAW),_+=e.length/2;const f=E.FLOAT;E.vertexAttribPointer(u,2,f,!1,0,0);const T=this.#Ht(t);E.uniform4f(c,T[0]/255,T[1]/255,T[2]/255,T[3]),E.lineWidth(i),this._render(_,E.LINES)}_registerObjectRender(e,t,i){this.#Ft.set(e,{method:t,webglProgramName:i})}_drawRenderObject(e,t){const i=e.constructor.name,s=this.#Ft.get(i)||this.#Ft.get(e.type);if(s){const i=s.webglProgramName,r=i?this.getProgram(i):null,n=i?this.getProgramVarLocations(i):null;return s.method(e,this.#Pt,t,r,n)}return console.warn("no registered draw object method for "+i+" skip draw"),Promise.resolve()}#$t(e,t){return new Promise(((i,s)=>{const r=e.tilemap,n=e.tilesets,a=e.tilesetImages,o=e.layerData,{tileheight:l,tilewidth:d}=r,c=d,u=l,[g,m]=t.canvasDimensions,[E,_]=!0===e.isOffsetTurnedOff?[0,0]:t.worldOffset,T=(this.#Mt.render.boundaries.realtimeCalculations,e.setBoundaries),p=[];o||(f(h,"check tilemap and layers name"),s()),this.#Mt.render.boundaries.mapBoundariesEnabled&&t._setMapBoundaries();for(let e=0;e<n.length;e++){const i=n[e].data,s=n[e].firstgid,r=n[e+1],h=r?r.firstgid:1e9,A=i.tilewidth,R=i.tileheight,S=a[e],b=i.imagewidth,x=i.imageheight,y=i.columns,v=o.width,I=o.height,w=c*v,O=u*I,C=_%u,P=E%c,D=0!==_?Math.floor(_/u):0,L=0!==E?Math.floor(E/c):0,M=O>m?Math.ceil(m/u)+1:I,N=w>g?Math.ceil(g/c)+1:v,B=M*N,W=v-N-L,G=i.spacing,F=i.margin,U=i._hasAnimations,j=i._hasBoundaries,k=i._boundaries,V=n[e]._temp;V.cells!==B&&V._initiateStorageData(B);let Y=V.vectors,X=V.textures,z=0;Y.fill(0),X.fill(0);let H=V._bTempIndexes;const K=4*N;let q=D*v;for(let e=0;e<M;e++){q+=L;for(let r=0;r<N;r++){let n=o.data[q];if(n>=s&&n<h){const a=r*d-P,o=e*l-C;if(n-=s,U){const e=i._animations.get(n);void 0!==e&&(n=e)}const h=n%y,c=Math.floor(n/y),u=a,g=o,m=a+A,E=o+R,_=1/b*(h*A+h*G+F),p=1/x*(c*R+c*G+F),S=_+1/b*A,v=p+1/x*R;if(Y[z]=u,X[z]=_,z++,Y[z]=g,X[z]=p,z++,Y[z]=m,X[z]=S,z++,Y[z]=g,X[z]=p,z++,Y[z]=u,X[z]=_,z++,Y[z]=E,X[z]=v,z++,Y[z]=u,X[z]=_,z++,Y[z]=E,X[z]=v,z++,Y[z]=m,X[z]=S,z++,Y[z]=g,X[z]=p,z++,Y[z]=m,X[z]=S,z++,Y[z]=E,X[z]=v,z++,T){let i=!1;if(j&&k.size>0){const e=k.get(n);e&&(i=!0,e.objects.forEach((e=>{const i=a+e.x,s=o+e.y;if(0!==e.rotation&&f("tilesetData.tiles.rotation property is not supported yet"),e.polygon)e.polygon.forEach(((r,n)=>{const a=e.polygon[n+1];if(a)t._addBoundaryLine(r.x+i,r.y+s,a.x+i,a.y+s);else{const n=e.polygon[0];t._addBoundaryLine(r.x+i,r.y+s,n.x+i,n.y+s)}}));else if(e.point)t._addPointBoundary(i,s);else if(e.ellipse){const r=e.width/2,n=e.height/2;t._addEllipseBoundary(i+r,s+n,r,n)}else{const r=e.width,n=e.height,a=r+i,o=n+s;t._addBoundaryLine(i,s,a,s),t._addBoundaryLine(a,s,a,o),t._addBoundaryLine(a,o,i,o),t._addBoundaryLine(i,o,i,s)}})))}if(!1===i){const i=t.getRawBoundaries();let s=[a+A,o,a+A,o+R],n=[a+A,o+R,a,o+R],l=[a,o,a+A,o],d=[a,o+R,a,o];if(0!==e){const n=(e-1)*K+4*r,a=H[n+2];if(a){const e=i[a];if(e){const s=i[a+1],r=i[a+2],n=i[a+3],o=l[0],d=l[1],h=l[2],c=l[3];o===r&&d===n&&h===e&&c===s&&(t._removeBoundaryLine(a),l=void 0)}const r=H[n+1],o=i[r];if(o){const e=i[r+1],n=i[r+2],a=i[r+0];o===i[r+2]&&n===a&&(t._removeBoundaryLine(r),s[0]=o,s[1]=e)}const h=H[n+3],c=i[h];if(c){const e=i[h+2],s=i[h+3],r=d[0];c===d[2]&&e===r&&(t._removeBoundaryLine(h),d[2]=e,d[3]=s)}}}if(0!==r){const s=e*K+4*(r-1),a=H[s];if(a){const e=H[s+1],r=i[e],o=i[e+1],h=i[e+2],c=i[e+3],u=d[0],g=d[1],m=d[2],E=d[3];u===h&&g===c&&m===r&&E===o&&(t._removeBoundaryLine(e),d=void 0);const _=i[a];if(_&&l){const e=i[a+1],s=i[a+3],r=l[1];e===l[3]&&s===r&&(t._removeBoundaryLine(a),l[0]=_,l[1]=e)}const f=H[s+2];if(i[f]){const e=i[f+1],s=i[f+2],r=i[f+3],a=n[1];e===n[3]&&r===a&&(t._removeBoundaryLine(f),n[2]=s,n[3]=r)}}}const h=e*K+4*r;l&&(t._addBoundaryLine(l[0],l[1],l[2],l[3]),H[h+0]=t.boundariesLen-4),t._addBoundaryLine(s[0],s[1],s[2],s[3]),H[h+1]=t.boundariesLen-4,t._addBoundaryLine(n[0],n[1],n[2],n[3]),H[h+2]=t.boundariesLen-4,d&&(t._addBoundaryLine(d[0],d[1],d[2],d[3]),H[h+3]=t.boundariesLen-4)}}}q++}q+=W}p.push([Y,X,i.name,S]),H.fill(0)}i(p)}))}#Zt(e,t){return new Promise(((i,s)=>{const r=e.tilemap,n=e.tilesets,a=e.tilesetImages,o=e.layerData,{tileheight:l,tilewidth:d}=r,[c,u]=!0===e.isOffsetTurnedOff?[0,0]:t.worldOffset;let g=[];o||(f(h,"check tilemap and layers name"),s()),this.#Mt.render.boundaries.mapBoundariesEnabled&&t._setMapBoundaries();for(let e=0;e<=n.length-1;e++){const t=n[e].data,i=n[e].firstgid,s=n[e+1],r=s?s.firstgid:1e9,h=t.tilewidth,m=t.tileheight,E=t.columns,_=o.width,f=o.height,T=a[e],p=T.width,A=T.height,R=t.spacing,S=t.margin,b=n[e]._temp;let x=0,y=b.vectors,v=b.textures,I=0;y.fill(0),v.fill(0);for(let e=0;e<f;e++)for(let t=0;t<_;t++){let s=o.data[x];if(s>=i&&s<r){s-=i;const r=s%E,n=Math.floor(s/E),a=t*d-c,o=e*l-u,g=a+h,_=o+m,f=1/p*(r*h+r*R+S),T=1/A*(n*m+n*R+S),b=f+1/p*h,x=T+1/A*m;y[I]=a,v[I]=f,I++,y[I]=o,v[I]=T,I++,y[I]=g,v[I]=b,I++,y[I]=o,v[I]=T,I++,y[I]=a,v[I]=f,I++,y[I]=_,v[I]=x,I++,y[I]=a,v[I]=f,I++,y[I]=_,v[I]=x,I++,y[I]=g,v[I]=b,I++,y[I]=o,v[I]=T,I++,y[I]=g,v[I]=b,I++,y[I]=_,v[I]=x,I++}x++}g.push([y,v,t.name,T])}i(g)}))}#Qt=(e,t)=>new Promise(((i,s)=>{const r=e.tilemap,n=r.tilesets,a=e.tilesetImages,o=e.layerData,{tileheight:l,tilewidth:d}=r,c=o.data.length,u=o.data.filter((e=>0!==e)).length,[g,m]=t.worldDimensions,[E,_]=!0===e.isOffsetTurnedOff?[0,0]:t.worldOffset,T=[];this.layerDataFloat32.set(o.data),o||(f(h,"check tilemap and layers name"),s()),this.#Mt.render.boundaries.mapBoundariesEnabled&&t._setMapBoundaries();for(let e=0;e<n.length;e++){const t=n[e].data,i=n[e].firstgid,s=n[e+1],r=s?s.firstgid:1e9,h=t.tilewidth,g=t.tileheight,m=t.columns,f=o.width,p=o.height,A=a[e],R=A.width,S=A.height,b=4,x=12*u,y=12*u,v=t.spacing,I=(t.margin,this.calculateBufferData(b,c,x,p,f,d,l,h,g,m,R,S,E,_,i,r,v,!1)),w=I>0?this.layerDataFloat32.slice(c,x+c):[],O=I>0?this.layerDataFloat32.slice(x+c,x+y+c):[];T.push([w,O,t.name,A])}i(T)}));#Ht(e){return e.replace("rgba(","").replace(")","").split(",").map((e=>Number(e.trim())))}#Xt(e){const t=new Float32Array(e.length*e.length),[i,s]=this.#ei(e,t,0);return i.slice(0,s)}#ei(e,t,i){const s=e.length;if(s<=3)return e.forEach((e=>{t[i]=e[0],i++,t[i]=e[1],i++})),[t,i];const r=[...e].sort(((e,t)=>t[1]-e[1])),n=e.indexOf(r[0]),a=n!==s-1?n+1:0;let o=e,l=o.length,d=0,h=a;for(;o.length>2;){const e=o.length;h>=e&&(h-=e);const s=0===h?o[e-1]:o[h-1],r=o[h],n=e===h+1?o[0]:o[h+1];if(c=s,u=r,ae({x:(g=n)[0]-c[0],y:g[1]-c[1]},{x:u[0]-c[0],y:u[1]-c[1]})<0)t[i]=s[0],i++,t[i]=s[1],i++,t[i]=r[0],i++,t[i]=r[1],i++,t[i]=n[0],i++,t[i]=n[1],i++,o=o.filter(((e,t)=>t!==h));else{if(d+=1,d>l)return f("TRIANGULATE_ISSUE","Can't extract all triangles vertices."),[t,i];h++}}var c,u,g;return[t,i]}#zt(e){this.#Pt.bufferData(this.#Pt.ARRAY_BUFFER,new Float32Array(e),this.#Pt.STATIC_DRAW)}#Yt(e,t){const i=0+e,s=0+t;this.#Pt.bufferData(this.#Pt.ARRAY_BUFFER,new Float32Array([0,0,i,0,0,s,0,s,i,0,i,s]),this.#Pt.STATIC_DRAW)}#Jt(e,t,i,s=0,r=!1){this.#qt(e,t,s),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,i),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,r?e.LINEAR_MIPMAP_LINEAR:e.LINEAR)}#Kt(e,t,i,s=0){this.#qt(e,t,s),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,i),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST)}#qt(e,t,i=0){e.activeTexture(e.TEXTURE0+i),e.bindTexture(e.TEXTURE_2D,t)}#ti(e,t){e.deleteTexture(t)}isPowerOfTwo(e){return!(e&e-1)}nextHighestPowerOfTwo(e){--e;for(var t=1;t<32;t<<=1)e|=e>>t;return e+1}}const Ie=["u_translation","u_rotation","u_scale","u_resolution","u_image"],we=["a_position","a_texCoord"],Oe=["u_translation","u_rotation","u_scale","u_resolution","u_fade_min","u_fade_max","u_color"],Ce=["a_position"],Pe=["u_resolution","u_image"],De=["a_position","a_texCoord"];class Le{#ii=0;#si=0;#ri=0;#ni;#ai=0;constructor(e){this.#ni=new Float32Array(e)}get drawCalls(){return this.#si}get verticesDraw(){return this.#ii}get tempRCircleT(){return this.#ni}get tempRCircleTPointer(){return this.#ai}set tempRCircleT(e){this.#ni[this.#ai]=e}set prevDrawTime(e){this.#ri=e}currentDrawTime(e){return e-this.#ri}incrementTempRCircleTPointer(){this.#ai++}incrementDrawCallsCounter(){this.#si+=1}set verticesDraw(e){this.#ii+=e}cleanupDebugInfo(){this.#ii=0,this.#si=0}cleanupDrawCallsCounter(){this.#si=0}cleanupTempVars(){this.#ni.fill(0),this.#ai=0}}class Me{#r;#oi;#li;#di;#hi;#ci;#ct;#z=new EventTarget;constructor(e,t,i){this.#ct=e,this.#hi=t,this.#li=new Le(this.#ct.gameOptions.render.cyclesTimeCalc.averageFPStime),this.#ci=i,this.#ci._initDrawCallsDebug(this.renderLoopDebug),this.#ct.gameOptions.render.cyclesTimeCalc.check===l.OPTIMIZATION.CYCLE_TIME_CALC.AVERAGES&&(this.#di=setInterval((()=>this.#ui()),this.#ct.gameOptions.render.cyclesTimeCalc.averageFPStime))}get stageData(){return this.#hi}get renderLoopDebug(){return this.#li}set _isCleared(e){this.#oi=e}get _isCleared(){return this.#oi}_start(){this.#r=!0,requestAnimationFrame(this.#gi)}_stop(){this.#r=!1,this.#hi=null,this.renderLoopDebug.cleanupTempVars(),clearInterval(this.#di)}#gi=e=>{if(!this.#r)return;const t=this.renderLoopDebug.currentDrawTime(e);this.renderLoopDebug.prevDrawTime=e;const i=performance.now(),s=this.#ct.gameOptions.render.cyclesTimeCalc.check===l.OPTIMIZATION.CYCLE_TIME_CALC.CURRENT;this.emit(l.EVENTS.SYSTEM.RENDER.START),this.#hi._clearBoundaries(),this.#mi(),this.render().then((()=>{const e=performance.now()-i;s?(console.log("current draw take: ",t," ms"),console.log("current render() time: ",e),console.log("draw calls: ",this.renderLoopDebug.drawCalls),console.log("vertices draw: ",this.renderLoopDebug.verticesDraw)):(this.renderLoopDebug.tempRCircleT=t,this.renderLoopDebug.incrementTempRCircleTPointer()),this.emit(l.EVENTS.SYSTEM.RENDER.END),this.#r&&setTimeout((()=>requestAnimationFrame(this.#gi)),0)})).catch((e=>{e.forEach?e.forEach((e=>{f(u,e)})):f(u,e.message),this._stop()}))};async render(){const e=this.#hi.renderObjects;let t=[],i=!1,s=e.length,r=new Array(s),n=s;if(0!==s){for(let t=0;t<s;t++){const i=e[t];if(i.isRemoved){e.splice(t,1),t--,s--;continue}i.hasAnimations&&i._processActiveAnimations();const n=await this.#Ei(i).catch((e=>Promise.reject(e)));r[t]=n}this.#ct.gameOptions.debug.boundaries.drawLayerBoundaries&&r.push(this.#_i().catch((e=>Promise.reject(e))))}return(await Promise.allSettled(r)).forEach((e=>{"rejected"===e.status&&(Promise.reject(e.reason),i=!0,t.push(e.reason))})),this._isCleared=!1,!1===i?Promise.resolve(n):Promise.reject(t)}addEventListener=(e,t,i)=>{this.#z.addEventListener(e,t,i)};removeEventListener=(e,t,i)=>{this.#z.removeEventListener(e,t,i)};emit=(e,...t)=>{const i=new Event(e);i.data=[...t],this.#z.dispatchEvent(i)};#Ei(e){return this.#ci._preRender().then((()=>this.#ci._drawRenderObject(e,this.stageData))).then((e=>this.#ci._postRender(e)))}#mi(){this.#ci._clearView()}#_i(){return new Promise((e=>{const t=this.stageData.getRawBoundaries(),i=this.stageData.getEllipseBoundaries(),s=this.stageData.getPointBoundaries(),r=this.stageData.getDebugObjectBoundaries(),n=this.stageData.boundariesLen,a=this.stageData.ellipseBLen,o=this.stageData.pointBLen,l=this.#ct.gameOptions.debug.boundaries.drawObjectBoundaries?r.length:0;if(n&&this.#ci._drawLines(t,this.#ct.gameOptions.debug.boundaries.boundariesColor,this.#ct.gameOptions.debug.boundaries.boundariesWidth),this.renderLoopDebug.incrementDrawCallsCounter(),a)for(let e=0;e<a;e+=4){const t=xe(i[e],i[e+1],i[e+2],i[e+3]);this.#ci._drawPolygon({x:0,y:0,vertices:t,isOffsetTurnedOff:!0},this.stageData),this.renderLoopDebug.incrementDrawCallsCounter()}if(o)for(let e=0;e<o;e+=2){const t=s[e],i=s[e+1],r=[t,i,t+1,i+1];this.#ci._drawLines(r,this.#ct.gameOptions.debug.boundaries.boundariesColor,this.#ct.gameOptions.debug.boundaries.boundariesWidth),this.renderLoopDebug.incrementDrawCallsCounter()}l>0&&this.#ci._drawLines(r,this.#ct.gameOptions.debug.boundaries.boundariesColor,this.#ct.gameOptions.debug.boundaries.boundariesWidth),e()}))}#fi(e){return new Promise(((e,t)=>{}))}#ui(){const e=this.#ct.gameOptions.render.cyclesTimeCalc.averageFPStime,t=this.renderLoopDebug.tempRCircleTPointer;let i=0;for(let e=0;e<t;e++)i+=this.renderLoopDebug.tempRCircleT[e];console.log("FPS average for",e/1e3,"sec, is ",(1e3/(i/t)).toFixed(2)),console.log("Last loop info:"),console.log("Webgl draw calls: ",this.renderLoopDebug.drawCalls),console.log("Vertices draw: ",this.renderLoopDebug.verticesDraw),this.renderLoopDebug.cleanupTempVars()}}class Ne{#Ti;#pi;#ci;#Ai;#Ri;#vt;#Si;#bi=!1;#xi=[];#z=new EventTarget;constructor(e,t,i){this.#Ti=document.createElement("canvas"),i.appendChild(this.#Ti),this.#pi=this.#Ti.getContext("webgl",{stencil:!0}),this.#Ri=e,this.#vt=t,this.#bi=this.systemSettings.gameOptions.render.boundaries.wholeWorldPrecalculations,this.#ci=new ve(this.#pi,this.#Ri.gameOptions,this.iLoader),this._registerRenderInit(this.#ci._initiateJsRender),this.systemSettings.gameOptions.optimization!==l.OPTIMIZATION.WEB_ASSEMBLY.NATIVE_WAT&&this.systemSettings.gameOptions.optimization!==l.OPTIMIZATION.WEB_ASSEMBLY.ASSEMBLY_SCRIPT||this._registerRenderInit(this.#ci._initiateWasm),this._registerRenderInit(this.fixCanvasSize),this._registerRenderInit((()=>this._registerAndCompileWebGlProgram(l.WEBGL.DRAW_PROGRAMS.IMAGES,"\n    attribute vec2 a_texCoord;\n\n    attribute vec2 a_position;\n\n    uniform vec2 u_translation;\n    uniform float u_rotation;\n    uniform vec2 u_scale;\n\n    uniform vec2 u_resolution;\n\n    varying vec2 v_texCoord;\n\n    void main(void) {\n        float c = cos(u_rotation);\n        float s = sin(u_rotation);\n\n        mat3 translationMatrix1 = mat3(\n            1, 0, 0,\n            0, 1, 0,\n            u_translation.x, u_translation.y, 1\n        );\n\n        mat3 translationMatrix2 = mat3(\n            1, 0, 0,\n            0, 1, 0,\n            -u_translation.x, -u_translation.y, 1\n        );\n        \n        mat3 rotationMatrix = mat3(\n            c, s, 0,\n            -s, c, 0,\n            0, 0, 1\n        );\n\n        mat3 scalingMatrix = mat3(\n            u_scale.x, 0, 0,\n            0, u_scale.y, 0,\n            0, 0, 1\n        );\n\n        mat3 matrix = translationMatrix1 * rotationMatrix * translationMatrix2 * scalingMatrix;\n    \n        vec2 position = (matrix * vec3(a_position, 1)).xy;\n\n        vec2 clipSpace = position / u_resolution * 2.0 - 1.0;\n\n        gl_Position = vec4(clipSpace * vec2(1, -1), 0, 1);\n        \n        v_texCoord = a_texCoord;\n    }","\n    precision mediump float;\n\n    uniform sampler2D u_image;\n\n    //texCoords passed in from the vertex shader\n    varying vec2 v_texCoord;\n    void main() {\n        vec4 color = texture2D(u_image, v_texCoord);\n        gl_FragColor = color;\n    }",Ie,we))),this._registerRenderInit((()=>this._registerAndCompileWebGlProgram(l.WEBGL.DRAW_PROGRAMS.PRIMITIVES,"\n    precision mediump float;\n\n    attribute vec2 a_position;\n\n    uniform vec2 u_translation;\n    uniform float u_rotation;\n    uniform vec2 u_scale;\n\n    uniform vec2 u_resolution;\n\n    void main(void) {\n        float c = cos(u_rotation);\n        float s = sin(u_rotation);\n\n        mat3 translationMatrix1 = mat3(\n            1, 0, 0,\n            0, 1, 0,\n            u_translation.x, u_translation.y, 1\n        );\n\n        //mat3 translationMatrix2 = mat3(\n        //    1, 0, 0,\n        //    0, 1, 0,\n        //    -u_translation.x, -u_translation.y, 1\n        //);\n        \n        mat3 rotationMatrix = mat3(\n            c, s, 0,\n            -s, c, 0,\n            0, 0, 1\n        );\n\n        mat3 scalingMatrix = mat3(\n            u_scale.x, 0, 0,\n            0, u_scale.y, 0,\n            0, 0, 1\n        );\n        \n        mat3 matrix = translationMatrix1 * rotationMatrix * scalingMatrix;\n\n        vec2 position = (matrix * vec3(a_position, 1)).xy;\n\n        vec2 clipSpace = position / u_resolution * 2.0 - 1.0;\n\n        gl_Position = vec4(clipSpace * vec2(1, -1), 0, 1);\n    }\n","\n    precision mediump float;\n\n    uniform vec4 u_color;\n    uniform float u_fade_min; \n    uniform float u_fade_max;\n    uniform vec2 u_resolution;\n    uniform vec2 u_translation;\n\n    void main(void) {\n        vec4 p = u_color;\n        if (u_fade_min > 0.0) {\n            vec2 fix_tr = vec2(u_translation.x, u_resolution.y - u_translation.y); \n            float distance = distance(fix_tr.xy, gl_FragCoord.xy);\n            if (u_fade_min <= distance && distance <= u_fade_max) {\n                float percent = ((distance - u_fade_max) / (u_fade_min - u_fade_max)) * 100.0;\n                p.a = u_color.a * (percent / 100.0);\n            }\n        }\n\n        gl_FragColor = p;\n    }\n",Oe,Ce))),this._registerRenderInit((()=>this._registerAndCompileWebGlProgram(l.WEBGL.DRAW_PROGRAMS.IMAGES_WITH_MERGE,"\n    attribute vec2 a_texCoord;\n\n    attribute vec2 a_position;\n\n    uniform vec2 u_resolution;\n\n    varying vec2 v_texCoord;\n\n    void main(void) {\n        vec2 clipSpace = a_position / u_resolution * 2.0 - 1.0;\n        gl_Position = vec4(clipSpace * vec2(1, -1), 0, 1);\n        v_texCoord = a_texCoord;\n    }","\n    precision mediump float;\n\n    uniform sampler2D u_image;\n\n    //texCoords passed in from the vertex shader\n    varying vec2 v_texCoord;\n    void main() {\n        vec4 color = texture2D(u_image, v_texCoord);\n        gl_FragColor = color;\n    }",Pe,De))),this._registerRenderInit(this.#ci._initWebGlAttributes)}_webGlEngine(){return this.#ci}addEventListener=(e,t,i)=>{this.#z.addEventListener(e,t,i)};removeEventListener=(e,t,i)=>{this.#z.removeEventListener(e,t,i)};get stageData(){return this.#Ai}get systemSettings(){return this.#Ri}get iLoader(){return this.#vt}get canvas(){return this.#Ti}get drawContext(){return this.#pi}emit=(e,...t)=>{const i=new Event(e);i.data=[...t],this.#z.dispatchEvent(i)};isAllFilesLoaded=()=>0===this.iLoader.filesWaitingForUpload;_isRenderActive(){return!!this.#Si&&this.#Si._isActive}initiateContext=e=>Promise.all(this.#xi.map((t=>t(e))));_registerAndCompileWebGlProgram(e,t,i,s,r){return this.#ci._registerAndCompileWebGlProgram(e,t,i,s,r),Promise.resolve()}_registerRenderInit(e){this.#xi.push(e)}_registerObjectRender(e,t,i){this.#ci._registerObjectRender(e,t,i)}setCanvasSize(e,t){this.#Ti.width=e,this.#Ti.height=t,this.#ci&&this.#ci._fixCanvasSize(e,t)}fixCanvasSize=()=>{const e=this.systemSettings,t=e.canvasMaxSize.width&&e.canvasMaxSize.width<window.innerWidth?e.canvasMaxSize.width:window.innerWidth,i=e.canvasMaxSize.height&&e.canvasMaxSize.height<window.innerHeight?e.canvasMaxSize.height:window.innerHeight;return this.setCanvasSize(t,i),Promise.resolve()};_createBoundariesPrecalculations(){}_startRender=async e=>{this.fixCanvasSize(),this.#Ai=e,this.systemSettings.gameOptions.library===l.LIBRARY.WEBGL&&(await this.#yi(),this.#Si=new Me(this.systemSettings,e,this._webGlEngine()),this.#Si.addEventListener(l.EVENTS.SYSTEM.RENDER.START,(()=>this.emit(l.EVENTS.SYSTEM.RENDER.START))),this.#Si.addEventListener(l.EVENTS.SYSTEM.RENDER.END,(()=>this.emit(l.EVENTS.SYSTEM.RENDER.END))),this.#Si._start())};_stopRender=()=>{this.#Si.removeEventListener(l.EVENTS.SYSTEM.RENDER.START,this.emit(l.EVENTS.SYSTEM.RENDER.START)),this.#Si.removeEventListener(l.EVENTS.SYSTEM.RENDER.END,this.emit(l.EVENTS.SYSTEM.RENDER.END)),this.#Si._stop(),this.#Si=void 0};#yi(){return new Promise(((e,t)=>{let i=[];const s=this.#bi;i.push(this.initiateContext(this.#Ai)),s&&console.warn("isBoundariesPrecalculations() is turned off"),Promise.allSettled(i).then((i=>{i.forEach((e=>{if("rejected"===e.status){const i=e.reason;f(u,i),t(i)}})),e()}))}))}}class Be{#vi;constructor(e){this.#vi=e}registerDrawObject(e,t){this.#vi.drawObjectFactory._registerNewObjectMethod(e,t)}registerAndCompileWebGlProgram(e,t,i,s,r){return this.#vi.iRender._registerAndCompileWebGlProgram(e,t,i,s,r)}registerRenderInit(e){this.#vi.iRender._registerRenderInit(e)}registerObjectRender(e,t,i){this.#vi.iRender._registerObjectRender(e,t,i)}}class We{#ct;#Ii;#wi;#Oi;#nt=new k;#Ci;#Pi=new X(this.#nt);#Di=new Map;#Li;#z=new EventTarget;constructor(e,t,i){e||_(d.CREATE_INSTANCE_ERROR,"systemSettings should be passed to class instance"),this.#ct=e,this.#Oi=new J(this.iLoader),this.#wi=e.network.enabled?new q(e):null,this.#Ci=new Ne(this.systemSettings,this.iLoader,i),this.#Ii=new Be(this),this.#Li=t,this.#Ci.addEventListener(l.EVENTS.SYSTEM.RENDER.START,(()=>this.emit(l.EVENTS.SYSTEM.RENDER.START))),this.#Ci.addEventListener(l.EVENTS.SYSTEM.RENDER.END,(()=>this.emit(l.EVENTS.SYSTEM.RENDER.END)))}emit=(e,...t)=>{const i=new Event(e);i.data=[...t],this.#z.dispatchEvent(i)};addEventListener=(e,t,i)=>{this.#z.addEventListener(e,t,i)};removeEventListener=(e,t,i)=>{this.#z.removeEventListener(e,t,i)};get iNetwork(){return this.#wi}get systemSettings(){return this.#ct}get audio(){return this.#Oi}get iLoader(){return this.#nt}get iRender(){return this.#Ci}get drawObjectFactory(){return this.#Pi}get iExtension(){return this.#Ii}get modules(){return this.#Di}installModule=(e,t,...i)=>{const s=new t(this,...i);return this.#Di.has(e)?(f("MODULE_ALREADY_INSTALLED","module "+e+" is already installed"),this.#Di.get(e)):(this.#Di.set(e,s),s)};startGameStage=(e,t)=>{if(this.#Li.has(e))if(!0===this.#Ci._isRenderActive())this.#Ci._stopRender(),_(d.ANOTHER_STAGE_ACTIVE," Can't start the stage "+e+" while, another stage is active");else{const i=this.#Li.get(e),s=i.stageData;this.#Pi._attachPageData(s),!1===i.isInitiated&&i._init(),i._start(t),this.emit(l.EVENTS.SYSTEM.START_PAGE),this.#Ci._startRender(s)}else _(d.VIEW_NOT_EXIST,"Stage "+e+" is not registered!")};stopGameStage=e=>{this.#Li.has(e)?(this.emit(l.EVENTS.SYSTEM.STOP_PAGE),this.drawObjectFactory._detachPageData(),this.#Ci._stopRender(),this.#Li.get(e)._stop()):_(d.STAGE_NOT_EXIST,"GameStage "+e+" is not registered!")}}class Ge{#Mi;#Ni=!1;#r;#Bi;#hi;constructor(){this.#r=!1}_register(e,t){this.#Mi=e,this.#Bi=t,this.#hi=new D(this.#Bi.systemSettings.gameOptions),this.#Wi(),this.#Gi(),this.register()}_init(){this.init(),this.#Ni=!0}register(){}init(){}start(e){}stop(){}resize(){}get iLoader(){return this.#Bi.iLoader}get draw(){return this.#Bi.drawObjectFactory}_attachCanvasToContainer(e){this.#Fi(this.canvasHtmlElement,e)}addRenderObject=e=>{const t=this.stageData;-1!==t.renderObjects.indexOf(e)?f("NEW_BEHAVIOR_INTRODUCED","stage.draw methods add objects to pageData, no need to call addRenderObject"):(t._renderObject=e,t._sortRenderObjectsBySortIndex())};get isActive(){return this.#r}get isInitiated(){return this.#Ni}get name(){return this.#Mi}get stageData(){return this.#hi}get systemSettings(){return this.#Bi.systemSettings}get audio(){return this.#Bi.audio}get iSystem(){return this.#Bi}get canvasHtmlElement(){return document.getElementsByTagName("canvas")[0]}addEventListener=(e,t,i)=>{this.iSystem.addEventListener(e,t,i)};removeEventListener=(e,t,i)=>{this.iSystem.removeEventListener(e,t,i)};_start(e){this.start(e),this.#r=!0,window.addEventListener("resize",this._resize),this._resize()}_stop(){this.#r=!1,window.removeEventListener("resize",this._resize),this.stop()}_resize=()=>{this.#Gi(),this.resize()};#Fi(e,t){t.appendChild(e)}#Wi(){const e=this.systemSettings.worldSize?this.systemSettings.worldSize.width:0,t=this.systemSettings.worldSize?this.systemSettings.worldSize.height:0;this.stageData._setWorldDimensions(e,t)}isBoundariesCollision=(e,t,i)=>{const s=i.type,r=i.vertices,n=i.circleBoundaries;switch(s){case l.DRAW_TYPE.TEXT:case l.DRAW_TYPE.RECTANGLE:case l.DRAW_TYPE.CONUS:case l.DRAW_TYPE.IMAGE:return n?this.#Ui(e,t,i.circleBoundaries.r):this.#ji(e,t,r,i.rotation);case l.DRAW_TYPE.CIRCLE:f(l.WARNING_CODES.METHOD_NOT_IMPLEMENTED,"isObjectCollision.circle check is not implemented yet!");break;case l.DRAW_TYPE.LINE:f(l.WARNING_CODES.METHOD_NOT_IMPLEMENTED,"isObjectCollision.line check is not implemented yet, please use .rect instead line!");break;default:f(l.WARNING_CODES.UNKNOWN_DRAW_OBJECT,"unknown object type!")}return!1};isObjectsCollision=(e,t,i,s)=>{const r=i.type,n=i.vertices,a=i.circleBoundaries;switch(r){case l.DRAW_TYPE.TEXT:case l.DRAW_TYPE.RECTANGLE:case l.DRAW_TYPE.CONUS:case l.DRAW_TYPE.IMAGE:return a?this.#ki(e,t,a,s):this.#Vi(e,t,n,i.rotation,s);case l.DRAW_TYPE.CIRCLE:f(l.WARNING_CODES.METHOD_NOT_IMPLEMENTED,"isObjectCollision.circle check is not implemented yet!");break;case l.DRAW_TYPE.LINE:f(l.WARNING_CODES.METHOD_NOT_IMPLEMENTED,"isObjectCollision.line check is not implemented yet, please use .rect instead line!");break;default:f(l.WARNING_CODES.UNKNOWN_DRAW_OBJECT,"unknown object type!")}return!1};#Vi(e,t,i,s,r){const n=r.length;let a=[];for(let o=0;o<n;o++){const n=r[o];let d;switch(n.type){case l.DRAW_TYPE.TEXT:case l.DRAW_TYPE.RECTANGLE:case l.DRAW_TYPE.CONUS:case l.DRAW_TYPE.IMAGE:d=this.#Yi(e,t,i,s,n);break;case l.DRAW_TYPE.CIRCLE:console.warn("isObjectCollision.circle check is not implemented yet!");break;case l.DRAW_TYPE.LINE:console.warn("isObjectCollision.line check is not implemented, please use rect instead");break;default:console.warn("unknown object type!")}d&&a.push(d)}return a.length>0?this.#Xi(a):null}#ki(e,t,i,s){const r=i.r,n=s.length;let a=[];for(let i=0;i<n;i++){const n=s[i],o=n.type,d=n.circleBoundaries;let h;switch(o){case l.DRAW_TYPE.TEXT:case l.DRAW_TYPE.RECTANGLE:case l.DRAW_TYPE.CONUS:case l.DRAW_TYPE.IMAGE:h=d?this.#zi(e,t,r,n.x,n.y,d.r):this.#Hi(e,t,r,n);break;case l.DRAW_TYPE.CIRCLE:console.warn("isObjectCollision.circle check is not implemented yet!");break;case l.DRAW_TYPE.LINE:console.warn("isObjectCollision.line check is not implemented, please use rect instead");break;default:console.warn("unknown object type!")}h&&a.push(h)}return a.length>0?this.#Xi(a):null}#Xi(e){return e.sort(((e,t)=>e.p<t.p))[0]}#Hi(e,t,i,s){const[r,n]=this.stageData.worldOffset,a=e-r,o=t-n,l=s.x-r,d=s.y-n,h=s.vertices,c=s.rotation,u=h.length;for(let e=0;e<u;e+=1){const t=h[e];let s=h[e+1];s||(s=h[0]);const r=this.#Ki(t,l,d,c),n=this.#Ki(s,l,d,c),u=_e(a,o,i,{x1:r[0],y1:r[1],x2:n[0],y2:n[1]});if(u)return u}return!1}#zi(e,t,i,s,r,n){const a=new C(e,t,s,r).length;return console.log(a),console.log(i),console.log(n),!(a-(i+n)>0)}#Yi(e,t,i,s,r){const[n,a]=this.stageData.worldOffset,o=e-n,l=t-a,d=r.x-n,h=r.y-a,c=r.vertices,u=r.rotation,g=i.map((e=>this.#Ki(e,o,l,s))),m=c.length;for(let e=0;e<m;e+=1){const t=c[e];let i=c[e+1];i||(i=c[0]);const s=this.#Ki(t,d,h,u),r=this.#Ki(i,d,h,u),n=ce(g,{x1:s[0],y1:s[1],x2:r[0],y2:r[1]});if(n)return n}return!1}#Ki(e,t,i,s){const r=new C(0,0,e[0],e[1]),n=ie(0,0,e[0],e[1]),a=r.length;return[t+a*Math.cos(s+n),i+a*Math.sin(s+n)]}#Ui(e,t,i){const s=this.stageData.getRawBoundaries(),r=this.stageData.getEllipseBoundaries(),n=this.stageData.getPointBoundaries(),[a,o]=this.stageData.worldOffset,l=e-a,d=t-o,h=this.stageData.boundariesLen,c=this.stageData.ellipseBLen,u=this.stageData.pointBLen;for(let e=0;e<h;e+=4){const t=s[e],r=s[e+1],n=s[e+2],a=s[e+3];if(0!==t||0!==r||0!==n||0!==a){const e=_e(l,d,i,{x1:t,y1:r,x2:n,y2:a});if(e)return e}}if(c>0)for(let e=0;e<c;e+=4){const t=Te([r[e],r[e+1],r[e+2],r[e+3]],{x:l,y:d,r:i});if(t)return t}if(u>0)for(let e=0;e<u;e+=2){const t=Ee(n[e],n[e+1],{x:l,y:d,r:i});if(t)return t}return!1}#ji(e,t,i,s){const r=this.stageData.getRawBoundaries(),n=this.stageData.getEllipseBoundaries(),a=this.stageData.getPointBoundaries(),[o,l]=this.stageData.worldOffset,d=e-o,h=t-l,c=i.map((e=>this.#Ki(e,d,h,s))),u=this.stageData.boundariesLen,g=this.stageData.ellipseBLen,m=this.stageData.pointBLen;for(let e=0;e<u;e+=4){const t=r[e],i=r[e+1],s=r[e+2],n=r[e+3];if(0!==t||0!==i||0!==s||0!==n){const e=ce(c,{x1:t,y1:i,x2:s,y2:n});if(e)return e}}if(g>0)for(let e=0;e<g;e+=4){const t=pe([n[e],n[e+1],n[e+2],n[e+3]],c);if(t)return t}if(m>0)for(let e=0;e<m;e+=2){const t=ue(a[e],a[e+1],c);if(t)return t}return!1}#Gi(){const e=this.systemSettings.canvasMaxSize.width&&this.systemSettings.canvasMaxSize.width<window.innerWidth?this.systemSettings.canvasMaxSize.width:window.innerWidth,t=this.systemSettings.canvasMaxSize.height&&this.systemSettings.canvasMaxSize.height<window.innerHeight?this.systemSettings.canvasMaxSize.height:window.innerHeight;this.stageData._setCanvasDimensions(e,t)}}class Fe extends Ge{#qi=0;#Ji=0;#Zi=0;register(){}init(){const[e,t]=this.stageData.canvasDimensions,i=e/3;this.background=this.draw.rect(0,0,e,t,this.systemSettings.gameOptions.loadingScreen.backgroundColor),this.loadingBarBg=this.draw.rect(e/2-i/2,t/2-10,i,20,this.systemSettings.gameOptions.loadingScreen.loadingBarBg),this.loadingBarProgress=this.draw.rect(e/2-i/2,t/2-10,i,20,this.systemSettings.gameOptions.loadingScreen.loadingBarProgress),this.text=this.draw.text(e/2-20,t/2-40,"JsGE","24px sans-serif","black"),this.#Zi=i}_progress=e=>{const t=this.#Zi/this.#qi;this.#Ji=e;const i=t*this.#Ji,s=e>this.#qi?this.#Zi:i;this.loadingBarProgress.width=s};start(e){this.#qi=e.total}}const Ue="loadingPage";class je{#Qi;#$i;constructor(e,t){e||_(d.CREATE_INSTANCE_ERROR,"iSystemSettings should be passed to class instance"),this.#Qi=new Map,t||(t=document.createElement("div"),document.body.appendChild(t)),this.#$i=new We(e,this.#Qi,t),this.registerStage(Ue,Fe),this.#$i.iLoader.addEventListener("loadstart",this.#es),this.#$i.iLoader.addEventListener("progress",this.#ts),this.#$i.iLoader.addEventListener("load",this.#is)}get iSystem(){return this.#$i}registerStage(e,t){if(e&&"string"==typeof e&&e.trim().length>0){const i=new t;i._register(e,this.iSystem),this.#Qi.set(e,i)}else _(d.CREATE_INSTANCE_ERROR,"valid class name should be provided")}preloadAllData(){return this.#$i.iLoader.preload()}#es=e=>{this.#$i.startGameStage(Ue,{total:e.total})};#ts=e=>{const t=e.loaded,i=e.total;this.#Qi.get(Ue)._progress(t,i)};#is=()=>{this.#$i.stopGameStage(Ue)}}var ke=n.oX,Ve=n.QD,Ye=n.T_,Xe=n.uw,ze=n.xl,He=n.xP,Ke=n.bq,qe=n.P6;export{ke as CONST,Ve as DrawImageObject,Ye as GameStage,Xe as ISystemAudio,ze as Primitives,He as System,Ke as SystemSettings,qe as utils};