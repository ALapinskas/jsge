const PROGRESS_EVENT_TYPE={loadstart:"loadstart",progress:"progress",abort:"abort",error:"error",load:"load",timeout:"timeout"},ERROR_MESSAGES={LOADER_NOT_REGISTERED:" loader is not registered.",RECURSION_ERROR:"Too much recursion. Stop iteration.",NOT_CORRECT_METHOD_TYPE:"uploadMethod should be instance of Promise and return upload result value",XML_FILE_EXTENSION_INCORRECT:" AtlasXML file extension is incorrect, only .xml file supported",TILESET_FILE_EXTENSION_INCORRECT:" tileset file extension is not correct, only .tsj or .json files are supported",TILEMAP_FILE_EXTENSION_INCORRECT:" tilemap file extension is not correct, only .tmj or .json files are supported",INPUT_PARAMS_ARE_INCORRECT:" fileKey and url should be provided",ATLAS_IMAGE_LOADING_FAILED:"Error loading atlas image ",TILESET_LOADING_FAILED:"Error loading related tileset ",TILEMAP_LOADING_FAILED:"Error loading tilemap ",AUDIO_LOADING_FAILED:"Error loading audio ",IMAGE_LOADING_FAILED:"Error loading image ",XML_FORMAT_INCORRECT:" XML format is not correct."};class Loader{#e;#t;#r=new Map;#s=new Map;constructor(e,t){this.#e=e,this.#t=(e,r,...s)=>{const i=t(e,r,...s);if(i instanceof Promise)return i.then((t=>this.#i(t,e)));throw new TypeError(ERROR_MESSAGES.NOT_CORRECT_METHOD_TYPE)}}#i=(e,t)=>new Promise(((r,s)=>{e||null===e||Warning("AssetsManager: uploadMethod for "+this.#e+" returns incorrect value"),this.#o(t,e),this.#a(t),r()}));#o(e,t){this.#s.set(e,t)}#a(e){this.#r.delete(e)}get filesWaitingForUpload(){return this.#r.size}get loadingQueue(){return this.#r}get uploadMethod(){return this.#t}_addFile=(e,t)=>{this.#r.has(e)&&Warning("AssetsManager: File "+this.#e+" with key "+e+" is already added"),this.#r.set(e,t)};_isFileInQueue=e=>this.#r.has(e);_getFile=e=>this.#s.get(e)}export default class AssetsManager{#n=5;#l=new EventTarget;#d=new Map;#E=0;constructor(){this.registerLoader("Audio",this._loadAudio),this.registerLoader("Image",this._loadImage),this.registerLoader("TileMap",this._loadTileMap),this.registerLoader("TileSet",this._loadTileSet),this.registerLoader("AtlasImageMap",this._loadAtlasImage),this.registerLoader("AtlasXML",this._loadAtlasXml)}get filesWaitingForUpload(){let e=0;return Array.from(this.#d.values()).map((t=>e+=t.filesWaitingForUpload)),e}registerLoader=(e,t=this._defaultUploadMethod)=>{this["add"+e]=(t,r,...s)=>{this.addFile(e,t,r,...s)},this["get"+e]=t=>this.getFile(e,t),this["is"+e+["InQueue"]]=t=>this.isFileInQueue(e,t);const r=this.#d.get(e)||new Loader(e,t);this.#d.set(e,r)};preload(){return this.#h(),new Promise((async(e,t)=>{this.#u().then((()=>{this.#c(),e()})).catch((e=>{t(e)}))}))}#u(e=0){return this.#R().then((t=>{if(0===this.filesWaitingForUpload)return Promise.resolve(t);if(++e>this.#n){const e=new Error(ERROR_MESSAGES.RECURSION_ERROR);return this.#g(e),Promise.reject(new Error(ERROR_MESSAGES.RECURSION_ERROR))}return this.#u(e)}))}#R(){return new Promise(((e,t)=>{let r=[];Array.from(this.#d.values()).forEach((e=>{Array.from(e.loadingQueue.entries()).forEach((t=>{const s=new Promise(((r,s)=>e.uploadMethod(t[0],...t[1]).then((e=>r(e)))));r.push(s)}))})),Promise.allSettled(r).then((r=>{for(const s of r){if("rejected"===s.status){const e=s.reason;this.#_(e)?t(e):(Warning("AssetsManager: "+e.message),this.#g(e))}e(r)}}))}))}addEventListener(e,t,...r){PROGRESS_EVENT_TYPE[e]?this.#l.addEventListener(e,t,...r):Warning("AssetsManager: Event type should be one of the ProgressEvent.type")}removeEventListener(e,t,...r){this.#l.removeEventListener(e,t,...r)}_loadAtlasXml=(e,t)=>(this.#m(t),fetch(t).then((e=>e.text())).then((e=>(new window.DOMParser).parseFromString(e,"text/xml"))).then((r=>{const s=r.documentElement||r.activeElement,i=s.attributes.getNamedItem("imagePath"),o=s.children;if(i){const r=this.#p(t);return this.addAtlasImageMap(e,r+i.value,o,r),Promise.resolve(s)}{const t=new Error(e+ERROR_MESSAGES.XML_FORMAT_INCORRECT);return this.#g(t),Promise.resolve(t)}})));_loadAtlasImage=(e,t,r,s="anonymous")=>new Promise(((e,i)=>{const o=new Image,a=new Map,n=document.createElement("canvas"),l=n.getContext("2d");o.crossOrigin=s,o.onload=()=>{const t=[];let s=[];n.width=o.width,n.height=o.height,l.drawImage(o,0,0);for(let e of r){const r=e.attributes,i=r.getNamedItem("name").value,o=i.includes(".")?i.split(".")[0]:i,a=r.getNamedItem("x").value,n=r.getNamedItem("y").value,d=r.getNamedItem("width").value,E=r.getNamedItem("height").value;t.push(createImageBitmap(l.getImageData(a,n,d,E),{premultiplyAlpha:"premultiply"})),s.push(o)}this.#S(),Promise.all(t).then((t=>{t.forEach(((e,t)=>{const r=s[t];a.set(r,e),this.addImage(r,"empty url",e)})),n.remove(),e(a)}))},o.onerror=()=>{const r=new Error(ERROR_MESSAGES.ATLAS_IMAGE_LOADING_FAILED+t);this.#g(r),e(null)},o.src=t}));_loadTileSet=(e,t,r=1,s)=>(this.#I(t),fetch(s?s+t:t).then((e=>e.json())).then((e=>{const{name:t,image:i,spacing:o,margin:a,tilewidth:n,tileheight:l}=e;return t&&i&&!this.isFileInQueue("Image",t)&&this.addImage(t,s?s+i:i),e.gid=r,Promise.resolve(e)})).catch((()=>{const e=new Error(ERROR_MESSAGES.TILESET_LOADING_FAILED+t);return this.#g(e),Promise.resolve(null)})));_defaultUploadMethod=(e,t)=>fetch(t);_loadTileMap=(e,t,r=!0)=>(this.#L(t),fetch(t).then((e=>e.json())).then((e=>{const s=this.#p(t);if(!0===r&&e.tilesets&&e.tilesets.length>0){const t=[];return e.tilesets.forEach(((e,r)=>{const{firstgid:i,source:o}=e,a=this._loadTileSet("default-"+i,o,i,s).then((e=>(this.#S(),Promise.resolve(e))));t.push(a)})),Promise.all(t).then((t=>{for(let r=0;r<t.length;r++){const s=t[r];e.tilesets[r].data=s}return Promise.resolve(e)}))}return Promise.resolve(e)})).catch((e=>(e.message.includes("JSON.parse:")&&(e=new Error(ERROR_MESSAGES.TILEMAP_LOADING_FAILED+t)),this.#g(e),Promise.resolve(null)))));_loadAudio=(e,t)=>new Promise((e=>{const r=new Audio(t);r.addEventListener("loadeddata",(()=>{this.#S(),e(r)})),r.addEventListener("error",(()=>{const r=new Error(ERROR_MESSAGES.AUDIO_LOADING_FAILED+t);this.#g(r),e(null)}))}));_loadImage=(e,t,r,s="anonymous")=>new Promise(((e,i)=>{if(r)e(r);else{const r=new Image;r.crossOrigin=s,r.onload=()=>{createImageBitmap(r,{premultiplyAlpha:"premultiply"}).then((t=>{this.#S(),e(t)}))},r.onerror=()=>{const r=new Error(ERROR_MESSAGES.IMAGE_LOADING_FAILED+t);this.#g(r),e(null)},r.src=t}}));#m(e){e.includes(".xml")||Exception(e+ERROR_MESSAGES.XML_FILE_EXTENSION_INCORRECT)}#I(e){e.includes(".tsj")||e.includes(".json")||Exception(e+ERROR_MESSAGES.TILESET_FILE_EXTENSION_INCORRECT)}#L(e){e.includes(".tmj")||e.includes(".json")||Exception(e+ERROR_MESSAGES.TILEMAP_FILE_EXTENSION_INCORRECT)}#_(e){return e.message.includes(ERROR_MESSAGES.NOT_CORRECT_METHOD_TYPE)||e.message.includes(ERROR_MESSAGES.XML_FILE_EXTENSION_INCORRECT)||e.message.includes(ERROR_MESSAGES.TILESET_FILE_EXTENSION_INCORRECT)||e.message.includes(ERROR_MESSAGES.TILEMAP_FILE_EXTENSION_INCORRECT)||e.message.includes(ERROR_MESSAGES.INPUT_PARAMS_ARE_INCORRECT)||e.message.includes(ERROR_MESSAGES.LOADER_NOT_REGISTERED)}#p(e){let t=e.split("/"),r=t.length,s="/";return t[r-1].includes(".tmj")||t[r-1].includes(".xml")||t[r-1].includes(".json")?(t.pop(),s=t.join("/")+"/"):(t[r-2].includes(".tmj")||t[r-2].includes(".xml")||t[r-2].includes(".json"))&&(t.splice(r-2,2),s=t.join("/")+"/"),s}addFile(e,t,r,...s){const i=this.#d.get(e);i?(this.#A(t,r,e),i._addFile(t,[r,...s])):Exception(e+ERROR_MESSAGES.LOADER_NOT_REGISTERED)}isFileInQueue(e,t){const r=this.#d.get(e);if(r)return r._isFileInQueue(t);Exception("Loader for "+e+" is not registered!")}getFile(e,t){const r=this.#d.get(e);if(r)return r._getFile(t);Exception("Loader for "+e+" is not registered!")}#A(e,t,r){const s=ERROR_MESSAGES.INPUT_PARAMS_ARE_INCORRECT;e&&0!==e.trim().length||Exception("add"+r+"()"+s),t&&0!==t.trim().length||Exception("add"+r+"()"+s)}#h(){let e=this.filesWaitingForUpload;this.#l.dispatchEvent(new ProgressEvent(PROGRESS_EVENT_TYPE.loadstart,{total:e}))}#c(){this.#l.dispatchEvent(new ProgressEvent(PROGRESS_EVENT_TYPE.load))}#S(){const e=this.filesWaitingForUpload;this.#E+=1,this.#l.dispatchEvent(new ProgressEvent(PROGRESS_EVENT_TYPE.progress,{lengthComputable:!0,loaded:this.#E,total:e}))}#g(e){Warning("AssetsManger: "+e.message),this.#l.dispatchEvent(new ErrorEvent(PROGRESS_EVENT_TYPE.error,{error:e}))}}function Exception(e){throw new Error(e)}function Warning(e){console.warn(e)}